<?php
 $_stopwatch = microtime (); define ('E2_VERSION',4169); define ('E2_RELEASE','11.4'); define ('CACHE',1); define ('BUILDER_OBFUSCATE',1); define ('BUILDER_FLATTEN',1); define ('BUILT', !strstr (__FILE__,'all.php')); define ('E2_RUN_ID',chr (rand (65,90))); function e2m_error404 () { global$_config,$_strings; if($_config['try_redirect_to_all']) { $c = 'all/'. urldecode ((string) @$_GET['go']); uq ($c); } header ('HTTP/1.1 404 Not found'); $v['class']='404'; $v['heading']=$_strings['pt--page-not-found']; $v['title']=$_strings['pt--page-not-found']; return $v; } class AeArbitraryNotesCollectionView { private $name = ''; private $isCached = false; private $hasRun = false; private $sql = null; private $currentURL = null; private $cacheFilename = null; private $cacheExpiresFilename = null; private $cacheable = []; private $viewExpiration = null; private $notesCTree = null; private $filterOutIDs = []; public function __construct ($name){ $this->name = $name; } public function setSQLRequest ($sql){ $this->sql = $sql; } public function setCurrentURL ($currentURL){ $this->currentURL = $currentURL; } public function setCacheFilename ($cacheFilename){ $this->isCached = true; $this->cacheFilename = $cacheFilename; } public function setCacheExpiresFilename ($cacheExpiresFilename){ $this->cacheExpiresFilename = $cacheExpiresFilename; } public function setViewExpiration ($viewExpiration){ $this->viewExpiration = $viewExpiration; } public function setFilterOutIDs ($filterOutIDs){ $this->filterOutIDs = $filterOutIDs; } public function orderNotesCTreeByVerticality () { if (!$this->hasRun)$this -> run (); usort ($this->notesCTree, function ($b,$y){ if (empty ($b['images'][0]['verticality']))$n = 0; else $n = $b['images'][0]['verticality']; if (empty ($y['images'][0]['verticality']))$m = 0; else $m = $y['images'][0]['verticality']; return (int)round (($m - $n)*10000); }); } public function getNotesCTree () { if (!$this->hasRun)$this -> run (); return$this->notesCTree; } private function prepareCacheableData () { $f = [ 'notes-records' => function () { $d = []; try { em ($this->sql,'get "'. $this->name .'" list'); foreach (tm () as $s){ if (kf ($s)==='public'){ $d[] = $s; } } } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get list from database'); } return $d; }, ]; if($this->isCached and is_file ($this->cacheFilename)) { $this->cacheable = @unserialize (file_get_contents ($this->cacheFilename)) or $this->cacheable = []; } $q = true; if (!empty ($this->cacheExpiresFilename)) { if($this->isCached and is_file ($this->cacheExpiresFilename)) { $l = time (); $z = (int) @file_get_contents ($this->cacheExpiresFilename); if(Log::$a)__log ('List expires '. date ('r',$z) .', now '. date ('r',$l)); $q = ($l < $z); } } $k = false; foreach ($f as $x => $e_){ if (!array_key_exists ($x,$this->cacheable) or !$q){ if(Log::$a)__log ('Build cache: "'. $x .'"'); $this->cacheable[$x]=$e_ (); $k = true; } else { if(Log::$a)__log ('Retrieved from cache: "'. $x .'"'); } } if($this->isCached and $k){ e3 ($this->cacheFilename,serialize ($this->cacheable)); if($this->cacheExpiresFilename){ @e3 ($this->cacheExpiresFilename,time () + $this->viewExpiration); } } } private function run () { $this->hasRun = true; if(Log::$a)__log ('AeArbitraryNotesCollectionView "'. $this->name .'" run {'); if(Log::$a)__log ('Cacheable data {'); $this -> prepareCacheableData (); if(Log::$a)__log ('}'); if(Log::$a)__log ('Uncacheable data {'); $this->notesCTree = []; foreach($this->cacheable['notes-records'] as $s){ if(in_array ($s['ID'],$this->filterOutIDs)) continue; $noteView = new AeNoteView ($s); $r = $noteView -> getNoteCTree (); $r['current?'] = ($r['href']==$this->currentURL); $this->notesCTree[] = $r; AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($s['ID']); } if(Log::$a)__log ('}'); if(Log::$a)__log ('}'); } } class AeDatabaseConfiguration { public $server; public $host; public $port = null; public $user; public $password; public $name; public $source; public $backup_dir; private $prefix = null; private $subset = null; public function __construct ( $source, $backup_dir, $server, $user, $password, $name, $prefix = null, $subset = null ) { $this->source = $source; $this->backup_dir = $backup_dir; $this->server = $server; list ($this->host,$this->port)=om ($this->server); if ((string)$this->port === '') { $this->port = null; } $this->user = $user; $this->password = $password; $this->name = $name; $this->prefix = $prefix; $this->subset = $subset; } public function hasPrefixSpecified () { return$this->prefix !== null; } public function getPrefix () { if($this->prefix === null){ throw new LogicException ('Assertion failed: database configuration has no prefix'); } return$this->prefix; } public function setPrefix ($prefix){ $this->prefix = $prefix; } public function hasSubsetSpecified () { return$this->subset !== null; } public function setSubset ($subset){ $this->subset = $subset; } public function getSubset () { if($this->subset === null){ throw new LogicException ('Assertion failed: database configuration has no subset'); } return$this->subset; } public function getDatabaseParamsArray () { return [ 'server' => $this->server, 'user_name' => $this->user, 'passw' => $this->password, 'name' => $this->name, ]; } public function getServerKeyString () { return$this->user .'@'. $this->server; } public function getDatabaseKeyString () { return$this -> getServerKeyString () .'/'. $this->name; } public function getTablesKeyString () { return$this -> getDatabaseKeyString () .'/'. $this -> getPrefix () .'...'; } public function __toString () { return$this -> getTablesKeyString () .'?'. $this -> getSubset (); } } class AeEnv { private static $t = false; public static $j = ''; public static $h = 'http'; public static $g = ''; public static $server = ''; public static $w = ''; public static $u = ''; public static $i = ''; public static $o = 'http'; public static $p = ''; public static $cv = ''; private static function updateBaseURL () { if (!self::$t) throw new LogicException ('AeEnv not initialized'); self::$p = self::$o. '://'. self::$server . self::$u . '/'; self::$cv = self::$p; self::$i = self::$u; if(self::$w !== (string)''){ self::$cv .= self::$w; self::$i .= ( '/'. rtrim (self::$w,'/') ); } } public static function examine ($vv){ list (self::$server, ) = explode (':',$vv['HTTP_HOST']); self::$u = substr ( $vv['PHP_SELF'], 0,strpos ($vv['PHP_SELF'],'/index.php') ); self::$o = ( !empty ($vv['HTTPS']) && $vv['HTTPS']!=='off' or $vv['SERVER_PORT']==443 or isset ($vv['HTTP_X_FORWARDED_PROTO']) && $vv['HTTP_X_FORWARDED_PROTO']=='https' or isset ($vv['HTTP_X_HTTPS']) && ($vv['HTTP_X_HTTPS']) ) ? 'https' : 'http'; if(getenv ('E2_USER_SUBPATH')) { self::$w = trim (getenv ('E2_USER_SUBPATH'),'/'); } elseif(getenv ('REDIRECT_E2_USER_SUBPATH')) { self::$w = trim (getenv ('REDIRECT_E2_USER_SUBPATH'),'/'); } if(self::$w !== '')self::$w .= '/'; self::$t = true; self::updateBaseURL (); self::$j = self::$server; self::$h = self::$o; self::$g = self::$p; } public static function setPrefersHTTPS ($bv){ if (!self::$t) throw new LogicException ('AeEnv not initialized'); if ((bool)$bv){ self::$o = 'https'; self::updateBaseURL (); } } public static function setPreferredServer ($yv){ if (!self::$t) throw new LogicException ('AeEnv not initialized'); if ($yv !== null and $_SERVER['HTTP_HOST']!==$yv){ self::$server = $yv; self::updateBaseURL (); } } public static function showDie () { if (!self::$t) throw new LogicException ('AeEnv not initialized'); echo '<pre>'; echo '<b>server</b>: "'. self::$server. '"<br />'; echo '<b>server_used</b>: "'. self::$j. '"<br />'; echo '<b>user_subpath</b>: "'. self::$w. '"<br />'; echo '<b>folder</b>: "'. self::$u. '"<br />'; echo '<b>folder_with_user_subpath</b>: "'. self::$i. '"<br />'; echo '<b>protocol_used</b>: "'. self::$h. '"<br />'; echo '<b>protocol</b>: "'. self::$o. '"<br />'; echo '<b>base_url_used</b>: "'. self::$g. '"<br />'; echo '<b>base_url</b>: "'. self::$p. '"<br />'; echo '<b>base_url_with_user_subpath</b>: "'. self::$cv. '"<br />'; echo '</pre>'; die; } } class AeFileManager { private static $nv = null; private static $mv = null; private static $fv = null; private static $dv = [ '.', ]; private static $sv = [ '', LOGS_DIRNAME, BACKUP_DIRNAME, ]; private static $av = [ '', CACHES_DIRNAME, BACKUP_DIRNAME, ]; private static $qv = [ PICTURES_DIRNAME, THUMBNAILS_DIRNAME, PICTURES_DIRNAME .'remote/', THUMBNAILS_DIRNAME .'remote/', VIDEO_DIRNAME, AUDIO_DIRNAME, AVATARS_DIRNAME, USERPIC_DIRNAME, ]; private static $lv = [ 'updating.psa', ]; private static $zv = [ 'password-hash.psa', 'password-wait.psa', 'last-comment.psa', 'new-uploads.psa', 'settings.json', 'bsi.psa', 'auth.psa', 'scheduled.psa', 'license.psa', 'checklist.psa', ]; private static function ready () { return self::$nv !== null and self::$mv !== null and self::$fv !== null; } public static function writtenDirectories ($mv = null,$fv = null){ if (!self::ready ()) return []; if ($mv === null)$mv = self::$mv; if ($fv === null)$fv = self::$fv; $kv = self::$dv; foreach(self::$sv as $xv){ $kv[] = self::$nv . $xv; } foreach(self::$av as $xv){ $kv[] = $mv . $xv; } foreach(self::$qv as $xv){ $kv[] = $fv . $xv; } $kv = array_unique ($kv); return $kv; } public static function writtenFiles ($mv = null,$fv = null){ if (!self::ready ()) return []; if ($mv === null)$mv = self::$mv; if ($fv === null)$fv = self::$fv; $ev = []; foreach(self::$lv as $rv){ $ev[] = self::$nv . $rv; } foreach(self::$zv as $rv){ $ev[] = $mv . $rv; } $ev = array_unique ($ev); return $ev; } public static function setInstancePath ($nv){ self::$nv = $nv; } public static function setUserPath ($mv){ self::$mv = $mv; } public static function setMediaPath ($fv){ self::$fv = $fv; } public static function forceAllDirectories () { if (!self::ready ()) return false; foreach(self::writtenDirectories () as $tv){ @qq ($tv); } } public static function forceInstanceDirectories () { if (!self::ready ()) return false; foreach(self::$sv as $xv){ @qq (self::$nv . $xv); } } public static function forceUserDirectories ($mv = null){ if (!self::ready ()) return false; if ($mv === null)$mv = self::$mv; foreach(self::$av as $xv){ @qq ($mv . $xv); } } public static function forceMediaDirectories ($fv = null){ if (!self::ready ()) return false; if ($fv === null)$fv = self::$fv; foreach(self::$qv as $xv){ @qq ($fv . $xv); } } public static function getPathsWithNoWritePermissions ($mv = null,$fv = null){ if (!self::ready ()) return []; if ($mv === null)$mv = self::$mv; if ($fv === null)$fv = self::$fv; clearstatcache (); $jv = []; foreach(self::writtenDirectories ($mv,$fv) as $hv){ if(is_dir ($hv) and !is_writable ($hv)) { $jv[] = $hv; } } foreach(self::writtenFiles ($mv,$fv) as $hv){ if(is_file ($hv) and !is_writable ($hv)) { $jv[] = $hv; } } return $jv; } } class AeLayoutDiversityManager { private static $layoutsUseIndexes = []; private static $layoutsUseIndex = 1; private static $layoutsUseMaxIndex = 1; public static function addLayoutsUsed ($gv){ self::$layoutsUseIndexes[$gv]=self::$layoutsUseIndex; self::$layoutsUseIndex ++; self::$layoutsUseMaxIndex ++; } public static function hasLayoutBeenUsed ($gv){ if (isset (self::$layoutsUseIndexes[$gv])) return true; } public static function getLayoutsUseRecency ($gv){ if (isset (self::$layoutsUseIndexes[$gv])) { return self::$layoutsUseIndexes[$gv]-self::$layoutsUseMaxIndex; } } } class AeMainMenuManager { private static $currentTags = []; private static $parentTags = []; static $isFavouritesCurrent = false; static $isFavouritesParent = false; static $isMostCommentedCurrent = false; static $isMostCommentedParent = false; static $isPopularCurrent = false; static $isPopularParent = false; static $isTagsCurrent = false; static $isTagsParent = false; static $isCalendarCurrent = false; static $isCalendarParent = false; public static function addCurrentTag ($wv){ self::$currentTags[] = $wv; } public static function addParentTag ($wv){ self::$parentTags[] = $wv; } public static function isCurrentTag ($wv){ if (!empty (self::$currentTags)) { return in_array ($wv,self::$currentTags); } return false; } public static function isParentTag ($wv){ if (!empty (self::$parentTags)) { return in_array ($wv,self::$parentTags); } return false; } } class AeModel { private static $uv = [ 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'pkey1' => "INT UNSIGNED DEFAULT '1' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v39' => "VARCHAR(39) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ]; private static $iv = [ 'Actions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityID', 'pkey'], ['Stamp', 'time'], ['ReadCount', 'int'], ], 'Aliases' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityType', 'v1'], ['EntityID', 'pkey'], ['Alias', 'v64'], ['Stamp', 'time'], ], 'Comments' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['Text', 'text'], ['Reply', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ['IsReplyVisible', '0'], ['IsReplyFavourite', '0'], ['IsAnswerAware', '1'], ['IsSubscriber', '0'], ['IsSpamSuspect', '0'], ['IsNew', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['ReplyStamp', 'time'], ['ReplyLastModified', 'time'], ['IP', 'v39'], ['IsGIPUsed', '0'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ], 'GIPsSessions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['AuthorProfileLink', 'v255'], ['SessionToken', 'v255'], ['Stamp', 'time'], ], 'Keywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Keyword', 'v255'], ['OriginalAlias', 'v64'], ['PageTitle', 'v255'], ['Description', 'text'], ['Summary', 'text'], ['Uploads', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ], 'Notes' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Title', 'v255'], ['Text', 'text'], ['Summary', 'text'], ['FormatterID', 'fid'], ['OriginalAlias', 'v64'], ['Uploads', 'text'], ['IsPublished', '0'], ['IsCommentable', '0'], ['IsVisible', '1'], ['IsFavourite', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['Offset', 'int'], ['IsDST', '0'], ['IsIndexed', '0'], ['IsExternal', '0'], ['ReadCount', 'uint'], ['SourceID', 'pkey'], ['SourceNoteID', 'pkey'], ['SourceNoteURL', 'v255'], ['SourceNoteJSONURL', 'v255'], ['SourceNoteData', 'text'], ], 'NotesKeywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['KeywordID', 'pkey'], ], 'Sources' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['TrueID', 'pkey'], ['Title', 'v255'], ['AuthorName', 'v255'], ['URL', 'v255'], ['PictureURL', 'v255'], ['IsWhiteListed', '0'], ['IsTrusted', '0'], ], ]; private static $ov = [ 'Actions' => [ ['unique', ['EntityID','Stamp']], ['index', ['SubsetID']], ], 'Aliases' => [ ['index', ['SubsetID']], ['index', ['Alias']], ['index', ['EntityID']], ], 'Comments' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'GIPsSessions' => [ ['unique', ['SubsetID','GIP','GIPAuthorID']], ['index', ['SubsetID']], ], 'Keywords' => [ ['index', ['SubsetID']], ], 'Notes' => [ ['fulltext', ['Title','Text']], ['index', ['SubsetID']], ['index', ['Stamp']], ['index', ['SourceID']], ['index', ['SourceNoteID']], ], 'NotesKeywords' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'Sources' => [ ['index', ['SubsetID']], ], ]; private static $pv = [ 'index' => 'INDEX', 'unique' => 'UNIQUE INDEX', 'fulltext' => 'FULLTEXT', ]; private static $cb = [ 'index' => 'KEY', 'unique' => 'UNIQUE KEY', 'fulltext' => 'FULLTEXT KEY', ]; public static function unprefixedCoreTablesNames () { return array_keys (self::$iv); } public static function unprefixedEssentialTablesNames () { return [ 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ]; } public static function assertUnprefixedTableName ($vb){ if (!array_key_exists ($vb,self::$iv)) { throw new LogicException ('Table "'. $vb .'" is not part of the model'); } } public static function columnsByUnprefixedTableName ($vb){ self::assertUnprefixedTableName ($vb); return self::$iv[$vb]; } public static function indexesByUnprefixedTableName ($vb){ self::assertUnprefixedTableName ($vb); return self::$ov[$vb]; } public static function softFieldsByUnprefixedTableName ($vb){ self::assertUnprefixedTableName ($vb); $bb = []; foreach(self::$iv[$vb] as $x){ if (!in_array ($x[1], ['key'])) { $bb[] = $x[0]; } } return $bb; } public static function columnsAndIndexesSQLByUnprefixedTableName ($vb){ self::assertUnprefixedTableName ($vb); $yb = []; foreach(self::columnsByUnprefixedTableName ($vb) as $nb){ list ($name,$mb)=$nb; $yb[] = "`". $name ."` ". self::expandColumnDefinition ($mb); } foreach(self::indexesByUnprefixedTableName ($vb) as $fb){ list ($type,$db)=$fb; $sb = implode ('',$db); $ab = self::indexCreateSQLByIndexType ($type).' `'. $sb .'` (`'. implode ('`, `',$db) .'`)'; $yb[] = $ab; } return "(". implode (", ",$yb) .")"; } public static function expandColumnDefinition ($qb){ return self::$uv[$qb]; } public static function indexCheckSQLByIndexType ($lb){ return self::$cb[$lb]; } public static function indexCreateSQLByIndexType ($lb){ return self::$pv[$lb]; } } class AeNoteReadCountsProvider { private static $dataByNoteID = []; private static $hasRun = false; private static $sql = null; public static function setSQLRequestTemplateToMapIDsToReadCounts ($sql){ self::$sql = $sql; } public static function requestDeferredReadCountForNoteID ($noteID){ self::$dataByNoteID[$noteID]=false; } public static function getReadCountForNoteID ($noteID){ if(self::$sql === null) return false; if (!self::$hasRun)self :: run (); if (empty (self::$dataByNoteID[$noteID])) return false; return self::$dataByNoteID[$noteID]; } private static function run () { self::$hasRun = true; $zb = []; foreach(self::$dataByNoteID as$note_id => $kb){ $zb[] = "(`ID` = ". $note_id . ")"; } if (!count ($zb)) return; $zb = implode (' OR ',$zb); try { em ( self::$sql ." AND (". $zb .")", 'get all requested read counts for notes' ); $xb = tm (); foreach ($xb as $eb){ self::$dataByNoteID[$eb['ID']] = $eb['ReadCount']; } } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get requested read counts for notes'); } } } class AeNoteView { private $noteRecord = []; private $isCached = false; private $hasRun = false; private $cacheFilename = null; private $noteCTree = null; private $highlightedTags = null; private $cacheable = []; private $OGImages = []; private $wantRichText = false; private $wantCommentsLink = false; private $wantNewCommentsCount = false; private $wantReadHref = false; private $wantPreviewHref = false; private $wantControls = false; private $wantHiddenTags = false; private $wantSharingButtons = false; private $wantRelatedNotes = false; private $filterOutRelatedNoteIDs = []; private $useLocalHref = false; public function __construct ($noteRecord){ $this->noteRecord = $noteRecord; if(CACHE_NOTES){ $this->isCached = true; $this->cacheFilename = e2_note_cache_filename_with_id_($noteRecord['ID']); } } public function setHighlightedTags ($highlightedTags){ $this->highlightedTags = $highlightedTags; } public function setWantRichText ($wantRichText){ $this->wantRichText = $wantRichText; } public function setWantCommentsLink ($wantCommentsLink){ $this->wantCommentsLink = $wantCommentsLink; } public function setWantNewCommentsCount ($wantNewCommentsCount){ $this->wantNewCommentsCount = $wantNewCommentsCount; } public function setWantReadHref ($wantReadHref){ $this->wantReadHref = $wantReadHref; } public function setWantPreviewHref ($wantPreviewHref){ $this->wantPreviewHref = $wantPreviewHref; } public function setWantControls ($wantControls){ $this->wantControls = $wantControls; } public function setWantHiddenTags ($wantHiddenTags){ $this->wantHiddenTags = $wantHiddenTags; } public function setWantSharingButtons ($wantSharingButtons){ $this->wantSharingButtons = $wantSharingButtons; } public function setWantRelatedNotes ($wantRelatedNotes){ $this->wantRelatedNotes = $wantRelatedNotes; } public function setFilterOutRelatedNoteIDs ($filterOutRelatedNoteIDs){ $this->filterOutRelatedNoteIDs = $filterOutRelatedNoteIDs; } public function setUseLocalHref ($useLocalHref){ $this->useLocalHref = $useLocalHref; } public function getNoteCTree () { if (!$this->hasRun)$this -> run (); return$this->noteCTree; } private function prepareCacheableData () { $f = [ 'title' => function () { return ry ( htmlspecialchars ($this->noteRecord['Title'],ENT_NOQUOTES,'UTF-8') ); }, 'text-format-info' => function () { return jy ( $this->noteRecord['FormatterID'], $this->noteRecord['Text'], 'full' ); }, 'summary' => function () { if ((string)$this->noteRecord['Summary']!==''){ return ry (htmlspecialchars ($this->noteRecord['Summary'],ENT_NOQUOTES,'UTF-8')); } else { $rb = $this->cacheable['text-format-info']['text-flow']; $tb = ''; foreach ($rb as $jb){ if(is_string ($jb)) { $tb = $jb; break; } } $tb = jy ( $this->noteRecord['FormatterID'], $tb, 'full' ); return zf ($tb['text-final']); } }, 'comments-count' => function () { if (!$this->noteRecord['IsPublished']) { return false; } else { return ab ($this->noteRecord['ID']); } }, 'tags-data' => function () { $hb = fa ($this->noteRecord['ID']); $gb['ctree'] = []; $gb['all-resnames-uploads'] = []; foreach ($hb as $wb => $ub){ $gb['ctree'][] = [ 'visible?' => (bool)$ub['IsVisible'], 'name' => htmlspecialchars ($ub['Keyword'],ENT_NOQUOTES,'UTF-8'), 'href' => wq ('e2m_tag', array ('*tag' => $ub)), ]; $gb['all-resnames-uploads']=array_merge ( $gb['all-resnames-uploads'], cy ('tag',$ub['ID']) ); } $gb['all-resnames-uploads']=array_unique ( $gb['all-resnames-uploads'] ); return $gb; }, ]; if($this->isCached and is_file ($this->cacheFilename)) { $this->cacheable = @unserialize (file_get_contents ($this->cacheFilename)) or $this->cacheable = []; } $k = false; foreach ($f as $x => $e_){ if (!array_key_exists ($x,$this->cacheable)) { if(Log::$a)__log ('Build cache: "'. $x .'"'); $this->cacheable[$x]=$e_ (); $k = true; } else { if(Log::$a)__log ('Retrieved from cache: "'. $x .'"'); } } if($this->isCached and $k){ e3 ($this->cacheFilename,serialize ($this->cacheable)); } } private function run () { $this->hasRun = true; if(Log::$a)__log ('AeNoteView run {'); if(Log::$a)__log ('Cacheable data {'); $this -> prepareCacheableData (); if(Log::$a)__log ('}'); if(Log::$a)__log ('Uncacheable data {'); $ib = false; if($this->noteRecord['IsPublished']) { if ((string)$this->noteRecord['OriginalAlias']!==''){ $ib = wq ('e2m_note', ['alias' => $this->noteRecord['OriginalAlias']]); } else { $ob = $this->noteRecord; $ob['__force_ymdn']=true; $ib = wq ('e2m_note', ['*note' => $ob]); } } $pb = v1 ($this->noteRecord); $c3 = [(int)$this->noteRecord['LastModified'],$pb]; $l = ( $this->noteRecord['IsPublished'] ? [(int)$this->noteRecord['Stamp'],$pb]:$c3 ); $v3 = kf ($this->noteRecord); $b3 = @$this->cacheable['text-format-info']['meta']['resources-detected']; if (!is_array ($b3))$b3 = []; if(count ($b3)) { bd ($b3); } $y3 = h2 ($b3); $n3 = @unserialize ($this->noteRecord['Uploads']) or $n3 = []; $m3 = array_merge ( g2 ( $b3,$n3 ), $this->cacheable['tags-data']['all-resnames-uploads'] ); $f3 = t3 ($m3); $d3 = h2 ($m3); $s3 = $this->noteRecord['SourceNoteData']; $s3 = @json_decode ($s3,true); $a3 = @$s3['og_images'][0] or $a3 = ''; if($this->noteRecord['IsExternal']) { $q3 = an ($this->noteRecord); } else { $q3 = []; } $l3 = false; $k3 = $this->cacheable['tags-data']['ctree']; foreach ($k3 as $x3 => $e3){ if($this->highlightedTags !== null){ $k3[$x3]['current?']=in_array ($k3[$x3]['name'],$this->highlightedTags); } if (!$this->wantHiddenTags and !$k3[$x3]['visible?']) { unset ($k3[$x3]); } } if($this->wantSharingButtons and $v3 === 'public'){ $r3 = ba ($f3); } else { $r3 = false; } if($this->wantNewCommentsCount){ $t3 = sb ($this->noteRecord['ID']); } else { $t3 = false; } $this->noteCTree = [ 'id' => (int)$this->noteRecord['ID'], 'title' => (string)$this->cacheable['title'], 'href' => wq ('e2m_note', ['*note' => $this->noteRecord]), 'href-original' => $ib, 'time' => $l, 'last-modified' => $c3, 'text' => (string)$this->cacheable['text-format-info']['text-final'], 'format-info' => $this->cacheable['text-format-info']['meta'], 'summary' => (string)$this->cacheable['summary'], 'snippet-text' => (string)$this->cacheable['summary'], 'draft?' => $v3 === 'draft', 'scheduled?' => $v3 === 'scheduled', 'public?' => $v3 === 'public', 'hidden?' => $v3 === 'hidden', 'current?' => false, 'favourite?' => (bool) ($this->noteRecord['IsFavourite'] and $v3 !== 'draft'), 'images' => w2 ($y3), 'thumbs' => u2 ($y3), 'source-main-image-url' => (string)$a3, 'og-images' => $f3, 'og-images-thumbs' => u2 ($d3), 'tags' => $k3, 'sharing-buttons' => $r3, 'related' => $l3, 'read-href' => ($this->wantReadHref and $this->noteRecord['IsPublished'])? wq ('e2m_note_read', ['*note' => $this->noteRecord]) : false, 'preview-href' => ($this->wantPreviewHref and ($v3 !== 'public'))? wq ('e2m_note', [ '*note' => $this->noteRecord, 'preview-key' => rf ($this->noteRecord) ]) : false, 'comments-count' => $this->cacheable['comments-count'], 'comments-count-text' => is_int ($this->cacheable['comments-count'])? e2l_get_string ('gs--n-comments', [ 'number' => $this->cacheable['comments-count'] ]) : '', 'new-comments-count' => $t3, 'new-comments-count-text' => is_int ($t3)? e2l_get_string ('gs--comments-n-new', [ 'number' => $t3 ]) : '', 'comments-link?' => (bool) ( $this->wantCommentsLink and $this->noteRecord['IsPublished'] and ( xb ($this->noteRecord) or ($this->cacheable['comments-count']>0) ) ), ]; if($this->noteRecord['IsExternal']) { $this->noteCTree = array_merge ($this->noteCTree,$q3); $this->noteCTree['href-original']=$this->noteCTree['href-external']; if (!$this->useLocalHref){ $this->noteCTree['href']=$this->noteCTree['href-external']; } } if($this->wantControls){ $this->noteCTree['edit-href']=wq ( 'e2m_note_edit', array ('*note' => $this->noteRecord) ); if($this->noteRecord['IsPublished'] and !$this->noteRecord['IsVisible']) { $this->noteCTree['show-action']=wq ('e2s_note_flag', [ '*note' => $this->noteRecord, 'flag' => 'IsVisible', 'value' => 1 ]); } if($this->noteRecord['IsPublished']) { $this->noteCTree['favourite-toggle-action']=wq ( 'e2s_note_flag_favourite', [ '*note' => $this->noteRecord, 'value' => !$this->noteRecord['IsFavourite'] ] ); } } $this->noteCTree['href-comments']=$this->noteCTree['href'] .'#comments'; if(Log::$a)__log ('}'); AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($this->noteRecord['ID']); if(Log::$a)__log ('}'); } } class AePageableNotesView { private $candy; private $parameters; private $pageExists = false; private $isCached = false; private $hasRun = false; private $sql = null; private $sql_count = null; private $highlightedTags = null; private $cacheFilename = null; private $prevPageTitle = null; private $nextPageTitle = null; private $totalNotes = null; private $totalPages = null; private $notesCTree = null; private $pagesCTree = null; private $wantPaging = false; private $wantNewCommentsCount = false; private $wantReadHrefs = false; private $wantPreviewHrefs = false; private $wantControls = false; private $wantHiddenTags = false; private $wantRelatedNotes = false; private $useLocalHrefs = false; private $page = 1; private $limit = 10; public function __construct ($candy,$parameters){ $this->candy = $candy; $this->parameters = $parameters; if (empty ($parameters['page'])) { $this->page = 1; } else { $this->page = (int)$parameters['page']; } } public function setSQLCountRequest ($sql_count){ if(strpos ($sql_count,"SELECT COUNT(*) Total FROM ")!==0){ die ('AePageableNotesView: Count request must start with "SELECT COUNT(*) Total FROM "'); } $this->sql_count = $sql_count; } public function setLimitlessSQLRequest ($sql){ if(strstr ($sql,"LIMIT")) { die ('AePageableNotesView: Request must not contain "LIMIT"'); } $this->sql = $sql; if($this->sql_count === null){ if(strpos ($sql,"SELECT * ")===0){ $this->sql_count = "SELECT COUNT(*) Total ". substr ($sql,9); } else { die ('AePageableNotesView: setSQLCountRequest () must be used'); } } } public function setPortionSize ($limit){ $this->limit = abs ((int)$limit); } public function setNextPrevPageTitles ($nextPageTitle,$prevPageTitle){ $this->nextPageTitle = $nextPageTitle; $this->prevPageTitle = $prevPageTitle; } public function setHighlightedTags ($highlightedTags){ $this->highlightedTags = $highlightedTags; } public function setCacheFilename ($cacheFilename){ $this->isCached = true; $this->cacheFilename = $cacheFilename; } public function setWantPaging ($wantPaging){ $this->wantPaging = $wantPaging; } public function setWantNewCommentsCount ($wantNewCommentsCount){ $this->wantNewCommentsCount = $wantNewCommentsCount; } public function setWantReadHrefs ($wantReadHrefs){ $this->wantReadHrefs = $wantReadHrefs; } public function setWantPreviewHrefs ($wantPreviewHrefs){ $this->wantPreviewHrefs = $wantPreviewHrefs; } public function setWantControls ($wantControls){ $this->wantControls = $wantControls; } public function setWantHiddenTags ($wantHiddenTags){ $this->wantHiddenTags = $wantHiddenTags; } public function setWantRelatedNotes ($wantRelatedNotes){ $this->wantRelatedNotes = $wantRelatedNotes; } public function setUseLocalHrefs ($useLocalHrefs){ $this->useLocalHrefs = $useLocalHrefs; } public function isExistingPage () { if (!$this->hasRun)$this -> run (); return$this->pageExists; } public function isFirstPage () { return$this->page === 1; } public function isFirstPageOfEmptyView () { if (!$this->hasRun)$this -> run (); return$this->page === 1 and $this->totalPages === 0; } public function getTotalNotes () { if (!$this->hasRun)$this -> run (); return$this->totalNotes; } public function getTotalPages () { if (!$this->hasRun)$this -> run (); return$this->totalPages; } public function getNotesCTree () { if (!$this->hasRun)$this -> run (); return$this->notesCTree; } public function getPagesCTree () { if (!$this->hasRun)$this -> run (); return$this->pagesCTree; } private function prepareCacheableData () { $this->totalNotes = 0; if($this->limit){ $j3 = ($this->page - 1)*$this->limit; $this->sql .= ' LIMIT '. $j3 .', '. $this->limit; } em ($this->sql_count,'count total notes of "'. $this->candy .'" list'); $h3 = tm (); $this->totalNotes = $h3 ? (int)$h3[0]['Total']:0; em ($this->sql,'get limited full notes "'. $this->candy .'" list'); $g3 = tm (); $z3 = []; foreach ($g3 as $x3 => $s){ $z3[] = $s['ID']; } $this->notesCTree = []; foreach ($g3 as $x3 => $s){ $noteView = new AeNoteView ($s); $noteView -> setWantNewCommentsCount ($this->wantNewCommentsCount); $noteView -> setWantReadHref ($this->wantReadHrefs); $noteView -> setWantPreviewHref ($this->wantPreviewHrefs); $noteView -> setWantControls ($this->wantControls); $noteView -> setWantHiddenTags ($this->wantHiddenTags); $noteView -> setWantCommentsLink (true); $noteView -> setWantRelatedNotes ($this->wantRelatedNotes); $noteView -> setFilterOutRelatedNoteIDs ($z3); $noteView -> setHighlightedTags ($this->highlightedTags); $noteView -> setUseLocalHref ($this->useLocalHrefs); $this->notesCTree[] = $noteView -> getNoteCTree (); } $this->pagesCTree = []; if ( $this->limit and $this->totalPages = (int)ceil ($this->totalNotes / $this->limit) ) { $this->pagesCTree['timeline?']=true; $this->pagesCTree['count'] = (int)$this->totalPages; $this->pagesCTree['this'] = (int)$this->page; if($this->wantPaging){ $this->pagesCTree['earlier-title']=$this->nextPageTitle; $this->pagesCTree['later-title']=$this->prevPageTitle; $w3 = $this->parameters; if($this->page < $this->totalPages){ $w3['page']=$this->page + 1; $this->pagesCTree['earlier-href']=wq ($this->candy,$w3); } if($this->page > 1){ $w3['page']=$this->page - 1; $this->pagesCTree['later-href']=wq ($this->candy,$w3); } } } } private function run () { $this->hasRun = true; if($this->isCached and is_file ($this->cacheFilename)) { $u3 = @unserialize (file_get_contents ($this->cacheFilename)); $this->totalNotes = @$u3['notes_total']; $this->notesCTree = @$u3['notes_ctree']; $this->pagesCTree = @$u3['pages_ctree']; $this->totalPages = @$this->pagesCTree['count']; } if ( is_int ($this->totalNotes) and is_array ($this->notesCTree) and is_array ($this->pagesCTree) and is_int ($this->totalPages) ) { if(Log::$a)__log ('Retrieved cached CTree'); } else { $this -> prepareCacheableData (); if($this->isCached){ e3 ($this->cacheFilename,serialize ([ 'notes_total' => $this->totalNotes, 'notes_ctree' => $this->notesCTree, 'pages_ctree' => $this->pagesCTree, ])); } } foreach($this->notesCTree as $i3){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($i3['id']); if (empty ($i3['related']['each'])) continue; foreach ($i3['related']['each'] as $o3){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($o3['id']); } } $this->pageExists = ( $this->totalPages > 0 and $this->page >= 1 and $this->page <= $this->totalPages ); } } class AePasswordCheckManager { const PASSWORD_HASH_FILE = 'password-hash.psa'; const PASSWORD_WAIT_FILE = 'password-wait.psa'; const MAX_PENALTY_SECONDS = 5; const FAIL_WAIT_SECONDS = 5; public static function checkPassword ($password){ $p3 = self::howSoonCanAnswerPasswordQuestion (); if ($p3 > 0){ return [ 'password-status' => 'waiting', 'timeout' => $p3 * 1000 ]; } if(self::isCorrectPasswordImmediately ($password)) { return [ 'password-status' => 'correct', 'timeout' => 0, ]; } else { return [ 'password-status' => 'incorrect', 'timeout' => self::increaseAndGetPenaltySeconds () * 1000, ]; } } private static function howSoonCanAnswerPasswordQuestion () { $cy = USER_DIR. self::PASSWORD_WAIT_FILE; $vy = time (); if (!file_exists ($cy)) { $by = @fopen ($cy,'w'); if (!$by){ sleep (self::FAIL_WAIT_SECONDS); return 0; } if(flock ($by,LOCK_EX)) { fwrite ($by,serialize ([ 'penalty_seconds' => 0, 'last_attempt_time' => $vy, ])); flock ($by,LOCK_UN); } else { fclose ($by); sleep (self::FAIL_WAIT_SECONDS); return 0; } fclose ($by); return 0; } if (!is_writable ($cy)) { sleep (self::FAIL_WAIT_SECONDS); return 0; } $by = @fopen ($cy,'r'); if (!$by){ sleep (self::FAIL_WAIT_SECONDS); return 0; } if (!flock ($by,LOCK_SH)) { fclose ($by); sleep (self::FAIL_WAIT_SECONDS); return 0; } $yy = stream_get_contents ($by); flock ($by,LOCK_UN); fclose ($by); $kb = @unserialize ($yy); if (!is_array ($kb)) { $kb = []; } $kb = @unserialize ($yy); if ( !is_array ($kb) or !isset ($kb['penalty_seconds']) or !isset ($kb['last_attempt_time']) ) { sleep (self::FAIL_WAIT_SECONDS); return 0; } $ny = (int)$kb['last_attempt_time'] + (int)$kb['penalty_seconds']; $my = $ny - $vy; return max ($my,0); } private static function increaseAndGetPenaltySeconds () { $cy = USER_DIR. self::PASSWORD_WAIT_FILE; $vy = time (); $fy = 0; $by = @fopen ($cy,'c+'); if (!$by) return 0; if (!flock ($by,LOCK_EX)) { fclose ($by); return 0; } $yy = stream_get_contents ($by); $kb = @unserialize ($yy); if (!is_array ($kb))$kb = []; $dy = ( isset ($kb['last_attempt_time']) ? (int)$kb['last_attempt_time']:$vy ); $fy = isset ($kb['penalty_seconds']) ? (int)$kb['penalty_seconds']:0; $fy = min ($fy + 1,self::MAX_PENALTY_SECONDS); if (($vy - $dy)>SECONDS_IN_A_MINUTE){ $fy = 0; } fseek ($by,0); ftruncate ($by,0); fwrite ($by,serialize ([ 'penalty_seconds' => $fy, 'last_attempt_time' => $vy ])); flock ($by,LOCK_UN); fclose ($by); return $fy; } private static function isCorrectPasswordImmediately ($password){ $sy = @unserialize (file_get_contents (USER_DIR. self::PASSWORD_HASH_FILE)); return (sha1 ($password)===$sy and trim ($password)!==''); } public static function isPasswordSet () { $sy = @unserialize (file_get_contents (USER_DIR. 'password-hash.psa')); return is_string ($sy) and $sy !== ''; } } class AeRequest { public $method = 'GET'; public $url = ''; public $candy = ''; public $parameters = []; public function __construct ($vv,$ay){ $this->method = $vv['REQUEST_METHOD']; $qy = urldecode ((string) @$ay['go']); if(substr ($qy,0,strlen (AeEnv::$w)) === AeEnv::$w){ $qy = substr ($qy,strlen (AeEnv::$w)); } $this->url = ( AeEnv::$h .'://'. AeEnv::$j . AeEnv::$u . AeEnv::$w . '/'. $qy ); list ($this->candy,$this->parameters)=uq ($qy); } public function toBeFulfilledByService () { return substr ($this->candy,0,4)=='e2s_'; } public function requiresInstallation () { return !in_array ($this->candy, [ 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', ]); } public function requiresVersionMatch () { return$this->requiresInstallation(); } public function requiresScheduleCheckBeforeServing () { return$this->requiresInstallation(); } public function shouldSlowDownAJAXResponse () { return in_array ($this->candy, [ 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_userpic_remove', 'e2j_file_upload', 'e2j_file_rename', 'e2j_file_remove', 'e2j_note_livesave', 'e2s_note_flag_favourite', 'e2s_comment_flag_ajax', 'e2s_tag_flag_ajax', ]); } public function requiresSignIn () { return ( !empty ($this->candy) and is_callable ($this->candy) and $this->requiresInstallation () and !in_array ($this->candy, [ 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_read', 'e2m_tags', 'e2m_tag', 'e2m_untagged', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_popular', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_sitemap_xml', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_calendar', 'e2m_unsubscribe', 'e2m_theme_preview', 'e2m_error404', 'e2m_password_reset', 'e2s_password_reset_email', 'e2m_password', 'e2s_password_save', 'e2s_sign_in', 'e2m_sign_out', 'e2m_gip_sign_in', 'e2m_gip_sign_in_callback', 'e2m_gip_sign_out', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_retrieve', 'e2s_notify', 'e2s_dump', ]) ); } public function allowedInReadOnlyMode () { return !in_array ($this->candy, [ 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2s_note_flag_favourite', 'e2s_note_flag', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2s_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ]); } public function replaceWith ($ly){ $this->candy = $ly; } } function c () { global$_config; $zy = [ 'new-note-href' => wq ('e2m_write'), 'drafts-href' => wq ('e2m_drafts', ['page' => 1]), 'drafts-count' => (int)lf (false,true), 'settings-href' => wq ('e2m_settings'), 'theme-preview-href' => wq ('e2m_theme_preview', array ('theme' => '')), 'password-href' => wq ('e2m_password', array ('recovery-key' => '')), 'database-href' => wq ('e2m_database'), 'timezone-href' => wq ('e2m_timezone'), 'sessions-href' => wq ('e2m_sessions'), 'sign-out-href' => wq ('e2m_sign_out'), ]; if (ca ()) { $zy['get-backup-href']=wq ('e2m_get_backup'); } if (@$_config['read_only']) { unset ($zy['new-note-href']); unset ($zy['settings-href']); unset ($zy['timezone-href']); } if (!$_config['allow_themes_preview']) { unset ($zy['theme-preview-href']); } $databaseConfiguration = sl (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { unset ($zy['database-href']); } list ($t3,$ky)=lb ($databaseConfiguration); if ($t3){ $zy['new-comments-count']=$t3; $zy['new-comments-href']=$ky; } return $zy; } function v ($xy,AeDatabaseConfiguration $databaseConfiguration,$ey){ static $ry = null; $ty = ( $xy === USER_DIR and $databaseConfiguration == sl () ); if ($ey){ if ($xy !== false){ @unlink ($xy . CACHE_FILENAME_ALIASMAP); } if ($ty)$ry = null; return; } if ($ty and is_array ($ry)) { return $ry; } $jy = null; if(CACHE_ALIASMAP and is_file ($xy . CACHE_FILENAME_ALIASMAP)) { $jy = @unserialize (file_get_contents ($xy . CACHE_FILENAME_ALIASMAP)); } if(is_array ($jy)) { if ($ty)$ry = $jy; return $jy; } if(Log::$a)__log ('Build aliasmap {'); $jy = []; rm ( $databaseConfiguration, "SELECT `EntityType`, `EntityID`, `Alias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Stamp` IN (". "SELECT MAX(`Stamp`) `MaxStamp` ". "FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "GROUP BY `EntityType`, `EntityID`". ")", 'get all active aliases' ); foreach (tm () as $hy){ $gy = $hy['EntityType'].$hy['EntityID']; $jy[$gy]=$hy['Alias']; } rm ( $databaseConfiguration, "SELECT `ID`, `Stamp`, `Offset`, `IsDST`, `OriginalAlias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Notes` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `IsPublished` = 1 ". "ORDER BY `Stamp`", 'get all notes to cache y/d/m/n urls' ); $wy = 0; $uy = false; foreach (tm () as $iy){ $gy = 'n'. $iy['ID']; $oy = d1 ( 'Y/m/d',$iy['Stamp'],v1 ($iy) ); if ($oy !== $uy)$wy = 0; $wy ++; $py = $oy .'/'. $wy; if (empty ($jy[$gy])) { $jy[$gy]=$py; } else { if ((string)$iy['OriginalAlias']===''){ $jy[$gy . '-ymdn']=$py; } } $uy = $oy; } rm ( $databaseConfiguration, "SELECT `ID`, `OriginalAlias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset (), 'get original active aliases for tags' ); foreach (tm () as $ub){ $gy = 't'. $ub['ID']; if (empty ($jy[$gy])) { $jy[$gy]=$ub['OriginalAlias']; } } if(CACHE_ALIASMAP)e3 ($xy . CACHE_FILENAME_ALIASMAP,serialize ($jy)); if ($ty)$ry = $jy; if(Log::$a)__log ('}'); return $jy; } function b ($ey = false){ return v (USER_DIR,sl (), $ey); } function e2_alias_of_note_with_id_($cn){ $vn = b () ['n'. $cn]; if(preg_match ( '/^(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)$/s', $vn ))$vn = ''; return $vn; } function e2ali__alias_from_title_($source){ global$_config; $bn = $source; if(array_key_exists ('autoreplace_for_aliases',$_config)) { $bn = strtr ( $bn, $_config['autoreplace_for_aliases'] ); } $bn = i1 ($bn); $bn = str_replace ('\'','',$bn); $bn = str_replace ('’','',$bn); $bn = str_replace (chr (146),'',$bn); $yn = ''; for ($wb = 0; $wb < strlen ($bn); ++ $wb){ if ( (ord ($bn[$wb]) >= 48 and ord ($bn[$wb]) <= 57) or (ord ($bn[$wb]) >= 65 and ord ($bn[$wb]) <= 90) or (ord ($bn[$wb]) >= 97 and ord ($bn[$wb]) <= 122) or 0 ) { $yn .= $bn[$wb]; } else { $yn .= '-'; } } $yn = preg_replace ('/\-+/','-',$yn); $yn = trim ($yn,'-'); $yn = strtolower ($yn); if ($yn == '-')$yn = ''; $yn = substr ($yn,0,ALIAS_MAX_LENGTH); return $yn; } function m (AeDatabaseConfiguration $databaseConfiguration,$vn){ if ((string)$vn === '') return false; rm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Alias` = '". $vn ."' ". "ORDER BY `Stamp` LIMIT 1", 'get alias record for alias "'. $vn .'"' ); $g3 = tm (); if(count ($g3)==1){ return $g3[0]; } else { return false; } } function f ($vn){ if ((string)$vn === '') return false; if(Log::$a)__log ('Get entity type and id from alias "'. $vn .'"'); $nn = @array_flip (b ()); $gy = (string) @$nn[$vn]; if ( strlen ($gy)>0 and ($gy[0]=='n' or $gy[0]=='t') ) { $eb = [ 'type' => $gy[0], 'id' => (int)substr ($gy,1) ]; return $eb; } $hy = m (sl (), $vn); if (!$hy) return false; $eb = [ 'type' => $hy['EntityType'], 'id' => (int)$hy['EntityID'], ]; if(Log::$a)__log ('Got entity type "'. $eb['type'] .'" and id "'. $eb['id'] .'"'); return $eb; } function d ( $xy,AeDatabaseConfiguration $databaseConfiguration, $sn,$dn,$mn,$source,$fn_ = 1 ) { if(Log::$a)__log ('Aliases: "'. $sn .'" available alias for source "'. $source. '"'); $an = $dn . $mn; if ($sn === 'set' and $an === '') return false; $yn = e2ali__alias_from_title_($source); if($source !== '' and $yn === ''){ $yn = (string)$fn_; } elseif ($fn_ > 1){ $qn = '-'. $fn_; $yn = substr ($yn,0,ALIAS_MAX_LENGTH - strlen ($qn)) . $qn; } $jy = v ($xy,$databaseConfiguration,false); if ($hy = m ($databaseConfiguration,$yn)) { $ln = $hy['EntityType'].$hy['EntityID']; if ( $an === $ln or $yn !== $jy[$ln] ) { if ($sn == 'find') return $yn; if ($sn == 'set'){ if(Log::$a)__log ('Aliases: update alias timestamp'); km ($databaseConfiguration,'Aliases', [ 'ID' => $hy['ID'], 'EntityType' => $dn, 'EntityID' => $mn, 'Alias' => $yn, 'Stamp' => time (), ]); v ($xy,$databaseConfiguration,true); return $yn; } } else { return d ($xy,$databaseConfiguration,$sn,$dn,$mn,$source,$fn_ + 1); } } else { if ($an !== '' and $yn == ''){ if(preg_match ( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', $jy [$an] )) { if(Log::$a)__log ('Aliases: d/m/y/n was already used for this entity'); return ''; } } if(Log::$a)__log ('Aliases: it’s an empty alias, and it was not being used for this entity'); if ( $dn == 't' and $zn = xa ($databaseConfiguration,$yn) ) { if ($zn['ID']!=$mn){ return d ($xy,$databaseConfiguration,$sn,$dn,$mn,$source,$fn_ + 1); } } if ($sn == 'find') return $yn; if ($sn == 'set'){ zm ($databaseConfiguration,'Aliases', [ 'EntityType' => $dn, 'EntityID' => $mn, 'Alias' => $yn, 'Stamp' => time (), ]); v ($xy,$databaseConfiguration,true); return $yn; } } return ''; } function e2_delete_aliases_for_entity_($type,$cn){ global$_config; em ( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = '". $type ."' ". "AND `EntityID`=". ((int)$cn), 'delete aliases of note' ); } function a () { static $kn; $xn = es (); if (empty ($kn)) { $kn = md5 (AeEnv::$cv .'email'. $xn); } return $kn; } function q () { static $en; $xn = es (); if (empty ($en)) { $en = md5 (AeEnv::$cv .'nospam'. $xn . date ('n-Y')); } return $en; } function l () { static $rn; $xn = es (); if(empty($rn)) { $rn = md5 (AeEnv::$cv .'nospam'. $xn . date ('n-Y',strtotime('-1 month'))); } return $rn; } function z ($note_id){ $xn = es (); return j1 ('comment_'. md5 (AeEnv::$cv .'nospam_cookie'. $xn . $note_id)); } function k () { $tn = $_SERVER['HTTP_USER_AGENT']; $xn = es (); return md5 (AeEnv::$cv .'nospam_cookie'. $xn . $tn); } function x () { if ( array_key_exists ('email',$_POST) and $_POST['email']!=='' ) return true; $en = q (); $rn = l (); if ( !array_key_exists ($en,$_POST) and !array_key_exists ($rn,$_POST) ) return true; if ( ( array_key_exists ($en,$_POST) and $_POST[$en]!=='' ) or ( array_key_exists ($rn,$_POST) and $_POST[$rn]!=='' ) ) return true; if ( !array_key_exists ('comment',$_POST) or (strlen ($_POST['comment']) > 6) ) return true; return false; } function e2_cookie_data_is_spam_suspicios_for_note_id_($note_id){ if ( !array_key_exists (z ($note_id),$_COOKIE) or ($_COOKIE[z ($note_id)] !== k ()) ) return true; return false; } function e2m_year ($parameters = []) { global$_strings,$_config; $jn = $parameters['year']; $hn = e2l_get_string ('pt--nth-year', ['year' => $jn]); if (!j ($jn)) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; $gn = gmmktime (0,0,0,1,1,$jn - 1); $wn = gmmktime (0,0,0,1,1,$jn + 1); list ($un,$in)=e2__fruitful_neighbours_with_ymd_($jn); $on = 'e2m_year'; if ($un){ $pn['prev-href']=wq ( $on,e2__parameters_with_timestamp_($un) ); $pn['prev-jump?'] = (bool) (gmdate ('Y',$gn)!=gmdate ('Y',$un)); $pn['prev-title']=gmdate ('Y',$un); } if ($in){ $pn['next-href']=wq ( $on,e2__parameters_with_timestamp_($in) ); $pn['next-jump?'] = (bool) (gmdate ('Y',$wn)!=gmdate ('Y',$in)); $pn['next-title']=gmdate ('Y',$in); } $pn['timeline?']=false; $pn['this']=$jn; $pn['this-title']=$jn; list ($cm,$vm)=z1 ($jn); $bb = [ 'title' => $hn, 'heading' => $hn, 'pages' => $pn, 'year' => (int)$jn, 'calendar' => t ($jn,false,false), ]; em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". xf (ss ()). "AND `Stamp` BETWEEN ". $cm ." ". "AND ". $vm ." ". "ORDER BY `Stamp`", 'get all notes for the year' ); $g3 = tm (); $bm = w (true,$g3,$jn); if(count ($bm)) { $bb['notes-list']=$bm; } else { $bb['nothing']=$_strings['gs--no-such-notes']; } return $bb; } function e2m_month ($parameters = []) { global$_strings,$_config; $jn = $parameters['year']; $ym = $parameters['month']; $hn = e2l_get_string ( 'pt--nth-month-of-nth-year', ['year' => $jn,'month' => $ym] ); if (!j ($jn,$ym)) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; $gn = gmmktime (0,0,0,$ym - 1,1, (int)$jn); $wn = gmmktime (0,0,0,$ym + 1,1, (int)$jn); list ($un,$in)=e2__fruitful_neighbours_with_ymd_($jn,$ym); $on = 'e2m_month'; if ($un){ $pn['prev-href']=wq ( $on,e2__parameters_with_timestamp_($un) ); $pn['prev-jump?'] = (bool) (gmdate ('Y/m',$gn)!=gmdate ('Y/m',$un)); $pn['prev-title']=e2l_get_string ( 'gs--nth-month-of-nth-year', [ 'year' => gmdate ('Y',$un),'month' => gmdate ('n',$un) ] ); } if ($in){ $pn['next-href']=wq ( $on,e2__parameters_with_timestamp_($in) ); $pn['next-jump?'] = (bool) (gmdate ('Y/m',$wn)!=gmdate ('Y/m',$in)); $pn['next-title']=e2l_get_string ( 'gs--nth-month-of-nth-year', [ 'year' => gmdate ('Y',$in),'month' => gmdate ('n',$in) ] ); } $pn['timeline?']=false; $pn['this-title']=$hn; list ($cm,$vm)=z1 ($jn,$ym); $bb = [ 'title' => $hn, 'heading' => $hn, 'calendar' => t ($jn,$ym,false), 'pages' => $pn, 'year' => (int)$jn, 'month' => (int)$ym, ]; em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". xf (ss ()). "AND `Stamp` BETWEEN ". $cm ." ". "AND ". $vm ." ". "ORDER BY `Stamp`", 'get all notes for the month' ); $g3 = tm (); $bm = w (true,$g3,$jn,$ym); if(count ($bm)) { $bb['notes-list']=$bm; } else { $bb['nothing']=$_strings['gs--no-such-notes']; } return $bb; } function e2m_day ($parameters = []) { global$_strings,$_config,$_current_url; $jn = (int)$parameters['year']; $ym = (int)$parameters['month']; $nm = (int)$parameters['day']; if (!(j ($jn,$ym,$nm))) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; if($_current_url === p ()) { AeMainMenuManager :: $isCalendarCurrent = true; AeMainMenuManager :: $isCalendarParent = false; } $hn = e2l_get_string ( 'pt--nth-day-of-nth-month-of-nth-year', ['year' => $jn,'month' => $ym,'day' => $nm] ); $gn = gmmktime (0,0,0, (int)$ym,$nm - 1, (int)$jn); $wn = gmmktime (0,0,0, (int)$ym,$nm + 1, (int)$jn); list ($un,$in)=e2__fruitful_neighbours_with_ymd_($jn,$ym,$nm); $on = 'e2m_day'; if ($un){ $pn['prev-href']=wq ( $on,e2__parameters_with_timestamp_($un) ); $pn['prev-jump?'] = (bool) (gmdate ('Y/m/d',$gn)!=gmdate ('Y/m/d',$un)); $pn['prev-title']=e2l_get_string ( 'gs--nth-day-of-nth-month-of-nth-year', [ 'year' => gmdate ('Y',$un),'month' => gmdate ('n',$un),'day' => gmdate ('j',$un), ] ); } if ($in){ $pn['next-href']=wq ( $on,e2__parameters_with_timestamp_($in) ); $pn['next-jump?'] = (bool) (gmdate ('Y/m/d',$wn)!=gmdate ('Y/m/d',$in)); $pn['next-title']=e2l_get_string ( 'gs--nth-day-of-nth-month-of-nth-year', [ 'year' => gmdate ('Y',$in),'month' => gmdate ('n',$in),'day' => gmdate ('j',$in), ] ); } $pn['timeline?']=false; $pn['this-title']=$hn; $bb = [ 'title' => $hn, 'heading' => $hn, 'pages' => $pn, 'calendar' => t ($jn,$ym,$nm), ]; $g3 = mf ($jn,$ym,$nm); $g3 = array_reverse ($g3); $mm = ss (); $bm = []; foreach ($g3 as $x3 => $iy){ if (!( kf ($iy)==='public' or ($mm and $iy['IsPublished']) )) continue; $noteView = new AeNoteView ($iy); $noteView -> setWantNewCommentsCount ($mm); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($mm and !@$_config['read_only']); $noteView -> setWantHiddenTags ($mm); $noteView -> setWantCommentsLink (true); $bm[] = $noteView -> getNoteCTree (); } if(count ($bm)) { $bb['notes']=$bm; } else { $bb['nothing']=$_strings['gs--no-such-notes']; } return $bb; } function e2m_calendar () { r1 (p ()); } function r ($fm){ global$_config; $bm = null; if(CACHE_FULLLIST and is_file (USER_DIR . CACHE_FILENAME_FULLLIST)) { $bm = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_FULLLIST)); if(Log::$a)__log ('Retrieving full notes list from cache...'); } if (!is_array ($bm)) { if(Log::$a)__log ('Retrieving full notes list from database...'); em ( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". xf (). "ORDER BY `Stamp`", 'get full notes list' ); $g3 = tm (); $bm = w ($fm,$g3); if ($fm){ if(CACHE_FULLLIST)e3 (USER_DIR . CACHE_FILENAME_FULLLIST,serialize ($bm)); } } return $bm; } function e2m_everything ($parameters = []) { global$_strings; $bm = r (true); $dm = count ($bm); $hn = e2l_get_string ('pt--n-posts', ['number' => $dm]); $bb = [ 'title' => $hn, 'heading' => $hn, ]; if(count ($bm)) { $bb['notes-list']=$bm; } else { $bb['nothing']=$_strings['gs--no-notes']; } return $bb; } function e2m_sitemap_xml ($parameters = []) { global$_config; $bm = r (false); if (@$_config['dev_xml_as_text']) { header ('Content-Type: text/plain'); } else { header ('Content-type: application/xml; charset=utf-8'); } echo '<?xml version="1.0" encoding="UTF-8"?>'."\r\n"; echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\r\n"; if(count ($bm)) { $sm = @$bm[0]['last-modified']; echo '<url>'."\r\n"; echo '<loc>'. wq ('e2m_frontpage', ['page' => 1]) .'</loc>'."\r\n"; echo '<lastmod>'; echo gmdate ('Y-m-d\TH:i:s\Z',$sm[0]); echo '</lastmod>'."\r\n"; echo '<changefreq>hourly</changefreq>'; echo '</url>'."\r\n"; foreach ($bm as $r){ echo '<url>'."\r\n"; echo '<loc>'; echo $r['href']; echo '</loc>'."\r\n"; echo '<lastmod>'; echo gmdate ('Y-m-d\TH:i:s\Z',$r['last-modified'][0]); echo '</lastmod>'."\r\n"; echo '</url>'."\r\n"; } } echo '</urlset>'."\r\n"; die; } function t ($jn,$ym,$nm){ if(is_numeric ($ym)) { $am = d1 ( 't',gmmktime (0,0,0, (int)$ym,1, (int)$jn), b1 () ); } else { $am = 0; } $qm = cv ('start'); $lm = d1 ( 'Y',$qm['stamp'],$qm['timezone'] ); $zm = s1 ('Y',time ()); $km = s1 ('m',time ()); if ((int)$jn == (int)$lm){ $xm = d1 ('m',$qm['stamp'],$qm['timezone']); } else { $xm = 1; } if ((int)$jn == (int)$zm){ $km = s1 ('m',time ()); } else { $km = 12; } if ((int)$jn == (int)$lm and (int)$ym == (int)$xm){ $em = d1 ('d',$qm['stamp'],$qm['timezone']); } else { $em = 1; } if ((int)$jn == (int)$zm and (int)$ym == (int)$km){ $rm = s1 ('d',time ()); } else { $rm = $am; } if(1){ $tm = u (); for ($wb = $lm; $wb <= $zm; ++ $wb){ $jm = gmmktime (0,0,0,1,1, (int)$wb); $hm[$wb] = [ 'number' => $wb, 'start-time' => [$jm,b1 ()], 'href' => wq ('e2m_year', [ 'year' => gmdate ('Y',$jm), ]), 'this?' => (bool) ($wb == $jn), 'real?' => true, 'fruitful?' => @in_array (gmdate ('Y',$jm),$tm), ]; } $gm['years']=$hm; } if(1){ $wm = i ($jn); for ($wb = 1; $wb <= 12; ++ $wb){ $jm = gmmktime (0,0,0, (int)$wb,1, (int)$jn); $um[$wb] = [ 'number' => $wb, 'start-time' => [$jm,b1 ()], 'href' => wq ('e2m_month', [ 'year' => gmdate ('Y',$jm), 'month' => gmdate ('m',$jm), ]), 'this?' => (bool) ($wb == $ym), 'real?' => $wb >= $xm and $wb <= $km, 'fruitful?' => @in_array (gmdate ('n',$jm),$wm), ]; } $gm['months']=$um; } if ($am){ $im = o ($jn,$ym); for ($wb = 1; $wb <= $am; ++ $wb){ $jm = gmmktime (0,0,0, (int)$ym, (int)$wb, (int)$jn); $om[$wb] = [ 'number' => $wb, 'start-time' => [$jm,b1 ()], 'href' => wq ('e2m_day', [ 'year' => gmdate ('Y',$jm), 'month' => gmdate ('m',$jm), 'day' => gmdate ('d',$jm), ]), 'this?' => (bool) ($wb == $nm), 'real?' => $wb >= $em and $wb <= $rm, 'fruitful?' => @in_array (gmdate ('d',$jm),$im), ]; } $gm['days']=$om; } return $gm; } function j ($jn,$ym = false,$nm = false){ $qm = cv ('start'); if ($qm === false){ return false; } $pm = d1 ('Y',$qm['stamp'],$qm['timezone']); $cf = s1 ('Y',time ()); if ($ym === false){ return (bool) ( $jn >= $pm and $jn <= $cf ); } else { $vf = d1 ('n',$qm['stamp'],$qm['timezone']); $bf = s1 ('n',time ()); if ($nm === false){ return (bool) ( $ym >= 1 and $ym <= 12 and ( ($jn > $pm and $jn < $cf) or ($jn == $pm and $ym >= $vf) or ($jn == $cf and $ym <= $bf) ) ); } else { $yf = d1 ('j',$qm['stamp'],$qm['timezone']); $nf = s1 ('j',time ()); if(1){ return (bool) ( checkdate ($ym,$nm,$jn) and ( ($jn > $pm and $jn < $cf) or ($jn == $pm and $ym > $vf) or ($jn == $pm and $ym == $vf and $nm >= $yf) or ($jn == $cf and $ym < $bf) or ($jn == $cf and $ym == $bf and $nm <= $nf) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($mf,$ff = false,$df = false){ global$_db,$_config; list ($sf,$af)=z1 ($mf,$ff,$df); $qf = SECONDS_IN_A_DAY; if ($df === false)$qf = SECONDS_IN_A_MONTH; if ($ff === false)$qf = SECONDS_IN_A_YEAR; $lf = $zf = null; em ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` < '". ($af - $qf) ."' ". "AND `Stamp` <= '". time () ."' ". xf (ss ()). "ORDER BY Stamp DESC", 'get previous fruitful neighbour with ymd' ); while ($kf = mysqli_fetch_array ($_db['result'],MYSQLI_ASSOC)) { list ($jn,$ym,$nm)=explode ('/', d1 ('Y/n/j',$kf['Stamp'],v1 ($kf)) ); $xf = $mf * 10000 + ($ff? ($ff * 100):0) + ($df? $df : 0); $ef = $jn * 10000 + ($ff? ($ym * 100):0) + ($df? $nm : 0); if ($ef < $xf){ $lf = gmmktime (0,0,0, (int)$ym, (int)$nm, (int)$jn); break; } } em ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` > '". ($sf + $qf) ."' ". "AND `Stamp` <= '". time () ."' ". xf (ss ()). "ORDER BY Stamp", 'get next fruitful neighbour with ymd' ); while ($kf = mysqli_fetch_array ($_db['result'],MYSQLI_ASSOC)) { list ($jn,$ym,$nm)=explode ('/', d1 ('Y/n/j',$kf['Stamp'],v1 ($kf)) ); $xf = $mf * 10000 + ($ff? ($ff * 100):0) + ($df? $df : 0); $ef = $jn * 10000 + ($ff? ($ym * 100):0) + ($df? $nm : 0); if ($ef > $xf){ $zf = gmmktime (0,0,0, (int)$ym, (int)$nm, (int)$jn); break; } } return [$lf,$zf]; } function e2__parameters_with_timestamp_($rf){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode ('/',gmdate ('Y/m/d',$rf)); return$parameters; } function w ($fm,$tf,$jn = false,$ym = false){ $bm = []; $jf = []; foreach ($tf as $x3 => $iy){ $r['href'] = wq ('e2m_note', ['*note' => $iy]); $r['time'] = [(int)$iy['Stamp'],v1 ($iy)]; $r['last-modified'] = [(int)min ($iy['LastModified'],time ()), v1 ($iy)]; $r['favourite?'] = (bool) ($iy['IsFavourite'] && $iy['IsPublished']); $hf = kf ($iy); $r['draft?'] = $hf === 'draft'; $r['scheduled?'] = $hf === 'scheduled'; $r['public?'] = $hf === 'public'; $r['hidden?'] = $hf === 'hidden'; if(array_key_exists ('SourceNoteURL',$iy) and @$iy['SourceNoteURL']!=''){ $r['href']=$iy['SourceNoteURL']; $r['href-original']=$iy['SourceNoteURL']; } if ( ($jn and $ym and ( ((int)$jn) .'/'. ((int)$ym) == d1 ('Y/n',$iy['Stamp'],v1 ($iy)) )) or ($jn and !$ym and ( (int)$jn == d1 ('Y',$iy['Stamp'],v1 ($iy)) )) or (!$jn and !$ym) ) { $bm[] = $r; $jf[] = str_replace ("\n",' ',$iy['Title']); } } if(Log::$a)__log ('Will do typography'); if ($fm){ $gf = implode ("\n",$jf); $gf = ry (htmlspecialchars ($gf,ENT_NOQUOTES,'UTF-8')); $jf = explode ("\n",$gf); } foreach ($bm as $x3 => $e3){ $bm[$x3]['title']=$jf[$x3]; } $bm = array_reverse ($bm); return $bm; } function u () { global$_config; em ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` <= '". time () ."' ". xf (ss ()), 'get all notes list years with notes' ); $g3 = tm (); $wf = []; foreach ($g3 as $uf){ $if_ = (int)d1 ('Y',$uf['Stamp'],v1 ($uf)); $wf[$if_]=true; } $wf = array_keys ($wf); sort ($wf); return $wf; } function i ($mf){ global$_config; list ($of,$pf)=z1 ($mf); em ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $of. "' AND '". $pf ."' ". "AND `Stamp` <= '". time () ."' ". xf (ss ()), 'get all notes for the year '. $mf .' to list months with notes' ); $g3 = tm (); $c2 = []; foreach ($g3 as $uf){ if ( ((int)$mf) == d1 ('Y',$uf['Stamp'],v1 ($uf)) ) { $v2 = (int)d1 ('n',$uf['Stamp'],v1 ($uf)); $c2[$v2]=true; } } $c2 = array_keys ($c2); sort ($c2); return $c2; } function o ($mf,$ff){ global$_config; list ($b2,$y2)=z1 ($mf,$ff); em ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $b2 ."' AND '". $y2 ."' ". "AND `Stamp` <= '". time () ."' ". xf (ss ()), 'get all notes for the month '.$ff.' of the year '. $mf .' to list days with notes' ); $g3 = tm (); $n2 = []; foreach ($g3 as $uf){ if ( ((int)$mf) .'/'. ((int)$ff) == d1 ('Y/n',$uf['Stamp'],v1 ($uf)) ) { $m2 = (int)d1 ('j',$uf['Stamp'],v1 ($uf)); $n2[$m2]=true; } } $n2 = array_keys ($n2); sort ($n2); return $n2; } function p () { $f2 = cv ('end'); return wq ('e2m_day', [ 'year' => d1 ( 'Y',$f2['stamp'],$f2['timezone'] ), 'month' => d1 ( 'm',$f2['stamp'],$f2['timezone'] ), 'day' => d1 ( 'd',$f2['stamp'],$f2['timezone'] ), ]); } function cv ($d2){ global$_config; $s2 = 'p1'; $mm = ss (); if (!$mm){ $s2 = 'p1v1'; } $a2 = USER_DIR . CACHES_DIRNAME . $d2 .'-stamp-'. $s2 .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file ($a2)) { $bb = @unserialize (file_get_contents ($a2)); } if(is_array (@$bb)) { return $bb; } else { $bb = [ 'stamp' => time (), 'timezone' => y1 (), ]; $q2 = (($d2 == 'end')? ' DESC' : ''); em ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` <= '". time () ."' ". xf ($mm). "ORDER BY `Stamp`". $q2 ." LIMIT 1", 'get '. $d2 .' timestamp' ); $g3 = tm (); if(count ($g3)) { $bb = [ 'stamp' => $g3[0]['Stamp'], 'timezone' => v1 ($g3[0]), ]; if(CACHE_EDGE_TIMEINFO)e3 ($a2,serialize ($bb)); return $bb; } return $bb; } } function vv ($url,$l2 = false){ if($_SERVER['HTTP_USER_AGENT']===E2_UA_STRING){ if(Log::$a)__log ('Spawn not allowed when requested by Aegea itself'); return false; } if(Log::$a)__log ('Spawn: Curl '. $url .' using '. ($l2? 'post' : 'get') .'...'); if(function_exists ('curl_init')) { $z2 = curl_init (); $k2 = !ini_get ('open_basedir'); $k2 = ($k2 and !$l2); curl_setopt_array ($z2, array ( CURLOPT_URL => $url, CURLOPT_POST => $l2, CURLOPT_POSTREDIR => false, CURLOPT_POSTFIELDS => '', CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ls (), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $k2, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content = curl_exec ($z2); $x2 = curl_errno ($z2); $e2_ = curl_error ($z2); $r2 = curl_getinfo ($z2); curl_close ($z2); if(Log::$a)__log ('Spawn: Curl returns: ['. print_r ($r2,true) .'] ['. $content .'], (errno='. $x2 .', errstr='. $e2_ .')...'); return $r2; } else { if(Log::$a)__log ('Spawn: Curl functions are not available'); } } function e2_check_timeout(){ static $t2; if(is_null($t2)) { $j2 = ini_get('max_execution_time'); if ($j2){ $t2 = time()+$j2 - 5; } else { $t2 = 0; } } return ($t2 == 0)?true : $t2 >= time(); } function e2_write_dump_header($cy){ $r2 = ( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. "/*!50503 SET NAMES utf8mb4 */;" .PHP_EOL. '' ); fwrite($cy,$r2); return true; } function e2_write_dump_footer($cy){ $h2 = 'COMMIT;' .PHP_EOL; $h2 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" . PHP_EOL . "/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" . PHP_EOL . "/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" . PHP_EOL . "/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;" . PHP_EOL . "/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" . PHP_EOL . "/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" . PHP_EOL; fwrite($cy,$h2); return true; } function e2_get_table_definition($g2,$w2){ $u2 = null; $g3 = mysqli_query($g2,"SHOW CREATE TABLE `{$w2}`"); if ($g3){ $i2 = mysqli_fetch_array($g3); $u2 = $i2['Create Table']; } return $u2; } function e2_write_table_definition($cy,$g2,$w2){ $o2 = e2_get_table_definition($g2,$w2); if(e2_check_timeout() && $o2){ fwrite($cy,$o2); fwrite($cy,';'); fwrite($cy,PHP_EOL . PHP_EOL); return true; } return false; } function e2_get_table_data($g2,$w2,$j3,$limit){ $p2 = "SELECT * FROM `{$w2}` LIMIT {$j3}, {$limit}"; $g3 = mysqli_query($g2,$p2); if (!$g3){ return false; } $cd = ''; $vd = "INSERT INTO `{$w2}` VALUES"; while ($bd = mysqli_fetch_row($g3)) { $yd = array(); foreach($bd as $bv){ $yd[] = is_null($bv)?"NULL" : "'" . mysqli_real_escape_string($g2,$bv)."'"; } $cd .= $vd . '(' . join(', ',$yd).');' . PHP_EOL; } return $cd; } function e2_table_disable_keys($w2){ return "ALTER TABLE `{$w2}` DISABLE KEYS;" . PHP_EOL; } function e2_table_enable_keys($w2){ return "ALTER TABLE `{$w2}` ENABLE KEYS;" . PHP_EOL; } function e2_get_total_records($g2,$w2){ $x3 = mysqli_fetch_row(mysqli_query($g2,"SELECT COUNT(*) FROM `{$w2}`")); return $x3[0]; } function e2_backup_select_chuck_size_for_table_($w2){ $limit = 5000; if(substr ($w2, -7)==='Actions')$limit = 50000; if(substr ($w2, -7)==='Aliases')$limit = 20000; if(substr ($w2, -7)==='NotesKeywords')$limit = 50000; if(Log::$a)__log ('Backup: chunk size '. (int)$limit); return$limit; } function e2_write_table_data($cy,$g2,$w2,$subset){ $nd = e2_get_total_records($g2,$w2); $j3 = 0; $limit = e2_backup_select_chuck_size_for_table_($w2); $g3 = true; $md = 20000; $fd = 30; if ($nd){ $dd = e2_table_disable_keys($w2); fwrite($cy,$dd); } $cd = "INSERT INTO `{$w2}` VALUES"; $sd = $nd; while ($sd > 0){ $p2 = "SELECT * FROM `{$w2}` "; if ((int)$subset > 0){ $p2 .= "WHERE `SubsetID` = {$subset} "; } $p2 .= "ORDER BY `ID` LIMIT {$j3}, {$limit}"; $g3 = mysqli_query($g2,$p2); $ad = mysqli_num_rows($g3); if (!$g3 || !e2_check_timeout()) { $g3 = false; break; } $qd = array(); $ld = 0; $zd = 0; while ($bd = mysqli_fetch_row($g3)) { if (!e2_check_timeout()) { $g3 = false; break; } $ad--; $db = array(); foreach($bd as $bv){ $db[] = is_null($bv)?"NULL" : "'" . mysqli_real_escape_string($g2,$bv)."'"; } $kb = '(' . join(', ',$db).')'; $ld += strlen($kb); $qd[] = $kb; $zd++; if ( ($ld >= $md) || ($zd >= $fd) || ($ad == 0)) { $p2 = $cd . join(', ',$qd).';'; fwrite($cy,$p2); fwrite($cy,PHP_EOL); $ld = 0; $zd = 0; $qd = array(); } } $j3 += $limit; $sd -= $limit; } if ($nd){ $kd = e2_table_enable_keys($w2); fwrite($cy,$kd); } return $g3; } function e2_backup($g2,$xd,$subset,$ed){ $rd = tmpfile(); e2_write_dump_header($rd); if(Log::$a)__log ('Backup: wrote header'); $td = true; foreach($xd as $w2){ if ((int)$subset > 0){ if(Log::$a)__log ('Backup: table '. $w2 .', subset '. $subset); } else { if(Log::$a)__log ('Backup: table '. $w2 .', all subsets'); } $jd = e2_write_table_definition($rd,$g2,$w2); if(Log::$a)__log ('Backup: wrote table definition with result '. @(int)$jd); $hd = e2_write_table_data($rd,$g2,$w2,$subset); if(Log::$a)__log ('Backup: wrote table data with result '. @(int)$hd); $td = $jd && $hd; if ($td === false){ break; } } if(Log::$a)__log ('Backup: wrote data with running == '. (int)$td); if ($td){ e2_write_dump_footer($rd); fseek($rd,0); $cy = fopen($ed,'w+'); while ($td && ($kb = fread($rd,1024))) { if(e2_check_timeout()) { fwrite($cy,$kb); } else { $td = false; } } fclose($cy); } fclose($rd); return $td; } function xv () { global$settings,$_lang,$_config,$_strings; if(Log::$a)__log ('Blog information'); $gd['author']=htmlspecialchars (rv (), ENT_NOQUOTES,'UTF-8'); if(array_key_exists ('blog_subtitle',$settings)) { $wd = hy ($settings['blog_subtitle'],'simple'); $ud = $wd['text-final']; $gd['subtitle']=$ud; $gd['subtitle-format-info']=$wd['meta']; z2 (@$wd['meta']['links-required']); } $gd['title']=htmlspecialchars (ev (), ENT_NOQUOTES,'UTF-8'); $gd['userpic-set?']=false; $gd['userpic-changeable?']=ss (); if ($gd['userpic-href']=tv ()) { $gd['userpic-set?']=true; $gd['userpic-large-href']=tv ('large'); $gd['userpic-square-href']=tv ('square'); $gd['userpic-changeable-href']=$gd['userpic-href']; } else { unset ($gd['userpic-href']); } if (ss ()) { $gd['userpic-upload-action']=wq ('e2j_userpic_upload'); $gd['userpic-remove-action']=wq ('e2j_userpic_remove'); } $gd['href']=wq ('e2m_frontpage', array ('page' => 1)); $gd['rss-href']=wq ('e2m_rss'); $gd['jsonfeed-href']=wq ('e2m_json'); $gd['language']=$_lang; $gd['show-follow-button?']=false; $gd['license-expired?']=false; $vy = array (time (), y1 ()); $od = s1 ('Y',$vy[0]); $gd['now']=$vy; $pd = $od; $cs = cv ('start'); if(array_key_exists ('stamp',$cs)) { $pd = s1 ('Y',$cs['stamp']); $gd['start-time'] = array ((int)$cs['stamp'],$cs['timezone']); } $vs = false; $bs = lf (true,true); if ($bs !== null){ if (ss ()) { $ys = lf (true,false); if ($ys !== null){ $vs = ($bs + $ys == 0); } } else { $vs = ($bs == 0); } } $gd['notes-count'] = (int)$bs; if ($gd['notes-count']>0){ $gd['selected-href']=wq ('e2m_favourites', ['page' => 1]); $gd['most-commented-href']=wq ('e2m_most_commented', ['page' => 1]); $gd['popular-href']=wq ('e2m_popular', ['page' => 1]); $gd['calendar-href']=p (); $gd['random-note-href']=ef (); } $gd['virgin?']=$vs; $ns = $_config['years_range_separator']? $_config['years_range_separator']:$_strings['gs--range-separator']; $gd['years-range']=$pd . (($pd == $od)? '':($ns . $od)); if(AeEnv::$u){ $gd['parent-site-href']=substr (AeEnv::$u, (int)strpos ('/',AeEnv::$u)); } return $gd; } function ev () { global$settings,$_strings; if ( array_key_exists ('blog_title',$settings) and trim ($settings['blog_title']) != '' ) { return trim ($settings['blog_title']); } else { return$_strings['e2--default-blog-title']; } } function rv () { global$settings,$_strings; if ( array_key_exists ('author',$settings) and trim ($settings['author']) != '' ) { return trim ($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function tv ($size = ''){ global$_config; $ms = false; $fs = $_config['path_media'].USERPIC_DIRNAME; if(is_file ($fs .'userpic@2x.jpg')) { $ms = 'userpic@2x.jpg'; } elseif(is_file ($fs .'userpic@2x.png')) { $ms = 'userpic@2x.png'; } if($size == 'large' and is_file ($fs .'userpic-large@2x.jpg')) { $ms = 'userpic-large@2x.jpg'; } elseif($size == 'square' and is_file ($fs .'userpic-square@2x.jpg')) { $ms = 'userpic-square@2x.jpg'; } if ($ms === false) return false; $ds = $fs . $ms; $ss = AeEnv::$p . USERPIC_DIRNAME . $ms; $as_ = stat ($ds); if ($as_['mtime'])$ss .= '?'. $as_['mtime']; return $ss; } function jv () { global$_config,$_stopwatch,$qs; $ls = round (kq () - $_stopwatch,3); return [ 'show?' => ($_config['display_stat'] > (int) !ss ()), 'generation-time' => str_replace ('.',',',$ls), 'peak-memory-mb' => str_replace ('.',',',round ((memory_get_peak_usage () / 1024 / 1024)*100)/100), 'db-query-count' => (int) @$qs, ]; } function e2m_info () { global$settings,$_template; if (!isset ($_template))gf (); $zs = array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, 'E2_EDITION' => defined ('E2_EDITION')? E2_EDITION : '0', '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (qn () !== null), 'server_name' => AeEnv::$server, 'folder_on_server' => AeEnv::$u, '---', 'default formatter' => DEFAULT_FORMATTER, '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr (md5 (file_get_contents ('system/library/neasden/Interpreter.php')), 0,4), '---', ); echo '<pre>'; foreach ($zs as $x3 => $e3){ if ($e3 == '---'){ echo "\n"; continue; } echo str_pad ($x3,24); echo '\''; print_r ($e3); echo '\''; echo "\n"; } echo '</pre>'; die; } function hv ($s){ global$_config; if (@$_config['broadcast_url'] and !$s['IsExternal']) { if($_config['log_broadcast']) { Log::$a = true; if(Log::$a)tn ('broadcast'); } if(Log::$a)__log ('Broadcast-async note: '. $s['Title']); $url = wq ('e2m_note_broadcast', array ('*note' => $s)); if(Log::$a)__log ('Broadcast will spawn url: '. $url); vv ($url); } } function gv ($ks){ global$_config; if (!$ks) return false; $url = $_config['broadcast_url']; $url .= '?src='. urlencode ($ks); if($_config['log_broadcast']) { Log::$a = true; if(Log::$a)tn ('broadcast'); } if(Log::$a)__log ('Broadcast: Curl '. $url .'...'); if(function_exists ('curl_init')) { $z2 = curl_init (); $k2 = !ini_get ('open_basedir'); curl_setopt_array ($z2, array ( CURLOPT_URL => $url, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ls (), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $k2, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content = curl_exec ($z2); $x2 = curl_errno ($z2); $e2_ = curl_error ($z2); $r2 = curl_getinfo ($z2); curl_close ($z2); if(Log::$a)__log ('Broadcast: Curl returns: ['. print_r ($r2,true) .'] ['. $content .'], (errno='. $x2 .', errstr='. $e2_ .')...'); if ($x2 === 0) return true; } else { if(Log::$a)__log ('Spawn: Curl functions are not available'); } return false; } function wv ($s){ if (!$s) return false; $ks = wq ('e2m_note_json', array ('*note' => $s)); return gv ($ks); } function e2m_note_broadcast ($parameters = array ()) { global$_config; if (@$_config['broadcast_url']) { if(array_key_exists ('*note',$parameters)) { $ks = wq ('e2m_note_json', array ('*note' => $parameters['*note'])); } elseif(array_key_exists ('alias',$parameters)) { $ks = wq ('e2m_note_json', array ('alias' => $parameters['alias'])); } if (gv ($ks)) { die ('Broadcasted.'); } else { die ('Could not broadcast.'); } } else { return e2m_error404 (); } } function e2_cache_filename_with_id_($cn,$s2){ return str_replace ('*',$cn,$s2); } function e2_note_cache_filename_with_id_($cn){ return e2_cache_filename_with_id_($cn,USER_DIR . CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($note_id,$xs){ if(is_numeric ($note_id)) { if(Log::$a)__log ('Caches: Drop caches for note id '. $note_id); @unlink (e2_note_cache_filename_with_id_($note_id)); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments')); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments-author')); } else { sq (USER_DIR . CACHE_FILENAMES_NOTES); sq (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS); sq (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR); } vb (); if ($xs !== false){ bb (); sq (USER_DIR . CACHE_FILENAMES_NOTES_RELATED); sq (USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG); sq (USER_DIR . CACHE_FILENAMES_TAG); sq (USER_DIR . CACHE_FILENAMES_TAG_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_POPULAR); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED); @unlink (USER_DIR . CACHE_FILENAME_FULLLIST); @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); } if ($xs !== true){ @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } @unlink (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS); } function e2_drop_caches_for_tag_($es){ if(is_numeric ($es)) { @unlink (e2_cache_filename_with_id_($es,USER_DIR . CACHE_FILENAMES_TAG)); @unlink (e2_cache_filename_with_id_($es,USER_DIR . CACHE_FILENAMES_TAG_AUTHOR)); } else { sq (USER_DIR . CACHE_FILENAMES_TAG); sq (USER_DIR . CACHE_FILENAMES_TAG_AUTHOR); } @unlink (USER_DIR . CACHE_FILENAME_FAVTAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); } function cb () { if(Log::$a)__log ('Caches: Drop notes caches'); e2_drop_caches_for_note_(null,null); } function vb () { if(Log::$a)__log ('Caches: Drop notes counts cache'); sq (USER_DIR . CACHE_FILENAMES_NOTES_COUNTS); } function bb () { if(Log::$a)__log ('Caches: Drop egde time info cache'); sq (USER_DIR . CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache () { if(Log::$a)__log ('Caches: Drop all kinds of caches'); sq (USER_DIR . CACHES_DIRNAME . '*'); return true; } function e2m_comment ($parameters = []) { r1 (wq ('e2m_note',$parameters)); } function e2m_comment_edit ($parameters = []) { return yb ('edit',$parameters); } function yb ($rs,$parameters = []) { global$_strings; $ts = $js = $_strings['pt--new-comment']; $hs = 'new'; if ($rs == 'edit'){ $gs = e2_commentrec_with_parameters_($parameters); $ws = $_strings['fb--save-changes']; $iy = $gs['noterec']; $ts = $js = $_strings['pt--edit-comment']; $us = mb ($iy,$gs,$parameters['comment-number']); if (!$gs){ return e2m_error404 (); } $is = [ '.note-id' => $gs['NoteID'], '.comment-id' => $gs['ID'], '.comment-number' => $parameters['comment-number'], '.already-subscribed?' => false, '.gip' => $gs['GIP'], 'create:edit?' => false, 'form-action' => wq ('e2s_comment_process'), 'submit-text' => $ws, 'show-subscribe?' => true, 'subscribe?' => (bool)$gs['IsSubscriber'], 'name' => htmlspecialchars ($gs['AuthorName'],ENT_COMPAT,'UTF-8'), 'email' => htmlspecialchars ($gs['AuthorEmail'],ENT_COMPAT,'UTF-8'), 'text' => htmlspecialchars ($gs['Text'],ENT_COMPAT,'UTF-8'), 'email-field-name' => a (), 'email-fields-revealed?' => true, ]; if ('' != trim ($gs['IP'])) { $is['ip']=$gs['IP']; } } $bb = [ 'title' => $ts, 'heading' => $js, 'form' => 'form-comment', 'form-comment' => $is, ]; if (!empty ($us)) { $bb['comments'] = ['each' => ['only' => $us]]; } return $bb; } function e2m_comment_reply ($parameters = []) { global$_strings; $gs = e2_commentrec_with_parameters_($parameters); if (!$gs){ return e2m_error404 (); } $iy = $gs['noterec']; $us = mb ($iy,$gs,$parameters['comment-number']); $us['replying?'] = (bool)true; $os = ($gs['Reply']=='' or !$gs['IsReplyVisible']); $ts = $os? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $ps = [ '.note-id' => $iy['ID'], '.comment-id' => $gs['ID'], '.reply-action' => $os? 'new' : 'edit', 'form-action' => wq ('e2s_comment_edit_reply'), 'submit-text' => $os? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($os), 'reply-text' => htmlspecialchars ($gs['Reply'],ENT_COMPAT,'UTF-8'), 'emailing-possible?' => MAIL_ENABLED, 'mail-back?' => (bool) ($os), ]; return [ 'title' => $ts, 'heading' => $ts, 'comments' => ['each' => ['only' => $us]], 'form' => 'form-comment-reply', 'form-comment-reply' => $ps, ]; } function e2m_comment_delete ($parameters = []) { global$_config; $gs = e2_commentrec_with_parameters_($parameters); $note_id = $gs['NoteID']; if (!$gs){ return e2m_error404 (); } e2_drop_caches_for_note_($note_id,true); @unlink (USER_DIR. '/last-comment.psa'); em ( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$gs['ID']). "'" ); t1 (); } function e2m_comment_reply_delete ($parameters = []) { global$_strings,$settings,$_config; $gs = e2_commentrec_with_parameters_($parameters); if (!$gs){ return e2m_error404 (); } em ( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$gs['ID']) ); t1 (); } function e2m_unsubscribe ($parameters){ global$_strings,$_config; $q2 = "ORDER BY `ID` DESC"; $ca = false; $iy = $parameters['*note']; $note_id = $iy['ID']; $va = $parameters['unsubscribe-email']; $ba = $parameters['unsubscribe-key']; $va = str_replace (' ','+',$va); if($note_id){ em ( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`='". jm ($va) ."' ". $q2, 'get subscriber’s comments ids' ); $g3 = tm (); if(count ($g3)<1) { $bb['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $ya = @$g3[0]; $na = md5 ($ya['ID'].$ya['Stamp'] .'x'); if ($ba == $na){ em ( "UPDATE `". $_config['db_table_prefix']."Comments` ". "SET `IsSubscriber`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND `AuthorEmail` = '". jm ($va). "'", 'unsubscribe' ); $ca = true; $bb['unsubscribe']['note-title']=ry ( htmlspecialchars ($iy['Title'],ENT_COMPAT,'UTF-8') ); $bb['unsubscribe']['note-href']=wq ( 'e2m_note', ['*note' => $iy] ); } if (!$ca){ $bb['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $bb['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } if ($ca){ $ts = $_strings['pt--unsubscription-done']; } else { $ts = $_strings['pt--unsubscription-failed']; } $bb['unsubscribe']['success?']=$ca; $bb['title']=$ts; $bb['heading']=$ts; return $bb; } function e2m_comment_flag ($parameters){ nb ($parameters); r1 (wq ('e2m_note',$parameters)); } function e2s_comment_flag_ajax ($parameters){ cq ([ 'flag-name' => 'comment', 'candy-name' => 'e2s_comment_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ nb ($parameters); }, 'redirect-candy' => 'e2m_note', ]); } function nb ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_note',$parameters)); } ms (); $gs = e2_commentrec_with_parameters_($parameters); $note_id = $gs['NoteID']; if (!$gs) throw new AeException ('Comment record not cound from parameters'); e2_drop_caches_for_note_($note_id,true); km ( sl (), 'Comments', [ 'ID' => $gs['ID'], $parameters['flag'] => (int) ($parameters['value']==1), ] ); } function e2s_comment_process () { global$_strings; $ma = true; $fa = ''; try { $note_id = rb (); } catch (AeFormIncompleteException $e){ hb ($_strings['er--name-email-text-required'],E2E_USER_ERROR); r1 (wq ('e2m_note', ['*note' => bf ($e->note_id)])); } catch (AeFormNoteNotCommentableException $e){ $ma = false; $da = $_strings['gs--comment-post-not-commentable']; $sa = $_strings['gs--comment-post-not-commentable-description']; $fa = $e->comment_text; } catch (AeFormDuplicateCommentException $e){ $ma = false; $da = $_strings['gs--comment-double-post']; $sa = $_strings['gs--comment-double-post-description']; $fa = $e->comment_text; } catch (AeFormCommentTooLongException $e){ $ma = false; $da = $_strings['gs--comment-too-long']; $sa = $_strings['gs--comment-too-long-description']; $fa = $e->comment_text; } catch (AeFormCommentIsSpamSuspectException $e){ $ma = false; $da = $_strings['gs--comment-spam-suspect']; $sa = $_strings['gs--comment-spam-suspect-description']; $fa = $e->comment_text; } if ($ma){ if($note_id){ r1 (wq ('e2m_note', ['*note' => bf ($note_id)])); } else { r1 (); } } else { $bb['title']=$da; $bb['heading']=$da; $bb['form']='form-unaccepted-comment'; $bb['form-unaccepted-comment'] = [ 'reason' => $sa, 'text' => @htmlspecialchars ($fa,ENT_COMPAT,'UTF-8'), ]; return $bb; } die; } function e2s_comment_edit_reply () { global$_config; ms (); $aa = @$_POST['text']; if(trim ($aa)=='')$aa = ''; $note_id = @$_POST['note-id']; $iy = bf ($note_id); $hs = @$_POST['comment-id']; $gs = fb ($hs); $qa = isset ($_POST['mail-back']); $la = time (); if (@$_POST['reply-action']=='new'){ $za = time (); } @unlink (e2_note_cache_filename_with_id_($note_id .'-comments')); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments-author')); if ($gs){ em ( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". jm ($aa) ."', ". ( isset ($za)? ( "`ReplyStamp`='". $za ."', " ) : ( "" ) ). "`ReplyLastModified`='". $la ."', ". "`IsReplyVisible`='1' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$hs), 'update comment reply' ); $ka = wq ('e2m_note', ['*note' => $iy]); if ($qa and $aa != ''){ $xa['comment-time'] = [$gs['Stamp'],y1 ()]; $xa['commenter']=$gs['AuthorName']; $xa['commenter-email']=$gs['AuthorEmail']; $xa['comment-text']=$gs['Text']; $xa['note-title']=ry ($iy['Title']); $xa['reply-time'] = [time (), y1 ()]; $xa['blog-author']=rv (); $xa['note-href']=$ka; $xa['comment-href']=$ka; $xa['reply-text']=$aa; if(1){ $ea = gn ( 'comment-reply',$xa ); $ra = e2l_get_string ( 'em--comment-reply', $xa ); $ta = $gs['AuthorEmail']; $ja = 'From: '. wn (); un ($ta,$ra,$ea,$ja); } if(1){ unset ($xa['commenter-email']); $ja = 'From: '. wn (); foreach (kb ($iy,$gs['AuthorEmail']) as $ha){ $ga = $ha['AuthorEmail']; $wa = md5 ($ha['ID'].$ha['Stamp'].'x'); $xa['unsubscribe-href']=wq ('e2m_unsubscribe', [ '*note' => $iy, 'unsubscribe-email' => $ga, 'unsubscribe-key' => $wa, ] ); $ta = $ga; $ea = gn ('comment-reply-to-public',$xa); $ra = e2l_get_string ( 'em--comment-reply-to-public-subject', $xa ); un ($ta,$ra,$ea,$ja); } } } r1 ($ka); } else { t1 (); } die; } function mb ($iy,$gs,$ua){ global$_config; if(Log::$a)__log ('Package comment '. $gs['ID'] .'...'); if ($iy === null){ $iy = bf ($gs['NoteID']); } $xa['number']=$ua; $ia = !empty ($gs['IsGIPUsed']); $xa['gip-used?']=$ia; $xa['gip']=$xa['gip-used?']?$gs['GIP']:''; $xa['name']=htmlspecialchars ($gs['AuthorName'],ENT_NOQUOTES,'UTF-8'); $xa['userpic-set?']=false; if ($ia){ $oa = AVATARS_DIRNAME . $gs['GIP'] .'-'. $gs['GIPAuthorID'] .'.jpg'; if(is_file ($_config['path_media'].$oa)) { $xa['userpic-set?']=true; $xa['userpic-href']=AeEnv::$p . $oa; } } $xa['name-href']=''; if ( $ia and $pa = vn ( $gs['GIP'],$gs['GIPAuthorID'],$gs['AuthorProfileLink'] ) ) { $xa['name-href']=$pa; } if (ss ()) { $xa['email']=htmlspecialchars ($gs['AuthorEmail'],ENT_NOQUOTES,'UTF-8'); if ('' != trim ($gs['IP'])) { $xa['ip']=$gs['IP']; } } $xa['author-name']=rv (); $xa['new?']=false; $xa['important?'] = (bool)$gs['IsFavourite']; $xa['reply-visible?'] = (bool) ($gs['IsVisible'] && $gs['IsReplyVisible']); $xa['reply-important?'] = (bool)$gs['IsReplyFavourite']; $xa['spam-suspect?'] = (bool)$gs['IsSpamSuspect']; $c1 = [(int)$gs['Stamp'],v1 ($iy)]; $xa['time']=$c1; $xa['last-modified']=$c1; if ($gs['LastModified']) $xa['last-modified'] = [(int)$gs['LastModified'],v1 ($iy)]; if ($gs['ReplyStamp']) $xa['reply-time'] = [(int)$gs['ReplyStamp'],v1 ($iy)]; if ($gs['ReplyLastModified']) $xa['reply-last-modified'] = [(int)$gs['ReplyLastModified'],v1 ($iy)]; if (ss ()) { $xa['subscriber?'] = (bool)$gs['IsSubscriber']; $xa['new?'] = (bool)$gs['IsNew']; $xa['first-new?']=false; if (!@$_config['read_only']) { $xa['important-toggle-action']=wq ('e2s_comment_flag_ajax', [ '*note' => $iy,'comment-number' => $ua, 'flag' => 'IsFavourite', 'value' => !$gs['IsFavourite'] ]); $xa['reply-important-toggle-action']=wq ('e2s_comment_flag_ajax', [ '*note' => $iy,'comment-number' => $ua, 'flag' => 'IsReplyFavourite', 'value' => !$gs['IsReplyFavourite'] ]); $xa['edit-href']=wq ('e2m_comment_edit', [ '*note' => $iy,'comment-number' => $ua, ]); $xa['removed-action']=wq ('e2s_comment_flag_ajax', [ '*note' => $iy,'comment-number' => $ua, 'flag' => 'IsVisible', 'value' => 0 ]); $xa['removed-reply-action']=wq ('e2s_comment_flag_ajax', [ '*note' => $iy,'comment-number' => $ua, 'flag' => 'IsReplyVisible', 'value' => 0 ]); $xa['replaced-action']=wq ('e2s_comment_flag_ajax', [ '*note' => $iy,'comment-number' => $ua, 'flag' => 'IsVisible', 'value' => 1 ]); $xa['replaced-reply-action']=wq ('e2s_comment_flag_ajax', [ '*note' => $iy,'comment-number' => $ua, 'flag' => 'IsReplyVisible', 'value' => 1 ]); $v1 = wq ('e2m_comment_reply', [ '*note' => $iy,'comment-number' => $ua ]); if ($gs['Reply']=='' or !$gs['IsReplyVisible']) { $xa['reply-href']=$v1; } else { $xa['edit-reply-href']=$v1; } } } if(mb_strlen ((string) @$gs['Text']) > $_config['max_comment_length']) { $gs['Text']=mb_substr ($gs['Text'],0,$_config['max_comment_length']); } $b1 = $iy['FormatterID']==='raw' ? 'neasden' : $iy['FormatterID']; $wd = jy ($b1,$gs['Text'],'simple'); $xa['text']=$wd['text-final']; $xa['reply']=''; $xa['replying?'] = (bool)false; $xa['replied?'] = (bool) ( (trim ((string) @$gs['Reply']) != '') && ($gs['IsReplyVisible']) ); if ((string)$gs['Reply']!==''){ $wd = jy ($iy['FormatterID'],$gs['Reply'],'full'); $xa['reply']=$wd['text-final']; } if(Log::$a)__log ('Comments: done'); return $xa; } function fb ($cn){ global$_config; em ( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $cn ."'" ); $xb = tm (); if(count ($xb)>0){ return $xb[0]; } else { return false; } } function db ($s){ global$_strings,$_config,$settings; if (@$_config['read_only']) return null; if (!xb ($s)) return null; $y1 = gy (); if (!count ($y1) and !empty ($settings['comments']['require_gip'])) return null; $n1 = (string) @$_COOKIE[j1 ('commenter_name')]; $m1 = (string) @$_COOKIE[j1 ('commenter_email')]; $f1 = (string) @$_COOKIE[j1 ('commenter_ph')]; $d1 = false; if ($m1 and $f1){ foreach (kb ($s) as $ha){ $na = md5 ($ha['ID'].$ha['Stamp'] .'x'); if ( $ha['AuthorEmail']==$m1 and $f1 == $na ) { $d1 = true; break; } } } $ws = $_strings['fb--submit']; $en = q (); $is = [ '.note-id' => $s['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$d1, 'cookie-name' => z ($s['ID']), 'cookie-value' => k (), 'email-field-name' => a (), 'nospam-field-name-part-1' => substr ($en,0,4), 'nospam-field-name-part-2' => substr ($en,4), 'create:edit?' => true, 'form-action' => wq ('e2s_comment_process'), 'submit-text' => $ws, 'show-subscribe?' => (bool) !$d1, 'emailing-possible?' => MAIL_ENABLED, 'subscribe?' => (bool)$d1, 'subscription-status' => $d1? $_strings['gs--you-are-already-subscribed']:'', 'name' => htmlspecialchars ($n1,ENT_COMPAT,'UTF-8'), 'email' => htmlspecialchars ($m1,ENT_COMPAT,'UTF-8'), 'text' => '', 'email-comments-enabled?' => empty ($settings['comments']['require_gip']), 'gips' => [], ]; $s1 = false; $a1 = ''; foreach ($y1 as $q1){ if (!is_file (SYSTEM_DIR .'gips/'. $q1 .'.json')) { continue; } $l1 = oy ($q1); $is['gips'][$q1]=iy ($q1); if ($l1){ $s1 = true; $z1 = bn ($q1); $a1 = $z1['GIP']; $is['name']=htmlspecialchars ( $z1['AuthorName'],ENT_COMPAT,'UTF-8' ); } } if (!$is['email-comments-enabled?'] and !count ($is['gips'])) { return false; } $k1 = (count ($is['gips']) === 0); $is['email-comments-only?']=$k1; $is['email-fields-revealed?'] = ( $k1 or (!empty ($n1) and !empty ($m1)) ); $is['logged-in?']=$s1; $is['logged-in-gip']=$a1; $is['logout-url']=$s1 ? wq('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())) : ''; return $is; } function sb ($note_id){ return qb ($note_id,'`IsNew` = 1'); } function ab ($note_id){ return qb ($note_id,'`IsVisible` = 1'); } function qb ($note_id,$x1){ global$_config; if (!is_numeric ($note_id)) return 0; $e1 = 0; em ( "SELECT count(*) ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND (". $x1. ")", 'count comments' ); $g3 = tm (); $g3 = (int)$g3[0]['count(*)']; $e1 = $g3; return (int)$e1; } function lb (AeDatabaseConfiguration $databaseConfiguration){ if(Log::$a)__log ('Count new comments'); $r1 = 0; $t1 = ''; em ( "SELECT `NoteID`, `Text` FROM `". $databaseConfiguration -> getPrefix () . "Comments` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `IsNew`=1 ORDER BY `Stamp` DESC", 'count new comments for author menu' ); $g3 = tm (); $r1 = count ($g3); while ($r1-- > 0){ if ($iy = bf ($g3[$r1]['NoteID'])) { $t1 = wq ('e2m_note', ['*note' => $iy]); break; } } $r1 ++; return [(int)$r1,$t1]; } function zb ($note_id){ global$_config; if(Log::$a)__log ('Comments: getting comments for note '. $note_id); em ( "SELECT c.*, g.`AuthorProfileLink` ". "FROM `". $_config['db_table_prefix']."Comments` c ". "LEFT JOIN `". $_config['db_table_prefix']."GIPsSessions` g ". "ON c.`SubsetID`=g.`SubsetID` ". "AND c.`GIP`=g.`GIP` ". "AND c.`GIPAuthorID`=g.`GIPAuthorID` ". "WHERE c.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$note_id . " ". "ORDER BY `Stamp`", 'get comments including deleted' ); $g3 = tm (); return $g3; } function kb ($iy,$j1 = ''){ global$_config; $q2 = "ORDER BY `ID` DESC"; $bb = $h1 = []; em ( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `IsVisible`, ". "`AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$iy['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `IsVisible`=1 ". "AND `AuthorEmail`!='". jm ($j1) ."' ". $q2, 'get subscribers by note' ); $g3 = tm (); foreach ($g3 as $ha){ if (!in_array ($ha['AuthorEmail'],$h1)) { $bb[] = $ha; } $h1[] = $ha['AuthorEmail']; } return $bb; } function xb ($iy,$g1 = NOTE_COMMENTABLE_NOW){ global$settings,$_config; $w1 = true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($iy['Stamp']<time () - $_config['comment_freshness_days']*SECONDS_IN_A_DAY) $w1 = false; $u1 = $iy['IsCommentable']; if ($g1 == NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $u1 = true; } return ( kf ($iy)==='public' and $w1 and $u1 ); } function e2_commentrec_with_parameters_($parameters = []) { $iy = $parameters['*note']; $i1 = zb ($iy['ID']); $gs = @$i1[$parameters['comment-number']-1]; if ($gs){ $gs['noterec']=$iy; return $gs; } } function rb () { global$settings,$_config; if(Log::$a)__log ('Process comment form'); ms (); $kn = a (); $note_id = $hs = $name = $va = $o1 = ''; if(array_key_exists ('note-id',$_POST)) $note_id = trim (@$_POST['note-id']); if(array_key_exists ('comment-id',$_POST)) $hs = trim (@$_POST['comment-id']); if(array_key_exists ('comment-number',$_POST)) $ua = trim (@$_POST['comment-number']); if(array_key_exists ('name',$_POST)) $name = trim (@$_POST['name']); if(array_key_exists ($kn,$_POST)) $va = trim (@$_POST[$kn]); if(array_key_exists ('text',$_POST)) $o1 = trim (@$_POST['text']); if ($hs === 'new'){ $p1 = cn (); if ($p1){ $z1 = bn ($p1); $name = trim ($z1['AuthorName']); $va = ''; $cq = $z1['GIPAuthorID']; } } else { if(array_key_exists ('gip',$_POST))$p1 = trim (@$_POST['gip']); } $vq = ( (array_key_exists ('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists ('subscribe',$_POST) and $_POST['subscribe']) ); $sm = time (); if (!is_numeric ($note_id)) { throw new AeFormInconsistentException (); } if (!is_numeric ($hs) and $hs !== 'new'){ throw new AeFormInconsistentException (); } if ($hs !== 'new' and !ss ()) { throw new AeFormInconsistentException (); } if ( $o1 == '' or (!$p1 and ((string)$name === '' or (string)$va === '')) ) { throw new AeFormIncompleteException ($note_id); } if ($hs == 'new' and !$p1){ w1 ('commenter_name',$name); w1 ('commenter_email',$va); } $bq = ($hs === 'new' and ( x () or e2_cookie_data_is_spam_suspicios_for_note_id_($note_id) )); if ($hs == 'new'){ $yq = @unserialize (file_get_contents (USER_DIR. '/last-comment.psa')); if(md5 ($name . $va . $o1) == @$yq['md5']) { throw new AeFormDuplicateCommentException ($o1); } if ( isset ($_config['max_comment_length']) and strlen (@$_POST['text']) > ($_config['max_comment_length']) ) { throw new AeFormCommentTooLongException ($o1); } $iy = bf ($note_id); if ($hs == 'new' and !xb ($iy)) { throw new AeFormNoteNotCommentableException ($o1); } if ($bq){ throw new AeFormCommentIsSpamSuspectException ($o1); } } e2_drop_caches_for_note_($note_id,true); if ($hs == 'new'){ $gs = [ 'NoteID' => (int)$note_id, 'AuthorName' => $name, 'AuthorEmail' => $va, 'Text' => $o1, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$vq, 'IsSpamSuspect' => (int)$bq, 'IsNew' => 1, 'Stamp' => (int)time (), 'LastModified' => (int)time (), 'IP' => jm (fs ()), 'IsGIPUsed' => intval (!empty ($p1) && !empty ($cq)), 'GIP' => !empty ($p1)?jm ($p1):'', 'GIPAuthorID' => !empty ($cq)?jm ($cq):'', ]; $gs = zm (sl (), 'Comments',$gs); $hs = $gs['ID']; $yq = [ 'id' => $hs, 'md5' => md5 ($name . $va . $o1), ]; @e3 (USER_DIR. 'last-comment.psa',serialize ($yq)); $nq = md5 ($gs['ID'].$gs['Stamp'].'x'); w1 ('commenter_ph',$nq); $iy = bf ($note_id); $ka = wq ('e2m_note', ['*note' => $iy]); $xa['comment-time'] = [$sm,y1 ()]; $xa['commenter']=$name; $xa['commenter-email']=$va; $xa['comment-text']=$o1; $xa['note-title']=$iy['Title']; $xa['note-href']=$ka; $xa['comment-href']=$ka; $xa['comments-disable-href']=wq ('e2s_note_flag', [ '*note' => $iy, 'flag' => 'IsCommentable', 'value' => 0 ]); $xa['reply-href']=wq ( 'e2m_comment_reply', [ '*note' => $iy, 'comment-number' => $ua ] ); if (isset ($settings['author_email']) and @$settings['notifications']['new_comments']) { $ea = gn ( 'comment-new-to-author',$xa ); $ra = e2l_get_string ( 'em--comment-new-to-author-subject', $xa ); $ta = $settings['author_email']; $ja = 'From: '. wn () ."\r\n". 'Reply-to: '. $name .' <'. $va .">"; un ($ta,$ra,$ea,$ja); } if (!$bq){ unset ($xa['commenter-email']); $ja = 'From: '. wn (); foreach (kb ($iy,$va) as $ha){ $ga = $ha['AuthorEmail']; $wa = md5 ($ha['ID'].$ha['Stamp'].'x'); $xa['unsubscribe-href']=wq ('e2m_unsubscribe', [ '*note' => $iy, 'unsubscribe-email' => $ga, 'unsubscribe-key' => $wa ] ); $ta = $ga; $ea = gn ('comment-new-to-public',$xa); $ra = e2l_get_string ( 'em--comment-new-to-public-subject', $xa ); un ($ta,$ra,$ea,$ja); } } } else { $mq = [ 'ID' => $hs, 'Text' => $o1, 'IsVisible' => 1, 'IsSubscriber' => ((int)$vq), 'LastModified' => time (), ]; if (!empty ($name))$mq['AuthorName']=$name; if (!empty ($va))$mq['AuthorEmail']=$va; km (sl (), 'Comments',$mq); } return (int)$note_id; } define ('E2_UA_STRING','Aegea '. E2_RELEASE .' (v'. E2_VERSION . (defined ('E2_EDITION')?'e':'') .')'); define ('E2_MINIMUM_PHP','5.6'); define ('E2_MINIMUM_MYSQL','5.6'); define ('E2_MINIMUM_MARIADB','10.1'); define ('E2E_STRANGE_ERROR',10); define ('E2E_USER_ERROR',20); define ('E2E_PERMISSIONS_ERROR',30); define ('E2E_MESSAGE',100); define ('E2E_DIAGNOSTICS_MESSAGE',110); define ('DEFAULT_TEMPLATE','acute'); define ('DEFAULT_FORMATTER','neasden'); define ('E2_NEW_FILES_RIGHTS',0777); define ('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); define ('DEFAULT_ITEMS_PER_PAGE',10); define ('MAX_ITEMS_PER_PAGE',100); define ('SYSTEM_DIR','system/'); define ('SYSTEM_DEFAULTS_DIR','system/default/'); define ('SYSTEM_THEME_DIR','system/theme/'); define ('LANGUAGES_DIRNAME','languages/'); define ('LIBRARY_DIRNAME','library/'); define ('THEMES_DIRNAME','themes/'); define ('EXTRAS_DIRNAME','extras/'); define ('SCRIPTS_SUBDIR','js/'); define ('LOGS_DIRNAME','logs/'); define ('CACHES_DIRNAME','caches/'); define ('BACKUP_DIRNAME','backup/'); define ('MAIN_LOG_FILENAME','main.log'); define ('PICTURES_DIRNAME','pictures/'); define ('THUMBNAILS_DIRNAME','pictures/thumbs/'); define ('AVATARS_DIRNAME','pictures/avatars/'); define ('USERPIC_DIRNAME','pictures/userpic/'); define ('VIDEO_DIRNAME','video/'); define ('AUDIO_DIRNAME','audio/'); define ('LICENSE_FILENAME','license.psa'); define ('THUMB_WIDTH',180); define ('THUMB_HEIGHT',120); define ('THUMB_JPG_QUALITY',50); define ('SCALED_IMAGE_JPG_QUALITY',80); define ('AVATAR_SIZE',80); define ('VIDEO_ICON_FILENAME','images/video.svg'); define ('AUDIO_ICON_FILENAME','images/audio.svg'); define ('VIDEO_ICON_WIDTH',180); define ('VIDEO_ICON_HEIGHT',120); define ('AUDIO_ICON_WIDTH',120); define ('AUDIO_ICON_HEIGHT',120); define ('ALIAS_MAX_LENGTH',64); define ('CACHE_ALIASMAP',CACHE and true); define ('CACHE_NOTES',CACHE and true); define ('CACHE_NOTES_RELATED',CACHE and true); define ('CACHE_NOTES_COMMENTS',CACHE and true); define ('CACHE_POPULAR',CACHE and true); define ('CACHE_POPULAR_WITH_TAG',CACHE and true); define ('CACHE_RANDOM_NOTE',CACHE and true); define ('CACHE_TAGS',CACHE and true); define ('CACHE_FAVTAGS',CACHE and true); define ('CACHE_NOTES_COUNTS',CACHE and true); define ('CACHE_EDGE_TIMEINFO',CACHE and true); define ('CACHE_FRONTPAGE',CACHE and true); define ('CACHE_FRONTPAGE_FEED',CACHE and true); define ('CACHE_TAG',CACHE and true); define ('CACHE_FULLLIST',CACHE and true); define ('CACHE_DRAFTS',CACHE and true); define ('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define ('CACHE_LASTMODIFIEDS',CACHE and true); define ('CACHE_INDEXED_FLAG',CACHE and true); define ('CACHE_FILENAME_ALIASMAP',CACHES_DIRNAME . 'aliasmap.psa'); define ('CACHE_FILENAMES_NOTES',CACHES_DIRNAME . 'note-*.psa'); define ('CACHE_FILENAMES_NOTES_RELATED',CACHES_DIRNAME . 'note-*-related.psa'); define ('CACHE_FILENAMES_NOTES_COMMENTS',CACHES_DIRNAME . 'note-*-comments.ctree.psa'); define ('CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR',CACHES_DIRNAME . 'note-*-comments-author.ctree.psa'); define ('CACHE_FILENAMES_NOTES_COUNTS',CACHES_DIRNAME . 'notes-count-*.txt'); define ('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_DIRNAME . '*.e2time.psa'); define ('CACHE_FILENAME_POPULAR',CACHES_DIRNAME . 'popular.ctree.psa'); define ('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_DIRNAME . 'popular-expires.txt'); define ('CACHE_FILENAME_RANDOM_NOTE',CACHES_DIRNAME . 'random-note.psa'); define ('CACHE_FILENAMES_POPULAR_WITH_TAG',CACHES_DIRNAME . 'popular-*.ctree.psa'); define ('CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES',CACHES_DIRNAME . 'popular-*-expires.txt'); define ('CACHE_FILENAME_TAGS',CACHES_DIRNAME . 'tags.ctree.psa'); define ('CACHE_FILENAME_TAGS_FULL',CACHES_DIRNAME . 'tags-full.ctree.psa'); define ('CACHE_FILENAME_TAGS_AUTHOR',CACHES_DIRNAME . 'tags-author.ctree.psa'); define ('CACHE_FILENAME_TAGS_AUTHOR_FULL',CACHES_DIRNAME . 'tags-author-full.ctree.psa'); define ('CACHE_FILENAME_FAVTAGS',CACHES_DIRNAME . 'favtags.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE',CACHES_DIRNAME . 'frontpage.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_DIRNAME . 'frontpage-author.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_DIRNAME . 'frontpage-feed.psa'); define ('CACHE_FILENAMES_TAG',CACHES_DIRNAME . 'tag-*.ctree.psa'); define ('CACHE_FILENAMES_TAG_AUTHOR',CACHES_DIRNAME . 'tag-*-author.ctree.psa'); define ('CACHE_FILENAME_FULLLIST',CACHES_DIRNAME . 'notes-list.ctree.psa'); define ('CACHE_FILENAME_DRAFTS',CACHES_DIRNAME . 'drafts.psa'); define ('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_DIRNAME . 'drafts-auc.psa'); define ('CACHE_FILENAME_LASTMODIFIEDS',CACHES_DIRNAME . 'last-modifieds-by-id.psa'); define ('CACHE_FILENAME_INDEXED_FLAG',CACHES_DIRNAME . 'indexed.flag'); define ('FP_NO_ID_OR_NEW', -1); define ('FP_INSERT_ERROR', -10); define ('FP_UPDATE_ERROR', -11); define ('FP_EMPTY_FIELD', -20); define ('FP_TITLE_OR_TEXT_EMPTY', -21); define ('FP_NOT_COMMENTABLE', -30); define ('FP_COMMENT_DOUBLE_POST', -101); define ('FP_COMMENT_TOO_LONG', -102); define ('FP_COMMENT_SPAM_SUSPECT', -103); define ('NOTE_COMMENTABLE_NOW', -1); define ('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define ('SECONDS_IN_A_MINUTE',60); define ('SECONDS_IN_AN_HOUR',3600); define ('SECONDS_IN_A_DAY',86400); define ('SECONDS_IN_A_WEEK',604800); define ('SECONDS_IN_A_MONTH',2592000); define ('SECONDS_IN_A_YEAR',31536000); function e2m_drafts ($parameters){ global$_strings,$_config; $draftsView = new AePageableNotesView ('e2m_drafts',$parameters); $draftsView -> setPortionSize ((int)$_config['drafts_per_page']); $draftsView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $draftsView -> setWantControls (true); $draftsView -> setWantPaging (true); $draftsView -> setUseLocalHrefs (true); if($draftsView -> isFirstPage () and CACHE_DRAFTS){ $draftsView -> setCacheFilename (USER_DIR . CACHE_FILENAME_DRAFTS); } $draftsView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `LastModified` DESC" ); $fq = $draftsView -> getNotesCTree (); if(count ($fq)) { if(Log::$a)__log ('Thumbnails {'); foreach ($fq as $x3 => $e3){ $fq[$x3]['thumbs']=u2 (@$e3['format-info']['resources-detected']); } if(Log::$a)__log ('}'); } $ts = $_strings['pt--drafts']; if($parameters['page']>1){ $ts .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $bb = [ 'title' => $ts, 'heading' => $_strings['pt--drafts'], 'notes' => $fq, 'pages' => $draftsView -> getPagesCTree (), ]; if(count ($fq) >= 5){ $bb['secret-link-promo']=e2l_get_string ( 'pm--secret-link', ['url' => $_config['paid_features_url']] ); } if($draftsView -> isFirstPageOfEmptyView ()) { $bb['nothing']=$_strings['gs--no-drafts']; } elseif (!$draftsView -> isExistingPage ()) { return e2m_error404 (); } return $bb; } function tb ($dq){ global$_config; if(Log::$a)__log ('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $sq = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and @is_array ($sq)) { if(Log::$a)__log ('Drafts: retrieve cached'); } else { if(Log::$a)__log ('Drafts: assemle cacheable...'); $sq = array (); em ( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `ID`", 'get original aliases of drafts to calculate use counts' ); $g3 = tm (); $bm = array (); foreach ($g3 as $x3 => $iy){ @$sq[$iy['OriginalAlias']] ++; } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ e3 (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize ($sq)); } } return $sq[$dq]; } function jb () { global$_strings; $aq = 'https://'. $_strings['e2--website-host'] .'/'; $qq = '('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; return [ 'built?' => BUILT, 'installed?' => (qn () !== null), 'version' => 'v'. E2_VERSION, 'version-description' => $_strings['e2--vname-aegea'] .' '. $qq, 'user-folder-name' => yl (), 'cookie-prefix' => json_encode (j1 ()), 'base-path' => json_encode (AeEnv::$i), 'href' => $aq, 'about' => ( '<span title="E2 '.$qq .'">'. $_strings['e2--powered-by'] .' '. '<a href="'. $aq .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> '. '<span class="e2-svgi">'. d2 ('aegea') .'</span></a></span>' ), ]; } function hb ($lq,$type = E2E_STRANGE_ERROR){ global$errors,$_config; if (!isset ($errors))$errors = []; $zq = (!ss ()+1 <= (int)$_config['show_call_stack']); if ($lq){ if ($lq[0]!='<')$lq = '<p>' . $lq .'</p>'; $kq = array ( 'description' => $lq, 'type' => $type, ); if($type == E2E_STRANGE_ERROR and $zq){ $kq['backtrace']=debug_backtrace (); } $errors[] = $kq; } return true; } function gb ($xq){ global$_strings; if(count ($xq)==0) return false; $eq = ''; $eq .= '<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $eq .= '<ul>'; foreach ($xq as $hv){ if ($hv == '.')$hv = ''; $eq .= '<li><tt>./'. $hv .'</tt></li>'; } $eq .= '</ul>'; return $eq; } function wb ($rq,$lq,$tq = false,$jq = false,$hq = []) { global$errors; if (!(error_reporting () & $rq) or ($rq & 8)) return; $tq = str_replace (__DIR__,'',$tq); hb ($tq .', line '. $jq .'<br />Error '. $rq .': '. $lq); $errors[count ($errors)-1]['phpcode']=$rq; } function ub ($gq,$wq,$cy,$kf){ if (!(error_reporting () & $gq)) return; throw new ErrorException($wq,0,$gq,$cy,$kf); } function ib () { global$errors,$_config; if (!isset ($errors))$errors = []; @session_start (); if(is_array (@$_SESSION['errors'])) { $e = array_merge (@$_SESSION['errors'],$errors); } else { $e = $errors; } $zq = (!ss ()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $zq and $e != NULL){ @e3 ('backtrace.psa',serialize ($e)); } else { @unlink ('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $bb = array (); $uq = false; if(count ($e)>0){ foreach($e as $wb => $iq){ if ($iq['type']==E2E_STRANGE_ERROR){ $iq['class']='serious'; $uq = true; if ($zq){ $iq['backtrace']=pb ($iq['backtrace']); } } if ($iq['type']==E2E_MESSAGE){ $iq['class']='info'; } $e[$wb]=$iq; } $bb['each']=$e; if ( $uq and @$_config['store_backtrace'] and $zq and is_file ('debug.php') ) { $bb['debug-link']='debug.php'; } } return $bb; } function ob () { $errors = ib (); foreach($errors['each'] as $oq){ echo '<p>'. $oq['description'] .'</p>'; } die; } function pb ($pq){ if (!is_array ($pq)) return 'No backtrace info'; $pq = array_reverse ($pq); $pq = array_splice ($pq,0,count ($pq)-1); $e = '<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($pq as $wb => $cl){ $vl = @$cl['args'] or $vl = array (); $bl = array (); foreach ($vl as $yl){ $bl[] = var_export ($yl,true); } $cy = @$cl['file']; $cy = str_replace ($_SERVER['DOCUMENT_ROOT'],'',$cy); $kf = (@$cl['line']? (' #'. $cl['line']) : '?'); $e .= '<div style="margin: .25em 0 .5em '. $wb*3 .'em">'; $e .= '<span style="float: right; color: #666"> '. $cy . $kf .'</span>'; $e .= '<tt><b>'. @$cl['function'] .' (</b>'; if(count ($bl)) { $nl = str_replace ("array (\n)",'array ()',$bl); $nl = implode (', ',$nl); if(0){ $nl = highlight_string ('<?'. $nl .'?'.'>',true); $nl = substr ($nl,77, -28); } $nl = str_replace ('&nbsp;',' ',$nl); $nl = nl2br ($nl); $e .= '<div style="margin: 0 0 0 1.12em">'. $nl .'</div>'; } $e .= '<b>)</b> &rarr;</tt></div>'; } $e .= '</p>'; return$e; } class AeException extends \Exception {} class AeMySQLException extends AeException {} class AeMySQLNotFoundException extends AeMySQLException {} class AeMySQLTooOldException extends AeMySQLException {} class AeMySQLCannotConnectException extends AeMySQLException {} class AeMySQLAccessDeniedException extends AeMySQLCannotConnectException {} class AeMySQLQueryException extends AeMySQLException {} class AeMySQLNoDataException extends AeMySQLException {} class AeMySQLNotMigrateableException extends AeMySQLException {} class AeMySQLCorruptedUpdateRecordCallException extends AeMySQLException {} class AeRecordNotFoundException extends AeException {} class AeInstallException extends AeException {} class AeInstallAlreadyInstalledException extends AeInstallException {} class AeInstallDatabaseOccupiedException extends AeInstallException {} class AeWritePermissionsException extends AeException {} class AeNotSavedException extends AeWritePermissionsException {} class AeTokenException extends AeException {} class AeOlbaException extends AeException {} class AeOlbaTemplateMissingException extends AeOlbaException {} class AeStubException extends AeException {} class AeFormException extends AeException {} class AeFormInconsistentException extends AeFormException {} class AeFormIncompleteException extends AeFormException { public $note_id = ''; function __construct ($note_id){ $this->note_id = $note_id; parent::__construct (); } } class AeFormCommentUnacceptableException extends AeFormException { public $comment_text = ''; function __construct ($comment_text){ $this->comment_text = $comment_text; parent::__construct (); } } class AeFormDuplicateCommentException extends AeFormCommentUnacceptableException {} class AeFormCommentTooLongException extends AeFormCommentUnacceptableException {} class AeFormNoteNotCommentableException extends AeFormCommentUnacceptableException {} class AeFormCommentIsSpamSuspectException extends AeFormCommentUnacceptableException {} function c3 ($ml,$fl = false){ $dl = substr (__DIR__,0,strrpos (__DIR__,'/')); $sl = ''; $al = []; foreach(array_reverse ($ml -> getTrace ()) as $ql){ $ll['where']=str_replace ( $dl .'/','',$ql['file'] ) .':'. $ql['line']; $zl = []; foreach ($ql['args'] as $kl){ $zl[] = htmlspecialchars ( str_replace ("\n","\n  ",var_export ($kl,true)), ENT_NOQUOTES,'UTF-8' ); } $xl = ''; if(count ($zl)) { $xl = ("\n". '  '. implode (",\n  ",$zl). "\n" ); } $ll['call']=$ql['function'] .' ('. $xl .')'; $al[] = $ll; } do { if ((string)$ml -> getMessage () !== ''){ $sl .= $ml -> getMessage () ."\n"; } $sl .= "\n";; $sl .= ( get_class ($ml) .' in '. str_replace ( $dl .'/','',$ml -> getFile () ) .':'. $ml -> getLine (). "\n" ); if ($ml -> getCode ()) { $sl .= 'Code: '. $ml -> getCode () ."\n"; } $el = ''; $wb = 1; foreach ($al as $kf){ $el .= $wb++ .'. '. $kf['where'] .' '. $kf['call']. "\n"; if (!$fl)$el .= "\n";; } $sl .= "\n";; } while ($ml = $ml -> getPrevious ()); if ($fl){ $el = preg_replace ('/^.*?$/smu','│            $0',$el); $sl .= '┌─'. "\n"; $sl .= $el; $sl .= '└─'; } else { $sl .= $el; } return $sl; } function v3 ($ml,$wq = ''){ global$_config; if($_config['dev_verbose'] > (int) !ss ()) { hb ('<pre>'. c3 ($ml) .'</pre>'); } if($_config['log_errors']) { Log::$a = true; if(Log::$a)tn ('error-$'); } if(Log::$a)__log ('Exception caught: '. c3 ($ml,true)); if(Log::$a)tn (''); if ((string)$wq !== ''){ if(Log::$a)__log ($wq); } } function b3 ($ml){ global$_config,$content; $content['title']=':-('; $content['exception-message']=$ml -> getMessage (); $rl['error']['message']=':-('; if (($_config['dev_verbose'] > (int) !ss ())) { $content['exception-string']=c3 ($ml); $rl['error']['message']=nl2br (c3 ($ml)); } if($_config['log_errors']) { Log::$a = true; if(Log::$a)tn ('error-$'); } if(Log::$a)__log ('Panic: '. c3 ($ml,true)); if(Log::$a)__log (':-('); if(array_key_exists ('result',$_POST) and ($_POST['result']=='ajaxresult')) { $bb = json_encode ($rl); } else { $bb = c2 ('panic',true); } echo $bb; die; } function y3 ($ml){ b3 ($ml); } function e2m_most_commented ($parameters = []) { global$settings,$_strings,$_config; $mm = ss (); $mostCommentedView = new AePageableNotesView ('e2m_most_commented',$parameters); $mostCommentedView -> setPortionSize ($settings['appearance']['notes_per_page']); $mostCommentedView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $mostCommentedView -> setWantNewCommentsCount ($mm); $mostCommentedView -> setWantReadHrefs ($_config['count_reads']); $mostCommentedView -> setWantControls ($mm and !@$_config['read_only']); $mostCommentedView -> setWantHiddenTags ($mm); AeMainMenuManager :: $isMostCommentedCurrent = $mostCommentedView->isFirstPage (); AeMainMenuManager :: $isMostCommentedParent = !$mostCommentedView->isFirstPage (); $tl = $_config['hot_period']; $jl = time () - n3 ($_config['hot_period']); $mostCommentedView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix'] ."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". xf ($mm). "AND `ID` IN ( ". "SELECT `NoteID` FROM ( ". "SELECT `NoteID`, COUNT(*) `CommentsCount` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND `Stamp` > ". $jl . " ". "GROUP BY `NoteID` ". "ORDER BY `CommentsCount` DESC ". ") As MostCommentedNotesIDs ". ")" ); $bb = [ 'title' => e2l_get_string ('pt--most-commented', ['period' => $tl]), 'heading' => e2l_get_string ('pt--most-commented', ['period' => $tl]), 'notes' => $mostCommentedView -> getNotesCTree (), 'pages' => $mostCommentedView -> getPagesCTree (), ]; if($mostCommentedView -> isFirstPageOfEmptyView ()) { $bb['nothing']=$_strings['gs--no-such-notes']; } elseif (!$mostCommentedView -> isExistingPage ()) { return e2m_error404 (); } return $bb; } function e2m_favourites ($parameters = []) { global$settings,$_config,$_strings; $mm = ss (); $favouritesView = new AePageableNotesView ('e2m_favourites',$parameters); $favouritesView -> setPortionSize ($settings['appearance']['notes_per_page']); $favouritesView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $favouritesView -> setWantPaging (true); $favouritesView -> setWantNewCommentsCount ($mm); $favouritesView -> setWantReadHrefs ($_config['count_reads']); $favouritesView -> setWantControls ($mm and !@$_config['read_only']); $favouritesView -> setWantHiddenTags ($mm); AeMainMenuManager :: $isFavouritesCurrent = $favouritesView->isFirstPage (); AeMainMenuManager :: $isFavouritesParent = !$favouritesView->isFirstPage (); $favouritesView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `IsFavourite`=1 ". xf ($mm). "ORDER BY `Stamp` DESC" ); $ts = $_strings['pt--favourites']; if($parameters['page']>1){ $ts .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $bb = [ 'title' => $ts, 'heading' => $_strings['pt--favourites'], 'notes' => $favouritesView -> getNotesCTree (), 'pages' => $favouritesView -> getPagesCTree (), ]; if($favouritesView -> isFirstPageOfEmptyView ()) { $bb['nothing']=$_strings['gs--no-favourites']; } elseif (!$favouritesView -> isExistingPage ()) { return e2m_error404 (); } return $bb; } function n3 ($tl){ if ('year' == $tl) return SECONDS_IN_A_YEAR; elseif ('month' == $tl) return SECONDS_IN_A_MONTH; elseif ('week' == $tl) return SECONDS_IN_A_DAY * 7; elseif ('day' == $tl) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function e2m_json ($parameters = array ()) { list ($hl,$sm)=q3 (); $gl = json_encode ($hl,E2_JSON_STYLE); x3 ($gl,$sm,'json'); } function e2m_rss ($parameters = array ()) { list ($hl,$sm)=q3 (); $wl = e2feeds__rss_using_jsonfeed_array_($hl); x3 ($wl,$sm,'rss'); } function e2m_tag_json ($parameters = array ()) { if(array_key_exists ('*tag',$parameters)) { $ub = $parameters['*tag']; } else { return e2m_error404 (); } list ($hl,$sm)=l3 ($ub); $gl = json_encode ($hl,E2_JSON_STYLE); x3 ($gl,$sm,'json'); } function e2m_tag_rss ($parameters = array ()) { if(array_key_exists ('*tag',$parameters)) { $ub = $parameters['*tag']; } else { return e2m_error404 (); } list ($hl,$sm)=l3 ($ub); $wl = e2feeds__rss_using_jsonfeed_array_($hl); x3 ($wl,$sm,'rss'); } function e2m_note_json ($parameters = array ()) { global$settings,$_current_url; $iy = $parameters['*note']; if ($iy == false) return e2m_error404 (); $mm = ss (); if (!( kf ($iy)==='public' or ($mm and $iy['IsPublished']) )) return e2m_error404 (); $sm = $iy['Stamp']; $ul = e2_jsonfeed_item_array_from_noterec_($iy); $il = array ($ul); $hl = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($il); $hl['title']=ev (); $hl['_rss_description']=a3 (); $hl['home_page_url']=wq ('e2m_frontpage', array ('page' => 1)); $hl['feed_url']=$_current_url; x3 (json_encode ($hl,E2_JSON_STYLE),$sm,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($il){ global$_lang,$_config,$settings; $bb = [ 'version' => 'https://jsonfeed.org/version/1.1', 'title' => null, '_rss_description' => null, '_rss_language' => $_lang, '_itunes_email' => '', '_itunes_categories_xml' => '', '_itunes_image' => '', '_itunes_explicit' => '', 'home_page_url' => null, 'feed_url' => null, 'icon' => tv (), 'authors' => [[ 'name' => rv (), 'url' => wq ('e2m_frontpage', array ('page' => 1)), 'avatar' => tv (), ]], 'items' => $il, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ]; return $bb; } function e2_jsonfeed_item_array_from_noterec_($iy){ $url = wq ('e2m_note', array ('*note' => $iy)); $ol = ( s1 ('Y-m-d\TH:i:s',$iy['Stamp']) . x1 ($iy['Stamp'],':') ); $pl = ( s1 ('Y-m-d\TH:i:s',$iy['LastModified']) . x1 ($iy['LastModified'],':') ); $c4 = ( s1 ('D, d M Y H:i:s ',$iy['Stamp']) . x1 ($iy['Stamp']) ); $wd = jy ($iy['FormatterID'], @$iy['Text'],'full-rss'); $noteView = new AeNoteView ($iy); $i3 = $noteView -> getNoteCTree (); $f3 = $i3['og-images']; $v4 = []; foreach ($i3['tags'] as $wv){ $v4[] = $wv['name']; } $v = array ( 'id' => (string)$iy['ID'], 'url' => $url, 'title' => ry ($iy['Title']), 'content_html' => $wd['text-final'], 'date_published' => $ol, 'date_modified' => $pl, 'tags' => $v4 ); if ($iy['IsExternal']) { $b4 = an ($iy); $v['url']=$b4['href-external']; $v['author'] = array ( 'name' => $b4['author'], 'url' => $b4['author-href'], 'avatar' => $b4['userpic-href'], ); } if(count ($f3)>0){ $v['image']=$f3[0]; } $v['_date_published_rfc2822']=$c4; $v['_rss_guid_is_permalink']='false'; $v['_rss_guid'] = (string)$iy['ID']; $v['_e2_data'] = array ( 'is_favourite' => (bool)$iy['IsFavourite'], 'links_required' => $wd['meta']['links-required'], 'og_images' => $f3, ); return $v; } function d3 ($y4,$ts,$t1){ global$_newsfeeds; if (!isset ($_newsfeeds))$_newsfeeds = []; $n4 = ''; if ($y4 == 'rss')$n4 = 'application/rss+xml'; if ($y4 == 'json')$n4 = 'application/json'; $_newsfeeds[] = [ 'type' => $n4, 'title' => htmlspecialchars ($ts,ENT_QUOTES,'UTF-8'), 'href' => $t1 ]; } function s3 () { global$_config; em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". xf (). "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get recent public noterecs for RSS or JSONFeed' ); return tm (); } function a3 () { global$settings; if (!empty ($settings['meta_description'])) { $m4 = strip_tags (ry (htmlspecialchars ($settings['meta_description'],ENT_NOQUOTES,'UTF-8'))); } elseif (!empty ($settings['blog_subtitle'])) { $wd = hy ($settings['blog_subtitle'],'full'); $m4 = $wd['text-final']; $m4 = zf ($m4); } else { $m4 = ev (); } return $m4; } function q3 () { global$settings,$_current_url; $sm = 0; $il = array (); $hl = array (); $a2 = USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file ($a2)) { if(Log::$a)__log ('Feed array (RSS, JSON): cached'); $hl = @unserialize (file_get_contents ($a2)); $sm = filemtime ($a2); } else { if(Log::$a)__log ('Feed array (RSS, JSON): not cached, will need to build'); $tf = s3 (); foreach ($tf as $iy){ $il[] = e2_jsonfeed_item_array_from_noterec_($iy); $sm = max ($sm,$iy['Stamp']); } $hl = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($il); $hl['title']=ev (); $hl['_rss_description']=a3 (); $hl['home_page_url']=wq ('e2m_frontpage', array ('page' => 1)); $hl['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)e3 ($a2,serialize ($hl)); } return array ($hl,$sm); } function l3 ($ub){ global$_config,$_strings,$_current_url; $sm = 0; $il = array (); em ( "SELECT n.* ". "FROM `". $_config['db_table_prefix']."Notes` n ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (nk.`KeywordID` = ". $ub['ID'] .") ". "AND n.`IsPublished` = 1 ". xf (ss ()). "ORDER BY n.`Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get tag noterecs for RSS or JSONFeed' ); $tf = tm (); foreach ($tf as $iy){ $il[] = e2_jsonfeed_item_array_from_noterec_($iy); $sm = max ($sm,$iy['Stamp']); } if ((string)$ub['Summary']!==''){ $m4 = strip_tags (ry (htmlspecialchars ($ub['Summary'],ENT_NOQUOTES,'UTF-8'))); } else if ((string)$ub['Description']!==''){ $wd = hy ($ub['Description'],'full'); $m4 = $wd['text-final']; $m4 = zf ($m4); } else { $m4 = a3 (); } $f4 = htmlspecialchars ($ub['PageTitle'],ENT_COMPAT,'UTF-8'); if ((string)$f4 !== ''){ $ts = $f4; } else { $ts = ( ev () .': '. $_strings['gs--posts-tagged'] .' '. htmlspecialchars ($ub['Keyword'],ENT_COMPAT,'UTF-8') ); } $hl = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($il); $hl['title']=$ts; $hl['_rss_description']=$m4; $hl['home_page_url']=wq ('e2m_tag', array ('*tag' => $ub)); $hl['feed_url']=$_current_url; return array ($hl,$sm); } function e2feeds__rss_using_jsonfeed_array_($content){ $d4 = USER_DIR . 'rss/rss.tmpl.php'; if (!is_file ($d4)) { $d4 = SYSTEM_DEFAULTS_DIR . 'rss/rss.tmpl.php'; } if(is_file ($d4)) { ob_start (); include $d4; $wl = ob_get_contents (); ob_end_clean (); } return $wl; } function k3 ($wl){ $s4 = ''; for ($wb = 0; $wb < strlen ($wl); ++$wb){ if(in_array (ord ($wl[$wb]), [10,13]) or ord ($wl[$wb]) >= 32){ $s4 .= $wl[$wb]; } } return $s4; } function x3 ($a4,$sm,$y4){ global$_config; $q4 = gmdate ('r',$sm); $l4 = md5 ($sm); if ($y4 == 'rss'){ if (@$_config['dev_xml_as_text']) { header ('Content-Type: text/plain'); } else { header ('Content-Type: application/xml; charset=utf-8'); } } elseif ($y4 == 'json'){ header ('Content-Type: application/json'); } else { header ('Content-Type: text/plain'); } header ('Last-modified: '. $q4); header ('Etag: '. $l4); header ('Cache-Control: public'); header ('Expires: '. date ('r',$sm + SECONDS_IN_A_DAY)); $z4 = isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes ($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $k4 = isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes ($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$z4 && !$k4 or $k4 && $k4 != $l4 or $z4 && $z4 != $q4 ) { if ($y4 == 'rss'){ $a4 = k3 ($a4); } ini_set ('zlib.output_compression',0); echo $a4; ini_set ('zlib.output_compression',1); } else { header ('HTTP/1.1 304 Not Modified'); } die; } define ('CROP_NONE',0); define ('CROP_SQUARE',1); function e3 ($cy,$x4){ @qq (dirname ($cy)); if (!@file_put_contents ($cy,$x4,LOCK_EX)) { return false; } @chmod ($cy,E2_NEW_FILES_RIGHTS); return true; } function e2s_retrieve ($parameters){ $url = base64_decode (strtr ($parameters['url'],'-_','+/')); if(Log::$a)__log ('Retrieve: '. $url); cd ($url,PROVIDE_MEDIA_NOW); die; } function r3 ( $dn,$e4,$b3 ) { $r4 = []; if(is_array ($b3)) { $r4 = j2 ($b3); } $t4 = @unserialize ( $e4['Uploads'] ) or $t4 = []; $j4 = array_diff ($r4,$t4); if(count ($j4)>0){ yy ($dn,$e4['ID'],'add',$j4); } return $j4; } function t3 ($h4){ $jv = []; foreach (w2 ($h4) as $g4){ $jv[] = $g4['src']; } return $jv; } function j3 ($name,$w4){ $name = i1 ($name); if(preg_match('//u',$name))$name = ql ($name,false); $u4 = ''; for ($wb = 0; $wb < strlen ($name); $wb++) { if($name[$wb]=='?'){ $u4 .= ''; } elseif(in_array ($name[$wb], [' ',':','/','\''])) { $u4 .= '-'; } elseif(ord ($name[$wb]) <= 127){ $u4 .= $name[$wb]; } } if ($u4 == '')$u4 = $w4; if ($u4[0]=='.')$u4 = $w4 . $u4; return $u4; } function h3 ($name){ $name = trim ((string)$name); if ( $name !== '' and strpos ($name,'..')===false and strpbrk ($name,"/\\\0")===false ) return$name; return null; } function g3 ($u,$ms,$i4){ $o4 = strrpos ($ms,'.'); if ($o4 === false){ $p4 = $ms; $cz = ''; } else { $p4 = substr ($ms,0,$o4); $cz = substr ($ms,$o4); } $wb = 0; $vz = null; while (true){ $uf = $p4 . ($wb ? '-'. $wb : '').$cz; $bz = $u . $uf; if (!is_file ($bz)) { return [ 'name' => $uf, 'existing-file?' => false, ]; } if ($vz === null){ $vz = file_get_contents ($i4); } if ($vz !== false and file_get_contents ($bz)==$vz){ return [ 'name' => $uf, 'existing-file?' => true, ]; } ++ $wb; } } function w3 ( $u,$yz,$nz,$mz ) { $g3 = [ 'name' => $yz, 'full-filename' => $u . $yz, 'existing-file?' => false, 'filesize' => 0, ]; if (!is_file ($nz)) { return $g3; } if ($mz){ $fz = $u . $yz; if (!ed ($nz,$fz)) { if(is_file ($fz)) { @unlink ($fz); } @rename ($nz,$fz); } $g3['full-filename']=$fz; $g3['filesize']=stat ($fz)['size']; return $g3; } $dz = g3 ( $u, $yz, $nz ); $sz = $dz['name']; $fz = $u . $sz; if ($dz['existing-file?']) { if (!ed ($nz,$fz)) { @unlink ($nz); } $g3['name']=$sz; $g3['full-filename']=$fz; $g3['existing-file?']=true; $g3['filesize']=stat ($fz)['size']; return $g3; } if (!ed ($nz,$fz)) { @rename ($nz,$fz); } $g3['name']=$sz; $g3['full-filename']=$fz; $g3['filesize']=stat ($fz)['size']; return $g3; } function u3 ($cy){ $cy = h3 ($cy); if ($cy === null){ return [ 'success' => false,'error' => 'invalid path' ]; } $az = t2 ($cy); if (!$az['is-local?'] or $az['type']==='unsupported'){ return [ 'success' => false,'error' => 'unsupported type' ]; } $qz = (string) @$az['local-folder']; $lz = (string) @$az['local-full-filename']; if ($qz === '' or $lz === ''){ return [ 'success' => false,'error' => 'invalid path' ]; } $qz = rtrim ($qz,'/\\').'/'; if(strpos ($lz,$qz)!==0){ return [ 'success' => false,'error' => 'invalid path' ]; } $zz = (string) @$az['local-full-thumb-filename']; $kz = (strlen ($zz)>0); if ($kz){ if(strpos ($zz,$qz)!==0){ $kz = false; $zz = ''; } } return [ 'success' => true, 'file' => $cy, 'resinfo' => $az, 'local-folder' => $qz, 'local-full-filename' => $lz, 'has-thumbnail?' => $kz, 'local-full-thumb-filename' => $zz, ]; } function i3 () { $xz = ['.gif','.jpg','.jpeg','.png','.svg']; if(e2_is_webp_supported ())$xz[] = '.webp'; if(e2_is_avif_supported ())$xz[] = '.avif'; return $xz; } function o3 () { $xz = ['.gif','.jpg','.jpeg','.png','.svg','.mp3','.ogg','.mp4','.mov']; if(e2_is_webp_supported ())$xz[] = '.webp'; if(e2_is_avif_supported ())$xz[] = '.avif'; return $xz; } function p3 ($ez){ global$_config; if(Log::$a)__log ('Count references for upload <'. $ez .'>'); if(is_file (USER_DIR . 'new-uploads.psa')) { $rz = @unserialize (file_get_contents (USER_DIR . 'new-uploads.psa')); } $tz = '%'. str_replace ('%','#%',$ez) .'%'; em ( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Text` LIKE '". $tz ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $tz ."' ESCAPE '#')", 'get notes where uploads may be referenced' ); $g3 = tm (); $jz = @unserialize ($g3[0]['Uploads']); if (!is_array ($jz)) { foreach ($g3 as $iy){ $wd = jy ( $iy['FormatterID'], @$iy['Text'],'full-rss' ); $jz = r3 ( 'note',$iy, $wd['meta']['resources-detected'] ); } } em ( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Description` LIKE '". $tz ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $tz ."' ESCAPE '#')", 'get tags where uploads may be referenced' ); $g3 = tm (); $hz = @unserialize ($g3[0]['Uploads']); if (!is_array ($hz)) { foreach ($g3 as $ub){ $wd = hy ( @$ub['Description'],'full-rss' ); $hz = r3 ( 'tag',$ub, $wd['meta']['resources-detected'] ); } } if (!is_array ($rz))$rz = []; if (!is_array ($jz))$jz = []; if (!is_array ($hz))$hz = []; $gz = array_merge ($rz,$jz,$hz); if(Log::$a)__log ('References found in relevant entries: '. var_export ($gz,true)); if(in_array ($ez,$gz)) { if(Log::$a)__log ('Still referenced, do not delete file'); return true; } return false; } function cy ($wz,$cn){ global$_config; if ($wz == 'note' and $cn == 'new'){ if(is_file (USER_DIR . 'new-uploads.psa')) { $gz = @unserialize (file_get_contents (USER_DIR . 'new-uploads.psa')); } } elseif ($wz == 'note'){ em ( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $cn ); $g3 = tm (); $gz = @unserialize ($g3[0]['Uploads']); } elseif ($wz == 'tag'){ em ( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $cn ); $g3 = tm (); $gz = @unserialize ($g3[0]['Uploads']); } if (!is_array ($gz))$gz = []; return $gz; } function vy ($wz,$cn,$gz){ global$_config; if ($wz == 'note' and $cn == 'new'){ if (!@e3 (USER_DIR . 'new-uploads.psa',serialize ($gz))) { return false; } } elseif ($wz == 'note'){ em ( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize ($gz) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $cn ); } elseif ($wz == 'tag'){ em ( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize ($gz) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $cn ); } else { return false; } if (!is_array ($gz))$gz = []; return $gz; } function by ($wz,$cn){ if (!$wz) return; if ($wz === 'note'){ if ($cn !== 'new' and $cn !== '' and $cn !== null){ e2_drop_caches_for_note_((int)$cn,null); } return; } if ($wz === 'tag'){ cb (); if(is_numeric ($cn)) { e2_drop_caches_for_tag_((int)$cn); } else { e2_drop_caches_for_tag_(null); } } } function yy ($wz,$cn,$action,$uz){ $gz = []; if(Log::$a)__log ('Register upload: <'. $wz.', '. $cn.', '. $action.', '. $uz .'>'); $gz = cy ($wz,$cn); $gz = p1 ($gz,$action,$uz); return vy ($wz,$cn,$gz); } function ny ($vb,$iz,$b3){ $t4 = @unserialize ($iz['Uploads']) or $t4 = []; $oz = j2 ($b3); $gz = p1 ($t4,'add',$oz); $gz = serialize ($gz); if ($gz != $iz['Uploads']) { $iz['Uploads']=$gz; km (sl (), $vb,$iz); } } function e2j_file_upload ($parameters = []) { global$_config,$_strings; ms (); $rl = [ 'success' => false ]; if (!count ($_FILES)) { if(Log::$a)__log ('Ajax file upload error: no files'); $rl['error']['message']='No files were received by server'; die (json_encode ($rl)); } $cy = array_pop ($_FILES); if(Log::$a)__log ('Ajax file upload: "'. $cy['name'].'"'); if ($cy['error']) { if(Log::$a)__log ('Ajax file upload: Error '. $cy['error']); if(4 != $cy['error'])$rl['error']['message'] = ( ly ($cy['error']) ); die (json_encode ($rl)); } $az = t2 ($cy['name']); if ($az['type']==='unsupported'){ if(Log::$a)__log ('Ajax file upload: unsupported type for "'. $cy['name'] .'"'); $rl['error']['message'] = ( _S ('er--supported-file-types') .' '. implode (', ',o3 ()) ); die (json_encode ($rl)); } @qq ($_config['path_media'].PICTURES_DIRNAME); @chmod ($_config['path_media'].PICTURES_DIRNAME,$_config['uploaded_files_mode']); @qq ($_config['path_media'].VIDEO_DIRNAME); @chmod ($_config['path_media'].VIDEO_DIRNAME,$_config['uploaded_files_mode']); @qq ($_config['path_media'].AUDIO_DIRNAME); @chmod ($_config['path_media'].AUDIO_DIRNAME,$_config['uploaded_files_mode']); $pz = (int) ( array_key_exists ('overwrite',$_GET) and is_file ($az['local-folder'].$cy['name']) ); $rl['data']['overwrite']=$pz; if(Log::$a)__log ('Ajax file upload: Overwrite is <'. $pz.'>'); $ck = j3 ( $cy['name'],$az['default-filename'] ); if(Log::$a)__log ('Ajax file upload: Safe name is <'. $ck.'>'); $vk = tempnam ($az['local-folder'],'upload-'); if (!$vk){ if(Log::$a)__log ('Ajax file upload: Cannot create a temporary file'); $rl['error']['message']=_S ('gs--error-occurred'); die (json_encode ($rl)); } if (!move_uploaded_file ($cy['tmp_name'],$vk)) { if(Log::$a)__log ('Ajax file upload: Cannot stage uploaded file'); @unlink ($vk); $rl['error']['message']=_S ('gs--error-occurred'); die (json_encode ($rl)); } @chmod ($vk,$_config['uploaded_files_mode']); $nz = $vk; $bk = $cy['size']; if(Log::$a)__log ('Ajax file upload: Resource type is "'. $az['type'].'"'); if ($az['type']=='local-image'){ $cz = pathinfo ($ck,PATHINFO_EXTENSION); $yk = $nz; $nk = $nz; $mk = ed ($cz,'jpg'); $fk = null; $dk = false; if (!$mk){ $sk = $ck . '.jpg'; $fk = tempnam ($_config['path_media'].PICTURES_DIRNAME,'upload-'); if (!$fk){ if(Log::$a)__log ('Ajax file upload: Cannot create a temporary jpg file'); @unlink ($yk); $rl['error']['message']=_S ('gs--error-occurred'); $rl = json_encode ($rl); die ($rl); } $nk = $fk; } if(Log::$a)__log ('Ajax file upload: Process uploaded image "'. $yk .'"'. ' to possibly "'. $nk .'"'); $ak = false; $nk = e2img_filename_by_processing ( $yk, $nk, [ $_config['fit_uploaded_images'], $_config['fit_uploaded_images'], ], CROP_NONE, SCALED_IMAGE_JPG_QUALITY, $ck ); if ($nk !== false){ if (!ed ($nk,$yk)) { $ck = $sk; if(is_file ($yk)) @unlink ($yk); } $qk = w3 ( $_config['path_media'].PICTURES_DIRNAME, $ck, $nk, $pz ); $ck = $qk['name']; $nk = $qk['full-filename']; $dk = $qk['existing-file?']; $bk = $qk['filesize']; if ($pz){ @unlink (nd ($ck)); } if ($lk = e2img_filename_by_processing ( $nk, nd ($ck), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY )) { if (yy ($parameters['entity'],$parameters['entity-id'],'add', [$ck])) { if(Log::$a)__log ('Ajax file upload: thumbnail, done as '. $lk); by ($parameters['entity'],$parameters['entity-id']); list ($zk,$kk)=e2_getimagesize ($lk); if(Log::$a)__log ('Ajax file upload: image size '. $zk .'×'. $kk); if (!$zk)$zk = THUMB_WIDTH/2; if (!$kk)$kk = THUMB_HEIGHT/2; list ($zk,$kk)=e2_fit_metrics_to_constraints ( [$zk,$kk], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $rl['success']=true; $rl['data']['new-name']=$ck; $rl['data']['filesize']=round ($bk / 1024) .' '. $_strings['gs--kb']; $rl['data']['thumb']=my ($lk); $rl['data']['width']=$zk; $rl['data']['height']=$kk; } else { if(Log::$a)__log ('Ajax file upload: couldn’t register upload'); if (!$dk){ @unlink ($nk); } @unlink ($lk); $rl['error']['message']=_S ('er--cannot-register-upload'); } } else { $ak = true; if ( !$dk and $nk !== false and is_file ($nk) ) { @unlink ($nk); } } } else { $ak = true; if ($fk and is_file ($fk)) { @unlink ($fk); } if(is_file ($yk)) { @unlink ($yk); } } if ($ak){ if(Log::$a)__log ('Ajax file upload: couldn’t process image for resizing'); if ( !$dk and $nk !== false and isset ($nk) and is_file ($nk) ) { @unlink ($nk); } $rl['error']['message']=_S ('er--cannot-create-thumbnail'); } } if ($az['type']=='local-video'){ $qk = w3 ( $az['local-folder'], $ck, $nz, $pz ); $ck = $qk['name']; $bk = $qk['filesize']; if(Log::$a)__log ('Ajax file upload: video, done'); $rl['success']=true; $rl['data']['new-name']=$ck; $rl['data']['filesize']=round ($bk / 1024) .' '. $_strings['gs--kb']; $rl['data']['thumb']=SYSTEM_THEME_DIR . VIDEO_ICON_FILENAME; $rl['data']['width']=VIDEO_ICON_WIDTH/2; $rl['data']['height']=VIDEO_ICON_HEIGHT/2; if (yy ($parameters['entity'],$parameters['entity-id'],'add', [$ck])) { by ($parameters['entity'],$parameters['entity-id']); } } if ($az['type']=='local-audio'){ $qk = w3 ( $az['local-folder'], $ck, $nz, $pz ); $ck = $qk['name']; $bk = $qk['filesize']; if(Log::$a)__log ('Ajax file upload: audio, done'); $rl['success']=true; $rl['data']['new-name']=$ck; $rl['data']['filesize']=round ($bk / 1024) .' '. $_strings['gs--kb']; $rl['data']['thumb']=SYSTEM_THEME_DIR . AUDIO_ICON_FILENAME; $rl['data']['width']=AUDIO_ICON_WIDTH/2; $rl['data']['height']=AUDIO_ICON_HEIGHT/2; if (yy ($parameters['entity'],$parameters['entity-id'],'add', [$ck])) { by ($parameters['entity'],$parameters['entity-id']); } } $rl = json_encode ($rl); die ($rl); } function my ($xk){ global$_config; $ek = strlen ($_config['path_media']); if ($ek and substr ($xk,0,$ek)==$_config['path_media']) { return substr ($xk,$ek); } else { return AeEnv::$p . $xk; } } function fy () { return [ 'userpic.original.png', 'userpic.original.jpg', 'userpic@2x.png', 'userpic@2x.jpg', 'userpic-large@2x.jpg', 'userpic-square@2x.jpg', ]; } function dy () { global$_config; foreach (fy () as $ms){ @unlink ($_config['path_media'].USERPIC_DIRNAME . $ms); } } function e2j_userpic_remove () { if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_settings')); } ms (); dy (); $rl = json_encode (['success' => true]); die ($rl); } function e2j_userpic_upload () { global$_config,$_strings; $rl = ['success' => false]; ms (); if(count ($_FILES)!=1){ if(Log::$a)__log ('Ajax userpic upload error: no or too many files'); $rl['error']['message']=$_strings['er--cannot-upload-no-or-too-many-files']; $rl = json_encode ($rl); die ($rl); } $cy = array_pop ($_FILES); if (!$cy['error']) { if(Log::$a)__log ('Ajax userpic upload: <'. $cy['name'].'>'); $rk = pathinfo ($cy['name']); $cz = '.'. strtolower ((string) @$rk['extension']); $tk = i3 (); if (!in_array ($cz,$tk,true)) { $rl['error']['message'] = ( _S ('er--supported-image-types') .' '. implode (', ',$tk) ); $rl = json_encode ($rl); die ($rl); } $jk = ($cz === '.png')?'png' : 'jpg'; $ds = 'userpic.original.'. $jk; $fs = $_config['path_media'].USERPIC_DIRNAME; if (!@qq ($fs)) { if(Log::$a)__log ('Can’t create directory <'. $fs .'>'); $rl = json_encode ($rl); die ($rl); } dy (); move_uploaded_file ($cy['tmp_name'],$fs . $ds); @chmod ($fs . $ds,$_config['uploaded_files_mode']); copy ( $fs . $ds, $fs .'userpic-large@2x.jpg' ); e2img_filename_by_processing ( $fs .'userpic-large@2x.jpg', $fs .'userpic-large@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_NONE, $_config['userpic_jpeg_quality'] ); copy ( $fs . $ds, $fs .'userpic-square@2x.jpg' ); $gk = e2img_filename_by_processing ( $fs .'userpic-square@2x.jpg', $fs .'userpic-square@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_SQUARE, $_config['userpic_jpeg_quality'] ); e2img_filename_by_processing ( $fs . $ds, $fs .'userpic@2x.jpg', [$_config['userpic_size'],$_config['userpic_size']], CROP_SQUARE, $_config['userpic_jpeg_quality'] ); if ($gk){ $uk = str_replace ($_config['path_media'],'',$gk); $rl = [ 'success' => true, 'data' => [ 'new-image-src' => $uk, ] ]; } else { $rl['error']['message'] = ( _S ('er--supported-image-types') .' '. implode (', ',i3 ()) ); } } elseif(4 != $cy['error']) { $rl['error']['message'] = ( ly ($cy['error']) ); } $rl = json_encode ($rl); die ($rl); } function e2j_file_rename ($parameters){ global$_strings; $rl = [ 'success' => false, 'error' => ['message' => _S ('er--error-occurred')], ]; if ( !array_key_exists ('file',$_POST) or !array_key_exists ('new-name',$_POST) ) { $rl['error']['message'].=' (request incomplete)'; die (json_encode ($rl)); } ms (); $ik = u3 ($_POST['file']); if (!$ik['success']) { if(Log::$a)__log ( 'Ajax file rename: refused to rename "'. $_POST['file'] .'" ('. $ik['error'] .')' ); $rl['error']['message'] = ( _S ('er--supported-file-types') .' '. implode (', ',o3 ()) ); die (json_encode ($rl)); } $ok = $ik['file']; $u4 = h3 ($_POST['new-name']); if ($u4 === null){ if(Log::$a)__log ('Ajax file rename: invalid new name "'. $_POST['new-name'] .'"'); $rl['error']['message'].=' (invalid new name)'; die (json_encode ($rl)); } if(Log::$a)__log ('Rename "'. $ok .'" to "'. $u4 .'" {'); if (xd ($ok)!==xd ($u4)) { $pk = pathinfo ($ok); $c7 = (string) @$pk['extension']; $u4 .= '.'. $c7; if(Log::$a)__log ('Cannot change file type while renaming, will rename to "' . $u4 .'"'); } $v7 = $ik['local-folder'].$u4; if(strpos ($v7,$ik['local-folder']) !== 0){ if(Log::$a)__log ('Ajax file rename: folder mismatch for "'. $u4 .'"'); $rl['error']['message'].=' (folder mismatch)'; die (json_encode ($rl)); } $b7 = is_file ($v7); if ( $b7 and ( file_get_contents ($ik['local-full-filename']) !== file_get_contents ($v7) ) ) { if(Log::$a)__log ('Target file exists and has different content, cancelling'); $rl['error']['message']=$_strings['er--cannot-rename-file-exists']. ': '. $u4; die (json_encode ($rl)); } if (yy ($parameters['entity'],$parameters['entity-id'],'remove',$ok)) { by ($parameters['entity'],$parameters['entity-id']); } if ($b7){ if(Log::$a)__log ('Target file exists and is identical, will merge'); if (p3 ($ok)) { if(Log::$a)__log ('Referenced in another entity, will register under new name with this entity'); } else { if(Log::$a)__log ('Not referenced in another entity, will delete and register under new name with this entity'); $y7 = [$ik['local-full-filename']]; if ($ik['has-thumbnail?']) { $y7[] = $ik['local-full-thumb-filename']; } foreach ($y7 as $n7){ if(Log::$a)__log ('Not referenced, deleting '. $n7); @unlink ($n7); } } if (yy ($parameters['entity'],$parameters['entity-id'],'add', [$u4])) { by ($parameters['entity'],$parameters['entity-id']); } } else { if (p3 ($ok)) { if(Log::$a)__log ('Referenced in another entity, will make a copy'); $m7 = 'copy'; } else { if(Log::$a)__log ('Not referenced in another entity, will rename'); $m7 = 'rename'; } if (@$m7 ( $ik['local-full-filename'], $v7 )) { if (yy ($parameters['entity'],$parameters['entity-id'],'add', [$u4])) { by ($parameters['entity'],$parameters['entity-id']); } if ($ik['has-thumbnail?']) { if(Log::$a)__log ('Will also try to copy/rename a thumbnail'); @$m7 ( $ik['local-full-thumb-filename'], nd ($u4) ); } } else { if(Log::$a)__log ('Error: couldn’t '. $m7); $rl['error']['message'].=' (couldn’t '. $m7 .')'; die (json_encode ($rl)); } } $rl = [ 'success' => true ]; $rl['data']['new-name']=$u4; $rl = json_encode ($rl); if(Log::$a)__log ('}'); die ($rl); } function e2j_file_remove ($parameters){ $rl = [ 'success' => false ]; if (!array_key_exists ('file',$_POST)) die (json_encode ($rl)); ms (); $ik = u3 ($_POST['file']); if (!$ik['success']) { if(Log::$a)__log ( 'Ajax file remove: refused to remove "'. $_POST['file'] .'" ('. $ik['error'] .')' ); $rl['error']['message'] = ( _S ('er--supported-file-types') .' '. implode (', ',o3 ()) ); die (json_encode ($rl)); } if (yy ( $parameters['entity'],$parameters['entity-id'],'remove',$ik['file'] )) { by ($parameters['entity'],$parameters['entity-id']); } if (!p3 ($ik['file'])) { $y7 = [$ik['local-full-filename']]; if ($ik['has-thumbnail?']) { $y7[] = $ik['local-full-thumb-filename']; } foreach ($y7 as $n7){ if(Log::$a)__log ('Not referenced, deleting "'. $n7 .'"'); @unlink ($n7); } } $rl['success']=true; die (json_encode ($rl)); } function sy () { global$_config; if (!$_config['files_total_size_limit']) return false; $f7 = 0; foreach(glob ($_config['path_media'].PICTURES_DIRNAME .'/*') as $cy){ $d7 = stat ($cy); $f7 += $d7['size']; } foreach(glob ($_config['path_media'].VIDEO_DIRNAME .'/*') as $cy){ $d7 = stat ($cy); $f7 += $d7['size']; } foreach(glob ($_config['path_media'].AUDIO_DIRNAME .'/*') as $cy){ $d7 = stat ($cy); $f7 += $d7['size']; } $s7 = $_config['files_total_size_limit']; $a7 = o1 ($f7,$s7); return [$f7,$s7,$a7]; } function ay ($q7){ $l7 = true; if (list ($f7,$s7,$a7)=$q7){ $l7 = ($s7 - $f7)>0; } return $l7; } function qy ($q7,$z7 = false){ $k7 = ''; if (list ($f7,$s7,$a7)=$q7){ $q7 = [ 'used' => round ($f7 / 1024 / 1024), 'total' => round ($s7 / 1024 / 1024), 'percent' => $a7 ]; if ($z7 or ($s7 - $f7)<1024 * 1024 * 10){ if ($f7 < $s7){ $k7 = e2l_get_string ('gs--used',$q7); } else { $k7 = e2l_get_string ('gs--used-all',$q7); } } } return $k7; } function ly ($oq){ global$_strings; if ($oq == UPLOAD_ERR_INI_SIZE){ $wq = $_strings['er--cannot-upload-file-too-big']; } elseif ($oq == UPLOAD_ERR_FORM_SIZE){ $wq = $_strings['er--cannot-upload-file-too-big']; } else { $wq = e2l_get_string ('er--cannot-upload', ['error' => $oq]); } return $wq; } function xy ($we){ $prefix = 'Neasden\\'; if(BUILT){ $ue = __DIR__ . '/library/neasden/'; } else { $ue = __DIR__ . '/../library/neasden/'; } $ek = strlen ($prefix); if(strncmp ($prefix,$we,$ek)!==0) return; $ie = substr ($we,$ek); $cy = $ue . str_replace ('\\','/',$ie).'.php'; if(file_exists ($cy)) require $cy; } function ey ($oe = null){ global$_config,$_lang; $pe = new Neasden\Configuration (); $pe->baseUrl = AeEnv::$p; $pe->pathMedia = $_config['path_media']; $pe->additionalExtensionsFolder = 'user/library/neasden/'; $pe->language = $_lang; $pe->htmlOn = true; $pe->htmlElementsOpaque = 'p ul ol li pre'; $pe->htmlElementsIgnore = 'div blockquote table tr td th thead tbody tfoot caption colgroup col'; $pe->htmlElementsSacred = 'object embed iframe head link script style code textarea'; $pe->htmlBasic = false; $pe->htmlCodeOn = true; $pe->htmlCodeWrap = [ '<pre class="e2-text-code"><code class="%s">', '</code></pre>' ]; $pe->htmlCodeRequireLinks = [ 'highlight/highlight.js', 'highlight/highlight.css', ]; $pe->htmlImgSrcPrefix = PICTURES_DIRNAME; $pe->htmlImgDetect = true; $pe->groupsOn = true; $pe->groupsHeadingsChar = '#'; $pe->groupsHeadingsPlus = 1; $pe->groupsQuotesChar = '>'; $pe->groupsListsChars = ['-','*']; $pe->groupsGenericCssClass = 'e2-text-generic-object'; $pe->extensions = [ 'HR', 'Block', 'AeOldList', 'Table' => [ 'css-class' => 'e2-text-table', ], 'Tweet' => [ 'css-class' => 'e2-text-generic-object', ], ]; $pe->typographyOn = true; $pe->typographyQuotes = true; $pe->typographyMarkup = true; $pe->typographyAutoHref = true; $pe->typographyNoFollowHrefs = false; $pe->typographyUndecoratedLinksCssClass = 'nu'; $pe->typographyCleanup = [ '&nbsp;' => ' ', '&laquo;' => '«', '&raquo;' => '»', '&bdquo;' => '„', '&ldquo;' => '“', '&rdquo;' => '”', ]; if ($oe === 'full' or $oe === 'full-rss'){ $pe->htmlOn = true; $pe->groupsOn = true; $pe->typographyMarkup = true; $pe->extensions = array_merge ($pe->extensions, [ 'MediaTimecodes', 'Picture' => [ 'src-prefix' => PICTURES_DIRNAME, 'folder' => PICTURES_DIRNAME, 'css-class' => 'e2-text-picture', 'max-width' => $_config['max_image_width'], ], 'Fotorama' => [ 'src-prefix' => PICTURES_DIRNAME, 'folder' => PICTURES_DIRNAME, 'css-class' => 'e2-text-picture', 'max-width' => $_config['max_image_width'], ], 'Video' => [ 'src-prefix' => VIDEO_DIRNAME, 'folder' => VIDEO_DIRNAME, 'css-class' => 'e2-text-video', 'max-width' => $_config['max_image_width'], 'getid3-path' => SYSTEM_DIR . LIBRARY_DIRNAME . 'getid3/getid3.php', ], 'OnlineVideo' => [ 'css-class' => 'e2-text-video', 'max-width' => $_config['max_image_width'], 'ratio' => 16/9, ], 'Audio' => [ 'src-prefix' => AUDIO_DIRNAME, 'folder' => AUDIO_DIRNAME, 'css-class' => 'e2-text-audio', 'getid3-path' => SYSTEM_DIR . LIBRARY_DIRNAME . 'getid3/getid3.php', ], ]);; } if ($oe === 'simple' or $oe === 'simple-rss'){ $pe->htmlOn = false; $pe->groupsOn = true; $pe->typographyMarkup = true; } if ($oe === 'full-rss' or $oe === 'simple-rss'){ $pe->htmlBasic = true; } if ($oe === 'kavychki'){ $pe->htmlOn = true; $pe->htmlCodeOn = false; $pe->groupsOn = false; $pe->typographyMarkup = false; $pe->typographyAutoHref = false; } return $pe; } function ry ($o1){ $pe = ey ('kavychki'); $c6 = new Neasden\Model (); $c6 -> addOpaqueElement ($o1); $v6 = new Neasden\Renderer ($pe,$c6); return $v6 -> getHTML (); } function ty ($b6,$o1){ if ($o1 === '') return []; if ($b6 === 'neasden'){ $pe = ey ('full'); $y6 = new Neasden\Interpreter ($pe,$o1); return $y6 -> getModel () -> getResources (); } else { return []; } } function jy ($b6,$o1,$oe){ if(Log::$a)__log ('Format: format with formatter "'. $b6 .'" in context "'. $oe.'"'); $meta = []; $rb = '-'; if ($b6 === 'neasden'){ $pe = ey ($oe); $y6 = new Neasden\Interpreter ($pe,$o1); $v6 = new Neasden\Renderer ($pe,$y6 -> getModel ()); $o1 = $v6 -> getHTML (); $c6 = $y6 -> getModel (); $rb = $c6 -> getFlow (); $meta = [ 'links-required' => $c6 -> getLinks (), 'resources-detected' => $c6 -> getResources (), ]; } return [ 'text-final' => $o1, 'text-flow' => $rb, 'meta' => $meta, ]; } function hy ($o1,$oe){ return jy (DEFAULT_FORMATTER,$o1,$oe); } function e2m_frontpage ($parameters = []) { global$settings,$_strings,$_config; if(Log::$a)__log ('Frontpage {'); $mm = ss (); $frontpageView = new AePageableNotesView ('e2m_frontpage',$parameters); $frontpageView -> setPortionSize ($settings['appearance']['notes_per_page']); $frontpageView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $frontpageView -> setWantPaging (true); $frontpageView -> setWantNewCommentsCount ($mm); $frontpageView -> setWantReadHrefs ($_config['count_reads']); $frontpageView -> setWantControls ($mm and !@$_config['read_only']); $frontpageView -> setWantHiddenTags ($mm); $frontpageView -> setWantRelatedNotes (true); if(CACHE_FRONTPAGE and $frontpageView -> isFirstPage ()) { if ($mm){ $frontpageView -> setCacheFilename (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); } else { $frontpageView -> setCacheFilename (USER_DIR . CACHE_FILENAME_FRONTPAGE); } } $frontpageView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". xf ($mm). "ORDER BY `Stamp` DESC" ); $ts = ev (); if($parameters['page']>1){ $ts .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $bb = [ 'title' => $ts, 'heading' => '', 'notes' => $frontpageView -> getNotesCTree (), 'pages' => $frontpageView -> getPagesCTree (), 'frontpage?' => $frontpageView -> isFirstPage (), ]; if ( !$frontpageView -> isExistingPage () and !$frontpageView -> isFirstPageOfEmptyView () ) { return e2m_error404 (); } if(Log::$a)__log ('} // Frontpage'); return $bb; } abstract class E2GIP { protected $gip_cookie_name = 'gip'; protected $gip_token_cookie_name = 'gip_access_token'; protected $gip_token = null; abstract public function get_auth_url (); abstract public static function get_profile_url ($cn,$n6); abstract public function callback (); const PHP_VERSION_VK_FEATURE = 70100; public static function set_session_data ($xn,$bv){ if(session_status () == PHP_SESSION_NONE){ session_start (); } $_SESSION[$xn]=$bv; } public static function get_session_data ($xn,$m6 = false){ if(session_status () == PHP_SESSION_NONE){ session_start (); } if(!isset ($_SESSION[$xn])) { return null; } $bv = $_SESSION[$xn]; if ($m6) unset($_SESSION[$xn]); return $bv; } public function get_config ($xn){ $f6 = 'gips/'. $this->type .'.json'; $gl = false; foreach ([USER_DIR,INSTANCE_DIR,SYSTEM_DIR] as $d6){ if(is_file ($d6 . $f6)) { $gl = @file_get_contents ($d6 . $f6); break; } } if ($gl !== false){ $bb = json_decode ($gl,true,512,JSON_BIGINT_AS_STRING)[$xn]; if ($bb) return $bb; } return null; } public function get_callback_url () { return wq ('e2m_gip_sign_in_callback', ['provider' => $this->type]); } protected function get_proxy_param () { global$settings; $s6 = DEFAULT_LANGUAGE; if(array_key_exists ('language',$settings))$s6 = $settings['language']; return '?language=' . $s6 . '&type=' . $this->type . '&callback_url=' . urlencode ($this -> get_callback_url ()); } public function get_gip_session_data () { global$_config; $a6 = $this->gip_token ? $this->gip_token : $_COOKIE[j1 ($this->gip_token_cookie_name)]; em ( "SELECT * FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '". $this->type ."' ". "AND `SessionToken` = '" . jm($a6)."' ". "ORDER BY `ID` DESC LIMIT 1", 'get GIP session data' ); $g3 = tm (); return $g3 ? $g3[0] : []; } public function is_logged_in () { if ( empty ($_COOKIE[j1 ($this->gip_cookie_name)]) || !in_array ($_COOKIE[j1 ($this->gip_cookie_name)], gy ()) || $_COOKIE[j1 ($this->gip_cookie_name)] != $this->type || empty ($_COOKIE[j1 ($this->gip_token_cookie_name)]) ) { return false; } $kb = $this -> get_gip_session_data (); return (bool)$kb; } protected function save_session ($cn,$name,$accessToken,$q6 = '',$userEmail = '',$userLink = ''){ $rf = time (); zm ( sl (), 'GIPsSessions', [ 'GIP' => $this->type, 'GIPAuthorID' => $cn, 'AuthorName' => $name, 'AuthorEmail' => $userEmail, 'AuthorProfileLink' => $userLink, 'SessionToken' => $accessToken, 'Stamp' => $rf, ], 'INSERT', 'ON DUPLICATE KEY UPDATE '. '`SessionToken` = "' . jm ($accessToken).'", '. '`AuthorName` = "' . jm ($name).'", '. '`Stamp` = "' . $rf . '"' ); w1 ($this->gip_cookie_name,$this->type); w1 ($this->gip_token_cookie_name,$accessToken); if (isset ($userEmail) && !empty ($userEmail))w1 ('commenter_email',$userEmail); $this->gip_token = $accessToken; } public static function get_logout_key () { if ($l6 = self::get_session_data ('logout_key')) { return $l6; } $l6 = md5 (microtime ()); self::set_session_data ('logout_key',$l6); return $l6; } public static function is_valid_logout_key ($xn){ $z6 = self::get_session_data ('logout_key',true); if (empty ($z6) || empty ($xn) || $z6 != $xn){ return false; } return true; } public function logout () { global$_config; w1 ($this->gip_cookie_name); w1 ($this->gip_token_cookie_name); em ( "DELETE FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '" . $this->type . "' ". "AND `SessionToken` = '" . jm ($_COOKIE[j1 ($this->gip_token_cookie_name)]) . "'", 'logout' ); } public function get_avatar_size () { return AVATAR_SIZE; } public function save_avatar ($cn,$k6){ global$_config; if (!preg_match ('/^https?\:\/\//i',$k6)) return; $k6 = str_replace ("\0",'',$k6); $cn = preg_replace ('/[^a-zA-Z0-9._-]/','',$cn); $cn = substr ($cn,0,64); @qq ($_config['path_media'].AVATARS_DIRNAME); @chmod ($_config['path_media'].AVATARS_DIRNAME,$_config['uploaded_files_mode']); $ds = $_config['path_media'].AVATARS_DIRNAME . $this->type .'-'. $cn .'.jpg'; if ($x6 = file_get_contents ($k6)) { file_put_contents ($ds,$x6); } return $ds; } } function e2m_gip_sign_in ($kb){ $type = $kb['provider']; $e6 = uy ($type); if (!$e6)t1 (); header ('Location: ' . $e6 -> get_auth_url ()); die; } function e2m_gip_sign_in_callback ($kb){ $type = $kb['provider']; $e6 = uy ($type); if (!$e6) return e2m_error404 (); $r6 = $e6 -> callback (); if (!$r6) return e2m_error404 (); echo '<script>'; $z1 = $e6 -> get_gip_session_data (); $t6 = [ 'name' => $z1['AuthorName'], 'gipIcon' => _SVG ($type), 'logoutUrl' => wq ('e2m_gip_sign_out', ['provider' => E2GIP::get_logout_key ()]), ]; echo 'window.opener.oauthAuthorized(' . json_encode ($t6).');'; echo 'window.close();</script>'; die; } function e2m_gip_sign_out ($kb){ $l6 = $kb['provider']; if (!E2GIP::is_valid_logout_key ($l6)) { return e2m_error404 (); } $e6 = py (); if ($e6)$e6 -> logout (); t1 (); } function gy () { global$_config; static $y1 = null; if ($y1 !== null) return $y1; $j6 = (string) @$_config['sign_in_with']; $h6 = '|twitter|facebook|vk|telegram|'; $g6 = SYSTEM_DIR .'gips/'; $y1 = []; foreach(explode (',',$j6) as $w6){ $w6 = trim ($w6); if ($w6 == 'vkontakte')$w6 = 'vk'; if (!strstr ($h6,'|'. $w6. '|')) continue; if (!is_file ($g6 . $w6 .'.php')) continue; if(in_array ($w6,$y1)) continue; if ($w6 === 'vk' and PHP_VERSION_ID < E2GIP::PHP_VERSION_VK_FEATURE) continue; $y1[] = $w6; } return $y1; } function wy ($type){ return "E2GIP" . ucfirst($type); } function uy ($type){ if (!in_array ($type,gy ())) { return false; } $u6 = wy ($type); $e6 = new $u6; return $e6; } function iy ($type){ return wq ('e2m_gip_sign_in', ['provider' => $type]); } function oy ($type = ''){ $i6 = !$type ? gy () : [$type]; foreach ($i6 as$type){ $e6 = uy ($type); if ($e6 && $e6 -> is_logged_in ()) { return true; } } return false; } function py () { foreach (gy () as$type){ $e6 = uy ($type); if ($e6 && $e6 -> is_logged_in ()) { return $e6; } } return false; } function cn () { foreach (gy () as$type){ $e6 = uy ($type); if ($e6 && $e6 -> is_logged_in ()) { return$type; } } return false; } function vn ($type,$cn,$n6){ $u6 = wy ($type); if(class_exists ($u6)) { return $u6::get_profile_url ($cn,$n6); } else { return false; } } function bn ($type){ $e6 = uy ($type); if (!$e6 || !$e6 -> is_logged_in ()) { return false; } return $e6 -> get_gip_session_data (); } function yn ($we){ $ds = SYSTEM_DIR .'gips/'. strtolower (str_replace ('E2GIP','',$we)) .'.php'; if(is_file ($ds)) require $ds; } function e2s_notify () { global$_config; if (!$_config['holborn']) die; $o6 = @$_GET['src']; if ($o6 == ''){ if(Log::$a)__log ('Holborn: No src URL'); die; } $gl = file_get_contents ($o6); $gl = dn ($gl); $p6 = json_decode ($gl,true); if (!$p6){ if(Log::$a)__log ('Holborn: No meaningful info from '. $o6 .' ('. json_last_error () .')'); if ($cr = mn ($o6)) { if(Log::$a)__log ('Holborn: Delete note with ID '. $cr['ID']); vf ($cr['ID']); } die; } nn ($p6,$o6); } function e2m_sources ($parameters){ global$_config; if (!$_config['holborn']) return e2m_error404 (); $vr = $_GET['ord']; $br = ''; if (@$vr[0]=='!'){ $vr = substr ($vr,1); $br = ' DESC'; } if (!$vr)$vr = 'ID'; $vr = "`". jm ($vr) ."`"; em ( "SELECT S.*, ". "REPLACE(REPLACE(REPLACE(S.`URL`, 'http://', ''), 'https://', ''), 'www.', '') AS _URLX, ". "COUNT(N.`ID`) AS NotesCount, ". "MAX(N.`Stamp`) AS LastNoteStamp ". "FROM `". $_config['db_table_prefix']."Sources` AS S, " . " `". $_config['db_table_prefix']."Notes` AS N " . "WHERE S.`SubsetID`=". $_config['db_table_subset'] ." ". "AND N.`SubsetID`=". $_config['db_table_subset'] ." ". "AND S.`ID` = N.`SourceID`". "GROUP BY S.`ID` ". "ORDER BY ". $vr ." ". $br ." ". "LIMIT 100" ); $g3 = tm (); foreach ($g3 as $ql){ $yr = $ql['ID']; if ($ql['ID']!=$ql['TrueID'])$yr = '<s>'.$yr.'</s><br />='. $ql['TrueID']; $source = [ 'id' => $yr, 'userpic-href' => $ql['PictureURL'], 'href' => $ql['URL'], 'href-display' => str_replace ('/','/<wbr>',$ql['URL']), 'href-filtered' => str_replace ('/','/<wbr>',$ql['_URLX']), 'title' => $ql['Title'], 'author' => $ql['AuthorName'], 'true?' => $ql['ID']==$ql['TrueID'], 'whitelisted?' => (bool)$ql['IsWhiteListed'], 'trusted?' => (bool)$ql['IsTrusted'], 'notes-count' => $ql['NotesCount'], 'latest-note-time' => [$ql['LastNoteStamp'],0], ]; if (!$ql['IsTrusted']) { $source['trust-url']=wq ( 'e2m_source_trust', ['source' => $ql['ID']] ); } if ($ql['IsTrusted']) { $source['premoderate-url']=wq ( 'e2m_source_premoderate', ['source' => $ql['ID']] ); } $source['ban-url']=wq ( 'e2m_source_ban', ['source' => $ql['ID']] ); $source['forget-url']=wq ( 'e2m_source_forget', ['source' => $ql['ID']] ); $nr[] = $source; } $bb = [ 'title' => 'Sources', 'heading' => 'Sources', ]; if(count ($nr)) { $bb['sources']=$nr; } else { $bb['nothing']='No sources'; } return $bb; } function e2m_source_trust ($parameters){ global$_config; $mr = $parameters['source']; em ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhitelisted`=1, `IsTrusted`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $mr, 'trust source' ); em ( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $mr, 'publish all notes from the just trusted source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); @unlink (USER_DIR . CACHE_FILENAME_INDEXED_FLAG); r1 (); } function e2m_source_premoderate ($parameters){ global$_config; $mr = $parameters['source']; em ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $mr, 'distrust source, set to premoderation' ); cb (); r1 (); } function e2m_source_ban ($parameters){ global$_config; $mr = $parameters['source']; em ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $mr, 'ban source' ); em ( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $mr, 'delete all notes from the just banned source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); r1 (); } function e2m_source_forget ($parameters){ global$_config; $mr = $parameters['source']; em ( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $mr, 'forget source' ); em ( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $mr, 'delete all notes from the just forgotten source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); r1 (); } function nn ($fr,$o6){ global$_config; if (!array_key_exists ('author',$fr)) { $fr['author']=$fr['authors'][0]; } $dr = sn ([ 'author' => $fr['author']['name'], 'title' => $fr['title'], 'href' => $fr['author']['url'], 'userpic-href' => $fr['author']['avatar'], ]); if (!$dr['IsWhiteListed']) return; if(preg_match ('/\+(\d\d)\:(\d\d)/',$fr['items'][0]['date_published'],$sr)) { $j3 = $sr[1]*SECONDS_IN_AN_HOUR + $sr[2]*SECONDS_IN_A_MINUTE; } $ar = @$fr['items'][0]['_e2_data'] or $ar = []; $ar = json_encode ($ar); $qr = $dr['IsTrusted']; $databaseConfiguration = sl (); $iy = [ 'Title' => $fr['items'][0]['title'], 'Text' => $fr['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime ($fr['items'][0]['date_published']), 'Offset' => (int)$j3, 'IsDST' => 0, 'LastModified' => strtotime ($fr['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $qr, 'IsExternal' => 1, 'SourceID' => $dr['ID'], 'SourceNoteID' => $fr['items'][0]['id'], 'SourceNoteURL' => $fr['items'][0]['url'], 'SourceNoteJSONURL' => $o6, 'SourceNoteData' => $ar, ]; $note_id = $fr['items'][0]['id']; if ( $cr = fn_ ($dr['ID'],$note_id) ) { $iy['ID']=$cr['ID']; km ($databaseConfiguration,'Notes',$iy); } else { $iy = zm ($databaseConfiguration,'Notes',$iy); } if ($qr){ if (wd ($iy)) { $iy['IsIndexed']='1'; km (sl (), 'Notes',$iy); } } $lr = @$fr['items'][0]['tags']; if(is_array ($lr)) { da ($databaseConfiguration,$iy['ID'],$lr); } e2_drop_caches_for_note_($iy['ID'],$qr); if($_config['backup_automatically']) { hm (); } } function mn ($o6){ global$_config; em ( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceNoteJSONURL`='". jm ($o6) ."' ". "LIMIT 1", 'get note ID by source JSON URL' ); $g3 = tm (); return $g3[0]; } function fn_ ($mr,$zr){ global$_config; em ( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`= '". $mr ."' ". "AND `SourceNoteID`= '". $zr ."' ". "LIMIT 1", 'get note ID by source ID and source note ID' ); $g3 = tm (); return $g3[0]; } function dn ($gl){ for ($wb = 0; $wb <= 31; ++$wb){ $gl = str_replace (chr ($wb),'',$gl); } $gl = str_replace (chr (127),'',$gl); if(0 === strpos (bin2hex ($gl),'efbbbf')) { $gl = substr ($gl,3); } return $gl; } function sn ($kr){ global$_config; $xr = false; em ( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `URL`= '". $kr['href'] ."' ". "LIMIT 1", 'get source record by the URL from blog info' ); $g3 = tm (); if(count ($g3)) { $xr = $g3[0]; if ($xr['ID']!=$xr['TrueID']) { em ( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`= '". $xr['TrueID'] ."' ". "LIMIT 1", 'get true source record by using the TrueID of just found record' ); $g3 = tm (); if(count ($g3)) { $xr = $g3[0]; } } } $dr = [ 'Title' => $kr['title'], 'AuthorName' => $kr['author'], 'PictureURL' => $kr['userpic-href'], ]; if ($xr !== false){ if ( $xr['Title']!==$kr['title'] or $xr['AuthorName']!==$kr['author'] or $xr['PictureURL']!==$kr['userpic-href'] ) { $dr['ID']=$xr['ID']; km (sl (), 'Sources',$dr); } return $xr; } else { $dr['URL']=$kr['href']; $dr['IsWhiteListed']=1; $dr['IsTrusted']=0; $dr = zm (sl (), 'Sources',$dr); $dr['TrueID']=$dr['ID']; km (sl (), 'Sources',$dr); return $dr; } } function an ($iy){ global$_config; $xa = []; if (@$iy['IsExternal']) { if(array_key_exists ('SourceID',$iy)) { em ( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $iy['SourceID'] ."'", 'get source by id' ); $xb = tm (); $xa['source']=$xb[0]['Title']; $xa['source-id'] = (int)$iy['SourceID']; $xa['source-true-id'] = (int)$xb[0]['TrueID']; $xa['source-whitelisted?'] = (bool)$xb[0]['IsWhiteListed']; $xa['source-trusted?'] = (bool)$xb[0]['IsTrusted']; if (!$xb[0]['IsTrusted']) { $xa['source-trust-url']=wq ( 'e2m_source_trust', ['source' => $iy['SourceID']] ); } if ($xb[0]['IsTrusted']) { $xa['source-premoderate-url']=wq ( 'e2m_source_premoderate', ['source' => $iy['SourceID']] ); } $xa['source-ban-url']=wq ( 'e2m_source_ban', ['source' => $iy['SourceID']] ); $xa['source-forget-url']=wq ( 'e2m_source_forget', ['source' => $iy['SourceID']] ); $xa['author']=$xb[0]['AuthorName']; $xa['author-href']=$xb[0]['URL']; $xa['userpic-href']=$xb[0]['PictureURL']; } if(array_key_exists ('SourceNoteURL',$iy) and @$iy['SourceNoteURL']!=''){ $xa['href-external']=$iy['SourceNoteURL']; } } return $xa; } function e2_is_webp_supported () { static $er = null; if ($er !== null) return $er; $er = ( defined ('IMAGETYPE_WEBP') and function_exists ('imagecreatefromwebp') ); return $er; } function e2_is_avif_supported () { static $er = null; if ($er !== null) return $er; $er = ( defined ('IMAGETYPE_AVIF') and function_exists ('imagecreatefromavif') ); return $er; } function e2img_filename_by_processing ( $rr,$tr, $jr,$hr,$gr, $wr = null ) { global$_config; if(Log::$a)__log ('Process image: "'. $rr .'" -> "'. $tr .'"'); if (!is_file ($rr)) { if(Log::$a)__log ('Process image: No source found'); return false; } $ur = stat ($rr)['size']; if ($wr === null){ $wr = $rr; } if (!sd ($wr)) { if(Log::$a)__log ('Process image: SVG, no processing'); return $rr; } if ( is_file ($tr) and filesize ($tr)>0 and !ed ($rr,$tr) ) { if(Log::$a)__log ('Process image: Already exists'); return $tr; } $ir = pathinfo ($tr); if (!@qq ($ir['dirname'])) { if(Log::$a)__log ( 'Process image: Can’t create directory <'. $ir['dirname'] .'>' ); return false; } if(Log::$a)__log ('Process image: Detecting image type'); $type = e2img__type_of_file ($rr); if (!$type) return false; $or_ = 'imagecreatefrom'. $type; if (!function_exists ($or_)) { if(Log::$a)__log ('Process image: Function does not exist ('. $or_ .')'); return false; } if(Log::$a)__log ('Process image: Opening original image ('. $or_ .')'); $pr = call_user_func ($or_,$rr); if (!$pr) return false; if ($ct = e2img__orientation_of_file ($rr)) { if(Log::$a)__log ('Process image: Needs orientation fix'); $pr = e2img__res_rotate ($pr, -$ct); } $vt = [imagesx ($pr),imagesy ($pr)]; $bt = $vt; $yt = [0,0,0,0]; if ($hr == CROP_SQUARE){ if(Log::$a)__log ('Process image: Needs crop'); list ($bt,$yt) = ( e2img__crop_metrics_to_square ($bt) ); } $bt = e2_fit_metrics_to_constraints ( $bt,$jr ); if ( $ct === 0 and $bt === $vt ) { if(Log::$a)__log ('Process image: No changes necessary, leaving original'); return $rr; } if(Log::$a)__log (var_export ($bt,true)); if(Log::$a)__log (var_export ($yt,true)); $nt = e2img__create_copy_resampled ( $pr, $bt, $yt, $type ); imagejpeg ($nt,$tr,$gr); if (!is_file ($tr)) { if(Log::$a)__log ('Process image: File not created by imagejpeg'); return false; } if ($tr !== $rr){ if ($ct === 0){ $mt = stat ($tr)['size']; if ($mt >= $ur){ if(Log::$a)__log ('Process image: Conversion to JPEG made file bigger, back up'); @unlink ($tr); $tr = $rr; } } } @chmod ($tr,$_config['uploaded_files_mode']); if(Log::$a)__log ('Process image: Done'); return $tr; } function e2img__create_copy_resampled ( $pr,$bt,$yt,$type ) { list ($ft,$dt)=$bt; list ($st,$at,$qt,$lt)=$yt; $nt = imagecreatetruecolor ($ft,$dt); if($type === 'png'){ imagefill ($nt,0,0,imagecolorallocate ($nt,255,255,255)); imagealphablending ($nt,true); } $zt = imagesx ($pr); $kt = imagesy ($pr); imagecopyresampled ( $nt, $pr, 0,0, 0 + $st,0 + $at, $ft,$dt, $zt - $qt,$kt - $lt ); imageinterlace ($nt,1); return $nt; } function e2img__type_of_file ($ds){ $xt = @getimagesize ($ds); if (!$xt) return false; if(defined ('IMAGETYPE_GIF') and $xt[2]==IMAGETYPE_GIF) return 'gif'; if(defined ('IMAGETYPE_JPEG') and $xt[2]==IMAGETYPE_JPEG) return 'jpeg'; if(defined ('IMAGETYPE_PNG') and $xt[2]==IMAGETYPE_PNG) return 'png'; if(e2_is_webp_supported () and $xt[2]==IMAGETYPE_WEBP) return 'webp'; if(e2_is_avif_supported () and $xt[2]==IMAGETYPE_AVIF) return 'avif'; return false; } function e2img__orientation_of_file ($ds){ if (!function_exists ('exif_read_data')) return 0; if (($et = @exif_read_data ($ds)) === false) return 0; if (@$et['Orientation']==3) return -180; if (@$et['Orientation']==6) return -270; if (@$et['Orientation']==8) return -90; return 0; } function e2img__res_rotate ($rt,$ct){ $tt = imagerotate ($rt,$ct,0); if ($tt !== false){ imagedestroy ($rt); $rt = $tt; } return $rt; } function e2_fit_metrics_to_constraints ( $jt,$jr ) { if ($jr === false)$jr = [0,0]; list ($zk,$kk)=$jt; list ($ht,$gt)=$jr; $wt = [1]; if ($ht)$wt[] = $ht / $zk; if ($gt)$wt[] = $gt / $kk; $ut = min ($wt); if ($ut < 1){ $zk = (int)round ($zk * $ut); $kk = (int)round ($kk * $ut); } return [$zk,$kk]; } function e2_getimagesize_jpeg ($ds){ $by = @fopen ($ds,'r'); if ($by === false){ throw new \RuntimeException (error_get_last ()['message']); } try { if (!flock ($by,LOCK_SH)) { throw new \RuntimeException ('Cannot lock the file: '. $ds); } $r2 = fread ($by,2); if ($r2 !== "\xFF\xD8"){ throw new \RuntimeException ('Unknown format: '. $ds); } for (;;) { $it = @unpack ('H4segment/nlen',fread ($by,4)); if ($it === false){ throw new \RuntimeException ('Unknown format: '. $ds); } $ek = $it['len']; $ot = $it['segment']; if(preg_match ('/^ffc[0-3]/',$ot)) { $pt = @unpack ('Cbits/nheight/nwidth',fread ($by,$ek - 2)); if ($pt === false){ throw new \RuntimeException ('Unknown format: '. $ds); } return [$pt['width'],$pt['height']]; } if(fseek($by,$ek - 2,SEEK_CUR)!==0){ throw new \RuntimeException ('Cannot find start of frame: '. $ds); } } } finally { fclose ($by); } } function e2_getimagesize ($ds){ $zk = $kk = 0; if (fd ($ds)) { try { list ($zk,$kk)=e2_getimagesize_jpeg ($ds); } catch (\Exception $e){ list ($zk,$kk)=getimagesize ($ds); } } elseif (sd ($ds)) { list ($zk,$kk)=getimagesize ($ds); } elseif (qd ($ds)) { try { require_once SYSTEM_DIR . LIBRARY_DIRNAME .'getid3/getid3.php'; $xt = new getid3 (); $xt = $xt->analyze ($ds); $zk = $xt['video']['resolution_x']; $kk = $xt['video']['resolution_y']; } catch (\Exception $e){} } elseif (ad ($ds)) { if(function_exists ('simplexml_load_string')) { $c5 = simplexml_load_string (file_get_contents ($ds)); if ($c5){ $v5 = $c5->attributes (); list ($zk,$kk) = [(string)$v5 -> width, (string)$v5 -> height]; } } } if(substr ($ds,strrpos ($ds,'.')-3,3)=='@2x'){ $zk = (int)floor ($zk / 2); $kk = (int)floor ($kk / 2); } $b5 = round (($kk > 0) ? ($zk / $kk):1,2); $y5 = round (($zk > 0) ? ($kk / $zk):1,2); return [$zk,$kk,$b5,$y5]; } function e2img__crop_metrics_to_square ($jt){ $n5 = $m5 = $f5 = $d5 = 0; list ($zk,$kk)=$jt; if ($zk > $kk){ $f5 = $zk - $kk; $n5 = floor ($f5 / 2); $kk = $zk; } elseif ($zk < $kk){ $d5 = $kk - $zk; $m5 = floor ($f5 / 2); $zk = $kk; } $yt = [$n5,$m5,$f5,$d5]; $s5 = [$zk,$kk]; return [$s5,$yt]; } function e2m_install () { global$_strings,$_config; gf (DEFAULT_TEMPLATE); $bb = []; if(Log::$a)__log ('Installer: not installed, present user with form'); $a5['server'] = @$_COOKIE[j1 ('install_db_server')]; $a5['user_name'] = @$_COOKIE[j1 ('install_db_user_name')]; $a5['passw']=ts (@$_COOKIE[j1 ('install_db_passw')]); $a5['name'] = @$_COOKIE[j1 ('install_db_name')]; $bb = [ 'title' => $_strings['pt--install'], 'heading' => $_strings['pt--install'], 'form-install' => [ 'form-action' => wq ('e2s_install'), 'form-check-db-config-action' => wq ('e2j_check_db_config'), 'form-list-databases-action' => wq ('e2j_list_databases'), 'submit-text' => $_strings['fb--begin'], 'db-server' => htmlspecialchars (@$a5['server']? $a5['server']:'localhost'), 'db-user' => htmlspecialchars (@$a5['user_name']? $a5['user_name']:'root'), 'db-password' => '', 'db-database' => htmlspecialchars ((string) @$a5['name']), ] ]; return $bb; } function qn () { static $e6 = null; if ($e6 === null){ $e6 = @unserialize ( @file_get_contents (INSTANCE_DIR . 'instance.psa') ) or $e6 = null; } return $e6; } function ln ($q5){ static $e6 = null; $e6 = qn (); $e6['version']=$q5; if (e3 (INSTANCE_DIR . 'instance.psa',serialize ($e6))) { return $e6; } else { die ('Cannot instantiate v'. $q5 .': probably permission denied'); } } function e2s_instantiate ($parameters){ global$_strings; if (qn () !== null){ die ('Remove the file "'. INSTANCE_DIR . 'instance.psa" first'); } else { if(is_numeric ($parameters['version'])) { if (ln ($parameters['version'])) { hb ($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); r1 (wq ('e2m_frontpage', array ('page' => 1))); } } } die ('Could not create instance of engine'); } function e2_install ($databaseConfiguration,$kb){ global$_strings,$_config,$settings; if ( qn () !== null and sl () !== null and AePasswordCheckManager::isPasswordSet () ) { throw new AeInstallAlreadyInstalledException ('Instance already created and db params set'); } $databaseConfiguration -> setPrefix ($_config['db_table_prefix']); $databaseConfiguration -> setSubset ($_config['db_table_subset']); if(array_key_exists ('db_plain_password',$kb)) { $databaseConfiguration->password = rs ($kb['db_plain_password']); } if($_config['log_installs']) { Log::$a = true; if(Log::$a)tn ('install-$'); } if(Log::$a)__log ('Installer: force directories'); AeFileManager::forceAllDirectories (); if(Log::$a)__log ('Installer: write password hash'); if (!@e3 (USER_DIR . 'password-hash.psa',serialize (sha1 ($kb['password'])))) { throw new AeNotSavedException; } $settings['db']=$databaseConfiguration -> getDatabaseParamsArray (); $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; xm ($databaseConfiguration,'check database during installation'); $l5 = fm ($databaseConfiguration); $z5 = false; if ($l5['occupied']) { if ($l5['migrateable'] and $kb['allow_migration']) { $z5 = true; if(Log::$a)__log ('Installer: data exists and migrateable'); } else { if(Log::$a)__log ('Installer: incomplete data in the database'); throw new AeInstallDatabaseOccupiedException ('Database already has some data'); } } if ($z5){ if(Log::$a)__log ('Installer: no need to create tables, will migrate'); try { bm ($databaseConfiguration); } catch (AeMySQLException $e){ v3 ($e,'Could not migrate'); hb ($_strings['er--double-check-db-params']); } bs ($databaseConfiguration); } else { if(Log::$a)__log ('Installer: create tables'); foreach(AeModel::unprefixedCoreTablesNames () as $vb){ lm ($databaseConfiguration,$vb); } } if(Log::$a)__log ('Installer: write settings'); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { throw new AeNotSavedException; } if(Log::$a)__log ('Installer: search index'); $k5 = pd (sl ()); try { $k5 -> erase (); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Installer: Rose not available'); } e2_drop_all_kinds_of_cache (); jd (USER_DIR); im ($databaseConfiguration); if(Log::$a)__log ('Installer: instantiate'); ln (E2_VERSION); if(Log::$a)__log ('Installer: complete'); } function e2s_install () { global$_strings,$_db,$_config; if ( qn () !== null and sl () !== null and AePasswordCheckManager::isPasswordSet () ) { r1 (); } $databaseConfiguration = ps ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); foreach($databaseConfiguration -> getDatabaseParamsArray () as $x3 => $e3){ if ($x3 !== 'passw'){ w1 ('install_db_'. $x3,$e3); } } if (!array_key_exists ('password',$_POST) or trim ($_POST['password']) == ''){ hb ($_strings['er--no-password-entered'],E2E_USER_ERROR); r1 (wq ('e2m_frontpage', ['page' => 1])); } $x5 = trim ($_POST['password']); @session_start (); $e5 = false; try { e2_install ($databaseConfiguration, [ 'allow_migration' => true, 'password' => $x5, ]); $e5 = true; } catch (AeMySQLCannotConnectException $e){ hb ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error () .' ('. mysqli_connect_errno () .')' ); } catch (AeMySQLTooOldException $e){ hb (e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ])); } catch (AeMySQLException $e){ hb ($_strings['er--cannot-find-db'] .' '. $databaseConfiguration->name); } catch (AeInstallDatabaseOccupiedException $e){ hb ($_strings['er--db-data-incomplete-install']); } catch (AeNotSavedException $e){ hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); } catch (AeInstallException $e){ } zn (); if (!$e5)r1 (wq ('e2m_frontpage', ['page' => 1])); foreach($databaseConfiguration -> getDatabaseParamsArray () as $x3 => $e3){ w1 ('install_db_'. $x3,''); } $r5['sessions'] = [[ 'stamp' => time (), 'remote_ip' => fs (), 'key_hash' => ds (true), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]]; if (!qs ($r5)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } vv (wq ('e2s_bsi_step', array ())); r1 (); } function zn () { global$_config; if ((strpos ($_SERVER['SERVER_SOFTWARE'],'Apache')!==0)) return; if(Log::$a)__log ('Running on Apache'); $t5 = SYSTEM_DEFAULTS_DIR . 'default.htaccess'; $j5 = false; if (!is_file ($t5)) { echo 'File not found: '.$t5. '. Please use the full Aegea installation package.'; die; } $h5 = file_get_contents ($t5); foreach ( ['custom_htaccess_directives','custom_htaccess_rewrites'] as $g5 ) { if ((string) @$_config[$g5]!==''){ $h5 = str_replace ( '##'. $g5 ."##\r\n", (string) @($_config[$g5]), $h5 ); } else { $h5 = str_replace ( "\r\n##". $g5 ."##\r\n", '', $h5 ); } } if(is_file ('.htaccess')) { if(Log::$a)__log ('There is an .htaccess file in the installation directory'); $w5 = file_get_contents ('.htaccess'); if ($w5 != $h5){ $j5 = true; $u5 = $i5 = '.htaccess.old'; $o5 = 1; while (is_file ($i5)) { $i5 = $u5 .'.'. $o5 ++; } if(Log::$a)__log ('Existing .htaccess wrong, backing up as <'. $i5 .'>'); if (!@rename ('.htaccess',$i5)) { if(Log::$a)__log ('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $j5 = true; } if ($j5){ if(Log::$a)__log ('Writing a correct .htaccess file'); if (!@file_put_contents ('.htaccess',$h5)) { if(Log::$a)__log ('Fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } @chmod ('.htaccess',E2_NEW_FILES_RIGHTS); } } function e2j_check_db_config () { global$_db,$_strings,$_config; $databaseConfiguration = ps ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); $rl = [ 'success' => true, 'data' => [ 'message' => '', 'db-responding' => false, 'db-connected' => false, 'db-found' => false, 'db-compatible' => false, 'db-occupied' => false, 'db-migrateable' => false, ] ]; try { xm ($databaseConfiguration,'connect to check DB config (try 1)'); } catch (AeMySQLAccessDeniedException $e){ $rl['data']['db-responding']=true; $rl = json_encode ($rl); die ($rl); } catch (AeMySQLCannotConnectException $e){ $rl = json_encode ($rl); die ($rl); } catch (AeMySQLTooOldException $e){ $rl['data']['db-responding']=true; $rl['data']['db-connected']=true; $rl['data']['message']=e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ]); $rl = json_encode ($rl); die ($rl); } catch (AeMySQLNotFoundException $e){ $rl['data']['db-responding']=true; $rl['data']['db-connected']=true; if($databaseConfiguration->name){ $rl = json_encode ($rl); die ($rl); } else { $p5 = sm ($databaseConfiguration); if(count ($p5)>0){ $rl['data']['db-found']=true; $databaseConfiguration->name = $p5[0]; } else { $rl = json_encode ($rl); die ($rl); } } } $rl['data']['db-responding']=true; $rl['data']['db-connected']=true; $rl['data']['db-found']=true; $rl['data']['db-compatible']=true; try { xm ($databaseConfiguration,'connect to check DB config (try 2)'); } catch (AeMySQLException $e){ $rl = json_encode ($rl); die ($rl); } $rl['data']['db-good']=true; $l5 = fm ($databaseConfiguration); if ($l5['occupied']) { if ($l5['migrateable']) { $rl['data']['message']=$_strings['gs--data-exists']; } else { $rl['data']['db-good']=false; $rl['data']['message']=$_strings['er--db-data-incomplete-install']; } } $rl = json_encode ($rl); die ($rl); } function e2j_list_databases () { global$_config; $databaseConfiguration = ps ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); $cj = []; $rl = [ 'success' => true, 'data' => [ 'databases-list' => [] ] ]; try { $cj = sm ($databaseConfiguration); $rl['data']['databases-list']=$cj; } catch (AeMySQLException $e){} $rl = json_encode ($rl); die ($rl); } if(substr ((string) @$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define ('DEFAULT_LANGUAGE','ru'); } else { define ('DEFAULT_LANGUAGE','en'); } function e2l_get_string ($vj,$kb){ global$_strings; $name = $_strings[$vj]; if(preg_match_all ('/\$\[(.+?)\]/u',$name,$sr,PREG_SET_ORDER)) { foreach ($sr as $bj){ $yj = $bj[1]; $b6 = ''; if(strstr ($yj,'.')) list ($yj,$b6)=explode ('.',$yj,2); if(array_key_exists ($yj,$kb)) { if ($b6){ $name = str_replace ($bj[0],e2l__format_value ($b6,$kb[$yj],$vj),$name); } else { $name = str_replace ($bj[0],$kb[$yj],$name); } } } } return$name; } function e2l__format_value ($b6,$bv,$vj){ @list ($b6,$nj)=explode ('.',$b6,2); $mj = 'e2lstr_'. $b6; if(function_exists ($mj)) { return call_user_func ($mj,$bv,$nj,$vj); } else { return $bv; } return $bv; } function kn () { global$_lang,$settings; if ( array_key_exists ('language',$settings) and is_file ($fj = SYSTEM_DIR . LANGUAGES_DIRNAME . $settings['language'] .'.php') ) { $_lang = $settings['language']; include $fj; } elseif(is_file ($fj = SYSTEM_DIR . LANGUAGES_DIRNAME . DEFAULT_LANGUAGE .'.php')) { $_lang = DEFAULT_LANGUAGE; include $fj; } else { die ('Language file missing: '. $fj); } return e2l_load_strings (); } class Log { public static $a = false; public static $kj = false; } function rn () { global$_config; $xj = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; if ( $_config['write_log'] and ($_config['write_log_create'] or is_file ($xj)) ) { Log::$a = true; Log::$kj = true; } else { Log::$a = false; Log::$kj = false; } if (!Log::$a) return; @qq (INSTANCE_DIR . LOGS_DIRNAME); if($_config['write_log_reset']) { @file_put_contents ($xj,''); @chmod ($xj,E2_NEW_FILES_RIGHTS); } if (@$_config['write_log_limit'] and is_file ($xj)) { $as_ = @stat ($xj); $as_ = $as_['size']; if ($as_ > $_config['write_log_limit']) { @rename ($xj,$xj .'.bak'); @chmod ($xj .'.bak',E2_NEW_FILES_RIGHTS); @file_put_contents ($xj,''); } } __log ('────────────────────────────────────────────────────────────────────────────────'); } function tn ($ej = false) { static $rj = false; if ($ej === false) return $rj; if ($ej === '') return $rj = false; $ds = str_replace ( '$',gmdate ('Y-m-d-\a\t-H-i-s'),$ej ); return $rj = $ds; } function __log ($o1){ static $jj; global$_stopwatch; $hj = tn (); $xj = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; if(function_exists ('getrusage')) { $gj = getrusage (); $wj = str_pad (round ($gj['ru_utime.tv_sec'] + ($gj['ru_utime.tv_usec']/1000000),5),10,' ',STR_PAD_RIGHT); } else { $wj = str_pad (round (kq () - $_stopwatch,5),10,' ',STR_PAD_RIGHT); } if ($o1[0]=='}'){ -- $jj; if ($jj < 0)$jj = 0; } $uj = ( E2_RUN_ID .' '. $wj .' '. str_repeat (' ',$jj * 2). $o1 . "\n" ); if ($o1[strlen ($o1)-1]=='{'){ ++ $jj; } $sn = FILE_APPEND; if(Log::$kj){ @file_put_contents ($xj,$uj,$sn); @chmod ($xj,E2_NEW_FILES_RIGHTS); } if ($hj !== false){ $ds = INSTANCE_DIR . LOGS_DIRNAME . $hj .'.log'; @qq (INSTANCE_DIR . LOGS_DIRNAME); @file_put_contents ($ds,$uj,$sn); @chmod ($hj,E2_NEW_FILES_RIGHTS); } if ($o1[0]=='#'){ $ij = INSTANCE_DIR . LOGS_DIRNAME . 'debug.log'; @qq (dirname ($ij). '/'); @file_put_contents ($ij,$uj,$sn); @chmod ($ij,E2_NEW_FILES_RIGHTS); } } function jn ($oj){ @e3 ( USER_DIR .'ctree.php', "<?php\r\n\r\n". var_export ($oj,true). "\r\n\r\n?>php" ); } function hn () { $xj = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; @qq (INSTANCE_DIR . LOGS_DIRNAME); @file_put_contents ($xj,''); @chmod ($xj,E2_NEW_FILES_RIGHTS); } define ('MAIL_ENABLED', !in_array ('mail',explode (',',ini_get ('disable_functions')))); function gn ($pj,$content){ $ch = SYSTEM_DEFAULTS_DIR .'mail/'. $pj .'.mtmpl.php'; if(is_file ($ch)) { ob_start (); include $ch; $ea = ob_get_contents (); ob_end_clean (); return trim ($ea); } } function wn () { global$_config; $vh = $_config['mail_from']; if ($vh[strlen ($vh)-1]=='@'){ $vh .= $_SERVER['HTTP_HOST']; } return $vh; } function un ($bh,$subject,$wq,$yh = ''){ global$_config; if($_config['dev_mail_debug']) { $u = 'mail-debug'; $hv = basename (tempnam ($u,'m-')); $o1 = ( 'To:       '.$bh ."\n". 'Subject:  '.$subject ."\n". $yh ."\n". "--------------------------------------------------\n". $wq ); e3 ($u .'/'. $hv,$o1); chmod ($u .'/'. $hv,E2_NEW_FILES_RIGHTS); rename ($u .'/'. $hv,$u .'/'. $hv.'.txt'); } $subject = '=?UTF-8?B?'. base64_encode ($subject) .'?='; $yh .= "\r\nContent-Type: text/plain; charset=utf-8"; if(MAIL_ENABLED){ mail ($bh,$subject,$wq,trim ($yh)); } } function in ($parameters,$nh){ global$settings; $mh['each'] = []; $mh['reorderable?']=false; $bs = lf (true,true); if ($bs === null or $bs === 0) return $mh; if (!@$settings['appearance']['show_main_menu']) return $mh; return $mh; } function on ($yd){ foreach ($yd as $ql) if ($ql['visible?']) return true; return false; } function pn () { global$settings,$_strings,$_current_url; $lh = ef (); return [ [ 'sort-id' => 'f', 'href' => wq ('e2m_favourites', ['page' => 1]), 'content-classes' => ['favourites'], 'svg-id' => 'favourite-on', 'title' => $_strings['nm--favourites'], 'current?' => AeMainMenuManager :: $isFavouritesCurrent, 'parent?' => AeMainMenuManager :: $isFavouritesParent, 'visible?' => (bool) @$settings['menu_items']['favourites_on'], 'available?' => true, ], [ 'sort-id' => 'h', 'href' => wq ('e2m_most_commented', ['page' => 1]), 'content-classes' => ['most-commented'], 'svg-id' => 'comments', 'title' => $_strings['nm--most-commented'], 'current?' => AeMainMenuManager :: $isMostCommentedCurrent, 'parent?' => AeMainMenuManager :: $isMostCommentedParent, 'visible?' => (bool) @$settings['menu_items']['most_commented_on'], 'available?' => true, ], [ 'sort-id' => 'p', 'href' => wq ('e2m_popular', ['page' => 1]), 'content-classes' => ['popular'], 'svg-id' => 'read', 'title' => $_strings['nm--most-read'], 'current?' => AeMainMenuManager :: $isPopularCurrent, 'parent?' => AeMainMenuManager :: $isPopularParent, 'visible?' => (bool) @$settings['menu_items']['popular_on'], 'available?' => true, ], [ 'sort-id' => 't', 'href' => wq ('e2m_tags'), 'svg-id' => 'tags', 'title' => $_strings['gs--tags'], 'current?' => AeMainMenuManager :: $isTagsCurrent, 'parent?' => AeMainMenuManager :: $isTagsParent, 'visible?' => (bool) @$settings['menu_items']['tags_on'], 'available?' => true, ], [ 'sort-id' => 'c', 'href' => p (), 'content-classes' => ['day','month','year'], 'svg-id' => 'calendar', 'title' => $_strings['gs--calendar'], 'current?' => AeMainMenuManager :: $isCalendarCurrent, 'parent?' => AeMainMenuManager :: $isCalendarParent, 'visible?' => (bool) @$settings['menu_items']['calendar_on'], 'available?' => true, ], [ 'sort-id' => 'r', 'href' => $lh? $lh : wq ('e2m_frontpage', ['page' => 1]), 'svg-id' => 'dice', 'title' => $_strings['nm--random-note'], 'current?' => $_current_url === $lh, 'parent?' => false, 'visible?' => $lh !== false and (bool) @$settings['menu_items']['random_on'], 'available?' => $lh !== false, ], ]; } function cm ($candy,$zh,$kh,$xh,$eh){ global $_config, $_template, $_newsfeeds, $_current_url, $_canonical_url; $meta['base-href']=AeEnv::$p; $meta['current-href']=$_current_url; $meta['canonical-href']=$_canonical_url; $meta['stylesheets']=q2 (); $meta['scripts']=l2 (); $meta['newsfeeds']=$_newsfeeds; $meta['favicon-type']='image/x-icon'; $meta['favicon-href']='favicon.ico'; if ($rh = tv ()) { $meta['favicon-type']=xd ($rh); $meta['favicon-href']=$rh; $meta['apple-touch-icon-href']=tv ('square'); } $meta['navigation-links'] = [[ 'rel' => 'index', 'href' => wq ('e2m_frontpage', ['page' => 1]), 'id' => 'link-index', ]]; if (!empty ($eh)) { foreach (['prev','next','earlier','later'] as $th){ if(array_key_exists ($th .'-href',$eh)) { $jh = $th; if ($th == 'earlier')$jh = 'prev'; if ($th == 'later')$jh = 'next'; $t1 = $eh[$th .'-href']; if ($t1 === 'javascript:;') continue; $meta['navigation-links'][] = [ 'rel' => $jh, 'href' => $t1, 'id' => 'link-'. $th, ]; } } } if (!isset ($_template))gf (); $meta['viewport']=$_template['meta_viewport']; if(is_file ($_config['path_media'].'manifest.json')) { $meta['manifest-href']=AeEnv::$p .'manifest.json'; } $meta['og-images'] = []; if(is_array ($zh['only']['og-images'])) { $meta['og-images']=$zh['only']['og-images']; $meta['twitter-card']='summary_large_image'; } if(is_array (@$kh['og-images'])) { $meta['og-images']=$kh['og-images']; $meta['twitter-card']='summary_large_image'; } if (!count ($meta['og-images'])) { $meta['og-images'] = array ($xh['userpic-large-href']); $meta['twitter-card']='summary'; } return$meta; } function vm (AeDatabaseConfiguration $databaseConfiguration){ $hh = $databaseConfiguration -> getSubset (); if ($hh < 1){ throw new LogicException ('Subset to set in place of zero must be greater than 0'); } xm ($databaseConfiguration,'prepare migrate db'); rm ($databaseConfiguration,'SET sql_quote_show_create=1'); } function bm (AeDatabaseConfiguration $databaseConfiguration){ $prefix = $databaseConfiguration -> getPrefix (); $hh = $databaseConfiguration -> getSubset (); if ($hh < 1){ throw new LogicException ('Subset to set in place of zero must be greater than 0'); } xm ($databaseConfiguration,'migrate db'); rm ($databaseConfiguration,'SET sql_quote_show_create=1'); ym ($databaseConfiguration); if(Log::$a)__log ('Fix problems with table structure {'); $gh = false; foreach(AeModel::unprefixedCoreTablesNames () as $w2){ lm ($databaseConfiguration,$w2); rm ($databaseConfiguration,"SHOW CREATE TABLE `". $prefix . $w2 ."`"); $wh[$w2]=tm (); $wh[$w2]=$wh[$w2][0]['Create Table']; rm ($databaseConfiguration,"SHOW INDEX FROM `". $prefix . $w2 ."`"); $uh = tm (); $ih = []; $oh = []; foreach ($uh as $fb){ $fb = $fb['Key_name']; if ( preg_match ('/\_[0-9]+$/',$fb) or ($w2 === 'Actions' and $fb === 'EntityID') or ($w2 === 'GIPsSessions' and $fb === 'GIP') or ($w2 === 'GIPsSessions' and $fb === 'SubsetID') or ($w2 === 'Notes' and $fb === 'Title') ) { $ih[] = $fb; $oh[] = 'DROP INDEX `'. $fb. '`'; } if ($w2 === 'Actions' and $fb === 'EntityID'){ $gh = true; } if ($w2 === 'Actions' and $fb === 'EntityIDStamp'){ $gh = true; } } if(count ($oh)) { $oh = implode (', ',array_unique ($oh)); $ih = implode (', ',array_unique ($ih)); if(Log::$a)__log ( 'Drop erroneous index "'. $ih .'" on "'. $prefix . $w2 .'"' ); rm ($databaseConfiguration, "ALTER TABLE `". $prefix . $w2 ."` ". $oh ); } if (!strstr ($wh[$w2],'InnoDB')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . $w2 ."` ". "ENGINE = InnoDB" ); } if (!strstr ($wh[$w2],'`SubsetID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . $w2 . "` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if ( $w2 === 'Actions' and strstr ($wh['Actions'],'`ReadCount`') and !$gh ) { nm ($databaseConfiguration); } rm ($databaseConfiguration, "UPDATE `". $prefix . $w2 ."` ". "SET `SubsetID` = ". $hh ." ". "WHERE `SubsetID` = 0" ); } if(Log::$a)__log ('}'); if(Log::$a)__log ('Ensure modern table structure {'); if (!strstr ($wh['Actions'],'`ReadCount`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Actions` ". "ADD `ReadCount` INT DEFAULT '0' NOT NULL" ); } if(strstr ($wh['Actions'],'`HitCount`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Actions` ". "DROP `HitCount`" ); rm ($databaseConfiguration, "DELETE FROM `". $prefix . "Actions` ". "WHERE `ReadCount` = 0" ); } if (!strstr ($wh['Aliases'],'`EntityType`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } rm ($databaseConfiguration, "UPDATE `". $prefix . "Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); rm ($databaseConfiguration, "DELETE FROM `". $prefix . "Aliases` ". "WHERE `ID` IN (". "SELECT `ID` FROM (". "SELECT a.`ID` FROM `". $prefix . "Aliases` a ". "LEFT OUTER JOIN `". $prefix . "Keywords` e ". "ON a.`EntityID` = e.`ID` ". "WHERE a.`EntityType` = 't' ". "AND e.`ID` IS NULL". ") AS temp". ")", 'clean up “leaked” tag aliases' ); if (!stristr ($wh['Comments'],'`Text` MEDIUMTEXT')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!stristr ($wh['Comments'],'`Reply` MEDIUMTEXT')) { if(strstr ($wh['Comments'],'`Reply`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); } else { if(Log::$a)__log ('No Reply column in comments; ignored assuming a 2.11 database'); } } if (!stristr ($wh['Comments'],'`IP` VARCHAR(39)')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `IP` `IP` VARCHAR(39)  DEFAULT '' NOT NULL" ); } if (!strstr ($wh['Comments'],'`IsGIPUsed`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `IsGIPUsed` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IP`" ); } if (!strstr ($wh['Comments'],'`GIP`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `GIP` VARCHAR(15) DEFAULT '' NOT NULL AFTER `IsGIPUsed`" ); } if (!strstr ($wh['Comments'],'`GIPAuthorID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `GIPAuthorID` VARCHAR(64) DEFAULT '' NOT NULL AFTER `GIP`" ); } if(strstr ($wh['Comments'],'`SocialType`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "DROP `SocialType`" ); } if(strstr ($wh['Comments'],'`SocialID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "DROP `SocialID`" ); } if (!strstr ($wh['GIPsSessions'],'`AuthorEmail`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "GIPsSessions` ". "ADD `AuthorEmail` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorName`" ); } if (!strstr ($wh['GIPsSessions'],'`AuthorProfileLink`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "GIPsSessions` ". "ADD `AuthorProfileLink` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorEmail`" ); } if(strstr ($wh['Keywords'],'`ParentKeywordID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr ($wh['Keywords'],'`OriginalAlias`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } if (!strstr ($wh['Keywords'],'`PageTitle`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `PageTitle` VARCHAR(255) DEFAULT '' NOT NULL AFTER `OriginalAlias`" ); } if (!stristr ($wh['Keywords'],'`Description` MEDIUMTEXT')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); } if (!strstr ($wh['Keywords'],'`Summary`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `Summary` MEDIUMTEXT AFTER `Description`" ); } if (!strstr ($wh['Keywords'],'`Uploads`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Summary`" ); } if (!stristr ($wh['Keywords'],'`Uploads` MEDIUMTEXT')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr ($wh['Keywords'],'`IsVisible`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `IsVisible` TINYINT(1) DEFAULT '1' NOT NULL AFTER `Uploads`" ); } rm ($databaseConfiguration, "UPDATE `". $prefix . "Keywords` SET `Summary` = '' WHERE `Summary` IS NULL" ); rm ($databaseConfiguration, "UPDATE `". $prefix . "Keywords` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); if (!strstr ($wh['Notes'],'`FormatterID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL AFTER `Text`" ); } if(1){ rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `FormatterID` `FormatterID` VARCHAR( 32 ) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL" ); } if (!strstr ($wh['Notes'],'`OriginalAlias`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if(strstr ($wh['Notes'],'`IP`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `IP`" ); } if (!stristr ($wh['Notes'],'`Text` MEDIUMTEXT')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!strstr ($wh['Notes'],'`Summary`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `Summary` MEDIUMTEXT AFTER `Text`" ); } if (!strstr ($wh['Notes'],'`IsIndexed`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr ($wh['Notes'],'`Uploads`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } if (!stristr ($wh['Notes'],'`Uploads` MEDIUMTEXT')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr ($wh['Notes'],'`IsExternal`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr ($wh['Notes'],'`SourceID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr ($wh['Notes'],'`SourceNoteID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr ($wh['Notes'],'`SourceNoteURL`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr ($wh['Notes'],'`SourceNoteData`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr ($wh['Notes'],'`SourceNoteJSONURL`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr ($wh['Notes'],'`SourceMainImageURL`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr ($wh['Notes'],'`IsIssue`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `IsIssue`" ); } if (!strstr ($wh['Notes'],'`ReadCount`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `ReadCount` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); rm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` n JOIN (". "SELECT `EntityID`, SUM(`ReadCount`) `AggregateReadCount` ". "FROM  `". $prefix . "Actions` ". "GROUP BY `EntityID`". ") a ON n.`ID` = a.`EntityID` ". "SET `ReadCount` = `AggregateReadCount`" ); } rm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `Summary` = '' WHERE `Summary` IS NULL" ); rm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); rm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `SourceNoteData` = '' WHERE `SourceNoteData` IS NULL" ); if (!strstr ($wh['Sources'],'`TrueID`')) { rm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); rm ($databaseConfiguration, "UPDATE `". $prefix . "Sources` ". "SET `TrueID` = `ID`" ); } if(Log::$a)__log ('}'); if(Log::$a)__log ('Ensure indexes {'); if(strstr ($wh['Notes'],'`Title` (`Title`(191))')) { if(Log::$a)__log ('Drop erroneous index on "'. $prefix .'Notes.Title"'); rm ($databaseConfiguration, "ALTER TABLE `". $prefix ."Notes` ". "DROP INDEX `Title`" ); } mm ($databaseConfiguration); foreach(AeModel::unprefixedCoreTablesNames () as $w2){ foreach(AeModel::indexesByUnprefixedTableName ($w2) as $fb){ list ($type,$db)=$fb; $sb = implode ('',$db); $ph = AeModel::indexCheckSQLByIndexType ($type).' `'. $sb .'` (`'. implode ('`,`',$db) .'`)'; $ab = AeModel::indexCreateSQLByIndexType ($type).' `'. $sb .'` (`'. implode ('`, `',$db) .'`)'; if (!strstr ($wh[$w2],$ph)) { if(Log::$a)__log ( 'Table "'. $prefix . $w2 .'" is missing "'. AeModel::indexCheckSQLByIndexType ($type) .'" on columns "'. implode ('", "',$db) .'"' ); rm ($databaseConfiguration, "ALTER TABLE `". $prefix . $w2 ."` ". "ADD ". $ab ); } } } if(Log::$a)__log ('}'); return true; } function ym (AeDatabaseConfiguration $databaseConfiguration){ if(Log::$a)__log ('Ensure encoding utf8mb4 on all native tables {'); foreach(AeModel::unprefixedCoreTablesNames () as $c8){ $v8 = $databaseConfiguration -> getPrefix () . $c8; if(Log::$a)__log ('Migrate: Check table '. $v8); $b8 = qm ($databaseConfiguration,$c8); if (!$b8) continue; if(stripos ($b8['Collation'],'utf8mb4')===0) continue; if(Log::$a)__log ('Migrate: Table '. $v8 .' has a wrong encoding'); if(Log::$a)__log ('Migrate: Drop indexes of table '. $v8); rm ($databaseConfiguration, "SHOW INDEX FROM `". $v8 ."` ". "WHERE `Key_name` <> 'PRIMARY' ". "AND `Seq_in_index` = 1", 'show indexes from table '. $v8 ); $uh = tm (); foreach ($uh as $fb){ rm ($databaseConfiguration, "ALTER TABLE `". $v8 ."` ". "DROP INDEX `". $fb['Key_name'] ."`", 'drop index '. $fb['Key_name'] ); } if(Log::$a)__log ('Migrate: Convert table '. $v8 .' to utf8mb4'); rm ($databaseConfiguration, "ALTER TABLE `". $v8 ."` ". "CONVERT TO CHARACTER SET utf8mb4", 'convert table to character set utf8mb4' ); } if(Log::$a)__log ('}'); if(Log::$a)__log ('Ensure encoding utf8mb4 on all Rose tables {'); foreach (od () as $y8){ $v8 = ( $databaseConfiguration -> getPrefix () . SEARCH_EXTRA_PREFIX . $y8 ); if(Log::$a)__log ('Migrate: Check table '. $v8); $b8 = qm ($databaseConfiguration,SEARCH_EXTRA_PREFIX . $y8); if (!$b8) continue; if(stripos ($b8['Collation'],'utf8mb4')===0) continue; if(Log::$a)__log ('Some Rose tables have a wrong encoding, will need to erase and recreate them all'); bs ($databaseConfiguration); break; } if(Log::$a)__log ('}'); } function nm (AeDatabaseConfiguration $databaseConfiguration){ $prefix = $databaseConfiguration -> getPrefix (); if(Log::$a)__log ( 'Table "'. $prefix .'Actions" is missing necessary UNIQUE index, must rearrange {' ); rm ($databaseConfiguration, "DROP TABLE IF EXISTS `". $prefix ."Actions_Fixed`", 'remove temporary Actions_Fixed table if exists' ); rm ($databaseConfiguration, "CREATE TABLE `". $prefix ."Actions_Fixed` ". "LIKE `". $prefix ."Actions`", 'create new temporary Actions_Fixed table' ); rm ($databaseConfiguration, "ALTER TABLE `". $prefix ."Actions_Fixed` ". "ADD UNIQUE INDEX(`EntityID`, `Stamp`)", 'add UNIQUE index to the temporary Actions_Fixed table' ); rm ($databaseConfiguration, "INSERT INTO `". $prefix ."Actions_Fixed` (`SubsetID`, `EntityID`, `Stamp`, `ReadCount`) ". "SELECT `SubsetID`, `EntityID`, `Stamp`, `AggregateReadCount` FROM (". "SELECT `SubsetID`, `EntityID`, `Stamp`, SUM(`ReadCount`) `AggregateReadCount` ". "FROM `". $prefix ."Actions` ". "GROUP BY `EntityID`, `Stamp`". ") `". $prefix ."Actions_Fixed_AliasRequiredForNoReason`", 'rearrange Actions records from existing problematic Actions table to the new temporary Actions_Fixed table' ); rm ($databaseConfiguration, "RENAME TABLE `". $prefix ."Actions` TO `". $prefix ."Actions_Corrupt`", 'rename Actions to Actions_Corrupt' ); rm ($databaseConfiguration, "RENAME TABLE `". $prefix ."Actions_Fixed` TO `". $prefix ."Actions`", 'rename Actions_Fixed to Actions' ); rm ($databaseConfiguration, "DROP TABLE `". $prefix ."Actions_Corrupt`", 'remove Actions_Corrupt table' ); if(Log::$a)__log ('}'); } function mm ($databaseConfiguration){ global$_db; $n8 = ( "(0 ". "OR `Text` LIKE '%!!%' ". "OR `Text` LIKE '%||%' ". "OR `Text` LIKE '%\%\%%' ". "OR `Text` LIKE '%##%' ". "OR `Text` LIKE '%++%' ". "OR `Text` LIKE '%((html%' ". "OR `Text` LIKE '%((img%' ". "OR `Text` LIKE '%((link%' ". "OR `Text` LIKE '%((%.jpg%' ". "OR `Text` LIKE '%((%.jpeg%' ". "OR `Text` LIKE '%((%.gif%' ". "OR `Text` LIKE '%((%.png%' ". "OR `Text` LIKE '%((%.webp%' ". "OR `Text` LIKE '%((%.avif%' ". "OR `Text` LIKE '%[[html%' ". "OR `Text` LIKE '%[[img%' ". "OR `Text` LIKE '%[[link%' ". "OR `Text` LIKE '%[[%.jpg%' ". "OR `Text` LIKE '%[[%.jpeg%' ". "OR `Text` LIKE '%[[%.gif%' ". "OR `Text` LIKE '%[[%.png%' ". "OR `Text` LIKE '%[[%.webp%' ". "OR `Text` LIKE '%[[%.avif%' ". ")" ); if(Log::$a)__log ('Switch from Calliope to Neasden {'); rm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `FormatterID` = 'neasden' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope' ". "AND (". "`IsPublished` = '0' ". "OR (". "`IsPublished` = '1' ". "AND !". $n8. ")". ")" ); if(Log::$a)__log (mysqli_affected_rows ($_db['link']) .' drafts and notes with simple formatting switched'); rm ($databaseConfiguration, "SELECT `ID` FROM `". $databaseConfiguration -> getPrefix () . "Notes` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope'" ); $tf = tm (); if(Log::$a)__log (count ($tf) .' with complex formatting remain'); if(count ($tf)>0){ $wv = 'AEGEA-LEGACY-REVIEW'; $m8 = ka ($databaseConfiguration,$wv); if (!$m8){ $m8['ID']=qa ($databaseConfiguration,$wv,false); } if(Log::$a)__log ('Tag "'. $wv .'" has ID '. $m8['ID']); foreach ($tf as $iy){ em ( "INSERT INTO `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$databaseConfiguration -> getSubset ()) .", ". ((int)$iy['ID']) .", ". ((int)$m8['ID']). ")", 'add new tag bindings' ); } $f4 = 'Aegea legacy notes for review'; $lq = 'These notes were automatically converted from a very old version of Aegea and may have formatting problems. Please edit them to fix these problems. When finished, just delete this tag.'; rm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Keywords` ". "SET `IsVisible` = 0, `IsFavourite` = 1, ". "`PageTitle` = '". $f4 ."', ". "`Description` = '". $lq ."' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `ID` = " . $m8['ID'] ); rm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `FormatterID` = 'neasden' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope'" ); if(Log::$a)__log ('Switched '. mysqli_affected_rows ($_db['link']) .' notes with complex formatting'); } if(Log::$a)__log ('}'); } function fm (AeDatabaseConfiguration $databaseConfiguration){ global$_db; $f8 = false; $d8 = array (); $sql = ( 'SHOW TABLES FROM `'. mysqli_real_escape_string ( $_db['link'],$databaseConfiguration->name ). '`' ); if(Log::$a)__log ('DB [?]: '. $sql); $g3 = mysqli_query ($_db['link'],$sql); if ($g3){ while ($bd = mysqli_fetch_row ($g3)) { foreach(AeModel::unprefixedCoreTablesNames () as $c8){ if(strcasecmp ($bd[0],$databaseConfiguration -> getPrefix () . $c8)===0){ $f8 = true; $d8[] = $c8; } } } } $s8 = true; foreach(AeModel::unprefixedCoreTablesNames () as $c8){ if (!in_array ($c8,$d8)) { $s8 = false; } } $a8 = true; foreach(AeModel::unprefixedEssentialTablesNames () as $c8){ if (!in_array ($c8,$d8)) { $a8 = false; } } return array ( 'occupied' => $f8, 'complete' => $s8, 'migrateable' => $a8, ); } function dm ($databaseConfiguration){ xm ($databaseConfiguration); $l5 = fm ($databaseConfiguration); if (!$l5['occupied']) { throw new AeMySQLNoDataException ('Database is empty'); } if (!$l5['migrateable']) { throw new AeMySQLNotMigrateableException ('Database is not migrateable'); } } function sm (AeDatabaseConfiguration $databaseConfiguration){ global $qs; if (($n6 = mysqli_connect ( 'p:'. $databaseConfiguration->host, $databaseConfiguration->user, ts ($databaseConfiguration->password), '', $databaseConfiguration->port )) === false) return []; $p5 = []; $q8 = [ 'information_schema', 'performance_schema', 'sys', 'mysql' ]; @$qs ++; $p2 = 'SHOW DATABASES'; if(Log::$a)__log ('DB ['. $qs .']: '. $p2); $g3 = mysqli_query ($n6,$p2); if ($g3 === false){ throw new AeMySQLQueryException ( "Could not list databases\n\nMySQL says:\n". mysqli_error ($n6) ); } while ($bd = mysqli_fetch_row ($g3)) { if(mysqli_select_db ($n6,$bd[0]) and !in_array ($bd[0],$q8)) { $p5[] = $bd[0]; } } return $p5; } function am ($databaseConfiguration,$w2){ rm ( $databaseConfiguration, "SHOW TABLES LIKE '". $databaseConfiguration -> getPrefix () . $w2 . "'" ); $rt = tm (); return count ($rt)>0; } function qm ($databaseConfiguration,$w2){ rm ( $databaseConfiguration, "SHOW TABLE STATUS LIKE '". $databaseConfiguration -> getPrefix () . $w2 . "'" ); $g3 = tm (); return $g3 ? $g3[0] : []; } function lm ($databaseConfiguration,$w2){ if (am ($databaseConfiguration,$w2)) return; rm ( $databaseConfiguration, "CREATE TABLE `". $databaseConfiguration -> getPrefix () . $w2 ."` ". AeModel::columnsAndIndexesSQLByUnprefixedTableName ($w2) ." ". "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4" ); } function zm (AeDatabaseConfiguration $databaseConfiguration,$w2,$iz,$m7 = 'INSERT',$l8 = ''){ global$_db; $z8['SubsetID']=$databaseConfiguration -> getSubset (); foreach ($iz as $x3 => $e3){ $z8[$x3]="'". jm ($e3) ."'"; } $k8 = "`". implode ("`, `",array_keys ($z8)). "`"; $x8 = implode (", ",array_values ($z8)); rm ( $databaseConfiguration, $m7 ." INTO `". $databaseConfiguration -> getPrefix () . $w2 ."` ". "(" . $k8 .") VALUES (". $x8 .")". ($l8? (' '. $l8):'') ); $iz['ID']=mysqli_insert_id ($_db['link']); return $iz; } function km (AeDatabaseConfiguration $databaseConfiguration,$w2,$iz,$e8 = false,$r8 = false){ if(Log::$a)__log ('Model: update record in table '. $w2 .' {'); $t8 = array (); foreach(AeModel::softFieldsByUnprefixedTableName ($w2) as $x){ if(array_key_exists ($x,$iz)) { $t8[] = '`'. $x .'`'."='". jm ($iz[$x]) ."'"; } } $j8 = array (); if(is_array ($e8)) { foreach(AeModel::softFieldsByUnprefixedTableName ($w2) as $x){ if(array_key_exists ($x,$e8)) { $j8[] = '`'. $x .'`'."='". jm ($e8[$x]) ."'"; } } } if(count ($j8)) { $x1 = implode (" AND ",$j8); } else { if (!array_key_exists ('ID',$iz) or !is_numeric ($iz['ID'])) { if(Log::$a)__log ('Error: e2_update_record must be called with an ID field in $record when updating single row'); return false; } $x1 = "`ID`=". $iz['ID']; } if(count ($t8)>0){ $h8 = $r8? 'LOW_PRIORITY ' : ''; rm ( $databaseConfiguration, "UPDATE ". $h8 ."`". $databaseConfiguration -> getPrefix () . $w2 ."` ". "SET ". implode (', ',$t8) ." ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND (". $x1 .")" ); } if(Log::$a)__log ('}'); return true; } define ('E2_MYSQL_CONNECT_TIMEOUT',5); function xm (AeDatabaseConfiguration $databaseConfiguration,$g8 = ''){ static $w8 = false; static $u8 = false; global $_instance_config, $_db, $qs; if ($w8 !== $databaseConfiguration -> getServerKeyString ()) { if(Log::$a)__log ('Ensure: Establishing connection "'. $databaseConfiguration -> getServerKeyString () .'"'); if ($w8 !== false){ if(Log::$a)__log ('Closing previous database connection'); mysqli_close ($_db['link']); } $i8 = mysqli_init (); $i8 -> options (MYSQLI_OPT_CONNECT_TIMEOUT,E2_MYSQL_CONNECT_TIMEOUT); if($_instance_config['dev_chaos'] and !rand (0, (1 / $_instance_config['dev_chaos']) - 1)) { throw new AeMySQLCannotConnectException ('Could not '. $g8 ."\n\nChaos"); } $o8 = @mysqli_real_connect ( $i8, 'p:'. $databaseConfiguration->host, $databaseConfiguration->user, ts ($databaseConfiguration->password), '', $databaseConfiguration->port ); if (!$o8){ $x2 = mysqli_connect_errno (); if(1045 === $x2){ throw new AeMySQLAccessDeniedException ('Could not '. $g8 . ' ('.$x2.')'); } else { throw new AeMySQLCannotConnectException ('Could not '. $g8 . ' ('.$x2.')'); } } if (!wm ($i8)) { throw new AeMySQLTooOldException ('Could not '. $g8); }; $_db['link']=$i8; $w8 = $databaseConfiguration -> getServerKeyString (); $u8 = false; } if ($u8 !== $databaseConfiguration->name){ if(Log::$a)__log ('Ensure: Selecting database "'. $databaseConfiguration->name .'"'); if (!@mysqli_select_db ($_db['link'],$databaseConfiguration->name)) { throw new AeMySQLNotFoundException ('Could not '. $g8); } $p2 = 'SET NAMES utf8mb4'; mysqli_query ($_db['link'],$p2); @$qs ++; if(Log::$a)__log ('DB ['. $qs .']: '. $p2); $u8 = $databaseConfiguration->name; } } function em ($p2,$g8 = 'run some query'){ $databaseConfiguration = sl (); return rm ($databaseConfiguration,$p2,$g8); } function rm ($databaseConfiguration,$p2,$g8 = ''){ global $qs,$_db,$_config; xm ($databaseConfiguration,$g8); if($_config['dev_chaos'] and !rand (0, (1 / $_config['dev_chaos']) - 1)) { throw new AeMySQLQueryException ('Could not '. $g8 ."\n\nChaos in e2_mysql_query"); } @$qs ++; if(Log::$a) if ($g8)__log ('Will '. $g8); if(Log::$a)__log ('DB ['. $qs .']: '. $p2); $_db['result'] = @mysqli_query ($_db['link'],$p2); if($_db['result']) { if($_config['backup_tail']) { if ( stripos ($p2,"SELECT")!==0 and stripos ($p2,"SHOW")!==0 ) { $ds = $databaseConfiguration->backup_dir .'backup-tail.sql'; @file_put_contents ($ds,$p2 .";\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod ($ds,E2_NEW_FILES_RIGHTS); } } } else { throw new AeMySQLQueryException ('Could not '. $g8 ."\n\nMySQL says:\n". mysqli_error ($_db['link'])); } } function tm ($type = MYSQLI_ASSOC){ global$_db; $bb = array (); while ($dh = @mysqli_fetch_array ($_db['result'],$type)) { foreach ($dh as $wb => $p8){ if(is_string ($p8)) { $dh[$wb]=$p8; } } $bb[] = $dh; } return $bb; } function jm ($x4){ global$_db; xm (sl (), 'escape string'); return mysqli_real_escape_string ($_db['link'], (string)$x4); } function hm () { global$_config; $jv = array_keys (gm (USER_DIR . BACKUP_DIRNAME)); if(Log::$a)__log ('Backup: Found '. count ($jv) .' backups'); if(count ($jv)) { $cg = time () - $jv[0]; $vg = ($cg >= $_config['backup_rebase_interval']); if(Log::$a)__log ('Backup: '. $cg .' seconds since last backup'); } else { $vg = true; } if ($vg){ if(Log::$a)__log ('Backup: Will rebuild backup'); vv (wq ('e2s_dump', []), true); } } function gm ($backup_dir){ $jv = []; foreach(glob ($backup_dir .'*.sql') as $cy){ if(preg_match ('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename ($cy),$sr)) { list (, $mf,$ff,$df,$bg,$wb,$yg)=$sr; $rf = gmmktime ((int)$bg, (int)$wb, (int)$yg, (int)$ff, (int)$df, (int)$mf); $jv[$rf]=$cy; } } krsort ($jv); return $jv; } function wm ($i8){ global$_db; $_db['software']='MySQL'; $_db['version-minimum']=E2_MINIMUM_MYSQL; $_db['version']=mysqli_get_server_info ($i8); $mg = strpos ($_db['version'],'-MariaDB'); if ($mg !== false){ $_db['software']='MariaDB'; $_db['version-minimum']=E2_MINIMUM_MARIADB; $_db['version']=substr ($_db['version'],0,$mg); if(substr ($_db['version'],0,6)==='5.5.5-'){ $_db['version']=substr ($_db['version'],6); } } if(Log::$a)__log ( 'Ensure: Running on "'. $_db['software'] .'", version "'. $_db['version'] .'"' ); return (version_compare ($_db['version'],$_db['version-minimum'],'>=')); } function um ($backup_dir){ $jv = gm ($backup_dir); $fg = [SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY,SECONDS_IN_A_WEEK,SECONDS_IN_A_MONTH, -1]; $dg = count ($jv); $sg = count ($fg)-1; if ($dg > $sg){ if(Log::$a)__log ('Stored are '. $dg .' backups, over '. $sg .', will sift...'); $ag = -1; $wb = 0; foreach ($jv as $rf => $cy){ if(Log::$a)__log ('Backup '. $cy .' ('. gmdate ('r',$rf) .')'); if ($ag == -1){ if(Log::$a)__log ('is latest, leave'); $ag = $rf; } elseif ($fg[$wb] == -1){ if(Log::$a)__log ('is too old, remove'); @unlink ($cy); } else { if ($ag - $rf < $fg[$wb]) { if(Log::$a)__log ('is not from long ago (within interval of '. $fg[$wb] .'s), remove'); @unlink ($cy); } else { $wb ++; if(Log::$a)__log ('is long enough ago, leave (proceed to interval of '. $fg[$wb] .'s)'); $ag = $rf; } } } } else { if(Log::$a)__log ('No need to sift'); } return; } function im (AeDatabaseConfiguration $databaseConfiguration){ global$_db; if(Log::$a)__log ('Backup to '. $databaseConfiguration->backup_dir); xm ($databaseConfiguration,'make backup'); $xd = []; foreach(AeModel::unprefixedCoreTablesNames () as $w2){ $xd[] = $databaseConfiguration -> getPrefix () . $w2; } $l = time (); $ds = $databaseConfiguration->backup_dir .'backup-'.gmdate ('Y-m-d-\a\t-H-i-s',$l).'.sql'; if($databaseConfiguration -> hasSubsetSpecified ()) { $subset = $databaseConfiguration -> getSubset (); } else { $subset = null; } e2_backup ($_db['link'],$xd,$subset,$ds); @unlink ($databaseConfiguration->backup_dir .'backup-tail.sql'); um ($databaseConfiguration->backup_dir); return $ds; } function om ($qg){ $lg = parse_url ($qg); $zg = @$lg['host']; $kg = @$lg['port']; if ((string)$zg === ''){ $zg = $qg; $kg = ''; } return [$zg,$kg]; } function e2s_dump () { global$_config; if (!$_config['allow_underhood_access']) { r1 (wq ('e2m_settings')); } if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_underhood')); } if (im (sl ())) { hb ('Backed up',E2E_MESSAGE); } r1 (wq ('e2m_underhood')); } function e2m_note ($parameters = []) { global $settings, $_config, $_strings; if(Log::$a)__log ('Note {'); $iy = @$parameters['*note']; if ($iy == false) return e2m_error404 (); $xg = rf ($iy); $hf = kf ($iy); $mm = ss (); $eg = ($parameters['preview-key']==$xg); if (!empty ($parameters['preview-key']) and !$eg) return e2m_error404 (); if (!$mm and !$eg and $hf !== 'public') return e2m_error404 (); if (!empty ($parameters['preview-key']) and $hf === 'public'){ unset($parameters['preview-key']); $ka = wq ('e2m_note',$parameters); r1 ($ka); } $ka = wq ('e2m_note',$parameters); $noteView = new AeNoteView ($iy); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($mm and !@$_config['read_only']); $noteView -> setWantHiddenTags ($mm); if ($hf === 'draft' or $hf === 'scheduled'){ if (!$eg){ $rg = [ '.note-id' => $iy['ID'], 'form-action' => wq ('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-note'], 'can-schedule?' => false, 'can-publish?' => !@$_config['read_only'], 'scheduling-promo' => e2l_get_string ( 'pm--scheduling', ['url' => $_config['paid_features_url']] ), ]; } } $tg = ''; $jg = []; $eh = []; if ($hf === 'public'){ $noteView -> setWantNewCommentsCount ($mm); $noteView -> setWantSharingButtons (@$settings['appearance']['show_sharing_buttons']); $noteView -> setWantRelatedNotes (true); } if ($hf === 'public' or $hf === 'hidden'){ if(Log::$a)__log ('Navigation {'); $hg = yf ($iy,'prev'); $gg = yf ($iy,'next'); if ($hg){ $eh['prev-href']=wq ('e2m_note', ['*note' => $hg]); $eh['prev-title']=ry (htmlspecialchars ($hg['Title'],ENT_NOQUOTES,'UTF-8')); } if ($gg){ $eh['next-href']=wq ('e2m_note', ['*note' => $gg]); $eh['next-title']=ry (htmlspecialchars ($gg['Title'],ENT_NOQUOTES,'UTF-8')); } $eh['title']=$_strings['nm--posts']; $eh['timeline?']=false; $eh['this-title']=ry (htmlspecialchars ($iy['Title'],ENT_NOQUOTES,'UTF-8')); if(Log::$a)__log ('}'); if(Log::$a)__log ('Comments {'); if ($mm){ $wg = e2_note_cache_filename_with_id_($iy['ID'] .'-comments-author'); } else { $wg = e2_note_cache_filename_with_id_($iy['ID'] .'-comments'); } $ug = null; if(CACHE_NOTES_COMMENTS and is_file ($wg)) { $ug = @unserialize (file_get_contents ($wg)); } if(is_array ($ug)) { if(Log::$a)__log ('retrieve cached ctree'); $tg = $ug; } else { if(Log::$a)__log ('assemble ctree...'); $ig = zb ($iy['ID']); $i1 = []; $og = true; foreach ($ig as $x3 => $gs){ if ($gs['IsVisible']) { $ya = mb ( $iy, $gs, $x3 + 1 ); if ($ya['new?'] and $og){ $ya['first-new?']=true; $og = false; } $i1[] = $ya; } } $tg = $i1; if(CACHE_NOTES_COMMENTS)e3 ($wg,serialize ($tg)); } if ($pg = db ($iy)) { $pg['.comment-number']=count ($tg)+1; } if(Log::$a)__log ('} // Comments'); } $i3 = $noteView -> getNoteCTree (); if ($mm and xb ( $iy,NOTE_COMMENTABLE_NOW_CONDITIONALLY )) { $jg['form-action']=wq ('e2s_note_flag', [ '*note' => $iy, 'flag' => 'IsCommentable', 'value' => (int) !$iy['IsCommentable'], ]); $jg['submit-text'] = ( $iy['IsCommentable']? $_strings['bt--close-comments-to-post']:$_strings['bt--open-comments-to-post'] ); } if ($mm and $i3['new-comments-count']>0){ if(Log::$a)__log ('mark comments as not new'); e2_drop_caches_for_note_($iy['ID'],true); km ( sl (), 'Comments', ['IsNew' => 0], ['NoteID' => $iy['ID']] ); } if(CACHE_RANDOM_NOTE and is_file (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)) { $lh = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)); if (((string)$lh)===$i3['href']) { @unlink (USER_DIR . CACHE_FILENAME_RANDOM_NOTE); } } foreach ($i3['tags'] as $wv){ AeMainMenuManager :: addParentTag ($wv['name']); } $bb = [ 'title' => $iy['Title'], 'notes' => ['only' => $i3], 'pages' => $eh, 'summary' => $i3['summary'], ]; if ($tg)$bb['comments']['each']=$tg; if ($jg)$bb['comments']['toggle']=$jg; $bb['comments']['count']=$i3['comments-count']; $bb['comments']['count-text']=$i3['comments-count-text']; $bb['comments']['new-count']=$i3['new-comments-count']; $bb['comments']['new-count-text']=$i3['new-comments-count-text']; $bb['comments']['display-form?']=xb ($iy); if (!empty ($pg)) { $bb['form']='form-comment'; $bb['form-comment']=$pg; } if (!empty ($rg)) { $bb['form']='form-note-publish'; $bb['form-note-publish']=$rg; } if(Log::$a)__log ('} // Note'); return $bb; } function e2m_note_read ($parameters = []) { global$_config; if (!$_config['count_reads']) { die ('Read counting disabled'); } $iy = $parameters['*note']; if ($iy == false) return e2m_error404 (); if(Log::$a)__log ('Note read {'); em ( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `ReadCount` = `ReadCount` + 1 ". "WHERE `ID` = ". $iy['ID'] ); $cw = time (); $cw = $cw - ($cw % SECONDS_IN_AN_HOUR); zm ( sl (), 'Actions', [ 'EntityID' => $iy['ID'], 'Stamp' => $cw, 'ReadCount' => 1, ], 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `ReadCount` = `ReadCount` + 1' ); em ( "DELETE LOW_PRIORITY FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time () - (SECONDS_IN_A_MONTH)) .")" ); if(Log::$a)__log ('}'); r1 (wq ('e2m_note',$parameters)); } function e2m_note_withdraw ($parameters = []) { $databaseConfiguration = sl (); $s = $parameters['*note']; if (!$s) return e2m_error404 (); if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_note', ['*note' => $s])); } ms (); $vw = wq ('e2m_note_broadcast', ['*note' => $s]); $s['IsPublished']=0; $s['IsCommentable']=0; $s['IsVisible']=1; $s['Stamp']=time (); $s['IP']=fs (); $vn = e2_alias_of_note_with_id_($s['ID']); if ($vn){ $s['OriginalAlias']=$vn; } else { $s['OriginalAlias']=d ( USER_DIR,$databaseConfiguration, 'find','n',$s['ID'],$s['Title'] ); } e2_drop_caches_for_note_($s['ID'],null); km ($databaseConfiguration,'Notes',$s); e2_delete_aliases_for_entity_('n',$s['ID']); ud ($s['ID']); vv ($vw); r1 (wq ('e2m_note', ['*note' => $s])); } function e2m_note_delete ($parameters = []) { global$_strings; $s = @$parameters['*note']; if (!$s) return e2m_error404 (); $hf = kf ($s); $bw = !$s['IsPublished']; if ($bw){ $yw = e2l_get_string ('gs--draft-will-be-deleted', [ 'draft' => htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), ]); } else { $yw = e2l_get_string ('gs--post-will-be-deleted', [ 'post' => htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), ]); } $ts = $bw? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $nw = [ '.note-id' => $s['ID'], '.is-draft' => (int)$bw, 'note-title' => htmlspecialchars ($s['Title'],ENT_COMPAT,'UTF-8'), 'caution-text' => $yw, 'form-action' => wq ('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$bw, ]; if ($hf === 'public'){ $nw['hide-action']=wq ( 'e2s_note_flag', [ '*note' => $parameters['*note'], 'flag' => 'IsVisible', 'value' => 0 ] ); } if ($s['IsPublished']) { $nw['withdraw-action']=wq ( 'e2m_note_withdraw',$parameters ); } $bb = [ 'title' => $ts. ': '. htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), 'heading' => $ts, 'form' => 'form-note-delete', 'form-note-delete' => $nw, ]; return $bb; } function e2s_note_flag_favourite ($parameters){ $parameters['flag']='IsFavourite'; cq ([ 'flag-name' => 'favourite', 'candy-name' => 'e2s_note_flag_favourite', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ pm ($parameters); }, 'redirect-candy' => 'e2m_note', ]); } function e2s_note_flag ($parameters){ pm ($parameters); r1 (wq ('e2m_note',$parameters)); } function pm ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_note',$parameters)); } ms (); $note_id = $parameters['*note']['ID']; if (!is_numeric ($note_id)) throw new AeException ('Note record not cound from parameters'); e2_drop_caches_for_note_($note_id,$parameters['*note']['IsPublished']); if($parameters['flag']=='IsVisible'){ cb (); } km (sl (), 'Notes', [ 'ID' => $note_id, $parameters['flag'] => (int) ($parameters['value']==1), ]); try { hv (bf ($note_id)); } catch (AeMySQLException $e){ v3 ($e,'Could not broadcast note flag change'); } return true; } function e2m_note_use_formatter ($parameters){ $note_id = $parameters['*note']['ID']; if (!is_numeric ($note_id)) { return e2m_error404 (); } e2_drop_caches_for_note_($note_id,$parameters['*note']['IsPublished']); if(in_array ($parameters['formatter'], ['raw','neasden'])) { km (sl (), 'Notes', [ 'ID' => $note_id, 'FormatterID' => $parameters['formatter'], ]); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function cf ($rs,$parameters = []) { global$_strings; $ts = $_strings['pt--new-post']; $js = $_strings['pt--new-post']; $note_id = 'new'; $mw = DEFAULT_FORMATTER; if ($rs == 'write'){ $rf = time (); $fw = 0; $pb = y1 (); $hf = 'draft'; $vn = $dw = ''; } if ($rs == 'edit'){ $s = @$parameters['*note']; if (!$s) return e2m_error404 (); $rf = min ($s['Stamp'],time ()); $fw = (int)$s['LastModified']; $pb = v1 ($s); $hf = kf ($s); if ($s['IsPublished']) { $js = $_strings['pt--edit-post']; $dw = ''; $vn = e2_alias_of_note_with_id_($s['ID']); } else { $js = $_strings['pt--edit-draft']; $dw = d ( USER_DIR,sl (), 'find','n',$s['ID'],$s['Title'] ); if (@$s['OriginalAlias']) { $vn = $s['OriginalAlias']; } else { $vn = $dw; } } $note_id = $s['ID']; $mw = $s['FormatterID']; $ts = $s['Title']; } $sw = za (); $aw = []; if ($sw !== null){ foreach ($sw as $wv){ $aw[] = $wv['tag-dotted']; } } $qw = []; if ($rs == 'edit' and count ($aw)) { $sw = fa ($s['ID']); foreach ($sw as $ub){ $qw[] = ta ($ub); } } $lw = []; foreach ($aw as $zw){ $kw['tag-dotted']=$zw; $kw['selected?']=in_array ($zw,$qw); $lw[] = $kw; } $qw = implode (', ',$qw); $b3 = []; if ($rs == 'write'){ $ws = $_strings['fb--save-and-preview']; $xw = ''; if(is_file (USER_DIR . 'new-uploads.psa')) { $xw = @file_get_contents (USER_DIR . 'new-uploads.psa'); } $n3 = @unserialize ($xw); } if ($rs == 'edit'){ if(array_key_exists ('draft',$parameters)) { $ws = $_strings['fb--save-and-preview']; } else { $ws = $_strings['fb--save-changes']; } $b3 = ty ( $s['FormatterID'],$s['Text'] ); $n3 = @unserialize ( $s['Uploads'] ) or $n3 = []; } $ew = u2 ( j2 ( g2 ( $b3,$n3 ) ) ); if ($rs == 'edit'){ ny ( 'Notes', $s, $b3 ); } $q7 = sy (); $l7 = ay ($q7); $rw = implode (', ',o3 ()); $bb['title']=$ts; $bb['heading']=$js; $bb['form']='form-note'; $bb['uploads'] = [ 'enabled?' => $l7, 'each' => $ew, 'default-name' => htmlspecialchars ($vn,ENT_COMPAT,'UTF-8'), 'allowed-extensions-list' => $rw, 'allowed-extensions-message' => ( _S ('er--supported-file-types') .' '. $rw ), 'upload-action' => wq ('e2j_file_upload'), 'rename-action' => wq ('e2j_file_rename'), 'remove-action' => wq ('e2j_file_remove'), ]; $bb['form-note'] = [ '.note-id' => $note_id, '.formatter-id' => $mw, '.last-modified-stamp' => $fw, '.published?' => (bool) @$s['IsPublished'], '.old-tags-hash' => md5 ($qw), '.action' => $rs, 'form-action' => wq ('e2s_note_process'), 'form-note-livesave-action' => wq ('e2j_note_livesave'), 'create:edit?' => (bool) ($rs == 'write'), 'title' => htmlspecialchars ((string) @$s['Title'],ENT_COMPAT,'UTF-8'), 'tags-info' => $lw, 'text' => htmlspecialchars ((string) @$s['Text'],ENT_NOQUOTES,'UTF-8'), 'stamp-formatted' => d1 ('d.m.Y H:i:s',$rf,$pb), 'time' => @$s['IsPublished']? [(int)$rf,$pb]:false, 'draft?' => $hf === 'draft', 'uploads-enabled?' => $l7, 'summary' => htmlspecialchars ((string) @$s['Summary']), 'alias-autogenerated' => htmlspecialchars ($dw,ENT_COMPAT,'UTF-8'), 'alias' => htmlspecialchars ($vn,ENT_COMPAT,'UTF-8'), 'submit-text' => $ws, 'space-usage' => qy ($q7), ]; if ($rs == 'edit'){ $bb['related-delete-href']=wq ( 'e2m_note_delete', ['*note' => $s] ); } return $bb; } function e2m_note_edit ($parameters = []) { return cf ('edit',$parameters); } function e2m_sw_offline_new () { $tw = AeEnv::$i .'/'; $jw = $tw .'new/'; if (!headers_sent ()) { header ('Content-Type: application/javascript; charset=utf-8'); header ('Service-Worker-Allowed: '. $tw); } echo ( 'self.e2NewNotePath = '. json_encode ($jw,JSON_UNESCAPED_SLASHES) .';'. "\n" ); readfile (SYSTEM_DIR . 'theme/js/e2-sw-offline-new.js'); die; } function e2m_write () { return cf ('write'); } function e2s_note_process () { global$_strings; try { $hw = qf (); $note_id = $hw['data']['id']; $iy = bf ($note_id); r1 (wq ('e2m_note', ['*note' => $iy])); } catch (AeFormIncompleteException $e){ hb ($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); if($e->note_id === 'new'){ r1 (wq ('e2m_write')); } else { r1 (wq ('e2m_note_edit', ['*note' => bf ($e->note_id)])); } } catch (AeMySQLException $e){ v3 ($e,'Could not process note'); r1 (); } die; } function e2s_note_publish () { global$_config,$settings; $databaseConfiguration = sl (); ms (); $note_id = ''; if(array_key_exists ('note-id',$_POST))$note_id = trim ($_POST['note-id']); if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } $gw = false; $s = bf ($note_id); if (!$s)r1 (); $ww = $s['OriginalAlias']; $uw = $s['Stamp']; $iw = !$s['IsExternal']; $s['ID']=$note_id; $s['IsVisible']=1; $s['IsPublished']=1; $s['IsCommentable'] = (int)$settings['comments']['default_on']; if(array_key_exists ('browser-offset',$_POST)) { $pb = e1 (@$_POST['browser-offset']); c1 ($pb); } else { $pb = y1 (); } if ($gw and $rf = af ($gw,$pb)) { $s['Stamp']=$rf; } elseif ($iw){ $s['Stamp']=time (); } else { $s['Stamp']=$uw; } if (wd ($s)) { $s['IsIndexed']='1'; } if ($pb){ $s['Offset'] = (int)$pb['offset']; $s['IsDST'] = (int)$pb['is_dst']; } e2_drop_caches_for_note_($note_id,null); km ($databaseConfiguration,'Notes',$s); $vn = ''; if ($ww or $ww === '0'){ $vn = d ( USER_DIR,$databaseConfiguration, 'set','n',$note_id,$ww ); $s['OriginalAlias']=$vn; } if ($vn != $ww){ km ($databaseConfiguration,'Notes',$s); } $hf = kf ($s); if ($hf === 'public'){ hv ($s); } r1 (wq ('e2m_note', ['*note' => $s])); } function vf ($note_id,$ow = -1){ global$_config; $xs = true; if ($ow){ $xs = false; } if ($ow === -1){ $xs = null; } e2_drop_caches_for_note_($note_id,$xs); em ( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$note_id) ."'", 'delete note by ID' ); ud ($note_id); e2_delete_aliases_for_entity_('n',$note_id); em ( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". ((int)$note_id), 'delete tag bindings after deleting note' ); } function e2s_note_delete () { ms (); $note_id = ''; if(array_key_exists ('note-id',$_POST))$note_id = trim ($_POST['note-id']); if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } $ow = (bool)$_POST['is-draft']; $s = bf ($note_id); if ($s){ $vw = wq ('e2m_note_broadcast', ['*note' => $s]); vf ($note_id,$ow); vv ($vw); } if ($ow){ r1 (wq ('e2m_drafts', ['page' => 1])); } else { r1 (); } die; } function e2j_note_livesave () { try { $hw = qf (); } catch (AeFormIncompleteException $e){ $hw = [ 'success' => false, 'error' => [ 'message' => 'Title or text is empty' ] ]; } catch (AeRecordNotFoundException $e){ $hw = [ 'success' => false, 'error' => [ 'message' => 'Record not found' ] ]; } catch (AeMySQLException $e){ v3 ($e); $hw = [ 'success' => false, 'error' => [ 'message' => 'Database error' ] ]; } echo json_encode ($hw); die; } function bf ($cn){ global$_config; em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $cn ."'" ); $xb = tm (); if(count ($xb)>0){ return $xb[0]; } else { return false; } } function yf ($iy,$pw,$cu = 1){ global$_config; $jh = ($pw == 'next')?'>':'<'; $vu = ($pw == 'next')?'':'DESC '; try { em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". $cu ." ". "AND (". "`Stamp` ". $jh ." '". $iy['Stamp'] ."' ". "OR (`Stamp` = '". $iy['Stamp'] ."' AND `ID` ". $jh . $iy['ID'] .")". ") ". xf (ss ()). "ORDER BY `Stamp` ". $vu . ", `ID` ". $vu . "LIMIT 1", 'get '. $pw .' note' ); $xb = tm (); if(count ($xb)>0) return $xb[0]; else return false; } catch (AeMySQLException $e){ v3 ($e,'Could not get '. $pw .' note'); return null; } } function nf ($bu){ global$_config; if(Log::$a)__log ('Lastmodifieds for Local Copier'); $bu = (string)$bu; $bu = preg_replace ('[^0-9,]','',$bu); $bu = trim ($bu,','); if(CACHE_LASTMODIFIEDS and is_file (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS)) { $yu = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS)); if ($yu['ids_csv']==$bu){ if(Log::$a)__log ('Returned from cache'); return $yu['lastmodifieds_json']; } } $x1 = '`ID`='. str_replace (',',' OR `ID`=',$bu); $nu = []; em ( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $x1 .")", 'get lastmodifieds for Local Copier' ); if(Log::$a)__log ('Requested from DB'); $g3 = tm (); foreach ($g3 as $x3 => $e3){ $nu[(int)$e3['ID']] = (int)$e3['LastModified']; } $mu = json_encode ($nu); if ($mu == '[]')$mu = '{}'; $yu = [ 'ids_csv' => $bu, 'lastmodifieds_json' => $mu, ]; if(CACHE_LASTMODIFIEDS){ e3 (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS,serialize ($yu)); } return $mu; } function mf ($mf,$ff,$df = false){ global$_config; list ($cm,$vm)=z1 ($mf,$ff,$df); em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` AND (`Stamp` BETWEEN " .$cm. " AND " .$vm. ") ". "ORDER BY Stamp", 'get all notes for the date '. $df .'.'. $ff .'.'. $mf ); $bb = []; foreach (tm () as $uf){ if(is_numeric ($df)) { $g1 = ((int)$mf) .'/'. ((int)$ff) .'/'. ((int)$df) == d1 ('Y/n/j',$uf['Stamp'],v1 ($uf)); } elseif(is_numeric ($ff)) { $g1 = ((int)$mf) .'/'. ((int)$ff) == d1 ('Y/n',$uf['Stamp'],v1 ($uf)); } else { $g1 = ((int)$mf) == d1 ('Y',$uf['Stamp'],v1 ($uf)); } if ($g1)$bb[] = $uf; } return $bb; } function e2_published_noterec_with_parameters_($parameters = []) { $iy = e2_noterec_with_parameters_($parameters); if ($iy and $iy['IsPublished']) return $iy; } function e2_noterec_with_parameters_($parameters = []) { global$_config; $iy = false; $du = false; if ((string) @$parameters['oalias']!=='')$du = $parameters['oalias']; if ((string)$du !== ''){ em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `OriginalAlias` = '". $du ."' ". "AND `IsPublished` = 0", 'get note record by original alias' ); $iy = tm (); if(count ($iy)===1) { $iy = @$iy[0]; if ($iy) return $iy; } } $su = false; if (@$parameters['draft']!=='') $su = @$parameters['draft']; if (@$parameters['draft2']!=='')$su = @$parameters['draft2']; if ($su){ $iy = bf ($su); return $iy; } if ((string)$du !== ''){ $parameters['alias']=$du; } if ((string) @$parameters['alias']!==''){ if ($au = f (@$parameters['alias'])) { if ($au['type']=='n'){ $iy = bf ($au['id']); if ($iy and $iy['IsPublished']) return $iy; } } } if ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' ) { $tf = mf ( $parameters['year'],$parameters['month'],$parameters['day'] ); if (@$tf[$parameters['day-number']-1]) { return $tf[$parameters['day-number']-1]; } } return null; } function sf ($ts,$o1,$pb,$xw){ $databaseConfiguration = sl (); vb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $iy = [ 'Title' => $ts, 'Text' => $o1, 'FormatterID' => DEFAULT_FORMATTER, 'OriginalAlias' => d ( USER_DIR,$databaseConfiguration, 'find','','',$ts ), 'Uploads' => $xw, 'IsPublished' => 0, 'Stamp' => (int)time (), 'LastModified' => (int)time (), ]; if ($pb and is_array ($pb)) { $iy['Offset'] = (int)$pb['offset']; $iy['IsDST'] = (int)$pb['is_dst']; } return zm ($databaseConfiguration,'Notes',$iy); } function af ($qu,$pb){ $lu = '/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; if(preg_match ($lu, (string) @$qu,$ff)) { $rf = gmmktime ((int)$ff[4], (int)$ff[5], (int)$ff[6], (int)$ff[2], (int)$ff[1], (int)$ff[3]); $rf -= m1 ($pb,$rf); return $rf; } else { return false; } } function qf () { global$_config; if(Log::$a)__log ('Process note form'); ms (); $note_id = $ts = $zu = $o1 = $ku = $xu = ''; if(array_key_exists ('note-id',$_POST)) $note_id = trim ($_POST['note-id']); if(array_key_exists ('title',$_POST)) $ts = trim ($_POST['title']); if(array_key_exists ('tags',$_POST)) $zu = $_POST['tags']; if(array_key_exists ('text',$_POST)) $o1 = trim ($_POST['text'],"\r\n"); if(array_key_exists ('summary',$_POST)) $ku = trim ($_POST['summary'],"\r\n"); if(array_key_exists ('old-tags-hash',$_POST)) $xu = $_POST['old-tags-hash']; if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } if ((string)$ts === '' or (string)$o1 === ''){ throw new AeFormIncompleteException ($note_id); } $eu = $o1; $eu = str_replace ("\n",'\n'."\n",$eu); $eu = str_replace ("\r",'\r'."\r",$eu); if (!is_array ($zu))$zu = []; $zu = trim (implode (', ',$zu)); $lr = u1 (',',$zu,'sort'); $zu = implode (', ',$lr); $ru = md5 ($zu); if(array_key_exists ('browser-offset',$_POST)) { $tu = e1 (@$_POST['browser-offset']); c1 ($tu); } else { $tu = y1 (); } $ju = (string) @$_POST['old-stamp']; $gw = (string) @$_POST['stamp']; $vn = @$_POST['alias']; $databaseConfiguration = sl (); if($note_id == 'new'){ $xw = ''; if(is_file (USER_DIR . 'new-uploads.psa')) { $xw = @file_get_contents (USER_DIR . 'new-uploads.psa'); } $iy = sf ($ts,$o1,$tu,$xw); $note_id = (int)$iy['ID']; @unlink (USER_DIR . 'new-uploads.psa'); $g3 = [ 'success' => true, 'data' => [ 'status' => 'created', 'id' => $note_id, 'note-url' => wq ('e2m_note', ['*note' => $iy]), 'note-edit-url' => wq ('e2m_note_edit', ['*note' => $iy]) ] ]; } else { $hu = bf ($note_id); if (!$hu){ throw new AeRecordNotFoundException (); } e2_drop_caches_for_note_($note_id,$hu['IsPublished']); $gu = $hu; $gu['ID']=$note_id; $gu['Title']=$ts; $gu['Summary']=$ku; $gu['Text']=$o1; $gu['FormatterID']=$hu['FormatterID']; $gu['LastModified']=time (); $gu['IsIndexed']='0'; $wu = [ 'offset' => $hu['Offset'], 'is_dst' => $hu['IsDST'], ]; if ($gu['FormatterID']!=='raw'){ $gu['FormatterID']=DEFAULT_FORMATTER; } if ($ju != $gw){ if ($rf = af ($gw,$wu)) { $gu['Stamp']=min ($rf,time ()); } } $yn = $vn; if ((string)$vn !== ''){ $uu = $vn; } elseif (!$hu['IsPublished']) { $uu = $ts; } else { $uu = ''; } if ($hu['IsPublished']) { $yn = d ( USER_DIR,$databaseConfiguration, 'set','n',$note_id,$uu ); $iu = [ '*note' => $gu, 'alias' => $yn, ]; } else { $yn = d ( USER_DIR,$databaseConfiguration, 'find','n',$note_id,$uu ); $gu['OriginalAlias']=$yn; $iu = [ '*note' => $gu, 'alias' => $yn, ]; } $b3 = ty ( $gu['FormatterID'],$gu['Text'] ); if(count ($b3)>0){ vd ($b3); bd ($b3); } km ($databaseConfiguration,'Notes',$gu); if ($gu['IsPublished']) { if (wd ($gu)) { $gu['IsIndexed']='1'; km ($databaseConfiguration,'Notes',$gu); } if ($ju != $gw){ b (true); } } $g3 = [ 'success' => true, 'data' => [ 'status' => 'saved', 'id' => (int)$gu['ID'], 'new-alias' => $yn, 'note-url' => wq ('e2m_note',$iu), 'note-edit-url' => wq ('e2m_note_edit',$iu) ] ]; } if ($ru != $xu){ da ($databaseConfiguration,$note_id,$lr); } if (isset ($gu)) { hv ($gu); } if($_config['backup_automatically']) { hm (); } return $g3; } function lf ($ou,$pu){ global$_config; if (!($ou and $pu) and !ss ()) { if(Log::$a)__log ('Error: e2_notes_count_generic called for invisible items unsecurely'); return null; } if (!is_bool ($ou) or !is_bool ($pu)) { if(Log::$a)__log ('Error: e2_notes_count_generic called with non-bool params'); return null; } if (!$ou and !$pu){ if(Log::$a)__log ('Error: e2_notes_count_generic called with nonsensical parameters'); return null; } $a2 = ( USER_DIR . CACHES_DIRNAME . 'notes-count-p'. (int)$ou . ($ou ? ('v'. (int)$pu):'') . '.txt' ); $g3 = false; if(CACHE_NOTES_COUNTS and is_file ($a2)) { $g3 = (int) @file_get_contents ($a2); } if(is_numeric ($g3) and $g3 > 0){ return $g3; } else { $g3 = null; try { em ( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". (int)$ou. " ". ($ou ? ( "AND `IsVisible`=". (int)$pu ) : ""), 'count notes with flags p'. (int)$ou . ($ou ? ('v'. (int)$pu):'') ); $g3 = tm (); $g3 = (int)$g3[0]['NotesCount']; if(CACHE_NOTES_COUNTS)e3 ($a2,$g3); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not count notes'); } return $g3; } } function zf ($o1){ $ku = $o1; $ku = preg_match ( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/mu', $ku, $sr ); $ku = @$sr[3]; if (!$ku)$ku = $o1; if(mb_strlen ($ku) <= 50)$ku = $o1; $ku = str_replace ([ '<p>','<blockquote>','<ul>','<ol>','<br />', ], "\n",$ku); $ku = trim (strip_tags ($ku)); if(mb_strlen ($ku)>50){ $c0 = mb_strpos ($ku,"\n",50); } else { $c0 = mb_strrpos ($ku,"\n"); } if ($c0 !== false){ $ku = mb_substr ($ku,0,$c0); $ku = trim ($ku,' :.()'."\n"); } if(preg_match ('/^(.{100,}?)(?:[:.!?()]|'."\n".')/su',$ku,$sr)) { $ku = trim ($sr[0],' :.()'."\n"); } if(preg_match ('/^(.{150,}?)[:.!?(),]/su',$ku,$sr)) { $ku = trim ($sr[0],' :.(),'."\n"); } if(preg_match ('/^(.{200,}?)[:.!?(), ]/su',$ku,$sr)) { $ku = trim ($sr[0],' :.()'."\n"); } $ku = preg_replace ('/[ \n\r\t]+/su',' ',$ku); if(mb_substr ($ku, -1)==='.')$ku = mb_substr ($ku,0, -1); if(mb_substr ($ku, -1)===':')$ku = mb_substr ($ku,0, -1); if(mb_substr ($ku, -1)==='!')$ku = mb_substr ($ku,0, -1); if (@in_array ($ku[mb_strlen ($ku)-1], [',',' '])) { $ku = trim ($ku,', '). '...'; } if(mb_strlen ($ku)>250){ $ku = trim (mb_substr ($ku,0,250)). '...'; } return $ku; } function kf ($iy){ $v0 = false; if ($iy['IsPublished']) { if ($v0){ return 'scheduled'; } else { if ($iy['IsVisible']) { return 'public'; } else { return 'hidden'; } } } else { return 'draft'; } } function xf ($mm = false){ if ($mm){ return ''; } else { return 'AND (n.`IsVisible` = 1 AND n.`Stamp` <= '. time () .') '; } } function ef () { global$_config; if(CACHE_RANDOM_NOTE and is_file (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)) { $lh = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)); return $lh; } $lh = false; $b0 = lf (true,true); if ($b0 >= 10){ em ( "SELECT COUNT(*) as NotesCount FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsFavourite` = 1 ". "AND n.`IsPublished` = 1 ". "AND n.`IsVisible` = 1 ", 'get the number of visible published favourite notes' ); $g3 = tm (); $y0 = (int)$g3[0]['NotesCount']; $n0 = ''; if ($y0 >= 10){ $n0 = 'AND n.`IsFavourite` = 1'; } em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". $n0 ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsVisible` = 1 ". "ORDER BY RAND() ". "LIMIT 1 ", 'get a random visible published and maybe favourite note' ); $tf = tm (); $lh = wq ('e2m_note', ['*note' => $tf[0]]); } if(CACHE_RANDOM_NOTE){ e3 (USER_DIR . CACHE_FILENAME_RANDOM_NOTE,serialize ($lh)); } return $lh; } function rf ($iy){ return ''; } define ('OLBA_SPECIAL_CHAR',"\x1"); define ('OLBA_SPECIAL_SEQUENCE_LENGTH',6); function gf ($z0 = null){ global$_template,$settings; if ($z0 === null)$z0 = @$settings['template']; $k0 = null; $x0 = null; $e0 = null; $r0 = array (); $t0 = $z0; if ($t0 !== null){ while (1){ foreach ([ USER_DIR . THEMES_DIRNAME, INSTANCE_DIR . THEMES_DIRNAME, SYSTEM_DIR . THEMES_DIRNAME ] as $j0){ $h0 = $j0 . $t0 .'/'; if ( is_dir ($h0) and is_file ($h0 .'/theme-info.php') ) { if(Log::$a)__log ('Theme "'. $t0 .'" found in "'. $h0 . '"'); break; } else { $h0 = false; } } if (!$h0){ if(Log::$a)__log ('Theme "'. $t0 .'" not found, using default theme "'. DEFAULT_TEMPLATE .'"'); $t0 = DEFAULT_TEMPLATE; $h0 = $j0 . $t0 .'/'; } array_push ($r0,$h0); $g0 = include $h0 .'/theme-info.php'; $w0[$h0]=$g0; if(array_key_exists ('meta_viewport',$g0)) { if ($k0 === null){ $k0 = $g0['meta_viewport']; } } if(array_key_exists ('supports_dark_mode',$g0)) { if ($x0 === null){ $x0 = $g0['supports_dark_mode']; } } if(array_key_exists ('use_likely_light',$g0)) { if ($e0 === null){ $e0 = $g0['use_likely_light']; } } if(array_key_exists ('based_on',$g0)) { $t0 = $g0['based_on']; } else { break; } } } if ($k0 === null)$k0 = ''; if ($x0 === null)$x0 = false; if ($e0 === null)$e0 = false; $h0 = SYSTEM_THEME_DIR; array_push ($r0,$h0); $w0[$h0] = []; $_template['name']=$z0; $_template['meta_viewport']=$k0; $_template['supports_dark_mode']=$x0; $_template['use_likely_light']=$e0; $_template['stack']=$r0; $_template['infos']=$w0; }; function wf ($u0){ global$content; if (!isset ($_olba_includes))$_olba_includes = 0; ++ $_olba_includes; if(Log::$a)__log ('Eat "'. $u0 .'"'); ob_start (); include $u0; return ob_get_clean (); } function uf ($fb){ return ( OLBA_SPECIAL_CHAR. str_pad ($fb,OLBA_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT). OLBA_SPECIAL_CHAR ); } function if_ ($name){ static $fb = 0; k2 ($name,'_olba_placeholders'); return uf ($fb ++); } function of ($i0){ global$_olba_placeholders; foreach($_olba_placeholders as $fb => $bv){ $o0 = uf ($fb); $p0 = strpos ($i0,$o0); $c9 = c2 ($bv,true); if ($p0 !== false){ $i0 = substr_replace ( $i0,$c9,$p0,strlen ($o0) ); } else { break; } } return $i0; } function pf ($v9){ foreach ([ USER_DIR . EXTRAS_DIRNAME, INSTANCE_DIR . EXTRAS_DIRNAME, SYSTEM_DIR . EXTRAS_DIRNAME ] as $b9){ if(is_dir ($b9)) { $y9 = $b9 . $v9 .'.tmpl.php'; if(is_file ($y9)) { return wf ($y9); } } } return ''; } function c2 ($v9){ global$_template,$_olba_includes; $y9 = 'templates/'. $v9 .'.tmpl.php'; if ($u0 = e2o__usable_file_with_basename_($y9)) { return wf ($u0); } else { ob_end_clean (); throw new AeOlbaTemplateMissingException ('Missing: '. $y9); } } function v2 () { global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists ('raw',$_GET) ) { $n9 = 'raw'; } else { $n9 = 'main'; } return c2 ($n9,true); } function b2 ($m9){ k2 ($m9 .'.css','_olba_used_stylesheets'); } function y2 ($f9){ k2 ($f9 .'.js','_olba_used_scripts'); } function n2 ($d9){ foreach ([ SYSTEM_DIR . LIBRARY_DIRNAME, INSTANCE_DIR . LIBRARY_DIRNAME, USER_DIR . LIBRARY_DIRNAME ] as $s9){ foreach(glob ($s9 . $d9 .'/*') as $cy){ $cz = pathinfo ($cy,PATHINFO_EXTENSION); if ($cz == 'js'){ k2 ($cy,'_olba_used_scripts'); } if ($cz == 'css'){ k2 ($cy,'_olba_used_stylesheets'); } } } } function m2 () { global$_template,$settings; foreach ([ USER_DIR . THEMES_DIRNAME, INSTANCE_DIR . THEMES_DIRNAME, SYSTEM_DIR . THEMES_DIRNAME ] as $a9){ if ($q9 = @opendir ($a9)) { while (false !== ($l9 = readdir ($q9))) { if(is_dir ($a9. $l9) and $l9 != '.' and $l9 != '..'){ if(is_file ($a9 . $l9 .'/theme-info.php')) { $z9[$l9]=$a9 . $l9 .'/'; } } } closedir ($q9); } } $jv = array (); $k9 = 1000; foreach ($z9 as$name => $u){ $g0 = include $u .'theme-info.php'; $x9 = @$g0['display_name']; if (!$x9) continue; if(is_array ($x9)) { if(array_key_exists ($settings['language'],$x9)) { $x9 = $x9[$settings['language']]; } else { $x9 = array_shift ($x9); } } $fb = @$g0['index'] or $fb = $k9 ++; $e9 = @$g0['colors']; if (!$e9)$e9 = array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $r9 = (bool) ($name == $_template['name']); if ($r9){ $t9 = wq ('e2m_theme_preview', array ('theme' => '')); } else { $t9 = wq ('e2m_theme_preview', array ('theme' => $name)); } $jv[$fb] = array ( 'name' => $name, 'display-name' => $x9, 'colors' => $e9, 'current?' => $r9, 'preview-url' => $t9, 'supports-dark-mode?' => (bool) @$g0['supports_dark_mode'], ); } ksort ($jv); return $jv; } function f2 ($ds){ return e2o__usable_file_with_basename_('images/'. $ds); } function d2 ($j9){ $h9 = e2o__usable_file_with_basename_('images/'. $j9 .'.svg'); if(is_file ($h9)) { return file_get_contents ($h9); } return ''; } function s2 ($m9){ global$_template; $ms = 'styles/'. $m9 .'.css'; $g9 = array (); foreach($_template['stack'] as $h0){ if(is_file ($ds = $h0 . $ms)) { $g9[] = $ds; } if ( array_key_exists ('reset_styles',$_template['infos'][$h0]) and in_array ($m9,$_template['infos'][$h0]['reset_styles']) ) { break; } } $g9 = array_reverse ($g9); } function a2 ($jv){ foreach ($jv as $x3 => $e3){ $as_ = stat ($e3); $jv[$x3]=AeEnv::$p . $jv[$x3] .'?'. $as_['mtime']; } return $jv; } function q2 () { global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets = array_unique ($_olba_used_stylesheets); $w9 = array (); foreach($_olba_used_stylesheets as $m9){ if(is_file ($m9)) { $w9[] = $m9; continue; } if(is_file ($ds = USER_DIR . SCRIPTS_SUBDIR . $m9)) { $w9[] = $ds; } $ms = 'styles/'. $m9; $g9 = array (); foreach($_template['stack'] as $h0){ if(is_file ($ds = $h0 . $ms)) { $g9[] = $ds; } if ( array_key_exists ('reset_styles',$_template['infos'][$h0]) and in_array ($m9,$_template['infos'][$h0]['reset_styles']) ) { break; } } $g9 = array_reverse ($g9); $w9 = array_merge ($w9,$g9); } $w9 = a2 ($w9); return $w9; } function l2 () { global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts = array_unique ($_olba_used_scripts); $u9 = array (); foreach($_olba_used_scripts as $f9){ if ( substr ($f9,0,7)=='http://' or substr ($f9,0,8)=='https://' or substr ($f9,0,2)=='//' ) { $u9[] = $f9; continue; } if(is_file ($f9)) { $u9[] = $f9; continue; } if(is_file ($i9 = USER_DIR . SCRIPTS_SUBDIR . $f9)) { $u9[] = $i9; } $ms = SCRIPTS_SUBDIR . $f9; if ($i9 = e2o__usable_file_with_basename_($ms)) { $u9[] = $i9; } } $u9 = a2 ($u9); return $u9; } function z2 ($o9){ if (!is_array ($o9)) return; foreach ($o9 as $n6){ if(substr ($n6, -3)=='.js'){ y2 (SYSTEM_DIR . LIBRARY_DIRNAME . substr ($n6,0, -3)); } if(substr ($n6, -4)=='.css'){ b2 (SYSTEM_DIR . LIBRARY_DIRNAME . substr ($n6,0, -4)); } } } function k2 ($bv,$zs){ if (!isset ($GLOBALS[$zs])) { $GLOBALS[$zs] = array ($bv); } else { $GLOBALS[$zs][] = $bv; } } function e2o__usable_file_with_basename_($ms){ global$_template; if (!isset ($_template))gf (); foreach($_template['stack'] as $h0){ if(is_file ($ds = $h0 . $ms)) { return $ds; } } return ''; } function e2m_theme_preview ($parameters){ global$_lang,$_strings,$_config,$settings,$_template; if (!$_config['allow_themes_preview']) { return e2m_error404 (); } if ((string)$parameters['theme']!==''){ gf ($parameters['theme']); } else { gf (); } if($parameters['theme'] == @$settings['template']) { r1 (wq ('e2m_theme_preview', ['theme' => ''])); } $s6 = $_lang; if (!is_file ($cy = 'system/preview/'. $s6 .'.php')) { $s6 = $_strings['--secondary-language']; $cy = 'system/preview/'. $s6 .'.php'; } if (!is_file ($cy = 'system/preview/'. $s6 .'.php')) { $cy = 'system/preview/'. DEFAULT_LANGUAGE .'.php'; } $v = include $cy; return $v; } function e2m_popular ($parameters = []) { global$settings,$_config,$_strings; $mm = ss (); $popularView = new AePageableNotesView ('e2m_popular',$parameters); $popularView -> setPortionSize ($settings['appearance']['notes_per_page']); $popularView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $popularView -> setWantNewCommentsCount ($mm); $popularView -> setWantReadHrefs ($_config['count_reads']); $popularView -> setWantControls ($mm and !@$_config['read_only']); $popularView -> setWantHiddenTags ($mm); AeMainMenuManager :: $isPopularCurrent = true; $tl = $_config['popular_period']; if ($tl === 'ever'){ $popularView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". xf ($mm). "ORDER BY `ReadCount` DESC" ); } else { $jl = time () - n3 ($_config['popular_period']); $p9 = ( "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND a.`Stamp` > ". $jl ." ". "AND n.`IsPublished` = 1 ". xf ($mm). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID`" ); $popularView -> setSQLCountRequest ( "SELECT COUNT(*) Total FROM (SELECT 1 ". $p9 .") _" ); $popularView -> setLimitlessSQLRequest ( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". $p9 ." ". "ORDER BY `AggregateReadCount` DESC" ); } $bb = [ 'title' => e2l_get_string ('pt--most-read', ['period' => $tl]), 'heading' => e2l_get_string ('pt--most-read', ['period' => $tl]), 'notes' => $popularView -> getNotesCTree (), 'pages' => $popularView -> getPagesCTree (), ]; if($popularView -> isFirstPageOfEmptyView ()) { $bb['nothing']=$_strings['gs--no-such-notes']; } elseif (!$popularView -> isExistingPage ()) { return e2m_error404 (); } return $bb; } function e2_ ($es = false,$z3 = []) { global$_config,$_current_url; $ci = $vi = ''; $mostReadNotesCollectionView = new AeArbitraryNotesCollectionView ('most read or most read by tag'); $mostReadNotesCollectionView -> setCurrentURL ($_current_url); $mostReadNotesCollectionView -> setFilterOutIDs ($z3); $jl = time () - n3 ($_config['popular_period']); $mostReadNotesCollectionView -> setSQLRequest ( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". $ci. "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". $vi. "AND a.`Stamp` > ". $jl ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsFavourite` = 1 ". xf (ss ()). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, `AggregateReadCount` DESC ". "LIMIT 10" ); if ($es === false){ if(CACHE_POPULAR){ $mostReadNotesCollectionView -> setViewExpiration (SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename (USER_DIR . CACHE_FILENAME_POPULAR); $mostReadNotesCollectionView -> setCacheExpiresFilename (USER_DIR . CACHE_FILENAME_POPULAR_EXPIRES); } } else { if(CACHE_POPULAR_WITH_TAG){ $mostReadNotesCollectionView -> setViewExpiration (SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename (e2_cache_filename_with_id_($es,USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG)); $mostReadNotesCollectionView -> setCacheExpiresFilename ( e2_cache_filename_with_id_($es,USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES) ); } } return$mostReadNotesCollectionView -> getNotesCTree (); } function r2 ($es = false,$z3 = []) { global$_strings; $bi = [ 'title' => $_strings['nm--most-read'], ]; $bi['each']=e2_ ($es,$z3); if ($es){ $bi['seed']=$es; } if(count ($bi['each']) < 7){ return []; } return $bi; } function e2s_post_service ($parameters){ global$_config; $yi = wq ('e2m_settings'); if($_config['allow_underhood_access']) { $yi = wq ('e2m_underhood'); } if($_SERVER['REQUEST_METHOD']!='POST'){ r1 ($yi); } if($_config['allow_underhood_access']) { if($parameters['service']==='build'){ ms (); e2_build (); hb ('Engine core built',E2E_MESSAGE); } if($parameters['service']==='sync'){ ms (); e2_drop_all_kinds_of_cache (); hb ('Caches invalidated',E2E_MESSAGE); } if($parameters['service']==='checklist-reset'){ ms (); us (); hb ('Checklist reset',E2E_MESSAGE); } if($parameters['service']==='log'){ ms (); hn (); hb ('Logs enabled',E2E_MESSAGE); } if($parameters['service']==='unlog'){ ms (); sq (INSTANCE_DIR . LOGS_DIRNAME . '*'); hb ('All logs deleted',E2E_MESSAGE); } if($parameters['service']==='migrate'){ ms (); bm (sl ()); hb ('Database structure up to date',E2E_MESSAGE); } } if($parameters['service']==='backup'){ } r1 ($yi); } define ('PROVIDE_MEDIA_ASYNC',10); define ('PROVIDE_MEDIA_NOW',20); function t2 ($ni){ global$_config; $mi = parse_url ($ni); if (isset ($mi['host'])) { $url = $ni; if ($mi['host']=='www.youtube.com'){ $cn = basename ($mi['path']); $fi = 'remote/youtube-'. $cn .'-cover.jpg'; $lz = $_config['path_media'].PICTURES_DIRNAME . $fi; $zz = nd ($fi); return [ 'url' => $url, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'youtube', 'video-id' => $cn, 'local-cover-href' => AeEnv::$p . PICTURES_DIRNAME . $fi, 'local-relative-filename' => $fi, 'local-full-filename' => $lz, 'local-full-failname' => $lz . '.failed', 'local-full-thumb-filename' => $zz, ]; } elseif ($mi['host']=='player.vimeo.com'){ $cn = basename ($mi['path']); $fi = 'remote/vimeo-'. $cn .'-cover.jpg'; $lz = $_config['path_media'].PICTURES_DIRNAME . $fi; $zz = nd ($fi); return [ 'url' => $url, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'vimeo', 'video-id' => $cn, 'local-cover-href' => AeEnv::$p . PICTURES_DIRNAME . $fi, 'local-relative-filename' => $fi, 'local-full-filename' => $lz, 'local-full-failname' => $lz . '.failed', 'local-full-thumb-filename' => $zz, ]; } elseif (dd ($mi['path'])) { return [ 'url' => $url, 'type' => 'remote-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => false, 'mime-type' => xd ($mi['path']), 'length' => '', ]; } else { return [ 'url' => $url, 'type' => 'remote-non-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => xd ($mi['path']), 'length' => '', ]; } } else { if (dd ($mi['path'])) { $url = AeEnv::$p . PICTURES_DIRNAME . $mi['path']; $qz = $_config['path_media'].PICTURES_DIRNAME; $lz = $qz . $mi['path']; $di = sd ($mi['path']); if ($di){ $zz = nd ($mi['path']); } else { $zz = $lz; } return [ 'url' => $url, 'type' => 'local-image', 'is-local?' => true, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => $di, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'mime-type' => xd ($mi['path']), 'length' => @stat ($lz)['size'], 'local-href' => $url, 'local-cover-href' => $url, 'default-filename' => 'image', 'local-folder' => $qz, 'local-relative-filename' => $mi['path'], 'local-full-filename' => $lz, 'local-full-thumb-filename' => $zz, ]; } elseif (qd ($mi['path'])) { $url = AeEnv::$p . VIDEO_DIRNAME . $mi['path']; $qz = $_config['path_media'].VIDEO_DIRNAME; $lz = $qz . $mi['path']; return [ 'url' => $url, 'type' => 'local-video', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => xd ($mi['path']), 'length' => @stat ($lz)['size'], 'local-href' => $url, 'default-filename' => 'video', 'local-folder' => $qz, 'local-relative-filename' => $mi['path'], 'local-full-filename' => $lz, 'local-full-thumb-filename' => SYSTEM_THEME_DIR . VIDEO_ICON_FILENAME, ]; } elseif (ld ($mi['path'])) { $url = AeEnv::$p . AUDIO_DIRNAME . $mi['path']; $qz = $_config['path_media'].AUDIO_DIRNAME; $lz = $qz . $mi['path']; return [ 'url' => $url, 'type' => 'local-audio', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => xd ($mi['path']), 'length' => @stat ($lz)['size'], 'local-href' => $url, 'default-filename' => 'audio', 'local-folder' => $qz, 'local-relative-filename' => $mi['path'], 'local-full-filename' => $lz, 'local-full-thumb-filename' => SYSTEM_THEME_DIR . AUDIO_ICON_FILENAME, ]; } else { return [ 'url' => '', 'type' => 'unsupported', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => false, ]; } } } function j2 ($h4){ $ai = []; foreach ($h4 as $ni){ $az = t2 ($ni); if ($az['is-local?'])$ai[] = $ni; } return $ai; } function h2 ($h4){ $ai = []; foreach ($h4 as $ni){ $az = t2 ($ni); if ($az['is-snippetable?'])$ai[] = $ni; } return $ai; } function g2 ( $b3,$n3 ) { if (!is_array ($b3))$b3 = []; if (!is_array ($n3))$n3 = []; $h4 = array_merge ($n3,$b3); $h4 = array_reverse ($h4); $h4 = array_unique ($h4); $h4 = array_reverse ($h4); return $h4; } function w2 ($h4){ if (!is_array ($h4) or !count ($h4)) return []; bd ($h4); $qi = []; foreach ($h4 as $ni){ if (!empty ($li[$ni])) continue; $az = t2 ($ni); if (!$az['is-usable-as-cover?']) continue; if (!is_file ($az['local-full-filename'])) continue; $size = e2_getimagesize ($az['local-full-filename']); list ($zk,$kk,$b5,$y5)=$size; $qi[] = [ 'src' => $az['local-cover-href'], 'width' => $zk, 'height' => $kk, 'horizontality' => $b5, 'verticality' => $y5, ]; $li[$ni]=true; } return $qi; } function u2 ($h4){ global$_strings; if (!is_array ($h4) or !count ($h4)) return []; bd ($h4); $zi = []; foreach ($h4 as $ni){ if (!empty ($li[$ni])) continue; $az = t2 ($ni); if (!$az['is-using-thumbnails?']) continue; if (!is_file ($az['local-full-filename'])) continue; $ki = [ 'is-available?' => true, 'src' => '', 'width' => '', 'height' => '', 'original-filename' => '', 'original-filesize' => '', ]; if (!$az['is-local?'] or is_file ($az['local-full-filename'])) { if ($az['is-generating-thumbnail?']) { $xi = yd ( $az ); } else { $xi = $az['local-full-thumb-filename']; } } if (empty ($xi)) { $ki['is-available?']=false; $xi = nd ( $az['local-relative-filename'] ); } $ki['src']=my ($xi); if ($ki['is-available?']) { if ($az['type']==='local-audio'){ $zk = AUDIO_ICON_WIDTH / 2; $kk = AUDIO_ICON_HEIGHT / 2; } else { $size = e2_getimagesize ($xi); list ($zk,$kk)=$size; } } else { $zk = $kk = ''; } if (!$zk)$zk = THUMB_WIDTH/2; if (!$kk)$kk = THUMB_HEIGHT/2; list ($zk,$kk)=e2_fit_metrics_to_constraints ( [$zk,$kk], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $ki['width']=$zk; $ki['height']=$kk; if ($az['is-local?']) { $ki['original-filename']=$ni; if(is_file ($az['local-full-filename'])) { $bk = stat ($az['local-full-filename'])[7]; $bk = round ($bk / 1024) .' '. $_strings['gs--kb']; $ki['original-filesize']=$bk; } } $zi[] = $ki; $li[$ni]=true; } return $zi; } function i2 ($ei){ foreach ( ['maxresdefault','hqdefault','mqdefault','sddefault','default'] as $ds ) { $url = 'http://img.youtube.com/vi/'. $ei .'/'. $ds .'.jpg'; if(Log::$a)__log ('Trying '. $url .'...'); $ri = @file_get_contents ($url); if ($ri !== false) return $ri; } return false; } function o2 ($ti){ $ji = @unserialize ( file_get_contents ('http://vimeo.com/api/v2/video/'. $ti .'.php') ); if (!empty ($ji[0]['thumbnail_large'])) { return @file_get_contents ($ji[0]['thumbnail_large']); } return false; } function p2 ($az,$hi){ if(is_file ($az['local-full-filename'])) { if(Log::$a)__log ('Already exists: '. $az['local-full-filename']); } elseif(is_file ($az['local-full-failname'])) { if(Log::$a)__log ('Already tried and failed: '. $az['local-full-filename']); } else { if(Log::$a)__log ('Resource '. $az['url'].' is missing a cover, retrieving'); if ($hi == PROVIDE_MEDIA_ASYNC){ vv (wq ('e2s_retrieve', [ 'url' => strtr (base64_encode ($az['url']), '+/','-_'), ])); } if ($hi == PROVIDE_MEDIA_NOW){ if(Log::$a)__log ('Downloading "'. $az['video-service'] .'" cover as '. $az['local-full-filename'] .'...'); if ($az['video-service']=='youtube'){ $ri = i2 ($az['video-id']); } if ($az['video-service']=='vimeo') { $ri = o2 ($az['video-id']); } if ($ri !== false){ e3 ($az['local-full-filename'],$ri); } else { e3 ($az['local-full-failname'],''); } } } } function cd ($ni,$hi){ $az = t2 ($ni); if(Log::$a)__log ('Resource '. $ni .' is of type '. $az['type']); if ($az['type']=='local-image'){ yd ($az); } if ($az['type']=='online-video'){ p2 ($az,$hi); if ($hi == PROVIDE_MEDIA_NOW and is_file ($az['local-full-filename'])) { yd ($az); } } if ($az['type']=='remote-image'){ } } function vd ($h4){ foreach ($h4 as $ni){ $az = t2 ($ni); if (empty ($az['local-full-failname'])) continue; if(is_file ($az['local-full-failname'])) { if(Log::$a)__log ('Deleting '. $az['local-full-failname'] .' to try again'); unlink ($az['local-full-failname']); } } } function bd ($h4){ if (!is_array ($h4)) return; if(Log::$a)__log ('Asynchronously provide data for resnames {'); foreach ($h4 as $ni){ cd ($ni,PROVIDE_MEDIA_ASYNC); } if(Log::$a)__log ('}'); } function yd ($az){ if (!$az['is-generating-thumbnail?']) return false; return e2img_filename_by_processing ( $az['local-full-filename'], $az['local-full-thumb-filename'], [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY ); } function nd ($si){ global$_config; $gi = pathinfo ($si); $cz = @$gi['extension']; if ($cz === 'jpg'){ $wi = 'thumb@2x.jpg'; } else { $wi = $cz. '.thumb@2x.jpg'; } return zd ( $_config['path_media'].THUMBNAILS_DIRNAME . $si, $wi ); } function fd ($ni){ $gi = pathinfo ($ni); $cz = @$gi['extension']; return (in_array (strtolower ($cz), ['jpg','jpeg'])); } function dd ($ni){ $gi = pathinfo ($ni); $cz = strtolower ((string) @$gi['extension']); $xz = ['jpg','jpeg','gif','png','svg']; if(e2_is_webp_supported ())$xz[] = 'webp'; if(e2_is_avif_supported ())$xz[] = 'avif'; return in_array ($cz,$xz); } function sd ($ni){ $gi = pathinfo ($ni); $cz = strtolower ((string) @$gi['extension']); $xz = ['jpg','jpeg','gif','png']; if(e2_is_webp_supported ())$xz[] = 'webp'; if(e2_is_avif_supported ())$xz[] = 'avif'; return in_array ($cz,$xz); } function ad ($ni){ $gi = pathinfo ($ni); $cz = (string) @$gi['extension']; return (in_array (strtolower ($cz), ['svg'])); } function qd ($ni){ $gi = pathinfo ($ni); $cz = (string) @$gi['extension']; return (in_array (strtolower ($cz), ['mp4','mov'])); } function ld ($ni){ $gi = pathinfo ($ni); $cz = (string) @$gi['extension']; return (in_array (strtolower ($cz), ['mp3','ogg'])); } function zd ($ni,$ii){ if (empty ($ii)) return $ni; $oi = substr ($ni,0,strrpos ($ni,'.')); $pi = $oi .'.'. $ii; return $pi; } function kd ($u,$ms){ if (!is_file ($u . $ms)) return $ms; $o4 = strrpos ($ms,'.'); $p4 = substr ($ms,0,$o4); $cz = substr ($ms,$o4); $wb = 0; while (is_file ($u . $p4 .'-'. (++ $wb).$cz)); $ms = $p4 .'-'. $wb . $cz; return $ms; } function xd ($ni){ $gi = pathinfo ($ni); $cz = strtolower ((string) @$gi['extension']); if ($cz == 'png') return 'image/png'; if ($cz == 'webp') return 'image/webp'; if ($cz == 'avif') return 'image/avif'; if ($cz == 'gif') return 'image/gif'; if ($cz == 'jpg' or $cz == 'jpeg') return 'image/jpeg'; if ($cz == 'mp3') return 'audio/mpeg'; if ($cz == 'ogg') return 'audio/ogg'; if ($cz == 'svg') return 'image/svg+xml'; if ($cz == 'mp4') return 'video/mp4'; if ($cz == 'mov') return 'video/quicktime'; } function ed ($co,$vo){ return strcasecmp ($co,$vo)===0; } define ('SEARCH_EXTRA_PREFIX','Rose'); define ('SEARCH_LIMIT',20); define ('SEARCH_SNIPPETS_LIMIT',20); define ('SEARCH_USE_ROSE',1); define ('SEARCH_USE_MYSQL',1); define ('BSI_SELECT_PORTION',10); define ('BSI_GIVE_UP_TIMEOUT',10); define ('BSI_UNLOCK_TIMEOUT',10); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Storage\Database\MysqlRepository; use S2\Rose\Stemmer\PorterStemmerEnglish; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Entity\ExternalContent; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found ($parameters = []) { global$_strings,$_config; $parameters['query']=trim ($parameters['query']); $p2 = $parameters['query']; if (!$p2){ return [ 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ]; } $bo = false; $yo = []; try { if (ss ()) { $no = ''; } else { $no = 'AND `IsVisible` = 1 '; } em ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". $no . "AND `Keyword`='". jm ($p2) ."'", 'get tags matching the search query' ); $hb = tm (); if (isset ($hb[0]['ID'])) { $bo = [ 'href' => wq ('e2m_tag', ['*tag' => $hb[0]]), 'name' => htmlspecialchars ($hb[0]['Keyword'],ENT_COMPAT,'UTF-8'), 'visible?' => (bool)$hb[0]['IsVisible'], ]; $yo = aa ($hb[0]['ID'],4); array_unshift ($yo,$bo); } } catch (AeMySQLException $e){ v3 ($e,'Could not get tags matching the search query'); } $mo = u1 (' ',$parameters['query']); if(SEARCH_USE_ROSE){ $fo = new PorterStemmerRussian (new PorterStemmerEnglish ()); foreach ($mo as $x3 => $e3){ $mo[$x3]=$fo -> stemWord ($mo[$x3]); } } $do_ = []; $mm = ss (); if(SEARCH_USE_ROSE){ try { $k5 = pd (sl ()); $so = new Finder ($k5,$fo); $so -> setHighlightTemplate ('<mark>%s</mark>'); $ao = new Query ($p2); $ao -> setInstanceId ($_config['db_table_subset']); $ao -> setLimit (SEARCH_LIMIT); $resultSet = $so -> find ($ao); foreach($resultSet -> getFoundExternalIds () as $qo){ $lo = $qo -> getId (); if ($lo[0]=='n'){ $note_id = substr ($lo,1); $iy = bf ($note_id); if (!empty ($_config['search_favourites_boost'])) { if ($iy['IsFavourite']) { $resultSet->setRelevanceRatio ( $lo, $_config['search_favourites_boost'] ); } } } } $snippetBuilder = new SnippetBuilder ($fo); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets ( $resultSet, static function (array $ko) use ($mm,$_config){ $g3 = new ExternalContent (); foreach ( array_slice ($ko,0,SEARCH_SNIPPETS_LIMIT) as $qo ) { $lo = $qo -> getId (); if ($lo[0]=='n'){ $note_id = substr ($lo,1); $iy = bf ($note_id); if ($iy){ $noteView = new AeNoteView ($iy); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($mm and !@$_config['read_only']); $noteView -> setWantHiddenTags ($mm); $i3 = $noteView -> getNoteCTree (); $xo[$iy['ID']] = $i3; $g3 -> attach ($qo,$i3['text']); } } } return $g3; } ); foreach($resultSet -> getItems () as $eo){ $ro = $eo -> getId (); if ($ro[0]=='n'){ $note_id = substr ($ro,1); $iy = bf ($note_id); if (!( kf ($iy)==='public' or ($mm and $iy['IsPublished']) )) continue; $iy['_']['_srprovider']='Rose'; $iy['_']['_rose_relevance']=$eo -> getRelevance (); $iy['_']['_rose_title']=$eo -> getHighlightedTitle ($fo); $iy['_']['_rose_snippet']=$eo -> getSnippet (); $do_[] = $iy; } } $to = false; if (@$_config['dev_rose_info']) { $to = print_r ($resultSet -> getTrace (), true); } } catch (EmptyIndexException $e){ bs (sl ()); jd (USER_DIR); } catch (AeMySQLException $e){ v3 ($e,'Could not do something with the database while working on Rose search results'); } } if(SEARCH_USE_MYSQL){ $jo = jm (preg_quote ($p2)); $ho = 'MySQL FT'; $go = ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 AND (". "MATCH (`Title`, `Text`) AGAINST ('". $jo ."')". ") ". xf ($mm). "LIMIT ". SEARCH_LIMIT ); try { em ( $go, 'search using MySQL fulltext search' ); $g3 = tm (); foreach ($g3 as $x3 => $iy){ $iy['_']['_srprovider']=$ho; $do_[] = $iy; } } catch (AeMySQLException $e){ v3 ($e,'Could not search using MySQL fulltext search'); } } $wo = []; $bm = []; $wb = 0; foreach ($do_ as $iy){ if (!in_array ($iy['ID'],$wo)) { if (!empty ($xo[$iy['ID']])) { $r = $xo[$iy['ID']]; } else { $noteView = new AeNoteView ($iy); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($mm and !@$_config['read_only']); $r = $noteView -> getNoteCTree (); } $r['search-result-provider']=$iy['_']['_srprovider']; if ($iy['_']['_srprovider']=='Rose'){ $r['search-rose'] = [ 'relevance' => $iy['_']['_rose_relevance'], 'title' => $iy['_']['_rose_title'], 'snippet' => $iy['_']['_rose_snippet'], ]; } if (@$iy['_']['_rose_title']) { $r['title']=$iy['_']['_rose_title']; } else { $r['title']=cs ($r['title'],$mo); } $r['title']=ry ($r['title']); if (!empty ($iy['_']['_rose_snippet'])) { $r['snippet-text']=$iy['_']['_rose_snippet']; } else { $o1 = $r['text']; $o1 = preg_replace ('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$o1); $o1 = preg_replace ('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$o1); $o1 = str_replace ( [ '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ], ' ', $o1 ); $o1 = strip_tags ($o1); $uo = []; $io = preg_split ('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$o1); $oo = 0; $po = ''; foreach ($io as $cp){ $cp = trim ($cp); if (!$cp) continue; if (!$po)$po = $cp; $vp = $cp; $vp = cs ($vp,$mo); if ($vp != $cp){ $uo[] = vs ($vp); $oo ++; if ($oo > 3) break; } } if(count ($uo)) { $r['snippet-text']=implode (' · ',$uo); } else { $r['snippet-text']=$po; } } $r['has-highlighed-thumbs?']=false; if ($b3 = @$r['format-info']['resources-detected']) { $bp = u2 ( h2 ($b3) ); foreach ($bp as $x3 => $e3){ $bp[$x3]['highlighted?'] = ( strstr ($e3['original-filename'],$p2)!==false ); if ($bp[$x3]['highlighted?']) { $r['has-highlighted-thumbs?']=true; } } $r['thumbs']=$bp; } $bm[] = $r; $wo[] = $iy['ID']; $wb ++; if ($wb >= SEARCH_LIMIT) break; } } $nd = count ($bm); if ($nd){ $yp = e2l_get_string ( 'pt--n-posts', ['number' => $nd] ); } else { $yp = $_strings['pt--no-posts']; $bb['nothing']=$_strings['gs--nothing-found']; } if ($wb >= SEARCH_LIMIT){ $yp = $_strings['gs--many-posts']; } if ($yo){ $bb['search-related-tags']=$yo; } $bb['notes']=$bm; $bb['pages'] = []; $bb['title']=$yp .' '. $_strings['gs--found-for-query'] .': '. $p2; $bb['heading']=''; if (@$to){ $bb['rose-debug-info']=$to; } return $bb; } function rd ($parameters){ if(Log::$a)__log ('Search form'); $p2 = trim ((string) @$parameters['query']); return [ 'form-action' => wq ('e2s_search'), 'query' => htmlspecialchars ($p2,ENT_COMPAT,'UTF-8'), ]; } function e2s_search () { $p2 = @$_POST['query']; $p2 = str_replace ('?',urlencode ('?'), (string) @$p2); $p2 = str_replace ('/',' ',$p2); $p2 = trim ($p2); $p2 = str_replace (' ','+',$p2); r1 (wq ('e2m_found', ['query' => $p2])); } function td () { global$_config; em ( "SELECT COUNT(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ", 'count total published notes' ); $rt = tm (); $np = $rt[0]['c']; em ( "SELECT COUNT(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed` = 1 AND `IsPublished` = 1 ", 'count indexed published notes' ); $rt = tm (); $mp = $rt[0]['c']; $fp = true; foreach (od () as $y8){ if (!am ( sl (), SEARCH_EXTRA_PREFIX . $y8 )) { $fp = false; break; } } $dp = hd (USER_DIR); if (!$fp){ $mp = 0; $dp['spent']=false; } $sp = $np - $mp; return [ 'indexed_count' => $mp, 'total_count' => $np, 'remaining_count' => $sp, 'time_spent' => @$dp['spent']? $dp['spent']:false, ]; } function e2s_bsi_step () { global$_config; $dp = hd (USER_DIR); ignore_user_abort (true); echo '<pre>'; if($_config['log_bsi']) { Log::$a = true; if(Log::$a)tn ('bsi'); } if(Log::$a)__log ('BSI step'); if ( !isset ($dp['lock']) or $dp['lock']<time () - (BSI_GIVE_UP_TIMEOUT + BSI_UNLOCK_TIMEOUT) ) { if (isset ($dp['lock'])) { if(Log::$a)__log ('Indexer: old lock is '. $dp['lock']); echo 'Old lock is '. $dp['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $dp['lock']=time (); if (!@e3 (USER_DIR . 'bsi.psa',serialize ($dp))) { if(Log::$a)__log ('Indexer: can’t get a new lock'); die ('Can’t get a new lock<br />'); } if(Log::$a)__log ('Indexer: new lock is '. $dp['lock']); echo 'New lock is '. $dp['lock'] .'<br /><br />'; try { $wb = 0; $ap = 0; $qp = kq (); $lp = false; $zp = false; while ($ap < BSI_GIVE_UP_TIMEOUT){ em ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION, 'get portion of unindexed notes for indexing' ); $rt = tm (); if(count ($rt)) { ++ $wb; if(Log::$a)__log ('Indexer: portion '. $wb); echo 'Portion '. $wb .'<br />'; foreach ($rt as $s){ if(Log::$a)__log ('Indexer: indexing "'. $s['Title'].'"'); echo 'Indexing: '. $s['Title'] .'<br />'; if (wd ($s)) { $s['IsIndexed']='1'; km (sl (), 'Notes',$s); } else { $zp = true; break 2; } if($_config['broadcast_on_indexing']) { wv ($s); } } $ap = round (kq () - $qp,3); if(Log::$a)__log ('Indexer: steps done '. count ($rt) .', spent '. $ap .' ms so far'); echo 'Steps done '. count ($rt) .', spent '. $ap .' ms so far<br /><br />'; } else { $lp = true; break; } } if ($lp){ if(Log::$a)__log ('Indexer: indexing complete'); echo 'Indexing complete<br /><br />'; if(CACHE_INDEXED_FLAG){ @e3 (USER_DIR . CACHE_FILENAME_INDEXED_FLAG,''); } } elseif ($zp){ if(Log::$a)__log ('Indexer: indexing failed'); echo 'Indexing failed<br /><br />'; } else { if(Log::$a)__log ('Indexer: time out'); echo 'Time out<br />'; unset ($dp['lock']); } if ($dp['spent']!=='?')$dp['spent']+=$ap; @e3 (USER_DIR . 'bsi.psa',serialize ($dp)); } catch (AeMySQLException $e){ v3 ($e,'Could not index notes'); if(Log::$a)__log ('Indexer: DB unaccessible'); echo 'DB unaccessible<br />'; } } else { if(Log::$a)__log ('Indexer: locked'); echo 'Locked<br />'; } die ('</pre>'); } function e2s_reindex () { global$_config; if (!$_config['allow_underhood_access']) { r1 (wq ('e2m_settings')); } if($_SERVER['REQUEST_METHOD']=='POST'){ ms (); @unlink (USER_DIR . CACHE_FILENAME_INDEXED_FLAG); bs (sl (), true); jd (USER_DIR); } r1 (wq ('e2m_underhood')); } function jd ($xy){ $dp = ['spent' => 0]; @e3 ($xy . 'bsi.psa',serialize ($dp)); return $dp; } function hd ($xy){ $dp = @unserialize (file_get_contents (USER_DIR . 'bsi.psa')); if (!is_array ($dp)) { $dp = jd ($xy); } return $dp; } function gd () { if(CACHE_INDEXED_FLAG and is_file (USER_DIR . CACHE_FILENAME_INDEXED_FLAG)) { return true; } $kp = td (); $s8 = ($kp['remaining_count']===0); if(CACHE_INDEXED_FLAG and $s8){ e3 (USER_DIR . CACHE_FILENAME_INDEXED_FLAG,''); } return $s8; } function wd ($iy){ static $xp = null; if(Log::$a)__log ('Indexer: index noterec'); $databaseConfiguration = sl (); try { if ($xp === null){ $fo = new PorterStemmerRussian (new PorterStemmerEnglish ()); $xp = new Indexer (pd ($databaseConfiguration),$fo); } $wd = jy ($iy['FormatterID'], @$iy['Text'],'full-rss'); r3 ( 'note',$iy, $wd['meta']['resources-detected'] ); $o1 = strip_tags ($wd['text-final']); $ep = new Indexable ( 'n'. $iy['ID'], $iy['Title'], $o1, $databaseConfiguration -> getSubset () ); $xp -> index ($ep); return true; } catch (EmptyIndexException $e){ bs (sl ()); jd (USER_DIR); } catch (\Exception $e){ v3 ($e,'Could not index note'); return false; } } function ud ($cn){ global$_config; static $xp = null; $databaseConfiguration = sl (); try { if ($xp === null){ $fo = new PorterStemmerRussian (new PorterStemmerEnglish ()); $xp = new Indexer (pd ($databaseConfiguration),$fo); } return $xp -> removeById ('n'. $cn,$_config['db_table_subset']); } catch (EmptyIndexException $e){ bs ($databaseConfiguration); jd (USER_DIR); } catch (\Exception $e){ v3 ($e,'Could not unindex note'); return false; } } function id ($we){ $prefix = 'S2\\Rose\\'; if(BUILT){ $ue = __DIR__ . '/library/rose/'; } else { $ue = __DIR__ . '/../library/rose/'; } $ek = strlen ($prefix); if(strncmp ($prefix,$we,$ek)!==0) return; $ie = substr ($we,$ek); $cy = $ue . str_replace ('\\','/',$ie).'.php'; if(file_exists ($cy)) require $cy; } function od () { return [ 'TOC' => 'Contents', 'WORD' => 'Word', 'FULLTEXT_INDEX' => 'Fulltext', 'KEYWORD_INDEX' => 'Keyword', 'KEYWORD_MULTIPLE_INDEX' => 'KeywordMultiple', ]; } function pd (AeDatabaseConfiguration $databaseConfiguration){ static $rp = null; if ($rp === null and SEARCH_USE_ROSE){ $tp = new \PDO ( 'mysql:'. 'host='. $databaseConfiguration->host .';'. 'dbname='. $databaseConfiguration->name.';'. 'port='. $databaseConfiguration->port, $databaseConfiguration->user, ts ($databaseConfiguration->password) ); $tp -> exec ('SET NAMES utf8mb4'); $tp -> setAttribute (\PDO::ATTR_ERRMODE,\PDO::ERRMODE_EXCEPTION); $jp = od (); $rp = new PdoStorage ( $tp, $databaseConfiguration -> getPrefix () . SEARCH_EXTRA_PREFIX, [ MysqlRepository::TOC => $jp['TOC'], MysqlRepository::WORD => $jp['WORD'], MysqlRepository::FULLTEXT_INDEX => $jp['FULLTEXT_INDEX'], MysqlRepository::KEYWORD_INDEX => $jp['KEYWORD_INDEX'], MysqlRepository::KEYWORD_MULTIPLE_INDEX => $jp['KEYWORD_MULTIPLE_INDEX'], ] ); } return $rp; } function cs ($o1,$mo){ foreach ($mo as $bg){ if ($bg == '-') continue; $bg = preg_quote ($bg,'/'); $bg = str_replace ('е','[её]',$bg); $bg = str_replace ('Е','[ЕЁ]',$bg); $o1 = preg_replace ('/(?<=^|\W)('.$bg.'[\w\p{M}]*)/iu','<mark>$1</mark>',$o1); } $o1 = str_replace ('</mark> <mark>',' ',$o1); $o1 = str_replace ('</mark> <mark>',' ',$o1); return $o1; } function vs ($hp){ $gp = mb_strtoupper (mb_substr ($hp,0,1)); return $gp . mb_substr ($hp,1); } function bs (AeDatabaseConfiguration $databaseConfiguration,$wp = false){ $up = false; if($databaseConfiguration -> hasSubsetSpecified () and !$up){ if(Log::$a)__log ('Search: unmark and unindex subset'); $x1 = "WHERE `SubsetID`=". $databaseConfiguration -> getSubset (); } else { if(Log::$a)__log ('Search: unmark and unindex all'); $x1 = ''; } em ( "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `IsIndexed`=0 ". $x1, 'mark all notes for reindexing' ); if ($wp)hb ('Notes marked for reindexing',E2E_MESSAGE); $k5 = pd ($databaseConfiguration); try { $k5 -> erase (); if ($wp)hb ('Indexes erased',E2E_MESSAGE); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Rose threw RuntimeException'); } } function e2m_password_reset () { global$_strings,$_config,$settings; if (!is_file (USER_DIR. 'password-reset.psa')) { $xn = sha1 (xs ()); $url = wq ('e2m_password', array ('recovery-key' => $xn)); @e3 (USER_DIR. 'password-reset.psa',$url); } $bb['title']=$_strings['pt--password-reset']; $bb['heading']=$_strings['pt--password-reset']; $ip = (bool) ($ta = $settings['author_email']); $bb['form']='form-password-reset-email'; $bb['form-password-reset-email'] = array ( 'form-action' => wq ('e2s_password_reset_email'), 'show-controls?' => $ip, 'submit-text' => $_strings['fb--send-link-by-email'], ); if($_config['user_has_access_to_filesystem']) { $bb['form-password-reset-email']['reset-info']=$_strings['gs--password-reset-link-saved']; } elseif (!$ip){ hb ($_strings['er--cannot-reset-password']); } return $bb; } function e2s_password_reset_email () { global$_strings,$settings; if($_SERVER['REQUEST_METHOD']!='POST')r1 (); if(array_key_exists ('email',$_POST))$va = trim ($_POST['email']); if (!$va){ hb ($_strings['er--cannot-send-link-email-empty']); r1 (wq ('e2m_password_reset')); } $op = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($op)==0){ hb ($_strings['er--error-occurred']); r1 (wq ('e2m_password_reset')); } if ($ta = $settings['author_email']) { if ($va == $ta){ $ea = gn ( 'password-reset', array ('reset-href' => $op) ); $ra = $_strings['em--password-reset-subject']; $ja = 'From: '. wn (); un ($ta,$ra,$ea,$ja); } hb ($_strings['gs--password-reset-link-sent-maybe'],E2E_MESSAGE); r1 (wq ('e2m_password_reset')); } die; } function e2m_password ($parameters){ global$_strings; $pp = false; $xn = ''; if(array_key_exists ('recovery-key',$parameters)) { $xn = $parameters['recovery-key']; $url = wq ('e2m_password', array ('recovery-key' => $xn)); $op = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($op)>0){ $pp = ($url == $op); } } if (ss () or $pp){ $bb['title']=$_strings['pt--password']; $bb['heading']=$_strings['pt--password-for-blog']; if ($pp){ $bb['title']=$_strings['pt--password-reset']; $bb['heading']=$_strings['pt--password-reset']; } $bb['form']='form-password'; $bb['form-password'] = array ( '.recovery-key' => $xn, 'form-action' => wq ('e2s_password_save'), 'recovering?' => $pp, 'submit-text' => $_strings['fb--change'], ); return $bb; } else { r1 (); } } function e2m_sessions () { global$_strings; $r5 = as_ (); $bb['title']=$_strings['pt--sessions']; $bb['heading']=$_strings['pt--sessions']; $ccv = array (); $xn = $_COOKIE[j1 ('key')]; foreach ($r5['sessions'] as $x3 => $e3){ $ccv[] = array ( 'current?' => sha1 ($xn)===$e3['key_hash'], 'opened' => array ((int)$e3['stamp'],b1 ()), 'ip-address' => $e3['remote_ip'], 'source' => ($e3['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$e3['remote_ip'], 'title' => ks ($e3['ua']), 'user-agent' => $e3['ua']? $e3['ua']:$_strings['gs--unknown'], ); } $ccv = array_reverse ($ccv); $bb['sessions']['each']=$ccv; if(count ($ccv)>1){ $bb['form']='form-sessions'; $bb['form-sessions'] = array ( 'form-action' => wq ('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $bb; } function e2m_sign_in () { global$_strings; if (ss ())r1 (wq ('e2m_frontpage', array ('page' => 1))); return [ 'title' => $_strings['pt--sign-in'], ]; } function e2m_sign_out () { global$_strings; $r5 = as_ (); $vcv = -1; if(array_key_exists ('sessions',$r5) and is_array ($r5['sessions'])) { foreach ($r5['sessions'] as $x3 => $e3){ $xn = $_COOKIE[j1 ('key')]; if(sha1 ($xn)===$e3['key_hash']) { $vcv = $x3; break; } } } if ($vcv > -1) unset ($r5['sessions'][$vcv]); if (!qs ($r5)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } w1 ('key',''); r1 (); } function e2s_error_message_from_password_checkinfo ($bcv){ global$_strings; $ycv = ['s' => ceil ($bcv['timeout']/1000)]; if ($bcv['password-status']==='correct'){ return false; } elseif ($bcv['password-status']==='waiting'){ return e2l_get_string ('er--password-wait',$ycv); } elseif ($bcv['timeout']>0){ return e2l_get_string ('er--wrong-password-wait',$ycv); } else { return$_strings['er--wrong-password']; } } function e2s_password_save () { global$_strings; ms (); $pp = false; $ncv = trim ($_POST['old-password']); if ($xn = trim ($_POST['recovery-key'])) { $url = wq ('e2m_password', array ('recovery-key' => $xn)); $op = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($op)>0){ $pp = ($url == $op); } } $bcv = AePasswordCheckManager::checkPassword ($ncv); if (($bcv['password-status']==='correct') or $pp){ $x5 = trim ($_POST['new-password']); if ($x5 != ''){ if (@e3 (USER_DIR. 'password-hash.psa',serialize (sha1 ($x5)))) { @unlink (USER_DIR. 'password-reset.psa'); hb ($_strings['gs--password-changed'],E2E_MESSAGE); r1 (); } else { hb ($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); r1 (wq ('e2m_password', ['recovery-key' => ''])); } } else { hb ($_strings['er--no-password-entered'],E2E_USER_ERROR); r1 (wq ('e2m_password', ['recovery-key' => ''])); } } else { hb ( e2s_error_message_from_password_checkinfo ($bcv), E2E_USER_ERROR ); r1 (wq ('e2m_password', ['recovery-key' => ''])); } die; } function ys () { global$_token; if (!ss ()) return ''; return$_token; } function ns () { return sha1 ( $_SERVER['HTTP_USER_AGENT'].fs () . time () . mt_rand (1000000,9999999) ); } function ms () { global$_token; if (!ss ()) return true; if ( !array_key_exists ('token',$_POST) or ((string)$_POST['token'] !== (string) @$_token) ) { throw new AeTokenException ('Incorrect token'); } return true; } function fs () { $mcv = $_SERVER['REMOTE_ADDR']; if(array_key_exists ('HTTP_X_FORWARDED_FOR',$_SERVER)) { $mcv = array_pop (explode (',',$_SERVER['HTTP_X_FORWARDED_FOR'])); } return $mcv; } function e2s_sign_in () { global$_strings; $r5 = as_ (); if($_SERVER['REQUEST_METHOD']=='POST'){ $password = (string) @$_POST['password']; $fcv = @$_POST['is_public_pc']; } else { $password = (string) @$_GET['password']; $fcv = false; } $bcv = AePasswordCheckManager::checkPassword ($password); if ($bcv['password-status']==='correct'){ @unlink (USER_DIR. 'password-reset.psa'); $dcv = [ 'stamp' => time (), 'remote_ip' => fs (), 'key_hash' => ds ($fcv), 'anti_csrf_token' => ns (), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]; $r5['sessions'][] = $dcv; } else { hb (e2s_error_message_from_password_checkinfo ($bcv),E2E_USER_ERROR); } if (!qs ($r5)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); r1 (); } t1 (); } function e2s_drop_other_sessions () { global$_strings; ms (); $r5 = as_ (); $dcv = null; foreach ($r5['sessions'] as $x3 => $e3){ $xn = $_COOKIE[j1 ('key')]; if(sha1 ($xn)===$e3['key_hash']) { $dcv = $e3; break; } } $r5['sessions'] = array ($dcv); if (!qs ($r5)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } t1 (); die; } function ds ($scv = false){ $xn = xs (); $acv = sha1 ($xn); w1 ('key',$xn, !$scv); return $acv; } function ss () { static $qcv = null; global$_token; if ($qcv !== null) return $qcv; $qcv = false; if (!isset ($_COOKIE[j1 ('key')])) return $qcv; $r5 = as_ (); $acv = sha1 ($_COOKIE[j1 ('key')]); $qcv = false; $_token = ''; foreach ($r5['sessions'] as &$dcv){ if ($acv === $dcv['key_hash']) { $qcv = true; $_token = (string) @$dcv['anti_csrf_token']; if($_token === ''){ $dcv['anti_csrf_token']=ns (); qs ($r5); } break; } } if (!$qcv)w1 ('key',''); return $qcv; } function as_ () { $r5 = []; if(is_file (USER_DIR . 'auth.psa')) { $r5 = unserialize (@file_get_contents (USER_DIR . 'auth.psa')); } if (!is_array ($r5))$r5 = []; if (!array_key_exists ('sessions',$r5))$r5['sessions'] = []; if (!is_array ($r5['sessions']))$r5['sessions'] = []; return $r5; } function qs ($r5){ return e3 (USER_DIR . 'auth.psa',serialize ($r5)); } function ls () { if ($xn = @$_COOKIE[j1 ('key')]) { return j1 ('key') .'='. $xn .""; } } function zs () { if ($xn = @$_COOKIE[j1 ('key')]) { return 'Cookie: '. j1 ('key') .'='. $xn ."\r\n"; } return "\r\n"; } function ks ($lcv){ global$_strings; if(strstr ($lcv,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr ($lcv,'iPad')) return$_strings['gs--ua-ipad']; if(strstr ($lcv,'Opera'))$bb = $_strings['gs--ua-opera']; if(strstr ($lcv,'Firefox'))$bb = $_strings['gs--ua-firefox']; if(strstr ($lcv,'Chrome'))$bb = $_strings['gs--ua-chrome']; if(strstr ($lcv,'Safari') and !strstr ($lcv,'Chrome'))$bb = $_strings['gs--ua-safari']; if (!$bb)$bb = $_strings['gs--ua-unknown']; if(strstr ($lcv,'Macintosh')) { if ($bb)$bb .= ' '. $_strings['gs--ua-for-mac']; } return $bb; } function e2j_check_password () { $rl = [ 'success' => true, 'data' => AePasswordCheckManager::checkPassword ((string) @$_POST['password']), ]; $rl = json_encode ($rl); die ($rl); } function xs () { if(function_exists ('random_bytes')) { $xcv = sha1 (random_bytes (128)); } else { $xcv = ''; $ecv = '0123456789abcdef'; for ($wb = 0; $wb < 40; $wb++) { $xcv .= $ecv[mt_rand (0,15)]; } $xcv .= time () . microtime (); $xcv = sha1 ($xcv); } return $xcv; } function es () { static $rcv; if(empty($rcv))$rcv = md5 ('seсret'); return $rcv; } function rs ($x4){ $xn = es (); $tcv = strlen ($xn); $jcv = strlen ($x4); $bb = ''; for ($wb = 0; $wb < $jcv + rand (16,64); ++ $wb){ if ($wb > $jcv){ $hcv = rand (0,127); } elseif ($wb == $jcv){ $hcv = 0; } else { $hcv = ord ($x4[$wb]); } $gcv = chr (($hcv + ord ($xn[$wb%$tcv])) % 256); $bb .= $gcv; } $bb = base64_encode ($bb); return $bb; } function ts ($x4){ $xn = es (); $tcv = strlen ($xn); $x4 = base64_decode ((string) @$x4); $jcv = strlen ($x4); $bb = ''; for ($wb = 0; $wb < $jcv; ++ $wb){ $wcv = (ord ($x4[$wb]) + 256 - ord ($xn[$wb%$tcv])) % 256; if ($wcv === 0) break; $bb .= chr ($wcv); } return $bb; } function js () { global$settings; if (ss ()) { return null; } else { return [ 'form-action' => wq ('e2s_sign_in'), 'form-check-password-action' => wq ('e2j_check_password'), 'login-name' => @$settings['author'], 'public-pc?' => false, 'reset-href' => wq ('e2m_password_reset'), ]; } } function hs () { if (!ss ()) return; list (, $ucv)=ws (); $g3 = false; foreach ($ucv as $ds => $icv){ if(Log::$a)__log ( 'Selfcheck: Double-checking remote access of "'. $ds .'" '. 'before showing a warning (status was '. $icv.')...' ); $r2 = vv (AeEnv::$cv . $ds); if ($r2 and $r2['http_code'] >= 400) continue; $g3 = true; $url = AeEnv::$cv . $ds; hb ( 'Security alert: <a href="'. $url .'">'. $ds .'</a> '. 'responded with HTTP '. $r2['http_code'] .' instead of 403' ); } return $g3; } function gs () { list ($ocv,$ucv)=ws (); $vy = time (); if ( $ocv === false or ( array_key_exists ('completed-stamp',$ocv) and @$ocv['completed-stamp']<$vy - SECONDS_IN_A_WEEK ) ) { $ocv = us (); } $pcv = false; if(count ($ucv)) { $pcv = true; } foreach ($ocv['statuses'] as $ds => $icv){ if ($icv >= 400) continue; if(Log::$a)__log ('Selfcheck: Checking remote access of "'. $ds .'"...'); $r2 = vv (AeEnv::$cv . $ds); if (!$r2 or @$r2['http_code']<200) break; $icv = $r2['http_code']; $ocv['statuses'][$ds]=$icv; if(Log::$a)__log ('Selfcheck: The response is '. $r2['http_code']); if ($icv >= 400 and !$pcv){ break; } else { $pcv = true; } } if (!array_key_exists ('completed-stamp',$ocv)) { end ($ocv['statuses']); $cvv = !empty (current ($ocv['statuses'])); if ($cvv)$ocv['completed-stamp']=$vy; if ($cvv)$ocv['completed']=date ('r',$vy); } @e3 (USER_DIR . 'checklist.psa',serialize ($ocv)); } function ws () { static $ocv,$ucv = null; if ($ocv !== null and $ucv !== null){ return [$ocv,$ucv]; } $vvv = USER_DIR . 'checklist.psa'; $ocv = @unserialize (file_get_contents ($vvv)); $bvv = @$ocv['statuses']; $ucv = []; if(is_array ($bvv)) { foreach ($bvv as $ds => $icv){ if ($icv !== null and $icv < 400){ $ucv[$ds]=$icv; } } } else { $ocv = false; } return [$ocv,$ucv]; } function us () { global$_config; if(Log::$a)__log ('Selfcheck: Reset access checklist file'); $yvv = array_merge ( AeFileManager::writtenFiles ($_config['path_user'],$_config['path_media']), [ '.htaccess', 'system/core.php', 'system/default/config.php', INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME, $_config['path_media'].PICTURES_DIRNAME .'.htaccess', $_config['path_media'].THUMBNAILS_DIRNAME .'.htaccess', $_config['path_media'].AVATARS_DIRNAME .'.htaccess', $_config['path_media'].USERPIC_DIRNAME .'.htaccess', $_config['path_media'].VIDEO_DIRNAME .'.htaccess', $_config['path_media'].AUDIO_DIRNAME .'.htaccess', USER_DIR . CACHE_FILENAME_FRONTPAGE, USER_DIR . BACKUP_DIRNAME .'backup-tail.sql', ] ); foreach ($yvv as $ds){ $nvv[$ds]=null; } $ocv = ['statuses' => $nvv]; @e3 (USER_DIR . 'checklist.psa',serialize ($ocv)); return $ocv; } function is () { $mvv['items_count']=0; $mvv['total_count']=0; $mvv['percentage']=0; $mvv['stamp_completed']=false; $vvv = USER_DIR . 'checklist.psa'; $ocv = @unserialize (file_get_contents ($vvv)); if ($ocv === false) return $mvv; $bvv = @$ocv['statuses']; $nd = $fvv = 0; if(is_array ($bvv)) { foreach ($bvv as $icv){ $nd ++; if ($icv !== null){ $fvv ++; } } $mvv['items_count']=$fvv; $mvv['total_count']=$nd; $mvv['percentage']=o1 ($fvv,$nd); } $mvv['stamp_completed'] = @$ocv['completed-stamp']; return $mvv; } function e2_load_settings_from_user_folder_($dvv){ $svv = []; if(is_file ($dvv . 'settings.json')) { $svv = json_decode (file_get_contents ($dvv . 'settings.json'),true); } $svv = va ($svv); return $svv; } function e2m_settings () { global$_lang,$_template,$_strings,$_config,$settings; $avv = []; foreach(glob (SYSTEM_DIR . LANGUAGES_DIRNAME. '*.php') as $ds){ $qvv = substr (basename ($ds),0,2); $yy = file_get_contents ($ds); if(preg_match ( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$yy,$sr )) { $x9 = $sr[1]; } else { $x9 = $qvv; } $avv[$qvv] = array ( 'selected?' => (bool) ($_lang == $qvv), 'display-name' => $x9, ); } $id = $lvv = false; $zvv = (string) @$id['pay-href']; if ((string)$zvv === ''){ $zvv = 'https://'. $_strings['e2--website-host'] .'/get/'; } if (!isset ($_template))gf (); $kvv = implode (', ',i3 ()); $bb['title']=$_strings['pt--settings']; $bb['heading']=$_strings['pt--settings']; $bb['form']='form-preferences'; $bb['form-preferences'] = [ 'blog-title-default' => htmlspecialchars ((string) @$_strings['e2--default-blog-title'],ENT_COMPAT,'UTF-8'), 'blog-title' => htmlspecialchars (ev (), ENT_COMPAT,'UTF-8'), 'blog-subtitle' => htmlspecialchars ((string) @$settings['blog_subtitle'],ENT_COMPAT,'UTF-8'), 'blog-meta-description' => htmlspecialchars ((string) @$settings['meta_description'],ENT_COMPAT,'UTF-8'), 'blog-author-default' => htmlspecialchars ((string) @$_strings['e2--default-blog-author'],ENT_COMPAT,'UTF-8'), 'blog-author' => htmlspecialchars ((string) @$settings['author'],ENT_COMPAT,'UTF-8'), 'languages' => $avv, 'language' => $_lang, 'form-action' => wq ('e2s_settings_save'), 'userpic-href' => tv ('square'), 'userpic-extensions-list' => $kvv, 'userpic-extensions-message' => _S ('er--supported-image-types') .' '. $kvv, 'notes-per-page' => $settings['appearance']['notes_per_page'], 'emailing-possible?' => MAIL_ENABLED, 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars ((string) @$settings['author_email'],ENT_COMPAT,'UTF-8'), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-require-gip?' => (bool) @$settings['comments']['require_gip'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-view-counts?' => (bool) @$settings['appearance']['show_view_counts'], 'show-sharing-buttons?' => (bool) @$settings['appearance']['show_sharing_buttons'], 'includes-main-menu-fields?' => false, 'main-menu-promo' => e2l_get_string ( 'pm--main-menu', ['url' => $_config['paid_features_url']] ), 'show-main-menu?' => false, 'main-menu-items' => [], 'includes-analytics-fields?' => false, 'analytics-promo' => e2l_get_string ( 'pm--analytics', ['url' => $_config['paid_features_url']] ), 'template-name' => $_template['name'], 'templates' => m2 (), 'respond-to-dark-mode?' => (bool) @$settings['appearance']['respond_to_dark_mode'], 'submit-text' => $_strings['fb--save-changes'], 'show-payment-info?' => $lvv and ($id !== false), 'paid-period' => @$id['licensed?'] ? (time () <= $id['until-stamp']) : false, 'paid-period-ended' => @$id['licensed?'] ? (time () > $id['until-stamp']) : false, 'paid-until' => @$id['licensed?'] ? ([$id['until-stamp'],y1 ()]) : false, 'pay-href' => $zvv, 'space-usage' => qy (sy (), true), ]; return $bb; } function e2s_settings_save () { global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_settings')); } ms (); $rvv = $ud = ''; if(array_key_exists ('blog-title',$_POST)) { $rvv = trim ($_POST['blog-title']); } if(array_key_exists ('blog-subtitle',$_POST)) { $ud = trim ($_POST['blog-subtitle']); } if(array_key_exists ('blog-meta-description',$_POST)) { $tvv = trim ($_POST['blog-meta-description']); } if(array_key_exists ('blog-author',$_POST)) { $jvv = trim ($_POST['blog-author']); } if(array_key_exists ('language',$_POST)) $hvv = $_POST['language']; if(array_key_exists ('email',$_POST)) $va = trim ($_POST['email']); $gvv = (int)$_POST['notes-per-page']; $settings['blog_title']=$rvv; $settings['blog_title']=ev (); $settings['author']=$jvv; $settings['author_email']=$va; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists ('template',$_POST)) { $settings['template']=trim ($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); $settings['comments']['require_gip'] = isset ($_POST['comments-require-gip']); $settings['appearance']['show_view_counts'] = isset ($_POST['show-view-counts']); if ( !array_key_exists ('language',$settings) or $settings['language']!=$hvv ) { e2_drop_all_kinds_of_cache (); $settings['language']=$hvv; } if ( @$settings['blog_subtitle']!=$ud or @$settings['meta_description']!=$tvv or @$settings['appearance']['notes_per_page']!=$gvv or @$settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or @$settings['appearance']['respond_to_dark_mode'] != isset ($_POST['respond-to-dark-mode']) or @$settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['blog_subtitle']=$ud; $settings['meta_description']=$tvv; $settings['appearance']['notes_per_page']=$gvv; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['appearance']['respond_to_dark_mode'] = isset ($_POST['respond-to-dark-mode']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } sq (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); r1 (wq ('e2m_settings')); } r1 (wq ('e2m_frontpage', array ('page' => 1))); } function e2m_underhood () { global$_db,$_config; if (!$_config['allow_underhood_access']) return e2m_error404 (); $bb['title']='Underhood'; $bb['heading']='Underhood'; $wvv = $_SERVER['SERVER_SOFTWARE']; if(preg_match ('/^Apache\/([0-9.]+)\b/i',$wvv,$sr)) { $wvv = 'Apache '. $sr[1]; } elseif(preg_match ('/^nginx\/([0-9.]+)\b/i',$wvv,$sr)) { $wvv = 'Nginx '. $sr[1]; } xm (sl (), 'check version'); $tu = y1 (); $uvv = $ivv = 0; foreach(glob (USER_DIR . CACHES_DIRNAME .'*') as $ds){ $uvv ++; $ivv += stat ($ds)['size']; } $ovv = $pvv = 0; foreach(glob (INSTANCE_DIR . LOGS_DIRNAME .'*') as $ds){ $ovv ++; $pvv += stat ($ds)['size']; } $kp = td (); $cbv = o1 ( $kp['indexed_count'],$kp['total_count'] ); $vbv = false; if ($kp['time_spent']) { if(is_numeric (($kp['time_spent']))) { $vbv = floor ($kp['time_spent']); } if ($vbv >= 60){ $vbv = ( floor ($vbv / 60) .'min '. str_pad ($vbv % 60,2,'0',STR_PAD_LEFT). 's' ); } elseif ($vbv > 0){ $vbv .= 's'; } else { $vbv = false; } } $mvv = is (); $bbv = array_keys (gm (USER_DIR . BACKUP_DIRNAME)); $bb['form']='form-underhood'; $bb['form-underhood'] = [ 'server-software' => $wvv, 'db-software' => $_db['software'], 'db-version' => $_db['version'], 'form-action-engine-rebuild' => BUILT? false : wq ('e2s_post_service', ['service' => 'build']), 'current-timezone-offset' => oa ($tu ['offset']), 'current-timezone-is-dst' => $tu ['is_dst'], 'cache-files-count' => $uvv, 'cache-files-size' => $ivv, 'form-action-cache-invalidate' => wq ('e2s_post_service', ['service' => 'sync']), 'search-index-items-count' => $kp['indexed_count'], 'search-index-total-items-count' => $kp['total_count'], 'search-index-time-spent' => $vbv, 'search-index-percentage' => $cbv, 'form-action-search-index-continue' => gd ()? false : wq ('e2s_bsi_step'), 'form-action-search-index-rebuild' => wq ('e2s_reindex'), 'checklist-items-count' => $mvv['items_count'], 'checklist-total-items-count' => $mvv['total_count'], 'checklist-percentage' => $mvv['percentage'], 'checklist-stamp-completed' => !empty ($mvv['stamp_completed'])? s1 ('D, M d, Y \a\t H:i:s',$mvv['stamp_completed']) : false, 'form-action-checklist-reset' => wq ('e2s_post_service', ['service' => 'checklist-reset']), 'log-files-count' => $ovv, 'log-files-size' => $pvv, 'form-action-logs-enable' => ( is_file (INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME) ? '' : wq ('e2s_post_service', ['service' => 'log']) ), 'form-action-logs-erase-disable' => ( $ovv? wq ('e2s_post_service', ['service' => 'unlog']) : '' ), 'backup-last' => count ($bbv)? s1 ('D, M d, Y \a\t H:i:s',$bbv[0]) : false, 'form-action-backup' => wq ('e2s_dump'), 'form-action-database-migrate' => wq ( 'e2s_post_service', ['service' => 'migrate'] ), 'form-action-license-verify' => wq ( 'e2s_post_service', ['service' => 'verify'] ), ]; return $bb; } function e2m_database () { global$settings,$_strings,$_config; $databaseConfiguration = sl (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { return e2m_error404 (); } $bb['title']=$_strings['pt--database']; $bb['heading']=$_strings['pt--database']; $bb['form']='form-database'; $bb['form-database'] = array ( 'form-action' => wq ('e2s_database_save'), 'db-server' => htmlspecialchars (@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars (@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-database' => htmlspecialchars (@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $bb; } function ps ($backup_dir,$ybv,$prefix = null,$subset = null){ $nbv['server']=$nbv['user_name'] = $nbv['passw']=$nbv['name']=''; if(array_key_exists ('db-server',$ybv)) $nbv['server']=$ybv['db-server']; if(array_key_exists ('db-user',$ybv)) $nbv['user_name']=$ybv['db-user']; if(array_key_exists ('db-password',$ybv))$nbv['passw']=$ybv['db-password']; if(array_key_exists ('db-database',$ybv))$nbv['name']=$ybv['db-database']; $databaseConfiguration = new AeDatabaseConfiguration ( 'post', $backup_dir, $nbv['server'], $nbv['user_name'], rs ($nbv['passw']), $nbv['name'], $prefix, $subset ); return$databaseConfiguration; } function e2s_database_save () { global$settings,$_db,$_strings,$_config; ms (); if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_database')); } $databaseConfiguration = sl (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { return e2m_error404 (); } $ybv = $_POST; if (!array_key_exists ('db-password',$ybv)) { $ybv['db-password']=htmlspecialchars (ts (@$settings['db']['passw'])); } $databaseConfiguration = ps ( USER_DIR . BACKUP_DIRNAME, $ybv, $_config['db_table_prefix'], $_config['db_table_subset'] ); $e5 = false; try { xm ($databaseConfiguration,'check database from HTTP post'); $l5 = fm ($databaseConfiguration); if (!$l5['occupied'] or !$l5['migrateable']) { hb ($_strings['er--db-data-incomplete']); r1 (wq ('e2m_database')); } bm ($databaseConfiguration); $e5 = true; } catch (AeMySQLCannotConnectException $e){ hb ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error () .' ('. mysqli_connect_errno () .')' ); } catch (AeMySQLTooOldException $e){ hb (e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ])); } catch (AeMySQLException $e){ hb ($_strings['er--cannot-find-db'] .' '. $databaseConfiguration->name); } if (!$e5){ r1 (wq ('e2m_database')); } $settings['db']=$databaseConfiguration -> getDatabaseParamsArray (); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); r1 (wq ('e2m_database')); } e2_drop_all_kinds_of_cache (); if (!$_config['retain_search_indexes_on_db_switch']) { $k5 = pd (sl ()); try { $k5 -> erase (); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Rose not available'); } jd (USER_DIR); } vv (wq ('e2s_bsi_step')); r1 (wq ('e2m_settings')); } function ca () { return class_exists ('ZipArchive'); } function e2m_get_backup () { if (ca ()) { $mbv = new ZipArchive (); $fbv = USER_DIR . BACKUP_DIRNAME .'backup.zip'; if ($mbv -> open ($fbv,ZIPARCHIVE::CREATE)) { @ $mbv -> addEmptyDir ('backup'); $dbv = USER_DIR . BACKUP_DIRNAME .'backup-tail.sql'; $sbv = ''; $abv = -1; foreach(glob (USER_DIR . BACKUP_DIRNAME .'backup-*.sql') as $cy){ if ($cy === $dbv) continue; $qbv = stat ($cy); if ($qbv['ctime']>$abv)$sbv = $cy; $abv = $qbv['ctime']; } if ($sbv === ''){ $sbv = im (sl ()); } $mbv -> addFile ($sbv,'backup/'. basename ($sbv)); if(is_file ($dbv)) { @file_put_contents ($dbv,"COMMIT;\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod ($dbv,E2_NEW_FILES_RIGHTS); } $mbv -> addFile ($dbv,'backup/backup-tail.sql'); $mbv -> close (); } if(is_file ($fbv)) { header ('Content-Type: application/zip'); header ('Content-Disposition: attachment; filename="backup.zip"'); readfile ($fbv); unlink ($fbv); } else { die ('Cannot get backup'); } die; } else { die ('Cannot get backup'); } } function va ($svv){ if ( !array_key_exists ('appearance',$svv) or !array_key_exists ('notes_per_page',$svv['appearance']) or !is_numeric ($svv['appearance']['notes_per_page']) or $svv['appearance']['notes_per_page']<1 ) { $svv['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ($svv['appearance']['notes_per_page']>MAX_ITEMS_PER_PAGE){ $svv['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists ('comments',$svv) or !array_key_exists ('default_on',$svv['comments']) ) { $svv['comments']['default_on']=false; } if (!array_key_exists ('respond_to_dark_mode',$svv['appearance'])) { $svv['appearance']['respond_to_dark_mode']=true; } if ( !array_key_exists ('template',$svv) or (string)$svv['template']==='' ) { $svv['template']=DEFAULT_TEMPLATE; } if (isset ($svv['description'])) { if (!isset ($svv['blog_subtitle'])) { $svv['blog_subtitle']=$svv['description']; } unset ($svv['description']); } if (isset ($svv['site_title'])) { if (!isset ($svv['blog_title'])) { $svv['blog_title']=$svv['site_title']; } unset ($svv['site_title']); } if (isset ($svv['user'])) { if (!isset ($svv['author_email'])) { $svv['author_email'] = (string) @$svv['user']['email']; } unset ($svv['user']); } if (isset ($svv['v3223_rss_permalinks_before_stamp'])) { unset ($svv['v3223_rss_permalinks_before_stamp']); } return $svv; } function e2j_save_menu_order () { global$settings; $rl = ['success' => false]; ms (); if(is_array (@$_POST['order'])) { $settings['menu_order']=$_POST['order']; if (@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { $rl = ['success' => true]; } } $rl = json_encode ($rl); die ($rl); } function ba ($f3){ global$_config; $zbv = $_config['share_to']; $kbv = '|twitter|x|facebook|vk|telegram|linkedin|whatsapp|'; $xbv = [ 'vk' => 'vkontakte', 'x' => 'xcom', ]; if (@$_config['share_to_twitter_via']) { $kb['twitter']['via']=$_config['share_to_twitter_via']; } if (@$_config['share_to_x_via']) { $kb['x']['via']=$_config['share_to_x_via']; } if(count ($f3)>0){ $ebv = $f3[0]; $kbv .= 'pinterest|'; $kb['pinterest']['media']=$ebv; } $rbv = []; foreach(explode (',',$zbv) as $tbv){ $tbv = trim ($tbv); $jbv = $tbv; if(array_key_exists ($tbv,$xbv)) { $jbv = $xbv[$tbv]; } if(strstr ($kbv,'|'. $tbv. '|')) { $rbv[$tbv]['class']=$jbv; $rbv[$tbv]['share?']=true; if(is_array (@$kb[$tbv]) and count ($kb[$tbv])) { $rbv[$tbv]['data']=$kb[$tbv]; } } } return $rbv; } function ya ($hbv,$kb = null){ if ($hbv === 'generic'){ $gbv = $kb; } else { if (!is_file ($wbv = SYSTEM_DIR . 'stubs/' . $hbv .'.php')) { throw new AeStubException ('No stub found for the problem "'. $hbv .'"'); } $gbv = include $wbv; } $ubv = false; if (!empty ($gbv['button'])) { $ubv = true; $ibv = wq ('e2m_frontpage', ['page' => 1]); $obv = $gbv['button']; } $bb = [ 'stub-kind' => $hbv, 'title' => $gbv['heading'], 'heading' => $gbv['heading'], 'stub' => $gbv['text'], ]; if ($ubv)$bb += [ 'stub-button-href' => $ibv, 'stub-button-text' => $obv ]; return $bb; } function e2m_tags () { global$_strings; AeMainMenuManager :: $isTagsCurrent = true; $bb['title']=$_strings['pt--tags']; $bb['heading']=$_strings['pt--tags']; $bb['tags']=la ([]); $sw = za (true); if ($sw === null){ $bb['unavailable?']=true; } else { $bb['tags']['each']=$sw; if(count ($sw)==0){ $bb['nothing']=$_strings['gs--no-tags']; } } return $bb; } function e2m_tag ($parameters = []) { global $settings, $_config, $_strings; if(Log::$a)__log ('Tag {'); $mm = ss (); $tagNotesView = new AePageableNotesView ('e2m_tag',$parameters); $tagNotesView -> setPortionSize ($settings['appearance']['notes_per_page']); $tagNotesView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $tagNotesView -> setWantPaging (true); $tagNotesView -> setWantNewCommentsCount ($mm); $tagNotesView -> setWantReadHrefs ($_config['count_reads']); $tagNotesView -> setWantControls ($mm and !@$_config['read_only']); $tagNotesView -> setWantHiddenTags ($mm); if(array_key_exists ('*tags',$parameters)) { $pbv = $parameters['*tags']; } elseif(array_key_exists ('*tag',$parameters)) { $pbv = [$parameters['*tag']]; } else { $pbv = []; } $hb = []; foreach ($pbv as $ub){ if ($mm or $ub['IsVisible']) { $hb[] = $ub; } } $c3v = count ($hb); if ($c3v == 0 or $c3v < count ($pbv)) { return e2m_error404 (); } foreach ($hb as $ub) if ($ub)$v3v[] = "nk.`KeywordID`=". $ub['ID']; $p9 = ( "FROM `". $_config['db_table_prefix'] ."Notes` n ". "JOIN `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (". implode (" OR ",$v3v).") ". "AND IsPublished=1 ". xf ($mm). "GROUP BY n.`ID` ". "HAVING COUNT(*)>=". $c3v ); $tagNotesView -> setSQLCountRequest ( "SELECT COUNT(*) Total FROM (SELECT 1 ". $p9 .") _" ); $tagNotesView -> setLimitlessSQLRequest ( "SELECT n.*, COUNT(*) ". $p9 ." ". "ORDER BY n.`Stamp` DESC" ); $b3v = []; foreach ($hb as $ub){ $b3v[] = $ub['Keyword']; if ($c3v === 1){ AeMainMenuManager :: addCurrentTag ($ub['Keyword']); } else { AeMainMenuManager :: addParentTag ($ub['Keyword']); } } $tagNotesView -> setHighlightedTags ($b3v); $f4 = ''; $kh['description']=''; $kh['summary']=''; $kh['visible?']=true; foreach ($hb as $ub) if (!$ub['IsVisible']) { $kh['visible?']=false; break; } if ($c3v === 1){ $y3v = $hb[0]; $n3v = b () ['t'. $y3v['ID']]; if(CACHE_TAG and $tagNotesView -> isFirstPage ()) { if ($mm){ $tagNotesView -> setCacheFilename (e2_cache_filename_with_id_($y3v['ID'],USER_DIR . CACHE_FILENAMES_TAG_AUTHOR)); } else { $tagNotesView -> setCacheFilename (e2_cache_filename_with_id_($y3v['ID'],USER_DIR . CACHE_FILENAMES_TAG)); } } $yo = aa ($y3v['ID'],5); if ($mm){ $kh['edit-href']=wq ( 'e2m_tag_edit', ['tag-alias' => $n3v] ); $m3v = (bool)$y3v['IsFavourite']; $f3v = $parameters; $f3v['flag']='IsFavourite'; $f3v['value'] = (int) !$m3v; $kh['pinned?']=false; } if ((string)$y3v['Description']!==''){ $wd = hy ($y3v['Description'],'full'); $lq = $wd['text-final']; $kh['description']=$lq; $kh['description-format-info']=$wd['meta']; z2 (@$wd['meta']['links-required']); } if ((string)$y3v['Summary']!==''){ $kh['summary']=ry (htmlspecialchars ($y3v['Summary'],ENT_NOQUOTES,'UTF-8')); } elseif ((string)$kh['description']!==''){ $kh['summary']=zf ($kh['description']); }; $d3v = wq ('e2m_tag_rss', ['tag-alias' => $n3v]); $s3v = wq ('e2m_tag_json', ['tag-alias' => $n3v]); d3 ( 'rss', ev () .': '. $y3v['Keyword'], $d3v ); d3 ( 'json', ev () .': '. $y3v['Keyword'], $s3v ); $kh['og-images']=t3 ( g2 ( @$kh['description-format-info']['resources-detected'], cy ('tag',$y3v['ID']) ) ); $kh['name']=htmlspecialchars ($y3v['Keyword'],ENT_COMPAT,'UTF-8'); $kh['related']=$yo; $f4 = htmlspecialchars ($y3v['PageTitle'],ENT_COMPAT,'UTF-8'); } $nd = $tagNotesView -> getTotalNotes (); $kh['notes-count']=$nd; $kh['notes-count-text']=e2l_get_string ('pt--n-posts', ['number' => $nd]); $a3v = $kh['notes-count-text'] .' '. $_strings['gs--tagged']; $q3v = []; foreach ($hb as $e3){ $q3v[] = htmlspecialchars ($e3['Keyword'],ENT_COMPAT,'UTF-8'); } $q3v = implode (', ',$q3v); if ((string)$f4 !== ''){ $ts = $f4; $js = $f4; } else { $ts = ev () .': '. $a3v .' '. $q3v; if ($c3v > 1){ $js = $_strings['pt--tags'] .': '. $q3v; } else { $js = $_strings['pt--tag'] .': '. $q3v; } } if($parameters['page']>1){ $ts .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $k3 = la ($parameters); $bb = [ 'title' => $ts, 'heading' => htmlspecialchars_decode ($js,ENT_COMPAT), 'notes' => $tagNotesView -> getNotesCTree (), 'pages' => $tagNotesView -> getPagesCTree (), 'tag' => $kh, 'tags' => $k3, ]; if ( !$tagNotesView -> isExistingPage () and !$tagNotesView -> isFirstPageOfEmptyView () ) { return e2m_error404 (); } if ( $tagNotesView -> isFirstPageOfEmptyView () and !$mm ) { return e2m_error404 (); } if($tagNotesView -> isFirstPageOfEmptyView ()) { $bb['nothing']=$_strings['gs--no-such-notes']; } if ((string)$kh['summary']!==''){ $bb['summary']=$kh['summary']; } if ($c3v == 1){ if (ss ()) { $bb['related-edit-href']=$kh['edit-href']; $bb['related-edit-title']=$_strings['tt--edit-tag']; } } if(Log::$a)__log ('} // Tag'); return $bb; } function e2m_tag_edit ($parameters = []) { global$_strings; if(array_key_exists ('*tag',$parameters)) { $ub = $parameters['*tag']; } if (!@$ub) return e2m_error404 (); AeMainMenuManager :: addParentTag ($ub['Keyword']); $b3 = ty ( 'neasden',$ub['Description'] ); $n3 = @unserialize ( $ub['Uploads'] ) or $n3 = []; $ew = u2 ( j2 ( g2 ( $b3,$n3 ) ) ); ny ( 'Keywords', $ub, $b3 ); $q7 = sy (); $z3v = b () ['t'. $ub['ID']]; $rw = implode (', ',o3 ()); $k3v = [ 'enabled?' => ay ($q7), 'each' => $ew, 'default-name' => htmlspecialchars ($z3v,ENT_COMPAT,'UTF-8'), 'allowed-extensions-list' => $rw, 'allowed-extensions-message' => ( _S ('er--supported-file-types') .' '. $rw ), 'upload-action' => wq ('e2j_file_upload'), 'rename-action' => wq ('e2j_file_rename'), 'remove-action' => wq ('e2j_file_remove'), ]; $x3v = [ '.tag-id' => $ub['ID'], '.formatter-id' => 'neasden', 'form-action' => wq ('e2s_tag_edit'), 'submit-text' => $_strings['fb--save-changes'], 'tag-dotted' => ta ($ub), 'page-title' => htmlspecialchars ($ub['PageTitle'],ENT_COMPAT,'UTF-8'), 'page-title-placeholder' => htmlspecialchars ($ub['Keyword'],ENT_COMPAT,'UTF-8'), 'alias' => htmlspecialchars ($z3v,ENT_COMPAT,'UTF-8'), 'description' => htmlspecialchars ($ub['Description'],ENT_COMPAT,'UTF-8'), 'summary' => htmlspecialchars ($ub['Summary'],ENT_COMPAT,'UTF-8'), 'pinned?' => (bool)$ub['IsFavourite'], 'space-usage' => qy ($q7), ]; $bb = [ 'body-uploads-enabled?' => ay ($q7), 'title' => $_strings['pt--tag-edit'] .': '. $ub['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $x3v, 'uploads' => $k3v, 'related-delete-href' => wq ('e2m_tag_delete', ['*tag' => $ub]), ]; return $bb; } function e2s_tag_flag_ajax ($parameters){ cq ([ 'flag-name' => 'tag', 'candy-name' => 'e2s_tag_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ na ($parameters); }, 'redirect-candy' => 'e2m_tag', ]); } function na ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ r1 (wq ('e2m_tag',$parameters)); } ms (); if(array_key_exists ('*tag',$parameters)) { $ub = $parameters['*tag']; } if (!$ub) throw new AeException ('Tag record not cound from parameters'); e2_drop_caches_for_tag_($ub['ID']); km ( sl (), 'Keywords', [ 'ID' => $ub['ID'], $parameters['flag'] => (int) ($parameters['value']==1), ] ); } function e2m_tag_delete ($parameters = []) { global$_strings; if(array_key_exists ('*tag',$parameters)) { $e3v = $parameters['*tag']; } if (!$e3v) return e2m_error404 (); $r3v = [ '.tag-id' => $e3v['ID'], 'caution-text' => e2l_get_string ('gs--tag-will-be-deleted-notes-remain', [ 'tag' => htmlspecialchars ($e3v['Keyword'],ENT_COMPAT,'UTF-8') ]), 'tag' => htmlspecialchars ($e3v['Keyword'],ENT_COMPAT,'UTF-8'), 'form-action' => wq ('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ]; $bb = [ 'title' => $_strings['pt--tag-delete'] .': '. $e3v['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $r3v, ]; return $bb; } function e2m_untagged ($parameters = []) { global$settings,$_strings,$_config; $mm = ss (); $untaggedView = new AePageableNotesView ('e2m_untagged',$parameters); $untaggedView -> setPortionSize ($settings['appearance']['notes_per_page']); $untaggedView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $untaggedView -> setWantPaging (true); $untaggedView -> setWantNewCommentsCount ($mm); $untaggedView -> setWantReadHrefs ($_config['count_reads']); $untaggedView -> setWantControls ($mm and !@$_config['read_only']); $untaggedView -> setWantHiddenTags ($mm); $p9 = ( "FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished`=1 ". "AND nk.`SubsetID` IS NULL ". xf ($mm) ); $untaggedView -> setSQLCountRequest ( "SELECT COUNT(*) Total ". $p9 ); $untaggedView -> setLimitlessSQLRequest ( "SELECT n.* ". $p9 ." ORDER BY n.`Stamp` DESC" ); $ts = $_strings['pt--posts-without-tags']; if($parameters['page']>1){ $ts .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $bb = [ 'title' => $ts, 'heading' => $_strings['pt--posts-without-tags'], 'notes' => $untaggedView -> getNotesCTree (), 'pages' => $untaggedView -> getPagesCTree (), ]; if($untaggedView -> isFirstPageOfEmptyView ()) { $bb['nothing']=$_strings['gs--no-posts-without-tags']; } elseif (!$untaggedView -> isExistingPage ()) { return e2m_error404 (); } return $bb; } function e2s_tag_edit () { global$_strings,$_config; ms (); $es = $zw = $lq = $uu = ''; if(array_key_exists ('tag-id',$_POST)) $es = $_POST['tag-id']; if(array_key_exists ('tag',$_POST)) $zw = $_POST['tag']; if(array_key_exists ('page-title',$_POST)) $f4 = trim ($_POST['page-title'],"\r\n"); if(array_key_exists ('description',$_POST)) $lq = trim ($_POST['description'],"\r\n"); if(array_key_exists ('summary',$_POST)) $ku = trim ($_POST['summary'],"\r\n"); if(array_key_exists ('urlname',$_POST)) $uu = trim ($_POST['urlname'],"\r\n"); list ($wv,$t3v)=ja ($zw); $j3v = 0; $h3v = 1; em ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = ".((int)$es)."", 'get tag record to update' ); $w3v = tm (); if(count ($w3v)!=1) die; $ub = $w3v[0]; em ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword` = '". jm ($wv) ."' ". "AND (`ID` != ".((int)$es).")", 'make sure new tag name does not conflict with existing ones' ); $w3v = tm (); if(count ($w3v)==0){ if ($h3v != $j3v){ cb (); } e2_drop_caches_for_tag_($es); if ($wv === ''){ $wv = $ub['Keyword']; hb ($_strings['er--tag-must-have-name'],E2E_USER_ERROR); } $ub['ID'] = ((int)$es); $ub['Keyword']=$wv; $ub['PageTitle']=$f4; $ub['Description']=$lq; $ub['Summary']=$ku; $ub['IsVisible']=$t3v; $b3 = ty ( 'neasden',$ub['Description'] ); if(count ($b3)>0){ vd ($b3); bd ($b3); } $databaseConfiguration = sl (); km ($databaseConfiguration,'Keywords',$ub); $yn = d ( USER_DIR,$databaseConfiguration, 'set','t',$ub['ID'],$uu ); r1 (wq ('e2m_tag', ['tag-alias' => $yn])); } else { hb ($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); t1 (); } die; } function e2s_tag_delete () { global$_config; ms (); $es = ((int)$_POST['tag-id']); cb (); e2_drop_caches_for_tag_($es); em ( "DELETE FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $es, 'delete note by ID' ); em ( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = 't' ". "AND `EntityID` = ". ((int)$es), 'delete aliases after deleting note' ); em ( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `KeywordID`=". $es, 'delete tag bindings after deleting tag' ); r1 (wq ('e2m_tags')); } function ma () { global$settings,$_config; $u3v = null; if(CACHE_FAVTAGS and is_file (USER_DIR . CACHE_FILENAME_FAVTAGS)) { $u3v = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_FAVTAGS)); } $mm = ss (); if (!is_array ($u3v)) { try { em ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsFavourite`=1 ORDER BY `Keyword`", 'get favorite tags for tags menu' ); $i3v = tm (); $u3v = []; foreach ($i3v as $ub){ if (!$ub['IsVisible']) continue; $xa['sort-id']='t'. $ub['ID']; $xa['tag']=htmlspecialchars ($ub['Keyword'],ENT_NOQUOTES,'UTF-8'); $xa['title']=vs ($xa['tag']); $xa['href']=wq ( 'e2m_tag', ['*tag' => $ub] ); $xa['visible?'] = (bool)$ub['IsVisible']; $xa['current?']=false; $xa['parent?']=false; $u3v[] = $xa; } if(CACHE_FAVTAGS)e3 (USER_DIR . CACHE_FILENAME_FAVTAGS,serialize ($u3v)); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Count not get tags menu from database'); } } if (!is_array ($u3v)) return null; foreach ($u3v as $x3 => $e3){ if (!$mm and !$u3v[$x3]['visible?']) { unset ($u3v[$x3]); continue; } $u3v[$x3]['parent?'] = ( AeMainMenuManager :: isParentTag ($u3v[$x3]['tag']) ); $u3v[$x3]['current?'] = ( AeMainMenuManager :: isCurrentTag ($u3v[$x3]['tag']) ); } if(is_array (@$settings['menu_order'])) { $q2 = array_flip ($settings['menu_order']); usort ($u3v, function ($dh,$sh) use ($q2){ $ah = @$q2[$dh['sort-id']]; $qh = @$q2[$sh['sort-id']]; if ($ah === false)$ah = count ($q2); if ($qh === false)$qh = count ($q2); return $ah - $qh; }); } return $u3v; } function fa ($note_id){ global$_config; $hb = []; em ( "SELECT k.* ". "FROM `". $_config['db_table_prefix']."Keywords` k, ". "`". $_config['db_table_prefix']."NotesKeywords` nk ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID`=". ((int)$note_id) ." ". "AND k.`ID`=nk.`KeywordID` ". "ORDER BY `Keyword`", 'get tag records for note by id' ); $hb = tm (); return $hb; } function da ($databaseConfiguration,$note_id,$lr){ sa ($databaseConfiguration, ['NoteID' => $note_id]); foreach ($lr as $zw){ list ($wv,$t3v)=ja ( $zw ); if ($wv === '') continue; $m8 = ka ($databaseConfiguration,$wv); if (!$m8){ @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); b (true); $m8['ID']=qa ( $databaseConfiguration,$wv,$t3v ); } rm ($databaseConfiguration, "INSERT INTO `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$databaseConfiguration -> getSubset ()) .", ". ((int)$note_id) .", ". ((int)$m8['ID']). ")", 'add new tag bindings' ); } } function sa ($databaseConfiguration,$o3v){ $p3v = []; foreach ([ 'ID', 'NoteID', 'KeywordID', ] as $x) if(array_key_exists ($x,$o3v)) { $t8[] = '`'. $x .'`'."='". jm ($o3v[$x]) ."'"; if ($x == 'ID')$cyv = 'tagbinging-id'; if ($x == 'NoteID')$cyv = 'tagbinging-note-id'; if ($x == 'KeywordID')$cyv = 'tagbinging-tag-id'; $p3v[$cyv]=$o3v[$x]; } $p2 = ( "DELETE FROM `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND ". implode (' AND ',$t8) ); rm ($databaseConfiguration,$p2); } function aa ($es,$vyv){ global$_config; em ( "SELECT `ID`, `Keyword`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix'] ."Keywords` k ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND k.`ID` IN (". "SELECT `KeywordID` FROM (". "SELECT COUNT(`NoteID`) NotesCount, `KeywordID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID` IN (". "SELECT nk2.`NoteID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk2 ". "WHERE nk2.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk2.`KeywordID`=". $es. ") ". "GROUP BY nk.`KeywordID` ". "HAVING NotesCount > 1 ". "ORDER BY NotesCount DESC ". "LIMIT 1, ". $vyv. ") k_ids". ")", 'find related tags' ); $yo = []; foreach (tm () as $ub){ if ($ub['ID']===$es) continue; $yo[] = [ 'name' => htmlspecialchars ($ub['Keyword'],ENT_NOQUOTES,'UTF-8'), 'href' => wq ('e2m_tag', ['*tag' => $ub]), 'visible?' => true, ]; } return $yo; } function qa ( AeDatabaseConfiguration $databaseConfiguration,$wv,$t3v ) { $ub = [ 'Keyword' => $wv, 'OriginalAlias' => d ( USER_DIR,$databaseConfiguration, 'find','','',$wv ), 'Description' => '', 'IsVisible' => $t3v, ]; $ub = zm ($databaseConfiguration,'Keywords',$ub); $byv = d ( USER_DIR,$databaseConfiguration, 'set','t',$ub['ID'],$wv ); if ($byv != $ub['OriginalAlias']) { $ub['OriginalAlias']=$byv; km ($databaseConfiguration,'Keywords',$ub); } return $ub['ID']; } function la ($parameters){ if (($yyv = za ()) === null) return []; $k3['each']=$yyv; if(count ($k3['each']) > 0){ $k3['href']=wq ('e2m_tags'); } if (($nyv = ma ()) !== null){ $k3['menu-each']=$nyv; } return $k3; } function za ($myv = false){ global$_config; $mm = ss (); $a2 = USER_DIR . CACHE_FILENAME_TAGS; if ($mm)$a2 = USER_DIR . CACHE_FILENAME_TAGS_AUTHOR; if ($myv){ $a2 = USER_DIR . CACHE_FILENAME_TAGS_FULL; if ($mm)$a2 = USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL; } $fyv = null; if(CACHE_TAGS and is_file ($a2)) { $fyv = @unserialize (file_get_contents ($a2)); } if (!is_array ($fyv)) { try { em ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY `Keyword`", 'get all tags' ); $dyv = []; foreach (tm () as $ub){ $wv['id'] = (int)$ub['ID']; $wv['tag']=htmlspecialchars ($ub['Keyword'],ENT_NOQUOTES,'UTF-8'); $wv['tag-dotted']=ta ($ub); $wv['pinned?']=false; $wv['visible?'] = (bool)$ub['IsVisible']; $wv['notes-count']=0; $wv['last-used']=0; $wv['freshness']=0; $wv['weight']=0; if ($myv){ $wv['href']=wq ('e2m_tag', ['*tag' => $ub]); } $dyv[$ub['ID']] = $wv; } em ( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished` = 1 ". xf ($mm). "AND nk.`NoteID` = n.`ID` ". "GROUP BY nk.KeywordID", 'get tags ordering info' ); $syv = 0; $ayv = 0; $qyv = 0; foreach (tm () as $lyv){ if (!isset ($dyv[$lyv['KeywordID']])) { unset ($dyv[$lyv['KeywordID']]); continue; } $xa =& $dyv[$lyv['KeywordID']]; $xa['notes-count']=$lyv['Count']; if (@$xa['last-used']<$lyv['LastUsed']) { $xa['last-used']=$lyv['LastUsed']; $zyv = (time () - $xa['last-used']) / SECONDS_IN_A_YEAR; $xa['freshness']=pow (1/2,$zyv); } $syv = max ($syv,$xa['notes-count']); $ayv = max ($ayv,$xa['freshness']); $qyv = max ($qyv,$xa['notes-count']*$xa['freshness']); } $fyv = []; foreach ($dyv as $wb => $e3){ if (!$mm and $e3['notes-count']==0) continue; if (!$mm and !$e3['visible?']) continue; $kyv = mb_strtolower ($e3['tag']); $fyv[$kyv]=$e3; if ($ayv != 0){ $fyv[$kyv]['freshness']=$e3['freshness']/$ayv; } else { $fyv[$kyv]['freshness']=0; } if ($qyv != 0){ $fyv[$kyv]['weight'] = ( $e3['freshness']*$e3['notes-count']/$qyv ); } else { $fyv[$kyv]['weight']=0; } if ($fyv[$kyv]['pinned?'])$fyv[$kyv]['weight']=1; } if(CACHE_TAGS)e3 ($a2,serialize ($fyv)); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get tags from database'); } } return $fyv; } function ka (AeDatabaseConfiguration $databaseConfiguration,$e3v){ rm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Keyword`='". jm ($e3v) ."'", 'get tag by name' ); $x3 = tm (); if (isset ($x3[0])) { return $x3[0]; } else { return null; } } function xa (AeDatabaseConfiguration $databaseConfiguration,$xyv){ rm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `OriginalAlias`='".jm ($xyv)."'", 'get tag by legacy urlname name' ); $xb = tm (); if (isset ($xb[0])) { return $xb[0]; } else { return null; } } function ea ($cn){ global$_config; em ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`='".((int)$cn)."'", 'get tag by id' ); $xb = tm (); if (isset ($xb[0])) { return $xb[0]; } else { return null; } } function e2_tagrecs_with_parameters_($parameters){ $eyv = []; if (@$parameters['tag-alias'] or $parameters['tag-alias']==='0'){ $eyv = explode (',',$parameters['tag-alias']); } $hb = []; foreach ($eyv as $xyv) if ($xyv or $xyv === '0'){ if ( $au = f (@$xyv) and ($au['type']=='t') and ($ub = ea ($au['id'])) ) { $hb[] = $ub; } else { if ($ryv = xa ( sl (), $xyv )) { $hb[] = $ryv; } } } return $hb; } function ta ($ub){ $tyv = htmlspecialchars ($ub['Keyword'],ENT_COMPAT,'UTF-8'); if (!$ub['IsVisible']) { $tyv = '.'. $tyv; } return $tyv; } function ja ($tyv){ if (@$tyv[0]==='.'){ return [trim (substr ($tyv,1),". \t\n\r\0\x0B"),false]; } else { return [$tyv,true]; } } function ha ($rf){ $bg = s1 ('H',$rf); if ($bg <= 4) return 4; elseif ($bg <= 10) return 1; elseif ($bg <= 16) return 2; elseif ($bg <= 22) return 3; else return 4; } function ga ($jyv,$hyv = null){ global$_strings; if ($hyv === null)$hyv = y1 (); $vy = time (); $gyv = d1 ('d.m.Y',$vy,$hyv); $wyv = d1 ('d.m.Y',$jyv,$hyv); $uyv = SECONDS_IN_A_MINUTE; $iyv = SECONDS_IN_AN_HOUR; $oyv = ha ($vy); $pyv = ha ($jyv); $cnv = $vy - $jyv; if ($cnv < 0) return$_strings['tt--from-the-future']; if ($cnv >= 0 and $cnv < 54) return$_strings['tt--just-now']; if ($cnv >= 54 and $cnv < 108) return$_strings['tt--one-minute-ago']; $vnv = $cnv + 12; $bnv = floor ($vnv / $uyv); if ($cnv >= 108 and $cnv < 54*$uyv) return e2l_get_string ( 'tt--minutes-ago', array ('minutes' => $bnv) ); if ($cnv >= 54*$uyv and $cnv < 108*$uyv) return$_strings['tt--one-hour-ago']; $vnv = $cnv + 12*$uyv; $ynv = floor ($vnv / $iyv); if ($cnv >= 108*$uyv and $cnv < 4*$iyv) return e2l_get_string ( 'tt--hours-ago', array ('hours' => $ynv) ); $l = d1 ('G:i',$jyv,$hyv); if ($cnv >= 4*$iyv and $oyv > $pyv and $gyv == $wyv){ return$_strings['tt--today']; } if ((($vy - $jyv) <= 7884000)) { return e2l_get_string ( 'tt--date', array ( 'day' => d1 ('j',$jyv,$hyv), 'month' => d1 ('m',$jyv,$hyv), ) ); } return d1 ('Y',$jyv,$hyv); } function wa ($jyv,$hyv = null){ global$_strings; $cnv = time () - $jyv; if ($cnv < 0) return$_strings['tt--from-the-future']; if ($cnv == 0) return$_strings['tt--now']; $nnv = array ( array (1,'tt--seconds-short'), array (SECONDS_IN_A_MINUTE,'tt--minutes-short'), array (SECONDS_IN_AN_HOUR,'tt--hours-short'), array (SECONDS_IN_A_DAY,'tt--days-short'), array (SECONDS_IN_A_MONTH,'tt--months-short'), array (SECONDS_IN_A_YEAR,'tt--years-short'), array (SECONDS_IN_A_YEAR + SECONDS_IN_A_MONTH,''), ); for ($wb = 0; $wb < count ($nnv); ++ $wb){ if ($cnv >= $nnv[$wb][0] and $cnv < $nnv[$wb + 1][0]) { return e2l_get_string ( $nnv[$wb][1], array ('value' => floor ($cnv / $nnv[$wb][0])) ); } } if ($hyv === null)$hyv = y1 (); return d1 ('Y',$jyv,$hyv); } function e2m_timezone () { global$_strings,$settings; $mnv = array ( 'form-action' => wq ('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => pa ($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $mnv, ); } function ua () { global$_strings; $fnv = array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $fnv; } function ia ($j3){ $fnv = ua (); return @$fnv[(int)$j3/SECONDS_IN_A_MINUTE]; } function oa ($j3){ $dnv = '+'; if ($j3 < 0)$dnv = '&ndash;'; $snv = str_pad ((int) (abs ($j3)/3600),2,'0',STR_PAD_LEFT); $anv = str_pad (abs ($j3)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $dnv . $snv .':'. $anv; } function pa ($qnv,$lnv = ''){ global$_strings; $fnv = ua (); $bb = ''; if (!$lnv)$lnv = count ($fnv); $bb .= '<select class="e2-select" name="offset" size="'. $lnv .'">'; foreach ($fnv as $j3 => $znv){ $knv = ''; if ($j3 * SECONDS_IN_A_MINUTE == $qnv)$knv = ' selected="selected"'; $bb .= '<option'. $knv .' value="'.$j3.'">'; $dnv = ''; if ($j3 < 0)$dnv = '−'; if ($j3 > 0)$dnv = '+'; $snv = (int) (abs ($j3 * SECONDS_IN_A_MINUTE)/3600); $anv = (int) (abs ($j3 * SECONDS_IN_A_MINUTE)/60 % 60); if ($snv){ $bb .= ( $dnv .' '. $snv .' '. $_strings['gs--timezone-offset-hours'] .' '. ($anv? ($anv .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($znv){ $bb .= ' ('. $znv. ')'; } } else { $bb .= $znv; } $bb .= '</option>'; } $bb .= '</select>'; return $bb; } function c1 ($pb){ global$settings; if($settings['timezone']===$pb) return true; $settings['timezone']=$pb; return @e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE)); } function e2s_select_timezone () { global$_strings; ms (); if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $pb['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $pb['is_dst'] = isset ($_POST['is_dst']); } if (c1 ($pb)) { r1 (wq ('e2m_settings')); } else { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); r1 (wq ('e2m_timezone')); } } function v1 ($r){ return array ( 'offset' => (int)$r['Offset'], 'is_dst' => (bool)$r['IsDST'], ); } function b1 () { return array ( 'offset' => 0, 'is_dst' => false, ); } function y1 () { global$settings; if(array_key_exists ('timezone',$settings)) { return$settings['timezone']; } else { return b1 (); } } function n1 ($pb,$xnv){ if (@$pb['is_dst']) { $env = (int)date ('I',$xnv); $rnv = date ('Z',$xnv)-$env * SECONDS_IN_AN_HOUR; $tnv = $pb['offset']; $jnv = $tnv - $rnv; $hnv = date ('I',$xnv + $jnv); return $hnv; } else { return 0; } } function m1 ($pb,$xnv){ if ($pb and is_array ($pb)) { return ( $pb['offset'] + n1 ($pb,$xnv)*SECONDS_IN_AN_HOUR ); } } function f1 ($xnv){ return m1 (y1 (), $xnv); } function d1 ($gnv,$uz,$pb){ return gmdate ($gnv,$uz + m1 ($pb,$uz)); } function s1 ($gnv,$uz){ return d1 ($gnv,$uz,y1 ()); } function a1 ($mf,$ff = false,$df = false){ if(is_numeric ($df)) { $wnv = gmmktime (0,0,0, (int)$ff, (int)$df, (int)$mf); $unv = gmmktime (0,0,0, (int)$ff,$df + 1, (int)$mf)-1; } elseif(is_numeric ($ff)) { $wnv = gmmktime (0,0,0, (int)$ff,1, (int)$mf); $unv = gmmktime (0,0,0,$ff + 1,1, (int)$mf)-1; } else { $wnv = gmmktime (0,0,0,1,1, (int)$mf); $unv = gmmktime (0,0,0,1,1,$mf + 1)-1; } return array ($wnv,$unv); } function q1 ($pb,$mf,$ff = false,$df = false){ list ($wnv,$unv)=a1 ($mf,$ff,$df); $wnv -= m1 ($pb,$wnv); $unv -= m1 ($pb,$unv); return array ($wnv,$unv); } function l1 ($mf,$ff = false,$df = false){ return q1 (y1 (), $mf,$ff,$df); } function z1 ($mf,$ff = false,$df = false){ $inv = 13; $onv = -12; $inv += 1; $onv -= 1; list ($wnv,$unv)=a1 ($mf,$ff,$df); $wnv -= $inv * 3600; $unv -= $onv * 3600; return array ($wnv,$unv); } function k1 ($j3){ if ((int) @$j3 > 0) return (string)'+'.abs (@$j3); elseif ((int) @$j3 < 0) return (string)'-'.abs (@$j3); else return ''; } function x1 ($xnv,$pnv = ''){ $cmv = f1 ($xnv); $dnv = ($cmv >= 0)?'+':'-'; $cmv = abs ($cmv); $yg = $cmv % 60; $cmv -= $yg; $ff = $cmv % 3600 / 60; $cmv -= $ff * 60; $bg = $cmv / 3600; if ($bg < 10)$bg = '0'.$bg; if ($ff < 10)$ff = '0'.$ff; return $dnv.$bg.$pnv.$ff; } function e1 ($vmv){ global$settings; if(is_numeric ($vmv)) { $g3['offset']=SECONDS_IN_A_MINUTE * $vmv; $g3['is_dst']=false; $bmv = SECONDS_IN_A_MINUTE * $vmv - SECONDS_IN_AN_HOUR; $ymv = array ('offset' => $bmv,'is_dst' => true); $ymv = (int)m1 ($ymv,time ()); if ($g3['offset']==$ymv){ $g3['offset']=$bmv; $g3['is_dst']=true; } } else { if(array_key_exists ('timezone',$settings)) { $g3 = $settings['timezone']; } else { $g3['offset']=0; $g3['is_dst']=false; } } return $g3; } function r1 ($x1 = ''){ global$errors; @session_start (); $_SESSION['errors']=$errors; if(substr ($x1,0,strlen (AeEnv::$o)+3)!=AeEnv::$o .'://'){ header ('Location: '. AeEnv::$cv . $x1); } else { header ('Location: '. $x1); } flush (); die; } function t1 () { $nmv = (string) @$_SERVER['HTTP_REFERER']; r1 ($nmv); } function j1 ($yj = ''){ $mmv = str_replace ('/','--', trim (AeEnv::$u .'/'.AeEnv::$w,'/') ); if ($mmv !== '')$mmv .= '-'; $url = AeEnv::$p; $d7 = substr_count ($_SERVER['HTTP_HOST'],'.'); $bb = $mmv . @str_repeat ('_',$d7).$yj; return $bb; } function h1 ($mcv){ $mcv = trim ($mcv); if ($mcv === '') return false; if ($mcv[0]==='['){ $unv = strpos ($mcv,']'); if ($unv !== false)$mcv = substr ($mcv,1,$unv - 1); } else { $fmv = strrpos ($mcv,':'); if ($fmv !== false && strpos ($mcv,':')===$fmv){ $uf = substr ($mcv,0,$fmv); if(filter_var ($uf,FILTER_VALIDATE_IP,FILTER_FLAG_IPV4)) { $mcv = $uf; } } } if (!filter_var ($mcv,FILTER_VALIDATE_IP)) return false; $dmv = strtolower ($mcv); if ($dmv === '::1' or $dmv === '0:0:0:0:0:0:0:1') return true; return strpos ($mcv,'127.')===0; } function g1 () { static $g3 = null; if ($g3 !== null) return $g3; if(PHP_SAPI === 'cli-server') return $g3 = true; if (!empty ($_SERVER['HTTP_X_FORWARDED_FOR'])) { return $g3 = false; } if (empty ($_SERVER['REMOTE_ADDR']) or !h1 ($_SERVER['REMOTE_ADDR'])) { return $g3 = false; } foreach (['SERVER_ADDR','LOCAL_ADDR'] as $xn){ if (empty ($_SERVER[$xn])) continue; if (!h1 ($_SERVER[$xn])) { return $g3 = false; } } return $g3 = true; } function w1 ($yj,$bv = '',$smv = true){ global$_config; $amv = $smv? (time () + 3600 * 24 * 365) : (0); $aj = $_SERVER['HTTP_HOST']; $qmv = substr_count ($aj,'.'); if ($qmv < 3)$aj = str_repeat ('.',3 - $qmv).$aj; $lmv = true; if($_config['insecure_cookies']) { $lmv = false; } elseif($_config['insecure_cookies_local'] and g1 ()) { $lmv = false; } if(version_compare (PHP_VERSION,7.3) >= 0){ $zmv = '/'; setcookie (j1 ($yj),$bv, [ 'expires' => $amv, 'path' => $zmv, 'domain' => "", 'secure' => $lmv, 'httponly' => true, 'samesite' => 'Lax' ]); } else { $zmv = '/; samesite=Lax'; setcookie (j1 ($yj),$bv,$amv,$zmv,"",$lmv,true); } } function u1 ($kmv,$x4,$xmv = ''){ if(trim ($x4)!=''){ $x4 = explode ($kmv,$x4); foreach ($x4 as $wb => $x3)$x4[$wb]=trim ($x3); foreach ($x4 as $wb => $x3) if ($x3 == '') unset ($x4[$wb]); $emv = array_unique ($x4); if ('sort' == $xmv)sort ($emv); return $emv; } else return array (); } function i1 ($x4){ $cl = array (); if(is_file (SYSTEM_DEFAULTS_DIR . 'romanize.txt')) { $cl = file (SYSTEM_DEFAULTS_DIR . 'romanize.txt'); } $rmv = $bh = ''; foreach ($cl as $wb => $kf){ if (!($wb%2))$rmv .= rtrim ($kf) .' '; else $bh .= rtrim ($kf) .' '; if ($wb%2){ while (mb_strlen ($bh)<mb_strlen ($rmv))$bh .= ' '; while (mb_strlen ($bh)>mb_strlen ($rmv))$rmv .= ' '; } } $tmv = ''; $jmv = -1; for ($wb = 0; $wb < mb_strlen ($rmv); ++ $wb){ $lbv = mb_substr ($rmv,$wb,1); if ($lbv != ' '){ $tmv .= $lbv; if ($jmv == -1)$jmv = $wb; } elseif ($tmv){ $hmv = trim (mb_substr ($bh,$jmv,mb_strpos ($bh,' ',$jmv + 1)-$jmv)); $eb = array ($tmv,$hmv); $gmv[mb_strlen ($tmv)][] = $eb; $tmv = ''; $jmv = -1; } } $wmv = array (); for ($wb = count ($gmv); $wb > 0; -- $wb){ foreach ($gmv[$wb] as $eb)$wmv[$eb[0]] = $eb[1]; } return strtr ($x4,$wmv); } function o1 ($dh,$sh,$umv = 0){ if ($sh == 0) return 0; $imv = round ($dh / $sh * 100,$umv); $omv = pow (10, -$umv); if ($dh > 0 and $imv == 0)$imv = $omv; if ($dh < $sh and $imv == 100)$imv = 100 - $omv; return $imv; } function p1 ($pmv,$action,$uz){ if (!is_array ($pmv))$pmv = array (); if($action == 'add'){ $pmv = array_unique (array_merge ($pmv,$uz)); } if($action == 'remove'){ unset ($pmv[array_search ($uz,$pmv)]); } if (!is_array ($pmv))$pmv = array (); return $pmv; } function cq ($kb){ $parameters = $kb['parameters']; $rl = [ 'success' => false ]; $kb['flipping-function'] ($parameters); $cfv = $parameters; $cfv['value'] = !$parameters['value']; $rl = [ 'success' => true, 'data' => [ 'flag-now-on' => ($parameters['value']==1), 'new-href' => wq ($kb['candy-name'],$cfv), ] ]; if(array_key_exists ('result',$_POST) and ($_POST['result']=='ajaxresult')) { $rl = json_encode ($rl); die ($rl); } else { r1 (wq ($kb['redirect-candy'],$parameters)); } } function vq ($x4){ $lcv = @$_SERVER['HTTP_USER_AGENT'] or $lcv = ''; $vfv = strstr ($lcv,'iPhone') || strstr ($lcv,'iPad'); $bfv = strstr ($lcv,'Macintosh'); if ($vfv) return ''; if ($x4 == 'submit'){ if ($bfv){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($x4 == 'livesave'){ if ($bfv){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($x4 == 'navigation'){ if ($bfv){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($x4 == 'navigation-later'){ if ($bfv){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($x4 == 'navigation-earlier'){ if ($bfv){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function bq ($o1){ $o1 = str_replace ('<','&lt;',$o1); $o1 = str_replace ('>','&gt;',$o1); return $o1; } function yq ($o1){ $o1 = str_replace ('"','&quot;',$o1); return $o1; } function nq ($bv,$yfv){ return str_replace ('.',',',round ($bv,$yfv)); } function e2_stripslashes_array ($zs){ return is_array ($zs)?array_map ('e2_stripslashes_array',$zs):stripslashes ($zs); } function mq () { if(version_compare (PHP_VERSION,'7.4') >= 0) return; if(get_magic_quotes_runtime ()) { set_magic_quotes_runtime (0); } if(get_magic_quotes_gpc ()) { $_GET = e2_stripslashes_array ($_GET); $_POST = e2_stripslashes_array ($_POST); $_COOKIE = e2_stripslashes_array ($_COOKIE); $_REQUEST = e2_stripslashes_array ($_REQUEST); } } function fq ($mcv){ return sprintf ('%u',ip2long ($mcv)); } function dq ($ua){ return long2ip (sprintf ('%d',$ua)); } function e2_decline_for_number ($o1,$ua = null){ $nfv = $o1; if ($ua === null){ $ua = substr ($o1,0,strpos ($o1,' ')); $nfv = substr ($o1,strpos ($o1,' ')+1); } $mfv = strpos ($nfv,'('); $ffv = strpos ($nfv,')'); if ($ffv > $mfv)$dfv = substr ($nfv,$mfv,$ffv - $mfv + 1); $sfv = explode (',',trim (@$dfv,'()')); if(count ($sfv)==2)array_unshift ($sfv,''); $afv = array (2,0,1,1,1,2,2,2,2,2); if ($ua%100 > 10 and $ua%100 < 20)$qfv = 2; else $qfv = $afv[$ua%10]; $ne = $sfv[$qfv]; $o1 = str_replace ($dfv,$ne,$o1); if(strstr ($o1,'(') and strstr ($o1,')')) { return e2_decline_for_number ($o1,$ua); } else { return $o1; } } function sq ($lfv){ $yvv = glob ($lfv,GLOB_NOSORT); if(is_array ($yvv)) { foreach ($yvv as $ds){ @unlink ($ds); } } } function aq ($d6){ $yvv = glob ($d6 .'*',GLOB_NOSORT); if(is_array ($yvv)) { foreach ($yvv as $ds){ if(basename ($ds)!='.' and basename ($ds)!='..'){ if(is_dir ($ds)) { if (aq ($ds .'/')) { if (!@rmdir ($ds)) { return false; } } else { return false; } } else { @unlink ($ds); } } } return true; } else { return false; } } function qq ($zmv){ $zmv = trim ($zmv,'/'); $zmv = explode ('/',$zmv); $d6 = ''; foreach ($zmv as $mg){ $d6 = $d6.$mg; if (!is_dir ($d6)) { if (@mkdir ($d6)) { @chmod ($d6,E2_NEW_FILES_RIGHTS); } else { return false; } } $d6 = $d6.'/'; } return true; } function lq ($zmv){ return preg_replace ('/\/([^\/]+?)\/\.\./','',$zmv); } function zq ($x4){ $zfv = get_html_translation_table (HTML_ENTITIES); $zfv = array_flip ($zfv); return strtr ($x4,$zfv); } function kq ($kfv = NULL){ if(NULL == $kfv)$kfv = microtime (); list ($xfv,$cnv)=explode (' ',$kfv); return ((float)$xfv + (float)$cnv); } function _A ($o1){ global$_candy,$_current_url; if ( preg_match ('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$o1,$sr) and ( $sr[1]==='' or $sr[1]===$_current_url or AeEnv::$o .'://'. AeEnv::$server . $sr[1]===$_current_url or AeEnv::$cv . $sr[1]===$_current_url or $_candy == 'e2m_install' ) ) { return $sr[2]; } else { return $o1; } } function _AT ($t1){ global$_current_url; return ( $t1 === '' or $t1 === $_current_url or AeEnv::$o .'://'. AeEnv::$server . $t1 === $_current_url or AeEnv::$cv . AeEnv::$w . $t1 === $_current_url ); } function _READS ($i3){ if (!empty ($i3['read-count'])) return $i3['read-count']; return AeNoteReadCountsProvider :: getReadCountForNoteID ($i3['id']); } function _IMGSRC ($ds){ return f2 ($ds); } function _SVG ($ds){ return d2 ($ds); } function _COLOR ($b,$y,$efv,$rfv = 1){ if(strlen ($b)!=3 and strlen ($b)!=6) return 'f0f'; if(strlen ($y)!=3 and strlen ($y)!=6) return 'f0f'; if(strlen ($b)==3)$b = $b[0].$b[0].$b[1].$b[1].$b[2].$b[2]; if(strlen ($y)==3)$y = $y[0].$y[0].$y[1].$y[1].$y[2].$y[2]; $x8 = array ( $b[0].$b[1],$b[2].$b[3],$b[4].$b[5], $y[0].$y[1],$y[2].$y[3],$y[4].$y[5], ); foreach ($x8 as $x3 => $e3){ $x8[$x3]=hexdec ($e3); } $ej = array ( $x8[0]+pow ($efv,$rfv) * ($x8[3]-$x8[0]), $x8[1]+pow ($efv,$rfv) * ($x8[4]-$x8[1]), $x8[2]+pow ($efv,$rfv) * ($x8[5]-$x8[2]), ); $tfv = ''; foreach ($ej as $x3 => $e3){ $tfv .= str_pad (dechex ($e3),2,'0',STR_PAD_LEFT); } return $tfv; } function _DT ($gnv,$jfv){ if (!$jfv) return ''; list ($rf,$pb)=$jfv; $bb = $gnv; $ym = d1 ('m',$rf,$pb); $bb = str_replace ('{zone}',e2__escape_all (oa ($pb['offset'])), $bb); $bb = str_replace ('{month}',e2__escape_all (e2l_get_string ('um--month', array ('month' => $ym))), $bb); $bb = str_replace ('{month-short}',e2__escape_all (e2l_get_string ('um--month-short', array ('month' => $ym))), $bb); $bb = str_replace ('{month-g}',e2__escape_all (e2l_get_string ('um--month-g', array ('month' => $ym))), $bb); $bb = d1 ($bb,$rf,$pb); return $bb; } function _AGO ($jfv){ return wa ($jfv[0], array ('offset' => $jfv[1]['offset'],'is_dst' => $jfv[1]['is_dst']) ); } function _NUM ($o1){ return e2_decline_for_number ($o1); } function _CSS ($hfv){ return b2 ($hfv); } function _CSS_HREF ($hfv){ return s2 ($hfv); } function _JS ($gfv){ return y2 ($gfv); } function _LIB ($d9){ return n2 ($d9); } function _T ($v9){ echo c2 ($v9); } function _T_DEFER ($name){ echo if_ ($name); } function _X ($v9){ echo pf ($v9); } function _T_FOR ($v9,$wfv = null){ global$content; if ($wfv === null)$wfv = $v9; if(array_key_exists ($wfv,$content)) { echo c2 ($v9); } else { echo ''; } } function _FIT ($r7,$t7){ } function _GUIDES ($ufv = false){ global$_olba_guides; if(is_array ($ufv))$_olba_guides = $ufv; if (!is_array ($_olba_guides)) return; $ifv = '<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $ofv = 0; $pfv = $_olba_guides; $pfv[] = 100; foreach ($pfv as $wb => $c2v){ if ($c2v == 100) break; $ofv += $c2v; $ifv .= '<div style="position: fixed; left: '. $c2v .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $v2v = 'position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($pfv[$wb+1]-$pfv[$wb]<4){ $ifv .= '<div style="'. $v2v.'; right: '. (100 - $c2v) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $c2v .'%</div>'; } else { $ifv .= '<div style="'. $v2v.'; left: '. $c2v .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $c2v .'%</div>'; } } $ifv .= '</div>'; $_olba_current_col = 0; return $ifv; } function _S ($x4){ global$_strings; return$_strings[$x4]; } function _SHORTCUT ($name){ return vq ($name); } function _ESCAPE ($o1){ return htmlspecialchars ((string) @$o1,ENT_NOQUOTES,'UTF-8'); } function _ESCAPE_ATTR ($o1){ return htmlspecialchars ((string) @$o1,ENT_QUOTES,'UTF-8'); } function e2__escape_all ($x4){ $bb = ''; for ($wb = 0; $wb < mb_strlen ($x4); ++ $wb){ $bb .= '\\'. mb_substr ($x4,$wb,1); } return $bb; } function xq ($rmv){ global$_db,$_instance_config,$_strings; $b2v = 'v'. $rmv; $y2v = 'v'. E2_VERSION; $n2v = tq ($rmv); $m2v = tq (E2_VERSION); if ($n2v === $m2v){ $n2v = $b2v; $m2v = $y2v; } else { $n2v .= ' ('. $b2v. ')'; $m2v .= ' ('. $y2v .')'; } $f2v = tq (3239) .' (v3239)'; if (!$_instance_config['allow_update']) { return ['stub' => ya ('update-disallowed')]; } if(E2_VERSION < $rmv and !$_instance_config['dev_ignore_version_mismatch']) { return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--confused'], 'text' => '<p>'. e2l_get_string ('gs--downdate-explanation', [ 'dr' => $n2v, 'rr' => $m2v, ]) .'</p>', ])]; } if ($rmv < 3239){ return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--multi-step-update'], 'text' => '<p>'. e2l_get_string ('gs--multi-step-update-p1', [ 'dr' => $n2v, 'rr' => $m2v, 'ur' => $f2v, ]) .'</p>'.'<p>'. e2l_get_string ('gs--multi-step-update-p2', [ 'dr' => $n2v, 'rr' => $m2v, 'ur' => $f2v, ]) .'</p>', ])]; } if (rq ()) { return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--updating'], 'text' => '<p>'. $_strings['gs--this-takes-seconds'] .'</p>', 'button' => $_strings['fb--retry'], ])]; } $d2v = @unserialize (file_get_contents (INSTANCE_DIR .'migration.psa')); if (!is_array ($d2v))$d2v = []; if($_instance_config['log_updates']) { Log::$a = true; if(Log::$a)tn ('update-$'); } if(Log::$a)__log ('Update from v'. $rmv .' to v'. E2_VERSION.' {'); $s2v = ($rmv < 3601); $databaseConfigurationsToMigrate = []; try { if(Log::$a)__log ('Update instance'); if($_instance_config['db']!==null){ $instanceDatabaseConfiguration = new AeDatabaseConfiguration ( 'instance-config', INSTANCE_DIR . BACKUP_DIRNAME, $_instance_config['db']['server'], $_instance_config['db']['user_name'], $_instance_config['db']['passw'], $_instance_config['db']['name'], $_instance_config['db_table_prefix'] ); if($_instance_config['backup_before_update']) { im ($instanceDatabaseConfiguration); } dm ($instanceDatabaseConfiguration); if(Log::$a)__log ('Instance has migrateable database table set "'. $instanceDatabaseConfiguration -> getTablesKeyString (). '"'); if (@$d2v[$instanceDatabaseConfiguration -> getTablesKeyString ()]) { if(Log::$a)__log ('Marked as already migrated, will skip'); } else { $a2v = (eq ($instanceDatabaseConfiguration)); $instanceDatabaseConfiguration -> setSubset ($a2v); if(Log::$a)__log ('Will set subset '. $a2v .' for subset-zero records'); $databaseConfigurationsToMigrate[ $instanceDatabaseConfiguration -> getTablesKeyString () ] = $instanceDatabaseConfiguration; } } zn (); AeFileManager::forceInstanceDirectories (); $q2v = dl (); if(Log::$a)__log ('Update '. count ($q2v) .' users {'); $xq = []; foreach ($q2v as $dvv){ $l2v = nl ($dvv,$_instance_config['path_user']); $z2v = fl ($_instance_config,$l2v); $svv = e2_load_settings_from_user_folder_($dvv); if(count ($k2v = AeFileManager::getPathsWithNoWritePermissions ( $z2v['path_user'],$z2v['path_media'] )) > 0){ $xq = array_merge ($xq,$k2v); continue; } if(Log::$a)__log ( 'User with key "'. $l2v .'" has path "'. $z2v['path_user'] .'", '. 'media path "'. $z2v['path_media'] .'"' ); $userDatabaseConfiguration = al ( $z2v,$svv ); if ($z2v['backup_before_update']) { im ($userDatabaseConfiguration); } dm ($userDatabaseConfiguration); if(Log::$a)__log ( 'User has migrateable database configuration "'. $userDatabaseConfiguration. '"' ); if (@$d2v[$userDatabaseConfiguration -> getTablesKeyString ()]) { if(Log::$a)__log ('Marked as already migrated, will skip'); } else { $databaseConfigurationsToMigrate[ $userDatabaseConfiguration -> getTablesKeyString () ] = $userDatabaseConfiguration; } AeFileManager::forceUserDirectories ($z2v['path_user']); AeFileManager::forceMediaDirectories ($z2v['path_media']); sq ($z2v['path_user'].CACHES_DIRNAME .'*'); if ($rmv < 3354){ @rename ($z2v['path_media'] .'pictures/userpics/',AVATARS_DIRNAME); @unlink ($z2v['path_user'] .'password-reset.txt'); } if ($rmv < 3949){ @unlink ($z2v['path_user'] .'indexing.psa'); } if ($rmv < 4137){ if(Log::$a)__log ('Delete thumbs (may have had incorrect names) {'); $x2v = $z2v['path_media'].THUMBNAILS_DIRNAME; foreach(glob ($x2v .'*.*') as $ds){ if(is_file ($ds) and dd ($ds)) { if(Log::$a)__log ('Unlink '. $ds); @unlink ($ds); } } if(Log::$a)__log ('}'); } foreach (fy () as $ms){ if(is_file ($z2v['path_user'].$ms)) { rename ( $z2v['path_user'].$ms, $z2v['path_media'].USERPIC_DIRNAME . $ms ); } } if ($s2v)jd ($z2v['path_user']); } if(count ($xq)>0){ return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--fix-permissions'], 'text' => ( '<p>'. $_strings['gs--fix-permissions'] .'</p>'. gb (array_unique ($xq)) ), 'button' => $_strings['fb--retry'], ])]; } if(Log::$a)__log ('}'); if(Log::$a)__log ('Migrate '. count ($databaseConfigurationsToMigrate) .' database table set(s), namely:'); $x3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ((++ $x3) .'. "'. $databaseConfigurationToMigrate -> getTablesKeyString (). '"'); } $x3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ('Prepage for migratation '. (++ $x3) .'/'. count ($databaseConfigurationsToMigrate) .':'); vm ($databaseConfigurationToMigrate); } $x3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ('Migrate '. (++ $x3) .'/'. count ($databaseConfigurationsToMigrate) .':'); bm ($databaseConfigurationToMigrate); $d2v[$databaseConfigurationToMigrate -> getTablesKeyString ()] = true; @e3 (INSTANCE_DIR .'migration.psa',serialize ($d2v)); if ($s2v){ bs ($databaseConfigurationToMigrate); } } } catch (AeMySQLCannotConnectException $e){ if(Log::$a)__log ('Aborting: cannot connect'); if(Log::$a)__log ($e -> getMessage ()); return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['er--cannot-connect-to-db'] .'</p>', ])]; } catch (AeMySQLNotFoundException $e){ if(Log::$a)__log ('Aborting: database not found'); return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['er--cannot-find-db'] .'</p>', ])]; } catch (AeMySQLTooOldException $e){ if(Log::$a)__log ('Aborting: '. $_db['software'] .' too old'); return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. e2l_get_string ( 'gs--dbs-version-too-old', [ 'dbs' => $_db['software'], 'dbv' => $_db['version'], 'minmysql' => E2_MINIMUM_MYSQL, 'minmariadb' => E2_MINIMUM_MARIADB, 'aegearelease' => tq (E2_VERSION) ] ) .'</p>' ])]; } catch (AeMySQLNotMigrateableException $e){ if(Log::$a)__log ('Aborting: not migrateable'); return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['gs--update-db-incomplete'] .'</p>', ])]; } catch (AeMySQLNoDataException $e){ if(Log::$a)__log ('Aborting: no data in database'); return ['stub' => ya ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['gs--update-db-no-data-configure-or-reinstall'] .'</p>', ])]; } finally { @unlink (INSTANCE_DIR .'updating.psa'); } @unlink (INSTANCE_DIR .'migration.psa'); if(Log::$a)__log ('Update completed'); $e6 = ln (E2_VERSION); return [ 'status' => 'success', 'from-release' => $n2v, 'to-release' => $m2v, 'instance' => $e6, ]; } function eq (AeDatabaseConfiguration $databaseConfiguration){ $e2v = 0; foreach(AeModel::unprefixedCoreTablesNames () as $w2){ rm ( $databaseConfiguration, "SELECT MAX(`SubsetID`) MaxSubsetID ". "FROM `". $databaseConfiguration -> getPrefix () . $w2 ."`" ); $g3 = tm (); $e2v = max ($e2v,$g3[0]['MaxSubsetID']); } return $e2v + 1; } function rq () { $r2v = ini_get ('max_execution_time')+1; $t2v = @unserialize (file_get_contents (INSTANCE_DIR .'updating.psa')); if (!is_array ($t2v))$t2v = []; if ( isset ($t2v['locktime']) and $t2v['locktime'] >= time () - $r2v ) return true; $t2v['locktime']=time (); @e3 (INSTANCE_DIR .'updating.psa',serialize ($t2v)); return false; } function tq ($e3){ $name = '2.6 or earlier'; if ($e3 >= 3119)$name = '2.6'; if ($e3 >= 3201)$name = '2.7b'; if ($e3 >= 3225)$name = '2.7b2'; if ($e3 >= 3239)$name = '2.7'; if ($e3 >= 3254)$name = '2.8a'; if ($e3 >= 3335)$name = '2.8b'; if ($e3 >= 3354)$name = '2.8b2'; if ($e3 >= 3364)$name = '2.8'; if ($e3 >= 3382)$name = '2.8 SP1'; if ($e3 >= 3386)$name = '2.8 SP2'; if ($e3 >= 3445)$name = '2.9a2'; if ($e3 >= 3492)$name = '2.9a4'; if ($e3 >= 3520)$name = '2.9b'; if ($e3 >= 3543)$name = '2.9b2'; if ($e3 >= 3553)$name = '2.9'; if ($e3 >= 3559)$name = '2.9 SP1'; if ($e3 >= 3565)$name = '2.9 SP2'; if ($e3 >= 3572)$name = '2.9 SP3'; if ($e3 >= 3576)$name = '2.9 SP4'; if ($e3 >= 3733)$name = '2.10a'; if ($e3 >= 3753)$name = '2.10a2'; if ($e3 >= 3783)$name = '2.10a3'; if ($e3 >= 3788)$name = '2.10'; if ($e3 >= 3805)$name = '2.10 SP1'; if ($e3 >= 3820)$name = '2.10 SP2'; if ($e3 >= 3831)$name = '2.10 SP3'; if ($e3 >= 3849)$name = '2.10 SP4'; if ($e3 >= 3860)$name = '2.10 SP5'; if ($e3 >= 3874)$name = '2.10 SP6'; if ($e3 >= 4034)$name = '11.0a'; if ($e3 >= 4045)$name = '11.0a2'; if ($e3 >= 4065)$name = '11.0b'; if ($e3 >= 4066)$name = '11.0b2'; if ($e3 >= 4079)$name = '11.0'; if ($e3 >= 4098)$name = '11.1'; if ($e3 >= 4116)$name = '11.2'; if ($e3 >= 4134)$name = '11.3'; if ($e3 >= 4169)$name = '11.4'; return$name; } $_url_map = [ '@retrieve:url' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', 'sitemap.xml' => 'e2://e2m_sitemap_xml', 'e2-sw-offline-new.js' => 'e2://e2m_sw_offline_new', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note?is_published=1&preview-key=0', ':note/:preview' => 'e2://e2m_note?is_published=1', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2s_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2s_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2s_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2s_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2s_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2s_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/read' => 'e2://e2m_note_read', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2s_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2s_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2s_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2s_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2s_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2s_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2s_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2s_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts?page=1', 'drafts-:page' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_note?is_published=0&preview-key=0', 'drafts/:draft/:preview' => 'e2://e2m_note?is_published=0', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'sources' => 'e2://e2m_sources', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2s_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2s_tag_flag_ajax?flag=IsFavourite&value=0', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'hot' => 'e2://e2m_most_commented', 'popular' => 'e2://e2m_popular', 'untagged' => 'e2://e2m_untagged?page=1', 'untagged/:page' => 'e2://e2m_untagged', 'calendar' => 'e2://e2m_calendar', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'settings' => 'e2://e2m_settings', 'settings/underhood' => 'e2://e2m_underhood', 'settings/underhood/build' => 'e2://e2s_post_service?service=build', 'settings/underhood/sync' => 'e2://e2s_post_service?service=sync', 'settings/underhood/checklist-reset' => 'e2://e2s_post_service?service=checklist-reset', 'settings/underhood/log' => 'e2://e2s_post_service?service=log', 'settings/underhood/unlog' => 'e2://e2s_post_service?service=unlog', 'settings/underhood/migrate' => 'e2://e2s_post_service?service=migrate', 'settings/underhood/verify' => 'e2://e2s_post_service?service=verify', 'settings/underhood/backup' => 'e2://e2s_dump', 'settings/underhood/index' => 'e2://e2s_bsi_step', 'settings/underhood/reindex' => 'e2://e2s_reindex', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password?recovery-key=', 'settings/password-reset' => 'e2://e2m_password_reset', 'settings/password/:reset' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', 'sign-in/:provider' => 'e2://e2m_gip_sign_in', 'sign-out/:provider' => 'e2://e2m_gip_sign_out', 'sign-in-done/:provider' => 'e2://e2m_gip_sign_in_callback', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', ]; $_url_chunks = [ '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => [ 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ], '\:draft' => [ '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ], '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9,]+)', '\:query' => '(?P<query>.*?)', '\:provider' => '(?P<provider>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:reset' => 'reset\:(?P<recovery_key>[0-9a-f]{40})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '(?P<source>\d+)', '\:url' => '\:(?P<url>[a-zA-Z0-9\=\/\\\+\-\_\,]+)', ]; $_url_autoredirects = [ '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ]; function jq () { global$_config; $j2v = [ 'result', 'url', 'entity', 'entity-id', 'overwrite', 'data', 'src', 'ord', ]; if($_config['raw_template_data_with_param']) { $j2v[] = 'raw'; } return $j2v; } function hq ($url){ global$_url_autoredirects; $url = preg_replace (array_keys ($_url_autoredirects),array_values ($_url_autoredirects),$url); if(preg_match ('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$url,$sr)) { if(2 == strlen ($sr[3]))$sr[3]='20'.$sr[3]; return ($sr[3].'/'.$sr[2].'/'.$sr[1].$sr[4]); } if(preg_match ('/^tags\-rss\/(.*?)\/?$/',$url,$sr)) { $wv = substr ($sr[1],strrpos ($sr[1],'/')+1); return ('tags/'. $wv . '/rss/'); } return$url; } function gq () { static $h2v = false; global$__synthetic_urls,$_config; if ($h2v) return; $g2v = $_config['url_composition']; $__synthetic_urls = false; if ($g2v == 'synthetic'){ $__synthetic_urls = true; } if ($g2v == 'auto'){ if(function_exists ('apache_get_modules')) { if(in_array ('mod_rewrite',apache_get_modules ())) { $__synthetic_urls = true; } } } if(getenv ('E2_SYNTH_URLS'))$__synthetic_urls = (bool)getenv ('E2_SYNTH_URLS'); if (isset ($_SERVER['E2_SYNTH_URLS']))$__synthetic_urls = (bool)$_SERVER['E2_SYNTH_URLS']; $h2v = true; } function wq ($candy,$parameters = []) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls; $w2v = array_flip ($_url_map); $url = AeEnv::$cv; $u2v = 'e2://'. $candy; if(array_key_exists ('page',$parameters)) { $parameters['page'] = (int)$parameters['page']; } if(array_key_exists ('day',$parameters)) { $parameters['day']=str_pad ((int)$parameters['day'],2,'0',STR_PAD_LEFT); } if(array_key_exists ('month',$parameters)) { $parameters['month']=str_pad ((int)$parameters['month'],2,'0',STR_PAD_LEFT); } if($parameters){ $u2v .= '?'; $i2v = []; $o2v = []; foreach($parameters as $xn => $bv){ if ($xn == '*note'){ $o2v[] = $xn; $i2v[] = oq ($bv); } if ($xn == '*tags'){ $o2v[] = $xn; $i2v[] = pq ($bv); } if ($xn == '*tag'){ $o2v[] = $xn; $i2v[] = pq ([$bv]); } } foreach ($o2v as $xn) unset($parameters[$xn]); foreach ($i2v as $p2v){ $parameters = array_merge ($parameters,$p2v); } foreach($parameters as $xn => $bv){ if (@$xn[0]!='_'){ $u2v .= $xn . ($bv !== true? ('='. urlencode ($bv)) : '') .'&'; } } $u2v = substr ($u2v,0, -1); } if(array_key_exists ($u2v,$w2v)) { if ($w2v[$u2v]!==''){ if (!$__synthetic_urls){ $url .= '?go='; } $url .= $w2v[$u2v]; if ( !in_array (substr ( $w2v[$u2v], strrpos ($w2v[$u2v],'.') ), ['.txt','.xml','.js']) ) { $url .= '/'; } } return$url; } else { $bdv = false; foreach ($w2v as $ydv => $ndv){ $mdv = $ydv; $mdv = preg_quote ($mdv,'/'); $fdv = parse_url ($ydv); $ddv = $fdv['host']; $sdv = parse_url ($u2v); if(strstr ($ydv,'::')) { $adv = $sdv['scheme'] .'://'. $sdv['host']; $mdv = str_replace ('\:\:','(.*)',$mdv); $mdv = '/^'. $mdv .'$/s'; if(preg_match ($mdv,$adv,$sr)) { $zmv = str_replace ('::',$sr[1],$ndv); $zmv = str_replace ('_','-',$zmv); $p2 = false; if(array_key_exists ('query',$sdv)) { $p2 = $sdv['query']; } if($__synthetic_urls and $p2){ $url .= $zmv .'/?'. $p2; } elseif($__synthetic_urls){ $url .= $zmv .'/'; } elseif ($p2){ $url .= '?go='. $zmv .'/?'. $p2; } else { $url .= '?go='. $zmv .'/'; } return$url; } } $qdv = false; if($candy === $ddv){ $bdv = true; if ((string) @$fdv['query']!==''){ $ldv = explode ('&',$fdv['query']); foreach ($ldv as $zdv){ list ($xn,$bv)=explode ('=',$zdv); $bv = urldecode ($bv); $xn = str_replace ('_','-',$xn); if ( array_key_exists ($xn,$parameters) and $parameters[$xn]!=$bv ) { $qdv = true; break; } } } if (!$qdv){ if(preg_match_all ('/\:[\-a-z]+/i',$ndv,$sr)) { foreach ($sr[0] as $kdv){ $xdv = $_url_chunks['\\'. $kdv]; if (!is_array ($xdv)) { $xdv = [$xdv]; } $edv = $xdv[0]; foreach ($xdv as $edv){ $rdv = '/\(\?P\<(.*?)\>.*?\)/'; $tdv = true; if (@preg_match_all ($rdv,$edv,$sr)) { $sr = $sr[1]; $tdv = true; for ($wb = 0; $wb < count ($sr); ++ $wb){ if ( !array_key_exists (str_replace ("_","-",$sr[$wb]), $parameters) or $parameters[str_replace ("_","-",$sr[$wb])] === '' ) { $tdv = false; break; } } } if (!$tdv) continue; $jdv = @preg_replace_callback ( $rdv, function ($sr) use ($parameters){ return$parameters[str_replace ("_","-",$sr[1])]; }, $edv ); $jdv = stripslashes ($jdv); $jdv = strtr ($jdv, [ '"' => '%22', '<' => '%3C', '>' => '%3E', ]); $hdv = str_replace ($kdv,$jdv,$ndv); break; } $ndv = @$hdv; } } $gdv = []; if ($ndv){ if($__synthetic_urls){ $url .= $ndv .'/'; } else { $gdv[] = 'go='. $ndv .'/'; } } if (@$parameters['raw']===true){ if($_config['raw_template_data_with_param']) { $gdv[] = 'raw'; } } if(count ($gdv)) { $url .= '?'. implode ('&',$gdv); } return$url; } } } if ($bdv){ return$url; } else { die ('Cannot compose url for candy '. $candy); } } } function uq ($url = null){ global$_url_map,$_url_chunks,$_current_url; if(Log::$a)__log ('Resolve request "'. $url .'" {'); gq (); $url = trim ($url,'/'); $url = hq ($url); $parameters = []; $u2v = ''; foreach($_url_map as $wdv => $ydv){ $udv = $wdv; $udv = preg_quote ($udv,'/'); if(strstr ($wdv,'::')) { $udv = str_replace ('\:\:','(.*)',$udv); $udv = '/^'. $udv .'$/s'; if(preg_match ($udv,$url,$sr)) { $idv = str_replace ('-','_',$sr[1]); $u2v = str_replace ('::',$idv,$ydv); } } elseif(strstr ($wdv,':')) { $odv = []; foreach($_url_chunks as $x3 => $e3){ if(is_array ($e3)) { $odv[$x3]='(?:(?:'. implode (')|(?:',$e3) .'))'; } else { $odv[$x3]=$e3; } } $udv = str_replace ( array_keys ($odv), array_values ($odv), $udv ); $udv = '/^'. $udv .'$/s'; if(preg_match ($udv,$url,$sr)) { $u2v = $ydv; foreach ($sr as $xn => $bv) if (!is_numeric ($xn)) { $xn = str_replace ('_','-',$xn); $parameters[$xn]=$bv; } } } else { if ($wdv == $url){ $u2v = $ydv; break; } } } if ($u2v){ $pdv = true; } else { $pdv = false; $u2v = 'e2://e2m_error404'; } if (!$u2v)$u2v = 'e2://e2m_error404'; $sdv = parse_url ($u2v); $candy = $sdv['host']; if ((string) @$sdv['query']!==''){ $ldv = explode ('&',$sdv['query']); foreach ($ldv as $zdv){ list ($xn,$bv)=explode ('=',$zdv); $bv = urldecode ($bv); $xn = str_replace ('_','-',$xn); $parameters[$xn]=$bv; } } foreach($_GET as $xn => $bv){ if(in_array ($xn,jq (), true)) { $parameters[$xn] = (string)$bv or $parameters[$xn]=true; } } $bb = false; if ($pdv){ $_current_url = AeEnv::$h .'://'. AeEnv::$j . $_SERVER['REQUEST_URI']; vl ($candy,$parameters); if(is_callable ($candy)) { $bb = [$candy,$parameters]; } else { $bb = [null, []]; } } else { $bb = [null, []]; } if(Log::$a){ $csv = ''; if(count ($bb[1]) > 0){ $csv = print_r ($bb[1],true); $csv = substr ($csv,8, -2); $csv = '    '. trim ($csv); $csv = preg_replace ('/^.*?$/smu','           $0',$csv); $csv = ' with parameters:'."\r\n". $csv; } __log ( 'Resolved to candy "'. $bb[0] .'"'. $csv ); } if(Log::$a)__log ('}'); return $bb; } function oq ($iy){ if (!isset ($iy['IsPublished'])) { throw new LogicException ('Cannot compose parameters from noterec without IsPublished'); return []; } if (!$iy['IsPublished']) { $parameters['is-published']=0; if ($iy['OriginalAlias']===''){ $parameters['draft']=$iy['ID']; } elseif (tb ($iy['OriginalAlias']) == 1){ $parameters['oalias']=$iy['OriginalAlias']; } else { $parameters['draft2']=$iy['ID']; $parameters['oalias2']=$iy['OriginalAlias']; } return$parameters; } $parameters['is-published']=1; $jy = b (); $gy = 'n'. $iy['ID']; $vsv = $jy[$gy]; if (isset ($iy['__force_ymdn']) and ((string)$iy['OriginalAlias']==='')) { $gy = 'n'. $iy['ID'] .'-ymdn'; if(array_key_exists ($gy,$jy)) { $vsv = $jy[$gy]; } } if(preg_match ( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', $vsv,$sr )) { $parameters['year']=$sr['year']; $parameters['month']=$sr['month']; $parameters['day']=$sr['day']; $parameters['day-number']=$sr['day_number']; } else { $parameters['alias']=$vsv; } return$parameters; } function pq ($hb){ $bsv = $parameters = []; foreach ($hb as $ub){ $bsv[] = b () ['t'. $ub['ID']]; } if(count ($bsv)) { $parameters['tag-alias']=implode (',',$bsv); } return$parameters; } function cl ($parameters){ if ( (string) @$parameters['alias']!=='' or ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' and (string) @$parameters['day-number']!=='' ) ) { if ($r = e2_published_noterec_with_parameters_($parameters)) { if(Log::$a)__log ('Fetched note '.$r['ID'].' "'. $r['Title'] .'" as *note'); $parameters['*note']=$r; foreach (['alias','year','month','day','day-number'] as $ysv){ if(array_key_exists ($ysv,$parameters)) { unset($parameters[$ysv]); } } } } if ( (string) @$parameters['oalias']!=='' or (string) @$parameters['draft']!=='' or (string) @$parameters['oalias2']!=='' or (string) @$parameters['draft2']!=='' ) { if ($r = e2_noterec_with_parameters_($parameters)) { if(Log::$a)__log ('Fetched note '.$r['ID'].' "'. $r['Title'] .'" as *note'); if ((string) @$parameters['oalias']!==''){ $parameters['alias']=$parameters['oalias']; } elseif ((string) @$parameters['oalias2']!==''){ $parameters['alias']=$parameters['oalias2']; } $parameters['*note']=$r; foreach (['oalias','draft','oalias2','draft2'] as $ysv){ if(array_key_exists ($ysv,$parameters)) { unset($parameters[$ysv]); } } } } if ( (string) @$parameters['tag-alias']!=='' ) { $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(Log::$a)__log ('Fetched '. count ($parameters['*tags']) .' tag(s) as *tag(s)'); if(count ($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; unset($parameters['*tags']); if(array_key_exists ('tag-alias',$parameters)) { unset($parameters['tag-alias']); } } } return$parameters; } function vl ($candy,$parameters){ global$_config,$_current_url,$_canonical_url; if (!$_config['force_canonical_urls']) return; if($candy === 'e2m_install') return; if($candy === 'e2m_sign_in') return; if($candy === 'e2m_error404') return; if($candy === 'e2m_gip_sign_in_callback') return; if($candy === 'e2s_notify') return; if($candy === 'e2j_file_upload') return; $_canonical_url = wq ($candy,$parameters); if(Log::$a)__log ('Params are: '. var_export ($parameters,true)); if ( $_current_url != $_canonical_url and urldecode ($_current_url)!=$_canonical_url ) { if(Log::$a)__log ('Used URL "'. $_current_url .'"'); if(Log::$a)__log ('Redirecting to canonical URL "'. $_canonical_url .'"'); r1 ($_canonical_url); } } function bl ($nsv){ global$_instance_config; $l2v = str_replace ('/','--',$nsv); if(substr ($l2v,0,4)=='www.'){ $l2v = substr ($l2v,4); } if(array_key_exists ($l2v,$_instance_config['path_user_rewrites'])) { $l2v = $_instance_config['path_user_rewrites'][$l2v]; } return $l2v; } function yl () { static $msv = null; if ($msv !== null) return $msv; $fsv = AeEnv::$server . AeEnv::$u; if(AeEnv::$w !== (string)''){ $fsv .= '/'. AeEnv::$w; } $msv = bl ($fsv); return $msv; } function nl ($dvv,$dsv){ $ssv = $dsv; $ssv = preg_quote ($ssv); $ssv = str_replace ('/','\/',$ssv); $ssv = str_replace ('%USERKEY%','(.*?)',$ssv); $ssv = '/'. $ssv . '/i'; $l2v = ''; if(preg_match ($ssv,$dvv,$sr) and array_key_exists (1,$sr)) { $l2v = $sr[1]; } return $l2v; } function ml ($asv,$l2v){ foreach (['path_user','path_media'] as $qsv){ if (!array_key_exists ($qsv .'.raw', $asv)) { $asv[$qsv .'.raw']=$asv[$qsv]; } if(strpos ($asv[$qsv .'.raw'],'%USERKEY%')!==false){ $asv[$qsv]=str_replace ( '%USERKEY%', $l2v, $asv[$qsv .'.raw'] ); } } return $asv; } function fl ($lsv,$l2v){ foreach (['path_user','path_media'] as $qsv){ if (!array_key_exists ($qsv .'.raw',$lsv)) { $lsv[$qsv .'.raw']=$lsv[$qsv]; } if(strpos ($lsv[$qsv .'.raw'],'%USERKEY%')!==false){ $lsv[$qsv]=str_replace ( '%USERKEY%', $l2v, $lsv[$qsv .'.raw'] ); } } $_config = $lsv; if(is_file ($f6 = $lsv['path_user'] .'config.php')) { include $f6; $_config += $lsv; } return$_config; } function dl () { global$_instance_config; if(strpos ($_instance_config['path_user'],'%USERKEY%')!==false){ $zsv = str_replace ( '%USERKEY%', '*', $_instance_config['path_user'] ); return glob ($zsv); } else { return [$_instance_config['path_user']]; } } function sl () { static $databaseConfiguration = null; global$settings,$_config; if($databaseConfiguration === null){ $databaseConfiguration = al ($_config,$settings); } return$databaseConfiguration; } function al ($z2v,$svv){ $nbv = null; $ksv = null; if(getenv ('E2_DB_SERVER'))$nbv['server']=getenv ('E2_DB_SERVER'); if(getenv ('E2_DB_USER_NAME'))$nbv['user_name']=getenv ('E2_DB_USER_NAME'); if(getenv ('E2_DB_PASSW'))$nbv['passw']=getenv ('E2_DB_PASSW'); if(getenv ('E2_DB_NAME'))$nbv['name']=getenv ('E2_DB_NAME'); if ($nbv !== null){ $ksv = 'environment'; if(Log::$a)__log ('Database configuration found in Environment, won’t look elsewhere'); } else { if(Log::$a)__log ('No database configuration found in Environment'); $nbv = $z2v['db']; if ($nbv !== null){ $ksv = 'config'; if(Log::$a)__log ('Database configuration found in Config, won’t look elsewhere'); } else { if(Log::$a)__log ('No database configuration found in Config'); if(array_key_exists ('db',$svv)) { $ksv = 'settings'; if(Log::$a)__log ('Database configuration found in Settings'); $nbv = $svv['db']; } else { if(Log::$a)__log ('No database configuration found anywhere'); } } } if ($nbv === null) return null; $databaseConfiguration = new AeDatabaseConfiguration ( $ksv, $z2v['path_user'].BACKUP_DIRNAME, $nbv['server'], $nbv['user_name'], $nbv['passw'], $nbv['name'], $z2v['db_table_prefix'], $z2v['db_table_subset'] ); return$databaseConfiguration; } function ql ($xsv,$esv = false){ $rsv = ''; $ek = strlen ($xsv); for ($wb = 0; $wb < 256; ++ $wb){ $tsv[$wb]=0; $jsv = $wb; while ($jsv & 0x00000080){ $jsv <<= 1; ++ $tsv[$wb]; } } for ($wb = 0xd090; $wb <= 0xd0bf; $wb++)$hsv[$wb]=chr (($wb & 0x000000ff)+48); for ($wb = 0xd180; $wb <= 0xd18f; $wb++)$hsv[$wb]=chr (($wb & 0x000000ff)+112); $hsv[0xd081]="\xa8"; $hsv[0xd191]="\xb8"; $hsv[0xc299]="\x99"; $hsv[0xc2a9]="\xa9"; $hsv[0xc2ae]="\xae"; $hsv[0xc2ab]="\xab"; $hsv[0xc2bb]="\xbb"; $hsv[0xc2a0]="\xa0"; $wb = 0; while ($wb < $ek){ $gsv = $xsv[$wb]; $wsv = ord ($gsv); if ($tsv[$wsv]==0){ $rsv .= $gsv; ++ $wb; } elseif ($tsv[$wsv]==2){ $usv = $hsv[($wsv << 8) | ord ($xsv[$wb+1])]; $rsv .= ($usv != null)? $usv : ( $esv? (e2utf8__unformat_htmlentity ( ll (substr ($xsv,$wb,2)) )) : '?' ); $wb += 2; } else { $isv = substr ($xsv,$wb,$tsv[$wsv]); if ($isv == "\xe2\x84\x96")$rsv .= "\xb9"; elseif ($isv == "\xe2\x80\x93")$rsv .= "\x96"; elseif ($isv == "\xe2\x80\x94")$rsv .= "\x97"; elseif ($isv == "\xe2\x80\x98")$rsv .= "\x91"; elseif ($isv == "\xe2\x80\x99")$rsv .= "\x92"; elseif ($isv == "\xe2\x80\x9a")$rsv .= "\x82"; elseif ($isv == "\xe2\x80\x9c")$rsv .= "\x93"; elseif ($isv == "\xe2\x80\x9d")$rsv .= "\x94"; elseif ($isv == "\xe2\x80\x9e")$rsv .= "\x84"; elseif ($isv == "\xe2\x80\xa6")$rsv .= "\x85"; elseif ($isv == "\xe2\x80\xb9")$rsv .= "\x8b"; elseif ($isv == "\xe2\x80\xba")$rsv .= "\x9b"; elseif ($isv == "\xe2\x82\xac")$rsv .= "\x88"; elseif ($isv == "\xe2\x84\xa2")$rsv .= "\x99"; else $rsv .= $esv? (e2utf8__unformat_htmlentity ( ll ($isv) )) : '?'; $wb += $tsv[$wsv]; } } return $rsv; } function ll ($lbv){ $osv = ''; $ek = strlen ($lbv); for ($wb = 0; $wb < $ek; ++ $wb){ $osv .= preg_replace ('/^1*0/','',decbin (ord ($lbv[$wb]))); } return '&#'. bindec ($osv) .';'; } if (!BUILT) include 'builder.php'; if(version_compare (PHP_VERSION,E2_MINIMUM_PHP)<0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } if (!function_exists ('getimagesize')) { die ('Function getimagesize is not defined, php_gd not installed?'); } if (!extension_loaded ('gd')) { die ('Extension gd not loaded, php_gd not installed?'); } if (!function_exists ('mb_internal_encoding')) { die ('Function mb_internal_encoding is not defined, php_mbstring not installed?'); } if (!class_exists ('PDO')) { die ('Class PDO is not defined installed, PDO not installed?'); } if (!in_array ('mysql',PDO::getAvailableDrivers ())) { die ('Required PDO driver "mysql" not installed'); } if (!is_file ($f6 = 'system/default/config.php')) { die ('File not found: '. $f6); } error_reporting (E_ALL); setlocale (LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding ('UTF-8'); date_default_timezone_set ('GMT'); mysqli_report (MYSQLI_REPORT_OFF); if(version_compare (PHP_VERSION,'7.0')<0){ error_reporting (E_ALL & ~E_STRICT); } ini_set ('pcre.jit','0'); include $f6; $_system_default_config = $_config; foreach (['instance/',$_config['path_user']] as $psv){ if(is_dir ($cav = $psv)) { if(is_file ($f6 = $cav .'config.php')) { include $f6; $_config += $_system_default_config; } break; } } $_instance_config = $_config; define ('INSTANCE_DIR',$cav); AeEnv::examine ($_SERVER); $_config = fl ($_instance_config,yl ()); define ('USER_DIR',$_config['path_user']); define ('USER_URLPATH','user/'); AeEnv::setPrefersHTTPS ($_config['force_https']); AeEnv::setPreferredServer ($_config['preferred_domain_name']); AeFileManager::setInstancePath (INSTANCE_DIR); AeFileManager::setUserPath ($_config['path_user']); AeFileManager::setMediaPath ($_config['path_media']); $_stopwatch = kq ($_stopwatch); spl_autoload_register ('id'); spl_autoload_register ('xy'); spl_autoload_register ('yn'); rn (); function e2 () { global$settings,$content, $_candy, $_lang, $_config, $_strings, $_template; if (!is_dir ($_config['path_user'])) { die ('User directory not found: '. $_config['path_user']); } $settings = e2_load_settings_from_user_folder_(USER_DIR); $_strings = kn (); if(Log::$a)__log ( 'Serving the user with key "'. yl () .'" '. 'using directory "'. $_config['path_user'] .'"' ); $vav = serialize ($_config); $vav = AeEnv::$server . $vav; $vav = serialize (md5 ($vav)); $bav = $_config['path_user'].'config-hash.psa'; if ($vav !== (string) @unserialize (file_get_contents ($bav))) { if(Log::$a)__log ('Edition or configuration changed, dropping all caches'); e2_drop_all_kinds_of_cache (); zn (); if (!@e3 ($bav,serialize ($vav))) { die ('Cannot write file: '. $bav); } } mq (); set_error_handler ('wb'); set_exception_handler ('y3'); $yav = new AeRequest ($_SERVER,$_GET); $content = []; $_candy = $yav->candy; $e6 = qn (); $nav = true; $mav = true; $mm = ss (); if ( $yav -> requiresInstallation () and ( $e6 === null or sl () === null or !AePasswordCheckManager::isPasswordSet () ) ) { $nav = false; zn (); if (!$_config['allow_installer'] or !$_config['allow_db_config']) { $content = ya ('not-configured'); } elseif(count ( $xq = AeFileManager::getPathsWithNoWritePermissions ( $_config['path_user'],$_config['path_media'] ) ) > 0){ $content = ya ('generic', [ 'heading' => $_strings['pt--fix-permissions'], 'text' => ( '<p>'. $_strings['gs--fix-permissions'] .'</p>'. gb (array_unique ($xq)) ), 'button' => $_strings['fb--retry'], ]); } else { $yav -> replaceWith ('e2m_install'); } } if ( empty ($content) and $yav -> requiresVersionMatch () and E2_VERSION !== $e6['version'] ) { $mav = false; if(Log::$a)__log ('Startup: need to update first'); $fav = xq ($e6['version']); if (@$fav['status']==='success'){ $e6 = $fav['instance']; if (ss ()) { hb (e2l_get_string ('gs--updated-successfully', [ 'from' => $fav['from-release'], 'to' => $fav['to-release'], ]), E2E_MESSAGE); } $mav = true; } else { $content = $fav['stub']; } } if ( empty ($content) and $yav -> requiresSignIn () ) { if(Log::$a)__log ('Author signed in? '. ($mm? 'Yes' : 'No')); if (!$mm){ $yav -> replaceWith ('e2m_sign_in'); if ($yav -> toBeFulfilledByService ()) { r1 (wq ('e2m_sign_in')); } } } if ( empty ($content) and !$yav -> allowedInReadOnlyMode () and $_config['read_only'] ) { $content = ya ('read-only-mode'); $nav = false; } header ('X-Powered-By: '. E2_UA_STRING); header ('Content-type: text/html; charset=UTF-8'); if (empty ($content)) { if (!is_callable ($yav->candy)) { $yav -> replaceWith ('e2m_error404'); } if(Log::$a)__log ('Candy after clearance: '. $yav->candy); if ($yav -> shouldSlowDownAJAXResponse () and $_config['dev_slow_ajax']) { sleep (1 + 2 * (rand () / getrandmax ())); } try { if ($yav -> requiresInstallation ()) { $yav->parameters = cl ($yav->parameters); if(Log::$a)__log ('Call e2_canonize_url for the second time:'); vl ($yav->candy,$yav->parameters); if ( array_key_exists ('is-published',$yav->parameters) and $yav->parameters['is-published']=='0' and (string) @$yav->parameters['*note']['IsPublished']=='1' ) { r1 (wq ($yav->candy,$yav->parameters)); } } if(Log::$a)__log ('Candy call {'); $content = call_user_func ($yav->candy,$yav->parameters); } catch (AeMySQLException $e){ if (!$yav->toBeFulfilledByService ()) { v3 ($e); $yav->parameters = []; $content['unavailable?']=true; } else { throw $e; } } if(Log::$a)__log ('}'); } if (!is_array ($content))$content = []; if (!array_key_exists ('notes',$content))$content['notes'] = []; if (!array_key_exists ('tag',$content))$content['tag'] = []; if (!array_key_exists ('drafts',$content))$content['drafts'] = []; if (!array_key_exists ('comments',$content))$content['comments'] = []; if (!array_key_exists ('notes-list',$content))$content['notes-list'] = []; $content['title']=strip_tags (ry ((string) @$content['title'])); if (!empty ($content['heading'])) { $content['heading']=strip_tags (ry (htmlspecialchars ((string) @$content['heading'],ENT_NOQUOTES,'UTF-8'))); } $content['language']=$_lang; if (!isset ($_template))gf (); $content['template']['respond-to-dark-mode?'] = ( array_key_exists ('supports_dark_mode',$_template) and $_template['supports_dark_mode'] and @(bool)$settings['appearance']['respond_to_dark_mode'] ); $content['template']['use-likely-light?']=$_template['use_likely_light']; if (!array_key_exists ('class',$content)) { $content['class']=str_replace ('_','-',str_replace ('e2m_','',$yav->candy)); } if ($nav and $mav){ if(Log::$a)__log ('Stuff for installed engine {'); d3 ('rss',ev (), wq ('e2m_rss')); d3 ('json',ev (), wq ('e2m_json')); $content['sign-in'] = [ 'done?' => (bool)$mm, 'required?' => (bool)$yav->requiresSignIn (), 'necessary?' => (bool)$yav->requiresSignIn () && !$mm, 'href' => wq ('e2m_sign_in'), 'prompt' => $_strings['gs--need-password'], 'token' => ys (), ]; $content['hrefs'] = [ 'everything' => wq ('e2m_everything'), ]; if (!array_key_exists ('tags',$content)) $content['tags']=la ($yav->parameters); if (!array_key_exists ('main-menu',$content)) $content['main-menu']=in ($yav->parameters,$content['class']); $content['blog']=xv (); $content['form-search']=rd ($yav->parameters); $content['engine']=jb (); $content['form-login']=js (); if($content['form-login']===null) unset($content['form-login']); if (!array_key_exists ('summary',$content)) { if (!empty ($settings['meta_description'])) { $content['summary']=strip_tags ( ry (htmlspecialchars ($settings['meta_description'],ENT_QUOTES,'UTF-8')) ); } else { $content['summary'] = @trim (strip_tags ($content['blog']['subtitle'])); } } if (@$settings['appearance']['show_view_counts']) { AeNoteReadCountsProvider :: setSQLRequestTemplateToMapIDsToReadCounts ( "SELECT `ID`, `ReadCount` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ); } foreach($content['notes'] as $r){ z2 (@$r['format-info']['links-required']); } if ($mm){ $content['admin']=c (); $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[j1 ('local_copies')]) { $content['last-modifieds-by-id'] = ( nf ($_COOKIE[j1 ('local_copies')]) ); } if($_config['allow_self_check']) { $dav = hs (); } } if(Log::$a)__log ('}'); } $content['message']=ib (); $i0 = v2 (); $content['meta']=cm ( $yav->candy, $content['notes'], $content['tag'], $content['blog'], $content['pages'] ); $content['stat']=jv (); $i0 = of ($i0); echo $i0; if ($nav and $mav and $_SERVER['HTTP_USER_AGENT']!==E2_UA_STRING){ if (!gd ()) { if(Log::$a)__log ('Spawn BSI step'); vv (wq ('e2s_bsi_step')); } if($_config['allow_self_check'] and !$dav){ gs (); } } if (@$_config['dev_dump_ctree'])jn ($content); } ?>